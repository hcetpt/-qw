==================
部分校验日志
==================

部分校验日志（PPL）是为RAID5阵列提供的一项功能。PPL所解决的问题是在脏关机后，某个条带的校验可能会与其他成员磁盘上的数据不一致。如果阵列处于降级状态，则无法重新计算校验值，因为其中一块磁盘缺失。这可能导致在重建阵列或以降级状态使用时发生无声的数据损坏——对于在脏关机期间未被写请求触及的阵列块，根据校验值计算出的数据可能是错误的。这种情况被称为RAID5写洞。正因为如此，默认情况下md不允许启动脏降级状态的阵列。

写操作的部分校验是对该条带中未被此写操作修改的数据块进行XOR运算得到的结果。这是恢复写洞所需的确切数据量。将部分校验与被修改的数据块进行XOR运算可以得到与写操作前状态一致的条带校验值，无论哪些数据块的写入已完成。如果该条带中的一个未被修改的数据磁盘缺失，则可以利用更新后的校验值来恢复其内容。在脏关机后启动阵列且所有磁盘均可用时也会执行PPL恢复，从而消除了重新同步阵列的需求。正因为如此，不支持同时使用写意图位图和PPL。

处理写请求时，PPL会在新数据和校验值分发到磁盘之前先写入部分校验。PPL是一种分布式日志——它存储在阵列成员驱动器的元数据区域，在特定条带的校验磁盘上。它不需要专门的日志驱动器。虽然写性能会降低30%-40%，但这种降低随着阵列中驱动器数量的增加而减少，并且日志驱动器不会成为瓶颈或单点故障。

与md中的另一种解决写洞问题的方案raid5-cache不同，PPL并不是真正的日志。它仅能防止无声的数据损坏，而不能防止丢失飞行中的数据。如果一个条带中的脏磁盘丢失，则不会对该条带执行PPL恢复（校验值不会更新）。因此，如果该磁盘丢失，条带已写部分可能包含任意数据。在这种情况下，行为与普通的RAID5相同。

PPL适用于md版本1元数据和外部（特别是IMSM）元数据阵列。可以使用mdadm选项--consistency-policy=ppl启用PPL。
PPL有一个限制：阵列中的磁盘最大数量为64个。这有助于保持数据结构和实现简单。考虑到多块磁盘同时失效的风险很高，拥有这么多磁盘的RAID5阵列不太可能出现。这种限制在实际应用中应该不会构成真正的问题。
