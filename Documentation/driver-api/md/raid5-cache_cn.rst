RAID 4/5/6 缓存
==============

RAID 4/5/6 可以包括一个额外的磁盘作为数据缓存，除了正常的 RAID 磁盘之外。缓存磁盘的存在不会改变 RAID 磁盘的作用。缓存磁盘将数据缓存到 RAID 磁盘上。缓存可以是透写(write-through, 自 4.4 版本起支持) 或回写(write-back, 自 4.10 版本起支持) 模式。mdadm（自 3.4 版本起支持）有一个新选项 `--write-journal` 用于创建带有缓存的阵列。请参考 mdadm 手册了解详情。默认情况下（阵列启动时），缓存处于透写模式。用户可以通过以下命令将其切换为回写模式：

```
echo "write-back" > /sys/block/md0/md/journal_mode
```

然后通过以下命令将其切换回透写模式：

```
echo "write-through" > /sys/block/md0/md/journal_mode
```

在两种模式下，所有对阵列的写操作都会先命中缓存磁盘。这意味着缓存磁盘必须速度快且持久。
透写模式
=========

此模式主要解决“写空洞”问题。对于 RAID 4/5/6 阵列，不干净的关机可能会导致某些条带中的数据处于不一致状态，例如，数据和校验位不匹配。原因在于条带写操作涉及多个 RAID 磁盘，并且有可能在不干净的关机之前并非所有的 RAID 磁盘都完成了写入。我们将包含不一致数据的阵列称为降级状态。MD 尝试重新同步阵列使其恢复到正常状态。但在重新同步完成之前，任何系统崩溃都将暴露出阵列中真实数据损坏的风险。这个问题被称为“写空洞”。透写缓存会首先将所有数据缓存在缓存磁盘上。数据在缓存磁盘上安全后，再被刷新到 RAID 磁盘上。两步写操作将确保 MD 即使在阵列降级的情况下也能在不干净的关机后恢复正确的数据。因此，缓存可以关闭“写空洞”。在透写模式下，MD 在数据安全地存储在 RAID 磁盘上之后向高层（通常是文件系统）报告 I/O 完成情况，所以缓存磁盘故障不会导致数据丢失。当然，缓存磁盘故障意味着阵列再次暴露于“写空洞”的风险之下。在透写模式下，缓存磁盘不需要很大。几百兆字节就足够了。
回写模式
========

回写模式同样解决了“写空洞”问题，因为所有写入的数据都被缓存在缓存磁盘上。但回写缓存的主要目的是提高写入速度。如果一个写操作跨越了一个条带的所有 RAID 磁盘，我们称其为全条带写。对于非全条带写操作，MD 必须先读取旧数据才能计算新的校验位。这些同步读取会降低写入吞吐量。一些顺序写入但由于没有同时调度也会受到这种开销的影响。回写缓存将数据聚合起来，并仅在数据成为一个全条带写操作后才将其刷新到 RAID 磁盘上。这完全避免了开销，因此对于某些工作负载非常有帮助。一个典型的例子是在顺序写入后进行 fsync 的工作负载。在回写模式下，MD 在数据到达缓存磁盘后立即向高层（通常是文件系统）报告 I/O 完成情况。数据稍后会在满足特定条件后刷新到 RAID 磁盘。因此，缓存磁盘故障会导致数据丢失。在回写模式下，MD 还在内存中缓存数据。内存缓存包含了与缓存磁盘上存储的相同数据，因此电源故障不会导致数据丢失。内存缓存大小对阵列性能有影响。建议设置较大的缓存大小。用户可以通过以下命令配置大小：

```
echo "2048" > /sys/block/md0/md/stripe_cache_size
```

太小的缓存磁盘在这种模式下会使写入聚合效率降低，具体取决于工作负载。建议使用至少几GB大小的缓存磁盘进行回写模式。
实现
=====

透写和回写缓存使用相同的磁盘格式。缓存磁盘被组织为简单的写日志。日志由“元数据”和“数据”对组成。元数据描述了数据，并包含用于恢复识别的校验和及序列 ID。数据可以是 I/O 数据或校验位数据。数据也被校验和处理，校验和存储在元数据中，在数据之前。校验和是一种优化，因为 MD 可以自由地写入元数据和数据，而无需担心顺序问题。MD 超级块有一个字段指向日志头的有效元数据。
日志的实现相当直接。难点在于MD如何按顺序将数据写入缓存磁盘和RAID磁盘。具体来说，在直通（write-through）模式下，MD为I/O数据计算校验和，然后将I/O数据和校验和都写入日志中，当数据和校验和在日志中稳定后，再将它们写入RAID磁盘，最后完成I/O操作。读取操作则像平常一样直接从RAID磁盘读取。

在回写（write-back）模式下，MD将I/O数据写入日志并报告I/O完成。此时数据也被完全缓存在内存中，这意味着读取操作必须查询内存缓存。如果满足某些条件，MD会将数据刷新到RAID磁盘：MD将为数据计算校验和并将校验和写入日志。完成后，MD会将数据和校验和写入RAID磁盘，然后可以释放内存缓存。这些刷新条件可能包括条带变为全条带写入、缓存磁盘空闲空间低或内核内存缓存空闲空间低。

在非正常关机后，MD会进行恢复。MD从日志中读取所有元数据和数据。序列ID和校验和可以帮助我们检测损坏的元数据和数据。如果MD发现带有有效数据和校验和（RAID4/5为1个校验和，RAID6为2个校验和）的条带，MD会将数据和校验和写入RAID磁盘。如果校验和不完整，则丢弃；如果部分数据损坏，也丢弃。然后MD加载有效数据，并以常规方式将其写入RAID磁盘。
