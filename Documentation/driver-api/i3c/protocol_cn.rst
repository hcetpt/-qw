SPDX 许可证标识符: GPL-2.0

============
I3C 协议
============

免责声明
==========

本章将重点介绍对软件开发人员重要的方面。对于所有与硬件相关的内容（例如总线上如何传输数据、如何防止冲突等），请参阅 I3C 规范。本文档仅是 I3C 协议及其引入概念的简要介绍。如果您需要更多信息，请参考 MIPI I3C 规范（可在此处下载 https://resources.mipi.org/mipi-i3c-v1-download）。

简介
============

I3C（发音为“eye-three-see”）是由 MIPI 标准化的一种协议，旨在克服 I2C 的局限性（如速度受限、中断所需的外部信号、无法自动检测连接到总线上的设备等），同时保持低功耗。
I3C 总线
=======

一个 I3C 总线由多个 I3C 设备组成，可能还包含一些 I2C 设备，但目前我们只关注 I3C 设备。
在 I3C 总线上，一个 I3C 设备可以扮演以下角色之一：

* 主控器：该设备控制着总线。它是负责发起交易或决定哪个设备允许在总线上发言的设备（在 I3C 中，从机生成事件是可能的，见下文）
* 从机：该设备作为从机运行，无法直接向总线上的另一个从机发送帧。如果主控器允许的话，该设备仍然可以自行主动向主控器发送事件

I3C 是一个多主控协议，因此总线上可能存在多个主控器，但同一时刻只能有一个设备担任主控器的角色。为了获得总线所有权，主控器必须遵循特定的程序。
I3C 总线上的每个设备都必须被分配一个动态地址以便进行通信。在此之前，设备应该只响应有限的一组命令。如果它有一个静态地址（也称为传统的 I2C 地址），那么该设备可以响应 I2C 传输。
除了这些每个设备的地址之外，协议还定义了一个广播地址以向总线上的所有设备发送信息。
一旦给设备分配了动态地址，这个地址将用于与该设备的所有直接通信。需要注意的是，即使分配了动态地址后，设备仍应处理广播消息。
I3C 设备发现
============

I3C 协议定义了一种机制，可以自动发现总线上存在的设备、它们的能力以及所提供的功能。在这方面，I3C 更接近于像 USB 这样的可发现总线，而不是 I2C 或 SPI。发现机制被称为 DAA（动态地址分配），因为它不仅能发现设备，还能为它们分配一个动态地址。

在 DAA 过程中，每个 I3C 设备会报告以下三个重要信息：

* BCR：总线特性寄存器。这个 8 位的寄存器描述了与设备总线相关的功能。
* DCR：设备特性寄存器。这个 8 位的寄存器描述了设备提供的功能。
* 预配置 ID：一个 48 位的唯一标识符。在一个给定的总线上不应出现预配置 ID 的冲突，否则可能会导致发现机制失败。

I3C 从机事件
=============

I3C 协议允许从机自主生成事件，从而让它们暂时控制总线。这种机制称为 IBI（带内中断），正如其名称所示，它允许设备无需外部信号就能生成中断。

在 DAA 过程中，总线上的每个设备都会被分配一个地址，该地址将作为优先级标识符来确定如果两个不同的设备在同一时刻生成中断时谁会胜出（动态地址越低，优先级越高）。

主机可以选择抑制中断。这种抑制请求可以是广播形式（适用于所有设备）或针对特定设备。

I3C 热插拔
===========

热插拔机制类似于 USB 的热插拔。此机制允许从机在被主机初始化后加入总线。

这包括以下使用场景：

* 设备在总线探测时未通电。
* 设备通过扩展板热插拔到总线上。

此机制依赖于从机事件来通知主机新设备已加入总线并等待分配动态地址。然后，主机可以根据需要自由处理请求：忽略请求或为从机分配动态地址。
I3C传输类型
==================

如果你不考虑SMBus（它仅仅是对于如何访问I2C设备暴露出来的寄存器的一种标准化），I2C只有一种传输类型。而I3C定义了三种额外的传输类别，这些类别与I2C传输一起存在以保持向后兼容性。

I3C CCC命令
----------------

CCC（通用命令码）命令主要用于总线管理以及一组设备共有的所有特性。CCC命令包含一个8位的CCC ID来描述被执行的命令。
这个ID的最高位指定了这是一条广播命令（比特7 = 0）还是一条单播命令（比特7 = 1）。
命令ID后面可以跟着一个负载。根据不同的命令，这个负载要么由发送命令的主设备发送（写CCC命令），要么由接收命令的从设备发送（读CCC命令）。当然，读取操作仅适用于单播命令。
需要注意的是，在向特定设备发送CCC命令时，设备地址会通过负载的第一个字节传递。
负载长度不会在总线上显式传递，而是应该从CCC ID中提取出来。
另外，供应商可以使用专门的CCC ID范围为其自己的命令（0x61-0x7f 和 0xe0-0xef）。

I3C私有SDR传输
-------------------------

私有SDR（单数据速率）传输应用于特定于设备并且不需要高速传输速度的情况。
这是类似于I²C传输的概念，但在I³C世界中。每次传输都会传递设备地址（在DAA期间分配的动态地址）、负载和方向。
与I²C的唯一区别是传输速度要快得多（典型的时钟频率为12.5MHz）。
### I³C HDR命令

HDR命令应用于所有特定于设备且需要高速传输的情况。
HDR命令首先关联的是HDR模式。目前，I³C规范定义了三种不同的模式（更多细节请参阅规范）：

* HDR-DDR：双倍数据速率模式
* HDR-TSP：三进制符号纯模式。仅适用于没有I²C设备的总线
* HDR-TSL：三进制符号传统模式。适用于有I²C设备的总线

发送HDR命令时，整个总线必须进入HDR模式，这通过广播CCC命令来实现。
一旦总线进入特定的HDR模式，主控器就会发送HDR命令。
一个HDR命令由以下部分组成：

* 一个16位的大端序命令字
* N个16位的大端序数据字

这些字可能被特定的前导码/后置码包裹，这取决于所选HDR模式，具体细节如下（更多细节请参阅规范）。
16位命令字由以下部分组成：

* bit[15]：方向位，读取为1，写入为0
* bit[14:8]：命令代码。标识执行的命令、数据字的数量及其含义
* bit[7:1]：该命令所指向设备的I³C地址
* bit[0]：保留/奇偶校验位

### 与I²C设备的向后兼容性

I³C协议设计时考虑到了与I²C设备的向后兼容性。
这种向后兼容性使得在同一总线上连接I²C和I³C设备混合使用成为可能，不过为了达到更高的效率，I²C设备应该配备50纳秒尖峰滤波器。
I²C设备无法像I³C设备那样被发现，而需要静态声明。为了让主控器了解这些设备的能力（包括总线相关的限制和功能），软件需要提供一些信息，这通过LVR（遗留I²C虚拟寄存器）来完成。
