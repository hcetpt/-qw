授权标识符：GPL-2.0
包含：<isonum.txt>

===================================
计算快速链路内存设备
===================================

计算快速链路（Compute Express Link，CXL）内存设备是一种实现了CXL.mem协议的CXL组件。它包含一定量的易失性内存、持久性内存或两者兼有。通过配置并利用MMIO邮箱传递消息的方式将其枚举为PCI设备。其对系统物理地址空间的贡献是通过HDM（主机管理的设备内存）解码器来处理的，这些解码器可选地定义了设备在主机桥下多个设备之间交错地址范围中的贡献或者在主机桥之间的交错。

CXL总线：工作原理
============================

类似于RAID驱动程序将磁盘对象组装成一个新的逻辑设备，CXL子系统被赋予的任务是将PCI-E和ACPI对象组装成CXL.mem解码拓扑。CXL.mem拓扑需要运行时配置的需求与RAID类似，即相同的硬件配置在不同的环境中可能会以截然不同的方式组装拓扑。一种情况可能是选择性能（如RAID0），将内存跨多个主机桥和端点进行条带化；而另一种情况可能为了容错而禁用任何条带化操作。

平台固件在"CXL根端口"（Linux术语，指的是CXL解码拓扑的顶部）枚举了一系列的交错选项。从那里开始，PCI-E拓扑决定了哪些端点可以参与哪些主机桥的解码规则。

路径中每个PCI-E交换机都会引入一个点，在该点上交错可以被分割。例如，平台固件可能在给定范围内只对一个主机桥进行解码，但这个主机桥可能反过来在多个根端口之间交错周期。位于端口和端点之间的交换机可能在多个下游交换端口之间交错周期等。

以下是"cxl_test"定义的CXL拓扑的一个示例列表。"cxl_test"模块生成了一个由两个主机桥组成的模拟CXL拓扑，每个主机桥都有两个根端口。每个根端口都连接到双向开关，端点连接到这些下游端口，总共形成了8个端点：

```
# cxl list -BEMPu -b cxl_test
{
  "bus":"root3",
  "provider":"cxl_test",
  "ports:root3":[
    ...
```

在上述列表中，每个"root"、"port"和"endpoint"对象对应内核中的一个'struct cxl_port'对象。一个'cxl_port'是一个可以为其后代解码CXL.mem的设备。因此，"root"声称非PCI-E可枚举平台解码范围，并将其解码到"ports"，"ports"解码到"endpoints"，而"endpoints"代表从SPA（系统物理地址）到DPA（设备物理地址）的解码。

继续使用RAID的类比，磁盘具有决定RAID集装配的拓扑元数据和设备上的元数据。CXL端口拓扑和CXL端口链接状态是用于CXL.mem集装配的元数据。CXL端口拓扑是由CXL.mem设备的出现所枚举的。也就是说，除非PCI-E核心将cxl_pci驱动程序附加到CXL内存扩展器，否则没有理由存在CXL端口对象。相反，对于热拔除/移除场景，没有需要Linux PCI核心来拆除开关级别的CXL资源，因为端点->remove()事件清理了用于支持该内存扩展器的端口数据。

可以通过命令来确定特定内存设备可以参与的端口元数据和潜在解码方案：

```
# cxl list -BDMu -d root -m mem3
{
  "bus":"root3",
  "provider":"cxl_test",
  "decoders:root3":[
    ...
```

...该命令查询CXL拓扑以询问"给定名为'mem3'的内核设备名的CXL内存扩展器，此设备可以参与哪些平台级解码范围"。一个给定的扩展器可以根据其拥有的解码器资源的数量同时参与多个CXL.mem交错集。在这个例子中，mem3可以参与跨越主机桥的PMEM交错、针对单个主机桥的PMEM交错、跨越2个主机桥的易失性内存交错以及仅针对单个主机桥的易失性内存交错。

相反，可以参与给定平台级解码方案的内存设备可以通过以下类似的命令来确定：

```
# cxl list -MDu -d 3.2
[
  ...
```

...其中解码器的命名方案为"decoder<port_id>.<instance_id>"。

驱动程序基础设施
=====================

本节涵盖了CXL内存设备的驱动程序基础设施。

CXL内存设备
-----------------
...此处省略了内核文档链接...

CXL端口
--------
...此处省略了内核文档链接...

CXL核心
--------
...此处省略了内核文档链接...

CXL区域
--------
...此处省略了内核文档链接...

外部接口
===================

CXL IOCTL接口
-------------------
...此处省略了内核文档链接...
