SPDX 许可证标识符: GPL-2.0

数字电视解复用器 kABI
---------------------

数字电视解复用器
~~~~~~~~~~~~~~~~

内核数字电视解复用器 kABI 定义了一个驱动程序内部接口，用于将底层、特定于硬件的驱动程序注册到与硬件无关的解复用层。这仅对数字电视设备驱动程序编写者感兴趣。
此 kABI 的头文件名为 `demux.h`，位于 `include/media` 中。
每个系统中的解复用器都应实现解复用 kABI。它用于选择解复用器的传输流（TS）源并管理解复用资源。
当解复用客户端通过解复用 kABI 分配资源时，它会收到指向该资源 kABI 的指针。
每个解复用器从 DVB 前端或内存接收其 TS 输入，如通过此解复用 kABI 设置。在一个拥有多个前端的系统中，kABI 可以用来选择一个 DVB 前端作为解复用器的 TS 源，除非这在硬件平台上是固定的。
解复用 kABI 仅控制前端与其连接的解复用器；设置其他前端参数（如调谐）所使用的 kABI 通过数字电视前端 kABI 定义。
实现抽象接口 demux 的函数应定义为静态或模块私有，并注册到解复用核心以便外部访问。没有必要实现 `dmx_demux` 类型结构体中的每一个函数。例如，解复用接口可能支持节过滤，但不支持 PES 过滤。kABI 客户端在调用函数之前需要检查任何函数指针的值：`NULL` 的值意味着该函数不可用。
每当解复用 API 的函数修改共享数据时，都应该处理丢失更新和竞态条件问题，例如使用互斥锁保护代码的一部分。
请注意，在下半部上下文中调用的函数不得休眠。
即使是在不需要交换的情况下简单的内存分配（未使用 `GFP_ATOMIC`），也可能导致内核线程进入睡眠状态。例如，Linux 内核从下半部上下文调用网络设备接口的函数。因此，如果从网络设备代码调用了解复用 kABI 函数，则该函数不得休眠。
### 解复用回调 API
~~~~~~~~~~~~~~~~~~

此内核空间 API 包含了向解复用客户端传递过滤数据的回调函数。与其它 DVB 内核 ABI（应用程序二进制接口）不同，这些函数由客户端提供并由解复用代码调用。
这个抽象接口中的函数指针不像其他解复用 API 那样被封装到一个结构体中，因为这些回调函数是独立注册和使用的。例如，API 客户端可以提供多个接收传输流 (TS) 数据包的回调函数，而没有接收 PES 数据包或节目的回调函数。
实现回调 API 的函数不需要具备可重入性：当一个解复用驱动程序调用其中一个函数时，在原始调用返回之前不允许再次调用该函数。如果一个回调是由硬件中断触发的，建议使用 Linux 的下半部机制或启动一个任务，而不是直接从硬件中断中调用回调函数。
这一机制通过 `dmx_ts_cb()` 和 `dmx_section_cb()` 回调函数实现。

### 数字电视解复用设备注册函数和数据结构
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. kernel-doc:: include/media/dmxdev.h

### 高级数字电视解复用接口
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. kernel-doc:: include/media/dvb_demux.h

### 驱动内部低级特定硬件解复用接口
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. kernel-doc:: include/media/demux.h
