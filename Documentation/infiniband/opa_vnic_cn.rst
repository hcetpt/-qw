Intel Omni-Path (OPA) 虚拟网络接口控制器 (VNIC)

Intel Omni-Path (OPA) 虚拟网络接口控制器 (VNIC) 功能支持通过 Omni-Path 织物封装以太网数据包来实现以太网功能。
架构
=============
Omni-Path 封装的以太网数据包交换模式涉及一个或多个叠加在 Omni-Path 织物拓扑上的虚拟以太网交换机。Omni-Path 织物上的一组 HFI 节点被允许通过特定的虚拟以太网交换机交换封装的以太网数据包。这些虚拟以太网交换机是通过配置织物上的 HFI 节点进行报头生成和处理而实现的逻辑抽象。在最简单的配置中，织物上的所有 HFI 节点都通过单一的虚拟以太网交换机交换封装的以太网数据包。一个虚拟以太网交换机实际上是一个独立的以太网网络。配置工作由以太网管理器 (EM) 完成，该管理器是可信织物管理器 (FM) 应用程序的一部分。HFI 节点可以有多个 VNIC，每个 VNIC 连接到不同的虚拟以太网交换机。下面的图示展示了一个包含两个虚拟以太网交换机和两个 HFI 节点的情况：

```
                               +-------------------+
                               |      Subnet/      |
                               |     Ethernet      |
                               |      Manager      |
                               +-------------------+
                                  /          /
                                /           /
                              /            /
                            /             /
  +-----------------------------+  +------------------------------+
  |  Virtual Ethernet Switch    |  |  Virtual Ethernet Switch     |
  |  +---------+    +---------+ |  | +---------+    +---------+   |
  |  | VPORT   |    |  VPORT  | |  | |  VPORT  |    |  VPORT  |   |
  +--+---------+----+---------+-+  +-+---------+----+---------+---+
           |                 \        /                 |
           |                   \    /                   |
           |                     \/                     |
           |                    /  \                    |
           |                  /      \                  |
       +-----------+------------+  +-----------+------------+
       |   VNIC    |    VNIC    |  |    VNIC   |    VNIC    |
       +-----------+------------+  +-----------+------------+
       |          HFI           |  |          HFI           |
       +------------------------+  +------------------------+
```

Omni-Path 封装的以太网数据包格式如下所示：
==================== ================================
Bits                 Field
==================== ================================
Quad Word 0:
0-19                 SLID (低 20 位)
20-30                长度（四字节单位）
31                   BECN 位
32-51                DLID (低 20 位)
52-56                SC (服务类别)
57-59                RC (路由控制)
60                   FECN 位
61-62                L2 (=10, 16 字节格式)
63                   LT (=1, 链路传输头部飞拍)

Quad Word 1:
0-7                  L4 类型 (=0x78 以太网)
8-11                 SLID[23:20]
12-15                DLID[23:20]
16-31                PKEY
32-47                熵
48-63                保留

Quad Word 2:
0-15                 保留
16-31                L4 头部
32-63                以太网数据包

Quad Words 3 到 N-1:
0-63                 以太网数据包（填充扩展）

Quad Word N（最后一个）:
0-23                 以太网数据包（填充扩展）
24-55                ICRC
56-61                尾部
62-63                LT (=01, 链路传输尾部飞拍)
==================== ================================

在发送端对以太网数据包进行填充，确保 VNIC OPA 数据包以四字节对齐。'Tail' 字段包含填充的字节数。在接收端读取 'Tail' 字段，并移除填充（以及 ICRC、Tail 和 OPA 报头），然后将数据包传递给网络堆栈。
L4 头部字段包含 VNIC 端口所属的虚拟以太网交换机 ID。在接收端，此字段用于将接收到的 VNIC 数据包解复用到不同的 VNIC 端口。
驱动设计
==============
Intel OPA VNIC 软件设计如以下图所示。OPA VNIC 功能包括硬件依赖组件和硬件无关组件。
已为 IB 设备添加了分配和释放 RDMA netdev 设备的支持。RDMA netdev 支持与网络堆栈交互，从而创建标准网络接口。OPA_VNIC 是一种 RDMA netdev 设备类型。
硬件依赖的 VNIC 功能是 HFI1 驱动程序的一部分。它实现了分配和释放 OPA_VNIC RDMA netdev 的动词。它涉及到为 VNIC 功能分配/管理硬件资源。它与网络堆栈交互并实现了所需的 net_device_ops 函数。它期望在发送路径中有 Omni-Path 封装的以太网数据包，并在传递给网络堆栈之前从接收到的数据包中剥离 Omni-Path 报头。它还实现了 RDMA netdev 控制操作。
OPA VNIC 模块实现了与硬件无关的 VNIC 功能。它由两部分组成：VNIC 以太网管理代理（VEMA）和 VNIC netdev 部分。

VEMA 自注册为 InfiniBand (IB) 核心的一个客户端，并与 IB MAD 堆栈进行交互。它与以太网管理器（EM）及 VNIC netdev 交换管理信息。VNIC netdev 部分负责分配和释放 OPA_VNIC RDMA netdev 设备。在需要时，它会覆盖由硬件相关 VNIC 驱动程序设置的 `net_device_ops` 函数，以适应任何控制操作。此外，它还处理在传输路径中将以太网数据包封装 Omni-Path 头的操作。对于每个 VNIC 接口，封装所需的配置信息由 EM 通过 VEMA 的 MAD 接口进行配置。它还通过调用 RDMA netdev 控制操作将任何控制信息传递给硬件相关的驱动程序：

```
+-------------------+ +----------------------+
|                   | |       Linux          |
|     IB MAD        | |      Network         |
|                   | |       Stack          |
+-------------------+ +----------------------+
                 |               |          |
                 |               |          |
        +----------------------------+      |
        |                            |      |
        |      OPA VNIC Module       |      |
        |  (OPA VNIC RDMA Netdev     |      |
        |     & EMA functions)       |      |
        |                            |      |
        +----------------------------+      |
                    |                       |
                    |                       |
           +------------------+             |
           |     IB core      |             |
           +------------------+             |
                    |                       |
                    |                       |
        +--------------------------------------------+
        |                                            |
        |      HFI1 Driver with VNIC support         |
        |                                            |
        +--------------------------------------------+
```

- **IB MAD**：InfiniBand 管理设备。
- **Linux Network Stack**：Linux 网络堆栈。
- **OPA VNIC Module**：实现 OPA VNIC RDMA Netdev 和 EMA 功能。
- **IB core**：InfiniBand 核心。
- **HFI1 Driver with VNIC support**：支持 VNIC 的 HFI1 驱动程序。
