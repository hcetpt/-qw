IBM 3270 显示系统支持
================================

此文件描述了支持 IBM 3270 设备本地通道连接的驱动程序。它由三个部分组成：

    * 引言
    * 安装
    * 操作


引言
============

本文档介绍了在 Linux/390 下安装和操作 3270 设备的过程。3270 设备是一种块模式的行和列终端，这种设备在二三十年前被 IBM 和克隆制造商销售了数以亿计。
您可能在内部拥有 3270 终端而自己并不知情。如果您使用的是 VM-ESA 操作系统，可以通过命令 "DEF GRAF <十六进制地址>" 定义一个 3270 终端到您的虚拟机中。
本文档假设您将通过 CP/CMS 命令定义四个 3270 终端：

    - DEF GRAF 620
    - DEF GRAF 621
    - DEF GRAF 622
    - DEF GRAF 623

您的 VM-ESA 网络连接允许您从 PC 或工作站上的 xterm 窗口启动 x3270、tn3270 或其他 3270 仿真器。使用 DEF GRAF 命令、类似 xterm 的应用程序以及此 Linux/390 3270 驱动程序，您就有了一种与 Linux 计算机进行通信的新方法。
本文档涵盖了驱动程序的安装过程和拨入 x3270 的操作。
安装
============

您需要通过安装补丁、构建内核并运行配置脚本（config3270.sh，在此目录下）来安装驱动程序。
**警告：** 如果您正在使用 3270 控制台支持，则每次更改控制台地址时（可能是通过在 silo 的 /boot/parmfile 中使用 condev= 参数），都必须重新运行配置脚本。更准确地说，每当您的 3270 组（包括控制台 3270）之间的子通道标识符发生变化时，都应该重新运行配置脚本。在运行完配置脚本和生成的 /tmp/mkdev3270 后尽快重启计算机。
如果您选择将 tub3270 制作为模块，您需要在 /etc/modprobe.d/ 目录下的某个配置文件中添加一行。如果您正在 VM 虚拟机上工作，可以使用 DEF GRAF 来定义虚拟 3270 设备。
您可以同时生成 3270 和 3215 控制台支持，或者只生成其中一个或完全不生成。如果两者都生成，那么在 VM 下的控制台类型不会改变。使用 #CP Q TERM 查看当前的控制台类型。使用 #CP TERM CONMODE 3270 将其更改为 3270。如果您仅生成 3270 控制台支持，那么驱动程序将在启动时自动将您的控制台转换为 3270（如果它是 3215）。
简而言之，步骤如下：

    1. 安装 tub3270 补丁
    2. （如果是模块）在 `/etc/modprobe.d/*.conf` 文件中添加一行
    3. （如果是 VM）使用 DEF GRAF 定义设备
    4. 重启
    5. 配置

为了测试一切是否正常工作，假设使用 VM 和 x3270，

    1. 打开一个 x3270 窗口
    2. 在该窗口中使用 DIAL 命令
翻译如下：

3. 您应该立即看到 Linux 登录界面。
以下是详细的安装步骤：

1. 3270 驱动程序是官方 Linux 内核源代码的一部分。构建包含内核源代码及所需补丁的树，然后执行以下命令：
   
   ```
   make oldconfig
   ```
   （如果您希望禁用 3215 控制台支持，请编辑 `.config` 文件；将 `CONFIG_TN3215` 的值改为 "n"；然后重新运行 `make oldconfig`。）
   ```
   make image
   make modules
   make modules_install
   ```

2. （仅当您已将 tub3270 配置为模块时才执行此步骤。）在文件 `/etc/modprobe.d/*.conf` 中添加一行以自动加载驱动程序。添加这一行后，在启动完成后（或使用模拟 3270 时，在使用 “DIAL <vmguestname>” 命令拨入您的虚拟机客体后），您将在 3270 上看到登录提示。由于行模式的主要数字为 227，因此应添加的行如下所示：

   ```
   alias char-major-227 tub3270
   ```

3. 如果您尚未定义，请为您的虚拟机客体定义图形设备。在重启（reipl）之前定义它们：

   ```
   - DEFINE GRAF 620
   - DEFINE GRAF 621
   - DEFINE GRAF 622
   - DEFINE GRAF 623
   ```

4. 重启。重启过程会扫描硬件设备，包括 3270 设备，并在加载 tub3270 驱动程序后使其能够正确响应下一步的配置请求。如果选择了 3270 控制台支持，则此时您的控制台将作为 3270 运行，而非 3215。

5. 运行 3270 配置脚本 `config3270`。该脚本位于同一目录下，即 `Documentation/arch/s390` 中的 `config3270.sh`。检查它生成的输出脚本 `/tmp/mkdev3270`，然后运行该脚本。这将创建必要的字符特殊设备文件并更改 `/etc/inittab`。然后通知 `/sbin/init` `/etc/inittab` 已经改变，通过发出带有 q 参数的 telinit 命令：

   ```
   cd Documentation/arch/s390
   sh config3270.sh
   sh /tmp/mkdev3270
   telinit q
   ```

   对于首次设置，这应该足够了。如果您更改了 3270 配置且正在重用 `config3270`，请遵循以下步骤：

   - 更改 3270 配置
   - 重启
   - 运行 `config3270` 和 `/tmp/mkdev3270`
   - 重启

以下是详细的测试步骤：

1. 打开一个 x3270 窗口，或者使用实际的硬件 3278 或 3279，或者使用您选择的 3270 模拟器。您将在您的 PC 或工作站上运行模拟器。例如，您可以使用以下命令：

   ```
   x3270 vm-esa-domain-name &
   ```

   如果您需要的是具有 43 行、每行 80 列的 3278 Model 4，默认模型编号。驱动程序不会利用扩展属性。
   您现在应该看到包含 VM 标志和底部输入行的屏幕。使用 TAB 键移动到底部行，该行可能标有 "COMMAND  ===>"。

2. 使用 DIAL 命令而不是 LOGIN 命令连接到您使用 DEF GRAF 命令定义的一个虚拟 3270：

   ```
   dial my-vm-guest-name
   ```

3. 您应该立即看到来自您的 Linux-390 操作系统的登录提示。如果没有发生这种情况，您会看到 “DIALED TO my-vm-guest-name   0620” 这一行。

为了排除故障：执行以下操作
A. 驱动程序是否已加载？使用 lsmod 命令（无需参数）来找出。很可能没有加载。尝试手动加载它，使用命令 "insmod tub3270"。该命令是否显示错误消息？哈哈！这就是问题所在！

B. 文件 `/etc/inittab` 是否像安装步骤 3 中那样进行了修改？使用 grep 命令来找出；例如，发出 "grep 3270 /etc/inittab"。未找到任何内容？这就是问题所在！

C. 特殊设备文件是否已经创建，就像安装步骤 2 中那样？使用 ls -l 命令来找出；例如，发出 "ls -l /dev/3270/tty620"。输出应该以字母 "c" 开头，表示字符设备，并且应该在设备名称的左侧包含 "227, 1"。没有这样的文件？没有 "c"？主要数字不正确？次要数字不正确？这就是问题所在！

D. 您是否收到以下消息？

   ```
   "HCPDIA047E my-vm-guest-name 0620 不存在"
   ```

   如果是这样，您必须从您的 VM 3215 控制台发出 "DEFINE GRAF 620" 命令，然后重启系统。
驱动程序在 3270 屏幕上定义了三个区域：日志区域、输入区域和状态区域。
日志区域占据了屏幕除底部两行之外的所有空间。驱动程序从顶部开始向下写入终端输出。当该区域满时，状态区域会从“Linux 运行中”变为“Linux 更多...”。经过滚动超时（默认为 5 秒）后，屏幕将清空，并继续从顶部向下写入更多的输出。
输入区域从倒数第二行的起始位置延伸到状态区域的起始位置。您在此区域内键入命令并按回车执行它们。
状态区域初始化为“Linux 运行中”，以给您一种温暖舒适的感觉。当日志区域填满且有待输出的内容时，它会变为“Linux 更多...”。此时您可以做几件事或什么都不做。如果您什么都不做，在（默认）5 秒后屏幕会自动清空并显示更多的输出内容。您也可以在输入区域什么也不输入的情况下直接按回车，在“Linux 更多...”和“Linux 暂停”之间切换，后者表示不会发生滚动。（如果您在输入区域为空时按回车并且状态为“Linux 运行中”，则应用程序将接收到一个换行符。）

您可以更改滚动超时值。例如，以下命令行：

```
echo scrolltime=60 > /proc/tty/driver/tty3270
```

将滚动超时值更改为 60 秒。如果您希望完全禁止滚动，请将 scrolltime 设置为 0。
当日志区域填满时，您还可以执行其他操作：按 PA2 清除日志区域并继续向其中写入更多输出，或者按 CLEAR 清除日志区域和输入区域，并继续向日志区域写入更多输出。
部分程序功能（PF）键和程序注意（PA）键预设了一些特殊功能。未预设功能的键按下时会发出警报声。
PA1 会向当前运行的应用程序发送一个 SIGINT 信号。您也可以在输入区域键入 "^C" 并按回车实现相同的效果。
PA2 会导致日志区域被清除。如果有待输出的内容，则随后会写入日志区域。
PF3 会使应用程序接收一个文件结束（EOF）作为输入。您也可以通过键入 "^D" 并按回车来达到同样的效果。
没有预设任何 PF 键用于作业挂起，但您可以通过键入 "^Z" 并按回车来挂起作业。您可能希望为此功能分配一个 PF 键。要使 PF7 引发作业挂起，请执行以下命令：

```
echo pf7=^z > /proc/tty/driver/tty3270
```

如果您键入的输入不以两个字符 "^n" 结尾，驱动程序会在末尾添加一个换行符并将其发送给 tty 驱动程序；否则，驱动程序会移除 "^n" 并不添加换行符。
IBM 3215 驱动程序的行为类似。

Pf10 会从管子的命令栈（默认深度为20）中提取最近的一条命令，并在输入区域显示。你可以再次按下 Pf10 来获取次近的一条命令，以此类推。只有当输入区域没有被设置为不可见（例如，在输入密码时）并且该命令与当前栈顶命令不相同时，一条命令才会被存入栈中。Pf10 可以回溯命令栈中的历史记录；而 Pf11 则可以向前移动。你可以将回溯功能分配给任意一个 Pf 键（或 Pa 键），比如，你可以将此功能分配给 Pa3，使用如下命令：

```
echo -e "pa3=\\033k" > /proc/tty/driver/tty3270
```

这会将字符串 ESC-k 分配给 Pa3。同样地，字符串 ESC-j 执行向前的功能。（理由：在 bash 中，如果使用 vi 模式的行编辑，则 ESC-k 和 ESC-j 分别用于检索前后的历史记录。欢迎提出建议。）

如果你觉得保存20条命令不够用？那就随时调整这个数值。要改为保存最后100条命令，执行如下命令：

```
echo "recallsize=100" > /proc/tty/driver/tty3270
```

有一些你经常使用的命令吗？将其分配给 Pf 或 Pa 键吧！使用如下命令：

```
echo "pf24='mkdir foobar; cd foobar'" > /proc/tty/driver/tty3270
```

当你按下 Pf24 时，会立即执行 `mkdir foobar` 和 `cd foobar` 这两条命令。如果你想在执行前先看到命令行，可以使用 `echo` 命令的 `-n` 选项：

```
echo -n "pf24='mkdir foo; cd foo'" > /proc/tty/driver/tty3270
```

祝你测试愉快！对于本文档、驱动程序等任何方面的评论和建议，我都非常欢迎。
Dick Hitt <rbh00@utsglobal.com>
