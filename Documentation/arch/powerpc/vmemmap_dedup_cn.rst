SPDX 许可证标识符: GPL-2.0

=====
设备 DAX
=====

设备 DAX 接口使用了在 `Documentation/mm/vmemmap_dedup.rst` 中解释的尾部消除重复技术。

在 PowerPC 架构上，vmemmap 消除重复仅与 Radix MMU 翻译一起使用。此外，
对于 64KB 的页面大小，只有具有 1GB 对齐方式的 devdax 命名空间使用 vmemmap 消除重复。
对于 2MB 的 PMD 级别映射，我们需要 32 个结构化页面，并且一个 64KB 的 vmemmap 页面可以包含 1024 个结构化页面（64KB / sizeof(struct page)）。因此，没有可能进行 vmemmap 消除重复。
对于 1GB 的 PUD 级别映射，我们需要 16384 个结构化页面，并且一个 64KB 的 vmemmap 页面可以包含 1024 个结构化页面（64KB / sizeof(struct page)）。因此，我们需要 16 个 64KB 的 vmemmap 页面来映射 1GB PUD 级别的结构化页面。
填充各个部分后，在设备 DAX 上的情况如下所示:
```
+-----------+ ---virt_to_page---> +-----------+   映射到   +-----------+
|           |                     |     0     | -------------> |     0     |
|           |                     +-----------+                +-----------+
|           |                     |     1     | -------------> |     1     |
|           |                     +-----------+                +-----------+
|           |                     |     2     | ----------------^ ^ ^ ^ ^ ^
|           |                     +-----------+                   | | | | |
|           |                     |     3     | ------------------+ | | | |
|           |                     +-----------+                     | | | |
|           |                     |     4     | --------------------+ | | |
|    PUD    |                     +-----------+                       | | |
|   级别    |                     |     .     | ----------------------+ | |
|  映射     |                     +-----------+                         | |
|           |                     |     .     | ------------------------+ |
|           |                     +-----------+                           |
|           |                     |     15    | --------------------------+
|           |                     +-----------+
|           |
|           |
|           |
+-----------+
```

对于 4KB 的页面大小，2MB 的 PMD 级别映射需要 512 个结构化页面，并且一个 4KB 的 vmemmap 页面包含 64 个结构化页面（4KB / sizeof(struct page)）。因此，我们需要 8 个 4KB 的 vmemmap 页面来映射 2MB PMD 级别的结构化页面。
填充各个部分后，在设备 DAX 上的情况如下所示:

```
+-----------+ ---virt_to_page---> +-----------+   映射到   +-----------+
|           |                     |     0     | -------------> |     0     |
|           |                     +-----------+                +-----------+
|           |                     |     1     | -------------> |     1     |
|           |                     +-----------+                +-----------+
|           |                     |     2     | ----------------^ ^ ^ ^ ^ ^
|           |                     +-----------+                   | | | | |
|           |                     |     3     | ------------------+ | | | |
|           |                     +-----------+                     | | | |
|           |                     |     4     | --------------------+ | | |
|    PMD    |                     +-----------+                       | | |
|   级别    |                     |     5     | ----------------------+ | |
|  映射     |                     +-----------+                         | |
|           |                     |     6     | ------------------------+ |
|           |                     +-----------+                           |
|           |                     |     7     | --------------------------+
|           |                     +-----------+
|           |
|           |
|           |
+-----------+
```

对于 1GB 的 PUD 级别映射，我们需要 262144 个结构化页面，并且一个 4KB 的 vmemmap 页面可以包含 64 个结构化页面（4KB / sizeof(struct page)）。因此，我们需要 4096 个 4KB 的 vmemmap 页面来映射 1GB PUD 级别的结构化页面。
填充各个部分后，在设备 DAX 上的情况如下所示:

```
+-----------+ ---virt_to_page---> +-----------+   映射到   +-----------+
|           |                     |     0     | -------------> |     0     |
|           |                     +-----------+                +-----------+
|           |                     |     1     | -------------> |     1     |
|           |                     +-----------+                +-----------+
|           |                     |     2     | ----------------^ ^ ^ ^ ^ ^
|           |                     +-----------+                   | | | | |
|           |                     |     3     | ------------------+ | | | |
|           |                     +-----------+                     | | | |
|           |                     |     4     | --------------------+ | | |
|    PUD    |                     +-----------+                       | | |
|   级别    |                     |     .     | ----------------------+ | |
|  映射     |                     +-----------+                         | |
|           |                     |     .     | ------------------------+ |
|           |                     +-----------+                           |
|           |                     |   4095    | --------------------------+
|           |                     +-----------+
|           |
|           |
|           |
+-----------+
```
