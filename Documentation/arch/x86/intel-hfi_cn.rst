### SPDX 许可证标识符: GPL-2.0

======================================
英特尔硬件的调度硬件反馈接口
======================================

概述
------

英特尔在其《64位和 IA-32 架构软件开发人员手册》（Intel SDM）第三卷第 14.6 节中描述了硬件反馈接口（HFI）[1]_。HFI 向操作系统提供系统中每个 CPU 的性能和能效能力数据。Linux 可以利用 HFI 提供的信息来影响任务调度决策。

硬件反馈接口
-------------------

硬件反馈接口向操作系统提供有关系统中每个 CPU 的性能和能效的信息。每种能力都以无单位量表示，范围为 [0-255]。数值越高，表示能力越强。能效和性能在不同的能力中分别报告。尽管在某些系统上这两个指标可能相关，但根据 Intel SDM 它们被指定为独立的能力。

这些能力可能会因系统运行条件的变化或外部因素的影响而在运行时发生变化。这些能力更新的速率取决于具体的处理器型号。在某些型号上，能力值在启动时设定后就不再改变。在其他型号上，能力值可能会每隔数十毫秒变化一次。例如，可以使用远程机制来降低热设计功耗（TDP）。这种变化可以在 HFI 中反映出来。同样，如果系统因为过热而需要降速，HFI 可能在特定 CPU 上反映出性能下降。

内核或用户空间策略守护进程可以使用这些能力来修改任务调度决策。例如，如果某个逻辑处理器的性能或能效能力变为零，则表明硬件建议操作系统出于性能或能效原因不要在此处理器上安排任何任务。

Linux 实现细节
-------------------

处理热事件中断的基础设施分为两部分。在 CPU 的本地 APIC 的本地向量表中，存在一个用于热监测寄存器的寄存器。这个寄存器控制当热监测产生中断时如何将中断传递给 CPU。更多详细信息可以在 Intel SDM 第三卷第 10.5 节找到[1]_。

热监测可以按 CPU 或按包生成中断。HFI 生成的是包级中断。该监控通过一组机器特定寄存器进行配置和初始化。具体来说，HFI 中断和状态通过 IA32_PACKAGE_THERM_INTERRUPT 和 IA32_PACKAGE_THERM_STATUS 寄存器中的指定位来控制。每个包存在一个 HFI 表。更多详细信息可以在 Intel SDM 第三卷第 14.9 节找到[1]_。

硬件在更新 HFI 表格并准备好供操作系统使用后会发出 HFI 中断。CPU 通过本地 APIC 的本地向量表中的热中断项接收此类中断。

在处理此类中断时，HFI 驱动程序解析更新后的表格，并使用热通知框架将更新传送给用户空间。鉴于每秒可能有多个 HFI 更新，传送给用户空间的更新被限制为 CONFIG_HZ 节拍的速率。

参考文献
----------

.. [1] https://www.intel.com/sdm
