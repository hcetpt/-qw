TSX 异步中止 (TAA) 缓解措施
=================================

.. _tsx_async_abort:

概述
--------

TSX 异步中止 (TAA) 是针对某些 Intel 处理器内部缓冲区的一种侧信道攻击，类似于微架构数据采样 (MDS)。在这种情况下，在交易同步扩展 (TSX) 事务中有异步中止条件待处理时，某些加载可能会推测性地将无效数据传递给依赖操作。这包括没有故障或辅助条件的加载。此类加载可能会推测性地暴露来自与 MDS 中相同的微架构数据结构中的陈旧数据，并且具有相同的暴露范围，即同线程和跨线程。此问题影响所有当前支持 TSX 的处理器。

缓解策略
-------------------

a) 禁用 TSX - 其中一项缓解措施是禁用 TSX。一个新的模型特定寄存器（MSR）IA32_TSX_CTRL 将在未来以及经过微码更新的当前处理器上可用，可以用来禁用 TSX。此外，它还控制在 CPUID 中枚举 TSX 功能位（RTM 和 HLE）。
b) 清除 CPU 缓冲区 - 类似于 MDS，清除 CPU 缓冲区可以缓解此漏洞。关于这种方法的更多详细信息可以在 :ref:`Documentation/admin-guide/hw-vuln/mds.rst <mds>` 中找到。

内核内部缓解模式
------------------------------

 =============    ============================================================
 off              缓解措施被禁用。要么 CPU 不受影响，要么通过内核命令行提供了 tsx_async_abort=off
tsx disabled     启用缓解措施。默认情况下，在支持 TSX 控制的处理器启动时禁用 TSX 功能
verw             启用缓解措施。CPU 受影响并且在 CPUID 中宣传了 MD_CLEAR
ucode needed     启用缓解措施。CPU 受影响并且在 CPUID 中未宣传 MD_CLEAR。这主要是为了虚拟化场景，其中主机有更新的微码但虚拟机监视器没有在 CPUID 中暴露 MD_CLEAR。这是一种尽力而为的方法，不保证效果
=============    ============================================================

如果 CPU 受影响且未提供 "tsx_async_abort" 内核命令行参数，则内核会根据 RTM 和 MD_CLEAR CPUID 位的状态选择适当的缓解措施。

下表指示了 tsx=on|off|auto 命令行选项对 TAA 缓解状态、VERW 行为及 TSX 特性的不同组合下的 IA32_ARCH_CAPABILITIES MSR 位的影响。
1. "tsx=off"

=========  =========  ============  ============  ==============  ===================  ======================
MSR_IA32_ARCH_CAPABILITIES 位     使用命令行参数 tsx=off 的结果
----------------------------------  -------------------------------------------------------------------------
TAA_NO     MDS_NO     TSX_CTRL_MSR  TSX 状态     VERW 是否可以在启动后清除  TAA 缓解措施       TAA 缓解措施
                                    启动后的 CPU 缓冲区     tsx_async_abort=off  tsx_async_abort=full
=========  =========  ============  ============  ==============  ===================  ======================
    0          0           0         硬件默认设置         是           与 MDS 相同           与 MDS 相同
    0          0           1        无效情况   无效情况       无效情况          无效情况
    0          1           0         硬件默认设置         否         需要微码更新     需要微码更新
    0          1           1          禁用           是           禁用了 TSX           禁用了 TSX
    1          X           1          禁用           X             不需要任何措施           不需要任何措施
=========  =========  ============  ============  ==============  ===================  ======================

2. "tsx=on"

=========  =========  ============  ============  ==============  ===================  ======================
MSR_IA32_ARCH_CAPABILITIES 位     使用命令行参数 tsx=on 的结果
----------------------------------  -------------------------------------------------------------------------
TAA_NO     MDS_NO     TSX_CTRL_MSR  TSX 状态     VERW 是否可以在启动后清除  TAA 缓解措施       TAA 缓解措施
                                    启动后的 CPU 缓冲区     tsx_async_abort=off  tsx_async_abort=full
=========  =========  ============  ============  ==============  ===================  ======================
    0          0           0         硬件默认设置        是            与 MDS 相同          与 MDS 相同
    0          0           1        无效情况   无效情况       无效情况         无效情况
    0          1           0         硬件默认设置        否          需要微码更新     需要微码更新
    0          1           1          启用           是               无需操作              与 MDS 相同
    1          X           1          启用           X              不需要任何措施          不需要任何措施
=========  =========  ============  ============  ==============  ===================  ======================

3. "tsx=auto"

=========  =========  ============  ============  ==============  ===================  ======================
MSR_IA32_ARCH_CAPABILITIES 位     使用命令行参数 tsx=auto 的结果
----------------------------------  -------------------------------------------------------------------------
TAA_NO     MDS_NO     TSX_CTRL_MSR  TSX 状态     VERW 是否可以在启动后清除  TAA 缓解措施       TAA 缓解措施
                                    启动后的 CPU 缓冲区     tsx_async_abort=off  tsx_async_abort=full
=========  =========  ============  ============  ==============  ===================  ======================
    0          0           0         硬件默认设置    是                与 MDS 相同           与 MDS 相同
    0          0           1        无效情况  无效情况        无效情况          无效情况
    0          1           0         硬件默认设置    否              需要微码更新     需要微码更新
    0          1           1          禁用           是               禁用了 TSX           禁用了 TSX
    1          X           1          启用           X                 不需要任何措施           不需要任何措施
=========  =========  ============  ============  ==============  ===================  ======================

在表格中，TSX_CTRL_MSR 是 MSR_IA32_ARCH_CAPABILITIES 中的一个新位，
用于指示是否支持 MSR_IA32_TSX_CTRL。
IA32_TSX_CTRL 寄存器中有两个控制位：

      位 0: 当被设置时，它禁用 TSX（事务同步扩展）的受限事务内存 (RTM) 子功能
             （将强制所有事务在 XBEGIN 指令上中止）
位 1: 当被设置时，它禁用 RTM 和 HLE 特性的枚举
             （即它会使 CPUID(EAX=7).EBX{位4} 和
             CPUID(EAX=7).EBX{位11} 读取为 0）
