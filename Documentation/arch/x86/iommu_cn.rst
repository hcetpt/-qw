x86 IOMMU 支持
=============

架构规范可从以下位置获取：
- 英特尔：http://www.intel.com/content/dam/www/public/us/en/documents/product-specifications/vt-directed-io-spec.pdf
- AMD：https://www.amd.com/content/dam/amd/en/documents/processor-tech-docs/specifications/48882_3_07_PUB.pdf

本指南提供了一些基本理解的快速参考表。
基础知识
---------

ACPI 枚举并列出平台上的不同 IOMMU，以及设备与控制它们的 IOMMU 之间的范围关系。
一些 ACPI 关键字：

- DMAR - 英特尔 DMA 重映射表
- DRHD - 英特尔 DMA 重映射硬件单元定义
- RMRR - 英特尔预留内存区域报告结构
- IVRS - AMD 输入/输出虚拟化报告结构
- IVDB - AMD 输入/输出虚拟化定义块
- IVHD - AMD 输入/输出虚拟化硬件定义

什么是英特尔 RMRR？
^^^^^^^^^^^^^^^^^^^

有些设备由 BIOS 控制，例如用于 PS2 模拟的 USB 设备。这些设备使用的内存区域在 e820 地图中标记为预留。当我们开启 DMA 翻译时，向这些区域的 DMA 将会失败。因此，BIOS 使用 RMRR 来指定这些区域及其需要访问这些区域的设备。操作系统应为此类区域设置统一映射，以便这些设备能够访问这些区域。

什么是 AMD IVRS？
^^^^^^^^^^^^^^^^^

架构定义了一个与 ACPI 兼容的数据结构，称为输入/输出虚拟化报告结构 (IVRS)，用于向系统软件传达与输入/输出虚拟化相关的信息。IVRS 描述了平台中包含的 IOMMU 的配置和功能，以及每个 IOMMU 虚拟化的设备信息。IVRS 提供了以下信息：

- 平台中存在的 IOMMU 及其功能和正确配置
- 与每个 IOMMU 相关的系统 I/O 拓扑
- 无法以其他方式枚举的外围设备
- 由 SMI/SMM、平台固件和平台硬件使用的内存区域。这些通常是系统软件需要配置的排除范围

I/O 虚拟地址（IOVA）是如何生成的？
---------------------------------------

表现良好的驱动程序在向需要执行 DMA 的设备发送命令之前调用 dma_map_*() 函数。DMA 完成且不再需要映射后，驱动程序调用 dma_unmap_*() 函数来取消映射该区域。

英特尔特定说明
-------------------

图形问题？
^^^^^^^^^^^^

如果您遇到图形设备的问题，可以尝试添加选项 intel_iommu=igfx_off 来关闭集成图形引擎。如果这样做解决了问题，请确保提交一个错误报告来描述问题。

IOVA 的一些例外
^^^^^^^^^^^^^^^^

中断范围不进行地址转换（0xfee00000 - 0xfeefffff）。
对于点对点交易也同样适用。因此我们从PCI MMIO范围内预留地址，以避免它们被分配为IOVA地址。

AMD 特定说明
-------------

遇到图形问题？
^^^^^^^^^^^^^^^^^^

如果你在使用集成图形设备时遇到问题，可以尝试在内核命令行中添加选项 `iommu=pt` 来使用1:1的IOMMU映射。如果这样做解决了问题，请务必提交一个错误报告来描述该问题。

故障报告
--------------

当出现错误时，IOMMU会通过中断信号进行报告。故障的原因及引起故障的设备信息会被打印到控制台。

内核日志样本
------------------

英特尔启动消息
^^^^^^^^^^^^^^^^^^^

类似这样的信息表明ACPI中有DMAR表存在：

::

    ACPI: DMAR (v001 A M I  OEMDMAR  0x00000001 MSFT 0x00000097) @ 0x000000007f5b5ef0

当ACPI处理并初始化DMAR时，会打印出DMAR的位置以及任何被处理的RMRR信息：

::

    ACPI DMAR:主机地址宽度 36
    ACPI DMAR:DRHD (标志: 0x00000000) 基址: 0x00000000fed90000
    ACPI DMAR:DRHD (标志: 0x00000000) 基址: 0x00000000fed91000
    ACPI DMAR:DRHD (标志: 0x00000001) 基址: 0x00000000fed93000
    ACPI DMAR:RMRR 基址: 0x00000000000ed000 结束: 0x00000000000effff
    ACPI DMAR:RMRR 基址: 0x000000007f600000 结束: 0x000000007fffffff

当DMAR被启用时，你会注意到：

::

    PCI-DMA: 使用 DMAR IOMMU

英特尔故障报告
^^^^^^^^^^^^^^^^^

::

    DMAR:[DMA 写入] 请求设备 [00:02.0] 故障地址 6df084000
    DMAR:[故障原因 05] PTE 写访问未设置
    DMAR:[DMA 写入] 请求设备 [00:02.0] 故障地址 6df084000
    DMAR:[故障原因 05] PTE 写访问未设置

AMD 启动消息
^^^^^^^^^^^^^^^^^

类似这样的信息表明存在IOMMU：

::

    iommu: 默认域类型: 翻译
    iommu: DMA 域 TLB 无效策略: 懒惰模式

AMD 故障报告
^^^^^^^^^^^^^^^^^

::

    AMD-Vi: 记录事件 [IO_PAGE_FAULT 域=0x0007 地址=0xffffc02000 标志=0x0000]
    AMD-Vi: 记录事件 [IO_PAGE_FAULT 设备=07:00.0 域=0x0007 地址=0xffffc02000 标志=0x0000]
