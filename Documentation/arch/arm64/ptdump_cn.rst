======================
内核页表转储
======================

`ptdump` 是一个调试文件系统（debugfs）接口，它提供了内核页表的详细转储。它提供了一个全面的内核虚拟内存布局概览以及与各个区域相关的属性，以人类可读的格式呈现。它对于转储内核页表以验证权限和内存类型非常有用。检查页表项及其权限有助于识别潜在的安全漏洞，例如具有过度宽松访问权限的映射或不适当的内存保护。

动态内存热插拔允许在不需要系统重启的情况下动态扩展或收缩可用内存。为了保持内存管理数据结构的一致性和完整性，arm64 使用 `mem_hotplug_lock` 半导体以写模式。此外，在读模式下，`mem_hotplug_lock` 支持 `get_online_mems()` 和 `put_online_mems()` 的高效实现。这些保护了被 ptdump 代码访问的内存的离线操作。

为了转储内核页表，请启用以下配置并挂载 debugfs：

```
CONFIG_GENERIC_PTDUMP=y
CONFIG_PTDUMP_CORE=y
CONFIG_PTDUMP_DEBUGFS=y
```

```
mount -t debugfs nodev /sys/kernel/debug
cat /sys/kernel/debug/kernel_page_tables
```

分析 `cat /sys/kernel/debug/kernel_page_tables` 的输出，可以推断出每个条目的虚拟地址范围、该条目覆盖的内存区域大小、页表的层次结构以及与每一页关联的属性。页属性提供了关于访问权限、执行能力、映射类型（如叶级 PTE 或块级 PGD、PMD 和 PUD）以及内核内存中页面的访问状态的信息。评估这些属性有助于理解内存布局、访问模式以及内核页的安全特性。
内核虚拟内存布局示例：

```
起始地址                结束地址              大小                    属性
+---------------------------------------------------------------------------------------+
| ---[ 线性映射开始 ]---------------------------------------------------------- |
| ..................                                                                    |
| 0xfff0000000000000-0xfff0000000210000  2112K PTE RW NX SHD AF  UXN  MEM/NORMAL-TAGGED |
| 0xfff0000000210000-0xfff0000001c00000 26560K PTE ro NX SHD AF  UXN  MEM/NORMAL        |
| ..................                                                                    |
| ---[ 线性映射结束 ]------------------------------------------------------------ |
+---------------------------------------------------------------------------------------+
| ---[ 模块开始 ]----------------------------------------------------------------- |
| ..................                                                                    |
| 0xffff800000000000-0xffff800008000000   128M PTE                                      |
| ..................                                                                    |
| ---[ 模块结束 ]------------------------------------------------------------------- |
+---------------------------------------------------------------------------------------+
| ---[ vmalloc() 区域 ]---------------------------------------------------------------- |
| ..................                                                                    |
| 0xffff800008010000-0xffff800008200000  1984K PTE ro x  SHD AF       UXN  MEM/NORMAL   |
| 0xffff800008200000-0xffff800008e00000    12M PTE ro x  SHD AF  CON  UXN  MEM/NORMAL   |
| ..................                                                                    |
| ---[ vmalloc() 结束 ]----------------------------------------------------------------- |
+---------------------------------------------------------------------------------------+
| ---[ 固定映射开始 ]------------------------------------------------------------------ |
| ..................                                                                    |
| 0xfffffbfffdb80000-0xfffffbfffdb90000    64K PTE ro x  SHD AF  UXN  MEM/NORMAL        |
| 0xfffffbfffdb90000-0xfffffbfffdba0000    64K PTE ro NX SHD AF  UXN  MEM/NORMAL        |
| ..................                                                                    |
| ---[ 固定映射结束 ]-------------------------------------------------------------------- |
+---------------------------------------------------------------------------------------+
| ---[ PCI I/O 开始 ]----------------------------------------------------------------- |
| ..................                                                                    |
| 0xfffffbfffe800000-0xfffffbffff800000    16M PTE                                      |
| ..................                                                                    |
| ---[ PCI I/O 结束 ]------------------------------------------------------------------- |
+---------------------------------------------------------------------------------------+
| ---[ vmemmap 开始 ]----------------------------------------------------------------- |
| ..................                                                                    |
| 0xfffffc0002000000-0xfffffc0002200000     2M PTE RW NX SHD AF  UXN  MEM/NORMAL        |
| 0xfffffc0002200000-0xfffffc0020000000   478M PTE                                      |
| ..................                                                                    |
| ---[ vmemmap 结束 ]------------------------------------------------------------------- |
+---------------------------------------------------------------------------------------+
```

`cat /sys/kernel/debug/kernel_page_tables` 输出示例：

```
0xfff0000001c00000-0xfff0000080000000     2020M PTE  RW NX SHD AF   UXN    MEM/NORMAL-TAGGED
0xfff0000080000000-0xfff0000800000000       30G PMD
0xfff0000800000000-0xfff0000800700000        7M PTE  RW NX SHD AF   UXN    MEM/NORMAL-TAGGED
0xfff0000800700000-0xfff0000800710000       64K PTE  ro NX SHD AF   UXN    MEM/NORMAL-TAGGED
0xfff0000800710000-0xfff0000880000000  2089920K PTE  RW NX SHD AF   UXN    MEM/NORMAL-TAGGED
0xfff0000880000000-0xfff0040000000000     4062G PMD
0xfff0040000000000-0xffff800000000000     3964T PGD
```
