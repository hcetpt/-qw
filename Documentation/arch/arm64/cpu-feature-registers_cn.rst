===========================
ARM64 CPU特性寄存器
===========================

作者: Suzuki K Poulose <suzuki.poulose@arm.com>

本文件描述了将AArch64 CPU ID/特性寄存器导出到用户空间的ABI。该ABI的可用性通过HWCAP中的HWCAP_CPUID进行宣传。
1. 动机
-------------

ARM架构定义了一组特性寄存器，这些寄存器描述了CPU/系统的功能。访问这些系统寄存器在EL0级别受到限制，并且没有可靠的方法让应用程序提取这些信息以便在运行时做出更好的决策。虽然可以通过HWCAPs获得一些有限的信息，但它们的使用存在一些问题：
a) 对HWCAPs的任何更改都需要更新用户空间（例如libc）来检测新的更改，这可能需要很长时间才能出现在发行版中。暴露这些寄存器允许应用程序获取信息而无需工具链的更新。
b) 在某些情况下，对HWCAPs的访问是有限制的（例如，在libc之前或在启动时ld初始化的情况下）。
c) HWCAPs无法有效地表示非布尔类型的信息。架构定义了一个标准格式来在ID寄存器中表示特性；这是明确定义的，并且能够表示所有有效的架构变体。
2. 需求
---------------

 a) 安全性：

    应用程序应能利用基础设施提供的信息安全地在整个系统上运行。这对具有异构CPU的系统具有更大的影响。
    基础设施导出一个值，该值在系统上所有可用的CPU上都是安全的。
    例如，如果至少有一个CPU不实现CRC32指令，而其他CPU支持，我们应该报告CRC32没有实现；
    否则，当应用程序被调度到不支持CRC32的CPU上时可能会崩溃。
b) 安全性：

    应用程序只能接收与用户空间正常操作相关的信息。因此，某些字段被屏蔽（即，使其不可见），并且其值被设置为表明该特性“不受支持”。请参阅第4节以获取可见特性的列表。此外，内核可能会根据它所支持的功能来操纵这些字段。例如，如果内核不支持FP，则即使CPU提供FP功能，其值也可能指示FP不可用。
c) 实现定义的特性

基础架构并未公开任何根据ARMv8-A架构被定义为实现相关的寄存器。
d) CPU识别：

MIDR_EL1被公开以帮助识别处理器。在一个异构系统中，这可能会产生竞态条件（就像getcpu()一样）。如果进程在使用该寄存器值时被迁移到另一个CPU上，除非设置了CPU亲和性，否则无法保证该值反映了当前正在执行的处理器。由于这个限制，没有公开REVIDR，因为REVIDR只有与MIDR一起才有意义。作为替代方案，MIDR_EL1和REVIDR_EL1通过sysfs接口公开如下所示：

	/sys/devices/system/cpu/cpu$ID/regs/identification/
	                                              \- midr
	                                              \- revidr

3. 实现
--------------------

基础架构是基于对'MRS'指令的模拟建立的。
从应用程序访问受限的系统寄存器会产生异常，并导致向进程发送SIGILL信号。
基础架构挂接到异常处理程序并模拟操作，前提是源属于支持的系统寄存器空间。
基础架构仅模拟以下系统寄存器空间：

	Op0=3, Op1=0, CRn=0, CRm=0,2,3,4,5,6,7

（参见ARMv8 ARM DDI 0487A.h中的表C5-6“非调试系统寄存器访问的系统指令编码”获取寄存器列表）
对于基础架构返回的值应用了以下规则：

a) “实现定义”的字段值设置为0
b) 预留字段的值填充为架构所定义的预留值
c) “可见”字段的值保持特定特性的系统范围安全值（除了MIDR_EL1，参见第4节）
d) 所有其他字段（即，不可见字段）设置为表示该特性缺失（如架构所定义）

4. 具有可见特性的寄存器列表
-------------------------------------------

  1) ID_AA64ISAR0_EL1 - 指令集属性寄存器0

     +------------------------------+---------+---------+
     | 名称                         | 位数   | 可见性 |
     +------------------------------+---------+---------+
     | RNDR                         | [63-60] |    y    |
     +------------------------------+---------+---------+
     | TS                           | [55-52] |    y    |
     +------------------------------+---------+---------+
     | FHM                          | [51-48] |    y    |
     +------------------------------+---------+---------+
     | DP                           | [47-44] |    y    |
     +------------------------------+---------+---------+
     | SM4                          | [43-40] |    y    |
     +------------------------------+---------+---------+
     | SM3                          | [39-36] |    y    |
     +------------------------------+---------+---------+
     | SHA3                         | [35-32] |    y    |
     +------------------------------+---------+---------+
     | RDM                          | [31-28] |    y    |
     +------------------------------+---------+---------+
     | ATOMICS                      | [23-20] |    y    |
     +------------------------------+---------+---------+
     | CRC32                        | [19-16] |    y    |
     +------------------------------+---------+---------+
     | SHA2                         | [15-12] |    y    |
     +------------------------------+---------+---------+
     | SHA1                         | [11-8]  |    y    |
     +------------------------------+---------+---------+
     | AES                          | [7-4]   |    y    |
     +------------------------------+---------+---------+


  2) ID_AA64PFR0_EL1 - 处理器特性寄存器0

     +------------------------------+---------+---------+
     | 名称                         | 位数   | 可见性 |
     +------------------------------+---------+---------+
     | DIT                          | [51-48] |    y    |
     +------------------------------+---------+---------+
     | SVE                          | [35-32] |    y    |
     +------------------------------+---------+---------+
     | GIC                          | [27-24] |    n    |
     +------------------------------+---------+---------+
     | AdvSIMD                      | [23-20] |    y    |
     +------------------------------+---------+---------+
     | FP                           | [19-16] |    y    |
     +------------------------------+---------+---------+
     | EL3                          | [15-12] |    n    |
     +------------------------------+---------+---------+
     | EL2                          | [11-8]  |    n    |
     +------------------------------+---------+---------+
     | EL1                          | [7-4]   |    n    |
     +------------------------------+---------+---------+
     | EL0                          | [3-0]   |    n    |
     +------------------------------+---------+---------+


  3) ID_AA64PFR1_EL1 - 处理器特性寄存器1

     +------------------------------+---------+---------+
     | 名称                         | 位数   | 可见性 |
     +------------------------------+---------+---------+
     | SME                          | [27-24] |    y    |
     +------------------------------+---------+---------+
     | MTE                          | [11-8]  |    y    |
     +------------------------------+---------+---------+
     | SSBS                         | [7-4]   |    y    |
     +------------------------------+---------+---------+
     | BT                           | [3-0]   |    y    |
     +------------------------------+---------+---------+


  4) MIDR_EL1 - 主ID寄存器

     +------------------------------+---------+---------+
     | 名称                         | 位数   | 可见性 |
     +------------------------------+---------+---------+
     | 制造商                       | [31-24] |    y    |
     +------------------------------+---------+---------+
     | 变体                         | [23-20] |    y    |
     +------------------------------+---------+---------+
     | 架构                         | [19-16] |    y    |
     +------------------------------+---------+---------+
     | 零件编号                     | [15-4]  |    y    |
     +------------------------------+---------+---------+
     | 修订版本                     | [3-0]   |    y    |
     +------------------------------+---------+---------+

注：MIDR_EL1的“可见”字段将包含在取值的CPU上的值，并不是系统范围的安全值。
5) ID_AA64ISAR1_EL1 - 指令集属性寄存器1

     +------------------------------+---------+---------+
     | 名称                         |  位数   | 可见性 |
     +------------------------------+---------+---------+
     | I8MM                         | [55-52] |    y    |
     +------------------------------+---------+---------+
     | DGH                          | [51-48] |    y    |
     +------------------------------+---------+---------+
     | BF16                         | [47-44] |    y    |
     +------------------------------+---------+---------+
     | SB                           | [39-36] |    y    |
     +------------------------------+---------+---------+
     | FRINTTS                      | [35-32] |    y    |
     +------------------------------+---------+---------+
     | GPI                          | [31-28] |    y    |
     +------------------------------+---------+---------+
     | GPA                          | [27-24] |    y    |
     +------------------------------+---------+---------+
     | LRCPC                        | [23-20] |    y    |
     +------------------------------+---------+---------+
     | FCMA                         | [19-16] |    y    |
     +------------------------------+---------+---------+
     | JSCVT                        | [15-12] |    y    |
     +------------------------------+---------+---------+
     | API                          | [11-8]  |    y    |
     +------------------------------+---------+---------+
     | APA                          | [7-4]   |    y    |
     +------------------------------+---------+---------+
     | DPB                          | [3-0]   |    y    |
     +------------------------------+---------+---------+

  6) ID_AA64MMFR0_EL1 - 内存模型特性寄存器0

     +------------------------------+---------+---------+
     | 名称                         |  位数   | 可见性 |
     +------------------------------+---------+---------+
     | ECV                          | [63-60] |    y    |
     +------------------------------+---------+---------+

  7) ID_AA64MMFR2_EL1 - 内存模型特性寄存器2

     +------------------------------+---------+---------+
     | 名称                         |  位数   | 可见性 |
     +------------------------------+---------+---------+
     | AT                           | [35-32] |    y    |
     +------------------------------+---------+---------+

  8) ID_AA64ZFR0_EL1 - SVE特性ID寄存器0

     +------------------------------+---------+---------+
     | 名称                         |  位数   | 可见性 |
     +------------------------------+---------+---------+
     | F64MM                        | [59-56] |    y    |
     +------------------------------+---------+---------+
     | F32MM                        | [55-52] |    y    |
     +------------------------------+---------+---------+
     | I8MM                         | [47-44] |    y    |
     +------------------------------+---------+---------+
     | SM4                          | [43-40] |    y    |
     +------------------------------+---------+---------+
     | SHA3                         | [35-32] |    y    |
     +------------------------------+---------+---------+
     | B16B16                       | [27-24] |    y    |
     +------------------------------+---------+---------+
     | BF16                         | [23-20] |    y    |
     +------------------------------+---------+---------+
     | BitPerm                      | [19-16] |    y    |
     +------------------------------+---------+---------+
     | AES                          | [7-4]   |    y    |
     +------------------------------+---------+---------+
     | SVEVer                       | [3-0]   |    y    |
     +------------------------------+---------+---------+

  9) ID_AA64MMFR1_EL1 - 内存模型特性寄存器1

     +------------------------------+---------+---------+
     | 名称                         |  位数   | 可见性 |
     +------------------------------+---------+---------+
     | AFP                          | [47-44] |    y    |
     +------------------------------+---------+---------+

  10) ID_AA64ISAR2_EL1 - 指令集属性寄存器2

     +------------------------------+---------+---------+
     | 名称                         |  位数   | 可见性 |
     +------------------------------+---------+---------+
     | CSSC                         | [55-52] |    y    |
     +------------------------------+---------+---------+
     | RPRFM                        | [51-48] |    y    |
     +------------------------------+---------+---------+
     | BC                           | [23-20] |    y    |
     +------------------------------+---------+---------+
     | MOPS                         | [19-16] |    y    |
     +------------------------------+---------+---------+
     | APA3                         | [15-12] |    y    |
     +------------------------------+---------+---------+
     | GPA3                         | [11-8]  |    y    |
     +------------------------------+---------+---------+
     | RPRES                        | [7-4]   |    y    |
     +------------------------------+---------+---------+
     | WFXT                         | [3-0]   |    y    |
     +------------------------------+---------+---------+

  11) MVFR0_EL1 - AArch32媒体和VFP特性寄存器0

     +------------------------------+---------+---------+
     | 名称                         |  位数   | 可见性 |
     +------------------------------+---------+---------+
     | FPDP                         | [11-8]  |    y    |
     +------------------------------+---------+---------+

  12) MVFR1_EL1 - AArch32媒体和VFP特性寄存器1

     +------------------------------+---------+---------+
     | 名称                         |  位数   | 可见性 |
     +------------------------------+---------+---------+
     | SIMDFMAC                     | [31-28] |    y    |
     +------------------------------+---------+---------+
     | SIMDSP                       | [19-16] |    y    |
     +------------------------------+---------+---------+
     | SIMDInt                      | [15-12] |    y    |
     +------------------------------+---------+---------+
     | SIMDLS                       | [11-8]  |    y    |
     +------------------------------+---------+---------+

  13) ID_ISAR5_EL1 - AArch32指令集属性寄存器5

     +------------------------------+---------+---------+
     | 名称                         |  位数   | 可见性 |
     +------------------------------+---------+---------+
     | CRC32                        | [19-16] |    y    |
     +------------------------------+---------+---------+
     | SHA2                         | [15-12] |    y    |
     +------------------------------+---------+---------+
     | SHA1                         | [11-8]  |    y    |
     +------------------------------+---------+---------+
     | AES                          | [7-4]   |    y    |
     +------------------------------+---------+---------+


附录 I: 示例
-------------------

::

  /*
   * 示例程序展示MRS模拟ABI
*
   * 版权所有(C) 2015-2016, ARM Ltd
   *
   * 作者: Suzuki K Poulose <suzuki.poulose@arm.com>
   *
   * 本程序遵循GNU通用公共许可证版本2，由自由软件基金会发布。
*
   * 本程序以“原样”提供，不附带任何形式的保证；无论是明示还是暗示的保证，
   * 包括但不限于对适销性和适合特定目的的保证。请参阅GNU通用公共许可证获取更多详情。
*/

  #include <asm/hwcap.h>
  #include <stdio.h>
  #include <sys/auxv.h>

  #define get_cpu_ftr(id) ({					\
		unsigned long __val;				\
		asm("mrs %0, "#id : "=r" (__val));		\
		printf("%-20s: 0x%016lx\n", #id, __val);	\
	})

  int main(void)
  {

	if (!(getauxval(AT_HWCAP) & HWCAP_CPUID)) {
		fputs("无法访问CPUID寄存器\n", stderr);
		return 1;
	}

	get_cpu_ftr(ID_AA64ISAR0_EL1);
	get_cpu_ftr(ID_AA64ISAR1_EL1);
	get_cpu_ftr(ID_AA64MMFR0_EL1);
	get_cpu_ftr(ID_AA64MMFR1_EL1);
	get_cpu_ftr(ID_AA64PFR0_EL1);
	get_cpu_ftr(ID_AA64PFR1_EL1);
	get_cpu_ftr(ID_AA64DFR0_EL1);
	get_cpu_ftr(ID_AA64DFR1_EL1);

	get_cpu_ftr(MIDR_EL1);
	get_cpu_ftr(MPIDR_EL1);
	get_cpu_ftr(REVIDR_EL1);

  #if 0
	/* 访问未公开的寄存器会导致SIGILL */
	get_cpu_ftr(ID_MMFR0_EL1);
  #endif

	return 0;
  }
