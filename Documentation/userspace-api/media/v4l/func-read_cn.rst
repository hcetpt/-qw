SPDX 许可声明标识符: GFDL-1.1-no-invariants-or-later
.. c:namespace:: V4L

.. _func-read:

***********
V4L2 read()
***********

名称
====

v4l2-read - 从 V4L2 设备读取数据

概要
========

.. code-block:: c

    #include <unistd.h>

.. c:function:: ssize_t read(int fd, void *buf, size_t count)

参数
=========

``fd``
    由 :c:func:`open()` 返回的文件描述符
``buf``
    要填充的缓冲区
``count``
    最大读取字节数

描述
===========

:c:func:`read()` 尝试从文件描述符 ``fd`` 中读取最多 ``count`` 字节的数据到以 ``buf`` 开始的缓冲区。缓冲区中的数据布局在相应的设备接口部分讨论，详见 ##。如果 ``count`` 为零，:c:func:`read()` 返回零且无其他结果。如果 ``count`` 大于 ``SSIZE_MAX``，结果是不确定的。无论 ``count`` 的值如何，每个 :c:func:`read()` 调用都将提供最多一个帧（两个场）的数据。默认情况下，:c:func:`read()` 在数据可用之前会阻塞。当将 ``O_NONBLOCK`` 标志传递给 :c:func:`open()` 函数时，在没有数据可用的情况下立即返回 ``EAGAIN`` 错误代码。可以使用 :c:func:`select()` 或 :c:func:`poll()` 函数来暂停执行直到数据可用。所有支持 :c:func:`read()` 函数的驱动程序也必须支持 :c:func:`select()` 和 :c:func:`poll()`。

驱动程序可以使用单个或多个缓冲区，并在内部缓冲区填满后丢弃最旧或最新的帧来实现读取功能。
:c:func:`read()` 永远不会返回正在被填充的缓冲区的“快照”。使用单个缓冲区时，当应用程序开始读取缓冲区时，驱动程序将停止捕获，直到读取完成。因此，只有垂直消隐间隔的时间可用于读取，或者捕获速率必须低于视频标准的标称帧率。:c:func:`read()` 在活动图像期间或上下场之间垂直消隐期间调用的行为取决于丢弃策略。丢弃最旧帧的驱动程序继续在内部缓冲区中捕获，不断覆盖之前未读取的帧，并在 :c:func:`read()` 调用时返回正在接收的帧，一旦该帧完成。丢弃最新帧的驱动程序会停止捕获直到下一个 :c:func:`read()` 调用。在 :c:func:`read()` 时接收到的帧将被丢弃，返回的是接下来的帧。这同样意味着捕获速率降低到标称帧率的一半或更少。bttv 驱动程序的视频读取模式是此模型的一个示例，在 :c:func:`read()` 被调用时启动 DMA 到用户内存并在 DMA 完成时返回。

在多缓冲区模型中，驱动程序维护一个内部缓冲区环，自动推进到下一个空闲缓冲区。这允许应用程序能够足够快地清空缓冲区时进行连续捕获。再次，当驱动程序没有空闲缓冲区时的行为取决于丢弃策略。

应用程序可以通过 :ref:`VIDIOC_G_PARM <VIDIOC_G_PARM>` 和 :ref:`VIDIOC_S_PARM <VIDIOC_G_PARM>` ioctl 获取和设置驱动程序内部使用的缓冲区数量。然而，它们是可选的。丢弃策略不报告也不能更改。
对于最低要求，请参见 :ref:`devices`

返回值
======

在成功的情况下，返回读取的字节数。如果这个数小于请求的字节数或一帧所需的数据量，并不算是错误。例如，这可能是因为 :c:func:`read()` 被信号中断了。在出错的情况下，返回 -1，并且 ``errno`` 变量会被相应地设置。在这种情况下，下一次读取将从新帧的开始处进行。可能的错误代码包括：

EAGAIN
    使用了 O_NONBLOCK 进行非阻塞 I/O 操作，并且没有立即可读的数据
EBADF
    ``fd`` 不是一个有效的文件描述符或未打开用于读取，或者进程已经打开了最大数量的文件
EBUSY
    驱动程序不支持多个读取流并且设备已经在使用中
EFAULT
    ``buf`` 引用了一个无法访问的内存区域
EINTR
    在任何数据被读取之前调用被信号中断
EIO
    I/O 错误。这表明存在某些硬件问题或与远程设备（如 USB 摄像头等）通信失败
EINVAL
    此驱动程序不支持 :c:func:`read()` 函数，或者此设备不支持该函数，或者此类设备通常不支持该函数
