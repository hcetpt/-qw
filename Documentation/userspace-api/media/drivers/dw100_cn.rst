SPDX 许可证标识符: GPL-2.0

DW100 非线性校正驱动程序
======================

在 i.MX8MP SoC 上发现的 Vivante DW100 非线性校正处理器 IP 核心，对输入图像应用了一个可编程的几何变换，以纠正由镜头引入的畸变。
变换函数通过硬件暴露为一个网格图，使用 16x16 像素宏块，并用 X、Y 顶点坐标索引：
::

                          图像宽度
           <--------------------------------------->

      ^    .-------.-------.-------.-------.-------
|    | 16x16 |       |       |       |       |
   I  |    | 像素 |       |       |       |       |
   m  |    | 宏块 |       |       |       |       |
   a  |    .-------.-------.-------.-------.-------
g  |    |       |       |       |       |       |
   e  |    |       |       |       |       |       |
      |    |       |       |       |       |       |
   h  |    .-------.-------.-------.-------.-------
e  |    |       |       |       |       |       |
   i  |    |       |       |       |       |       |
   g  |    |       |       |       |       |       |
   h  |    .-------.-------.-------.-------.-------
t  |    |       |       |       |       |       |
      |    |       |       |       |       |       |
      |    |       |       |       |       |       |
      v    '-------'-------'-------'-------'-------'

            用于非线性校正映射的图像块网格

每个 x, y 坐标寄存器使用 16 位来记录坐标地址，采用无符号 12.4 固定点格式（UQ12.4）：
::

    .----------------------.--------..----------------------.--------
|         31~20        | 19~16  ||         15~4         |  3~0   |
    |       (整数部分)     | (小数部分) ||       (整数部分)     | (小数部分) |
    '----------------------'--------''----------------------'--------'
    <-------------------------------><------------------------------->
                Y 坐标                     X 坐标

                           映射寄存器布局

非线性校正映射由应用程序通过 V4L2_CID_DW100_DEWARPING_16x16_VERTEX_MAP 控制设置。该控制包含一个 u32 类型的值数组，存储网格每个顶点的目标坐标。X 坐标存储在低 16 位中，Y 坐标存储在高 16 位中。
数组元素的数量必须与图像大小匹配：

.. code-block:: C

    elems = (DIV_ROUND_UP(width, 16) + 1) * (DIV_ROUND_UP(height, 16) + 1);

如果应用程序未设置该控制，则驱动程序使用身份映射。
关于DW100硬件操作的更多细节可以在《IMX8MP参考手册》的 *13.15 节 “DeWarp”* 中找到。

Vivante DW100 m2m 驱动实现了以下特定于驱动程序的控制：

``V4L2_CID_DW100_DEWARPING_16x16_VERTEX_MAP (__u32 array)``
    指定给DW100驱动程序其去畸变映射（即查找表）blob，如《IMX8MP参考手册》的 *13.15.2.3 节 “Dewarping Remap”* 中所描述的那样，作为一个U32动态数组。图像被划分为许多小的16x16块。如果图像的宽度或高度不能被16整除，则最右侧或底部的块大小为剩余部分。去畸变映射仅保存每个块的顶点坐标。去畸变网格映射由x和y的顶点坐标组成。每个x、y坐标寄存器使用16位（UQ12.4）来记录坐标地址，其中Y坐标位于高位，X坐标位于低位。当接收格式改变时，驱动程序会修改此控制的尺寸，以反映新的输入分辨率。
.. _IMX8MP: https://www.nxp.com/webapp/Download?colCode=IMX8MPRM
