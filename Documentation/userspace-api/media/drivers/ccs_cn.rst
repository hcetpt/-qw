SPDX 许可证标识符: 仅限 GPL-2.0

.. include:: <isonum.txt>

.. _媒体-ccs-uapi:

MIPI CCS 摄像头传感器驱动程序
================================

MIPI CCS 摄像头传感器驱动程序是一个通用的驱动程序，适用于符合 `MIPI CCS <https://www.mipi.org/specifications/camera-command-set>`_ 规范的摄像头传感器。它暴露了三个子设备，分别代表像素阵列、合并器和缩放器。由于各个设备的功能有所不同，因此驱动程序根据硬件中存在的功能来暴露接口。详情请参阅 :ref:`CCS 驱动程序内核文档 <媒体-ccs-driver>`。

像素阵列子设备
----------------------

像素阵列子设备表示摄像头传感器的像素矩阵以及许多符合规范的设备中所具有的模拟裁剪功能。模拟裁剪通过在实体的源端口（0）上使用 ``V4L2_SEL_TGT_CROP`` 进行配置。可以通过获取 ``V4L2_SEL_TGT_NATIVE_SIZE`` 目标来获得像素矩阵的大小。

合并器
--------------

合并器子设备表示传感器上的合并功能。为此，在接收端口（0）上支持选择目标 ``V4L2_SEL_TGT_COMPOSE``。此外，如果设备没有缩放或数字裁剪功能，则源端口（1）会暴露另一个数字裁剪选择矩形，该矩形只能在线末尾和帧末尾进行裁剪。

缩放器
--------------

缩放器子设备表示传感器的数字裁剪和缩放功能。当支持数字裁剪时，使用 V4L2 选择目标 ``V4L2_SEL_TGT_CROP`` 在接收端口（0）上配置数字裁剪。缩放则通过在接收端口（0）上使用选择目标 ``V4L2_SEL_TGT_COMPOSE`` 来配置。此外，如果存在缩放器子设备，则其源端口（1）会暴露另一个数字裁剪选择矩形，该矩形只能在线末尾和帧末尾进行裁剪。

数字裁剪和模拟裁剪
--------------------------

数字裁剪功能指的是通过丢弃一些数据来实现裁剪。而模拟裁剪意味着从不检索被裁剪的信息。对于摄像头传感器来说，这意味着永远不会从位于配置的选择矩形之外的像素矩阵读取模拟数据。这种差异会影响设备的时序，并且可能也会影响功耗。
私有控制
----------------

MIPI CCS 驱动程序在 ``V4L2_CID_USER_BASE_CCS`` 下实现了一系列私有控制，用于控制符合 MIPI CCS 标准的摄像头传感器。

模拟增益模型
~~~~~~~~~~~~~~~~~~~

CCS 定义了一个模拟增益模型，其中增益可以通过以下公式计算：

    gain = m0 * x + c0 / (m1 * x + c1)

m0 或 c0 中至少有一个为零。特定于设备的常数可以从以下控制中获取：

    V4L2_CID_CCS_ANALOGUE_GAIN_M0
    V4L2_CID_CCS_ANALOGUE_GAIN_M1
    V4L2_CID_CCS_ANALOGUE_GAIN_C0
    V4L2_CID_CCS_ANALOGUE_GAIN_C1

在这种情况下，模拟增益（公式中的 `x`）通过 ``V4L2_CID_ANALOGUE_GAIN`` 进行控制。

替代模拟增益模型
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

CCS 定义了另一个称为替代模拟增益的模型。在这种情况下，计算实际增益的公式包含线性和指数部分：

    gain = linear * 2 ^ exponent

可以分别使用 ``V4L2_CID_CCS_ANALOGUE_LINEAR_GAIN`` 和 ``V4L2_CID_CCS_ANALOGUE_EXPONENTIAL_GAIN`` 控制来设置 `linear` 和 `exponent` 因子。

阴影校正
~~~~~~~~~~~~~~~~~~

CCS 标准支持镜头阴影校正。该功能可以通过 ``V4L2_CID_CCS_SHADING_CORRECTION`` 进行控制。此外，还可以使用 ``V4L2_CID_CCS_LUMINANCE_CORRECTION_LEVEL`` 更改亮度校正级别，其中值 0 表示不进行校正，而值 128 表示将角落的亮度校正为比中心低 10%。

亮度校正级别需要在启用阴影校正的情况下才能生效。

**版权** |copy| 2020 英特尔公司
