SPDX 许可声明标识符: GPL-2.0

I/O 请求处理
=============

用户虚拟机（User VM）的 I/O 请求由 hypervisor 构建，并由 ACRN Hypervisor 服务模块根据 I/O 请求的地址范围分发给相应的 I/O 客户端。I/O 请求处理的详细信息如下：

1. I/O 请求
--------------

对于每个用户虚拟机，有一个 4 KB 的共享内存区域用于 hypervisor 和服务虚拟机（Service VM）之间的 I/O 请求通信。一个 I/O 请求是一个 256 字节的结构缓冲区，即 `struct acrn_io_request`，当用户虚拟机中的 I/O 访问被截获时，由 hypervisor 的 I/O 处理器填充。ACRN 用户空间首先在服务虚拟机中分配一个 4 KB 的页面，并将该缓冲区的 GPA（客户物理地址）传递给 hypervisor。此缓冲区用作包含 16 个 I/O 请求槽的数组，每个请求槽为 256 字节。此数组通过 vCPU ID 进行索引。

2. I/O 客户端
--------------

I/O 客户端负责处理那些访问的 GPA 落在特定范围内的用户虚拟机 I/O 请求。每个用户虚拟机可以关联多个 I/O 客户端。每个用户虚拟机都关联了一个特殊的客户端，称为默认客户端，它处理所有不符合其他客户端范围的 I/O 请求。ACRN 用户空间充当每个用户虚拟机的默认客户端。

下面的图示展示了 I/O 请求共享缓冲区、I/O 请求和 I/O 客户端之间的关系：
```
+------------------------------------------------------+
|                                       Service VM     |
|+--------------------------------------------------+  |
||      +----------------------------------------+  |  |
||      | shared page            ACRN userspace  |  |  |
||      |    +-----------------+  +------------+ |  |  |
||   +----+->| acrn_io_request |<-+  default   | |  |  |
||   |  | |  +-----------------+  | I/O client | |  |  |
||   |  | |  |       ...       |  +------------+ |  |  |
||   |  | |  +-----------------+                 |  |  |
||   |  +-|--------------------------------------+  |  |
||---|----|-----------------------------------------|  |
||   |    |                             kernel      |  |
||   |    |            +----------------------+     |  |
||   |    |            | +-------------+  HSM |     |  |
||   |    +--------------+             |      |     |  |
||   |                 | | I/O clients |      |     |  |
||   |                 | |             |      |     |  |
||   |                 | +-------------+      |     |  |
||   |                 +----------------------+     |  |
|+---|----------------------------------------------+  |
+----|-------------------------------------------------+
      |
+----|-------------------------------------------------+
|  +-+-----------+                                     |
|  | I/O handler |              ACRN Hypervisor        |
|  +-------------+                                     |
+------------------------------------------------------+
```

3. I/O 请求状态转换
------------------------

ACRN I/O 请求的状态转换如下：
```
FREE -> PENDING -> PROCESSING -> COMPLETE -> FREE -> ..
```
- FREE：此 I/O 请求槽为空
- PENDING：此槽中有待处理的有效 I/O 请求
- PROCESSING：I/O 请求正在被处理
- COMPLETE：I/O 请求已被处理

处于 COMPLETE 或 FREE 状态的 I/O 请求归 hypervisor 所有。HSM 和 ACRN 用户空间负责处理其他状态的请求。

4. I/O 请求处理流程
------------------------

a. 当用户虚拟机中的 I/O 访问被截获时，hypervisor 的 I/O 处理器会用 PENDING 状态填充一个 I/O 请求。
b. hypervisor 发出一个上层调用（upcall），即通知中断，到服务虚拟机。
c. 上层调用处理器调度一个工作线程来分发 I/O 请求。
d. 工作进程查找待处理的 I/O 请求，根据 I/O 访问的地址将它们分配给不同的注册客户端，更新这些请求的状态为处理中，并通知相应的客户端进行处理。
e. 被通知的客户端处理分配的 I/O 请求。
f. HSM 将 I/O 请求的状态更新为完成，并通过超调用通知虚拟机监控程序完成情况。
