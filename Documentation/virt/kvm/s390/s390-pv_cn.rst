SPDX 许可证标识符: GPL-2.0

=========================================
s390（IBM Z）超监视器和受保护的虚拟机
=========================================

摘要
-------
受保护的虚拟机（PVM）是不允许 KVM 访问其状态（如客户内存或客户寄存器）的 KVM 虚拟机。相反，这些 PVM 主要由一个新的实体——超监视器（UV）来管理。UV 提供了一个可以被 PVM 和 KVM 使用的 API 来请求管理操作。
每个客户机都以非受保护模式启动，并且随后可能会请求转换为受保护模式。在转换过程中，KVM 将该客户机及其 VCPU 注册到超监视器，并准备所有必要的条件以便运行它。
超监视器将保护并解密客户机的引导内存（即内核/initrd）。在客户机运行期间，它会保护诸如 VCPU 启动/停止和注入中断的状态变化。
由于访问客户机状态（如 SIE 状态描述）通常是运行虚拟机所必需的，因此对 SIE 指令的行为进行了一些修改。引入了一种新的格式 4 状态描述，其中某些字段对于 PVM 具有不同的含义。尽可能地减少了 SIE 退出以提高速度并减少暴露的客户机状态。

中断注入
-------------------
中断注入由超监视器保护。由于 KVM 无法访问 VCPU 的低层核心，因此通过格式 4 状态描述来处理注入。
机器检查、外部、I/O 和重启中断可以通过中断注入控制字段（偏移量 0x54）中的位在 SIE 入口时注入。如果在注入时客户机 CPU 不启用该中断，则识别出一个有效性拦截。格式 4 状态描述包含拦截数据块中的字段，用于传输与中断相关联的数据。
程序和服务调用异常具有另一层保护；它们只能为已被拦截到 KVM 的指令注入。这些异常必须是 KVM 指令仿真产生的有效结果，例如，我们永远不能注入地址异常，因为这些异常是由 SIE 报告的，而 KVM 无法访问客户机内存。

掩码通知拦截
-------------------------------
KVM 无法再拦截 lctl(g) 和 lpsw(e)，以在 PVM 启用某一类中断时获得通知。作为替代方案，引入了两个新的拦截代码：一个指示 CRs 0、6 或 14 的内容已更改，表明不同的中断子类；另一个指示 PSW 位 13 已更改，表明请求了机器检查干预并且现在已启用这些干预。

指令仿真
---------------------
使用 PVM 的格式 4 状态描述，SIE 指令已经解释了比格式 2 更多的指令。虽然它无法解释每一个指令，但需要将一些任务交给 KVM；因此，SIE 和超监视器保护了仿真输入和输出。
与 SIE 相关联的控制结构提供了安全指令数据区（SIDA）、拦截参数（IP）和安全拦截通用寄存器保存区。客户机 GR 和大部分指令数据（如 I/O 数据结构）都经过了过滤。
指令数据在需要时会被复制到和从SIDA（安全拦截数据区）中读取。访客（Guest）
GR（通用寄存器）会被存入/从安全拦截通用寄存器保存区中取出。
只有那些用于模拟指令所需的GR值会被复制到这个保存区，并且实际的寄存器编号将被隐藏。
拦截参数状态描述字段仍然包含指令文本的字节，但使用的是预设的寄存器值而不是实际的值。也就是说，每条指令始终使用相同的指令文本，以防止泄露访客的指令文本。
这也意味着，从hypervisor的角度来看，访客在r<n>中的寄存器内容可能在r<m>中。
安全指令数据区包含指令存储数据。指令数据，例如由指令引用的数据（如SCLP中的SCCB），通过SIDA进行移动。当一条指令被拦截时，SIE（安全拦截入口）只允许该指令的数据和程序中断通过前面讨论的两个数据区传递给访客。其他数据要么被忽略，要么导致有效性拦截。

### 指令模拟拦截
-------------------
有两种类型的SIE安全指令拦截：正常类型和通知类型。正常的SIE安全指令拦截会使访客等待被拦截指令类型的完成，即在SIE入口处尝试用KVM提供的数据完成该指令的模拟。这可能是程序异常或指令完成。
通知类型的拦截会告知KVM由于访客指令解释而导致的访客环境变化。例如，对于存储前缀指令的通知拦截，可以提供新的lowcore位置。在SIE重新进入时，任何数据区中的KVM数据都会被忽略，并且执行继续进行，就像访客指令已经完成一样。因此，KVM不允许注入程序中断。

### 链接
-----
`KVM论坛2019演讲 <https://static.sched.com/hosted_files/kvmforum2019/3b/ibm_protected_vms_s390x.pdf>`_
