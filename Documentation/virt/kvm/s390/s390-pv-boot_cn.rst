SPDX 许可证标识符: GPL-2.0

======================================
s390（IBM Z）受保护虚拟机的启动/IPL
======================================

摘要
-------
受保护虚拟机（PVM）的内存对 I/O 和 hypervisor 不可访问。在需要 hypervisor 访问 PVM 内存的情况下，必须使该内存可访问。供 hypervisor 访问的内存将会被加密。详细信息请参见 `Documentation/virt/kvm/s390/s390-pv.rst`。

在 IPL（启动）时，会启动一个小的明文引导加载程序，该程序向 KVM 提供有关加密组件及其必要元数据的信息，以便解密受保护的虚拟机。基于这些数据，KVM 将使 Ultravisor（UV）知晓受保护的虚拟机，并指示其保护 PVM 的内存、解密组件并验证数据和地址列表哈希值，以确保完整性。之后，KVM 可以通过 SIE 指令运行 PVM，UV 将拦截此指令并代表 KVM 执行。由于来宾镜像就像一个不透明的内核镜像，它本身进行 PV 模式切换，因此用户可以通过任何可用方法（网络、dasd、scsi、直接内核等）加载加密的来宾可执行文件和数据，而无需更改启动过程。

Diag308
-------
这个诊断指令是处理虚拟机 IPL 及相关操作的基本机制。虚拟机可以设置和检索 IPL 信息块，这些信息块指定了 IPL 方法/设备，并请求虚拟机内存和子系统重置以及 IPL 操作。
对于 PVM，这一概念已通过新的子代码进行了扩展：

子代码 8：设置类型为 5 的 IPL 信息块（用于 PVM 的信息块）
子代码 9：将保存的块存储到来宾内存中
子代码 10：进入受保护虚拟化模式

新的 PV 加载设备特定参数字段指定了所有进入 PV 模式所需的必要数据：
* PV 标头起始位置
* PV 标头长度
* 组件列表，包含：
   * AES-XTS 调整前缀
   * 起始位置
   * 大小

PV 标头包含 UV 用来解密和验证 PV 的密钥和哈希值，以及控制标志和初始 PSW。组件例如是一个加密的内核、内核参数和 initrd。组件由 UV 解密。在初始导入加密数据后，所有定义的页面都将包含来宾内容。所有未指定的页面在首次访问时将作为零页开始。当处于受保护虚拟化模式下时，某些子代码将导致异常或返回错误码。
子代码 4 和 7 指定了不清理客户机内存的操作，这将导致规范异常。这是因为 UV 在移除安全虚拟机时会清除所有内存，因此不允许使用非清理的 IPL 子代码。
子代码 8、9、10 将导致规范异常。
重新以受保护模式 IPL 只能通过先绕道非受保护模式来实现。

键
------
每个 CEC 都将有一个唯一的公钥，以便工具能够构建加密镜像。
请参阅 `s390-tools <https://github.com/ibm-s390-linux/s390-tools/>`_ 工具。
