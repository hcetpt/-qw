SPDX 许可证标识符: GPL-2.0

===========================================
s390（IBM Z）受保护虚拟化内存转储
===========================================

摘要
-------

对虚拟机（VM）进行内存转储是调试其内部问题的重要工具。当一个受保护的虚拟机遇到问题时，这一点尤为重要，因为在运行过程中无法从外部访问其内存和寄存器。然而，在对受保护的虚拟机进行内存转储时，我们需要确保在内存转储交到虚拟机所有者手中之前保持其机密性，因为只有虚拟机所有者有权对其进行分析。

虚拟机内存转储的机密性由Ultravisor保证，它提供了一个与KVM接口通信的方式，可以请求加密后的CPU和内存数据。这种加密基于客户通信密钥，该密钥用于以客户能够解密的方式加密虚拟机数据。

内存转储过程
------------

内存转储分为三个步骤：

**初始化**

此步骤初始化内存转储过程，生成加密种子，并提取将用于加密虚拟机内存转储数据的转储密钥。

**数据收集**

目前可以从虚拟机中收集两种类型的数据：内存和vCPU状态。
vCPU状态包含所有重要的寄存器，包括通用寄存器、浮点寄存器、向量寄存器、控制寄存器和tod/定时器。如果在使用hypervisor帮助下模拟指令时对vCPU进行转储，则vCPU转储可能包含不完整数据。这种情况通过转储数据中的标志位来指示。出于同样的原因，不仅要输出加密的vCPU状态，还应输出未加密的hypervisor状态。
内存状态进一步分为加密内存及其元数据，元数据包括加密调整参数和状态标志。一旦加密内存被导出，就可以直接读取。导出时间无关紧要，因为不需要重新加密。已经交换出去的内存（即已导出的内存）可以直接从交换区读取并写入目标文件，无需任何特殊操作。
需要从Ultravisor请求导出页面的调整参数/状态标志。

**结束**

结束步骤将提供所需的数据以解密vCPU和内存数据，并结束内存转储过程。当此步骤成功完成后，可以开始新的内存转储初始化。
