.. SPDX-License-Identifier: GPL-2.0

=========================
XICS 中断控制器
=========================

支持的设备类型：KVM_DEV_TYPE_XICS

组：
  1. KVM_DEV_XICS_GRP_SOURCES
       属性：

         每个中断源一个，按源编号索引
  2. KVM_DEV_XICS_GRP_CTRL
       属性：

         2.1 KVM_DEV_XICS_NR_SERVERS（仅写）

  kvm_device_attr.addr 指向一个 __u32 值，该值是中断服务器编号的数量（即最高的可能 vcpu 编号加一）
错误：

    =======  ==========================================
    -EINVAL  值大于 KVM_MAX_VCPU_IDS
    -EFAULT  attr->addr 的用户指针无效
    -EBUSY   已有一个 vcpu 连接到该设备
    =======  ==========================================

此设备模拟了在 PAPR 中定义的 XICS（eXternal Interrupt Controller Specification）。XICS 有一组中断源，每个源由一个 20 位的源编号标识，并且有一组中断控制呈现（ICP）实体，也称为“服务器”，每个实体都与一个虚拟 CPU 关联。
ICP 实体通过为每个 vcpu 启用 KVM_CAP_IRQ_ARCH 功能来创建，在 kvm_enable_cap 结构的 args[0] 中指定 KVM_CAP_IRQ_XICS，args[1] 中指定中断服务器编号（即从 XICS 的角度来看的 vcpu 编号）。每个 ICP 都有 64 位的状态，可以通过 KVM_GET_ONE_REG 和 KVM_SET_ONE_REG ioctl 在 vcpu 上读取和写入。64 位状态字包含以下位字段，从字的最低有效位开始：

* 未使用，16 位

* 待处理中断优先级，8 位
  0 表示最高优先级，255 表示没有待处理中断
* 待处理 IPI（处理器间中断）优先级，8 位
  0 表示最高优先级，255 表示没有待处理 IPI
* 待处理中断源编号，24 位
  0 表示没有待处理中断，2 表示有 IPI 待处理

* 当前处理器优先级，8 位
  0 表示最高优先级，意味着不能传递任何中断，而 255 是最低优先级
每个源有 64 位的状态，可以使用 KVM_GET_DEVICE_ATTR 和 KVM_SET_DEVICE_ATTR ioctl 读取和写入，指定 KVM_DEV_XICS_GRP_SOURCES 属性组，属性编号为中断源编号。64 位状态字包含以下位字段，从字的最低有效位开始：

* 目标（服务器编号），32 位

  此处指定了中断应发送的位置，即为目标 vcpu 指定的中断服务器编号
* 优先级，8位

  这是为该中断源指定的优先级，其中0表示最高优先级，255表示最低优先级。优先级为255的中断永远不会被传递。
* 级别敏感标志位，1位

  如果中断源是电平敏感的，则该位为1；如果是边沿敏感（或MSI）的，则为0。
* 屏蔽标志位，1位

  如果中断被屏蔽（无论其优先级如何都无法传递），例如通过ibm,int-off RTAS调用，则该位置为1；如果没有被屏蔽，则为0。
* 待处理标志位，1位

  如果中断源有待处理的中断，则该位置为1；否则为0。
每个虚拟机只能创建一个XICS实例。
