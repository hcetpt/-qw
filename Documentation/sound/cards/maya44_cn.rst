### 关于Maya44 USB音频支持的说明
==================================

.. note::
   以下文档是 Rainer 的补丁的原始文件，当前的 maya44 代码基于此。部分内容可能已过时，但我将其保留作为参考 —— tiwai

2008年2月14日

Rainer Zimmermann <mail@lightshed.de>

### 开发状态
==================

该驱动是在 Piotr Makowski（oponek@gmail.com）的倡议下开发的，并由 Lars Bergmann 资助。开发工作由 Rainer Zimmermann（mail@lightshed.de）完成。ESI 提供了一张用于开发工作的 Maya44 样卡。然而，不幸的是，获取详细的编程信息非常困难，因此我（Rainer Zimmermann）不得不通过实验和推测来找出一些特定于卡片的信息。仍有一些信息（特别是几个 GPIO 位）缺失。这是在2008年2月5日发布到 alsa-devel 邮件列表的第一个测试版本。以下功能已经经过 Rainer Zimmermann 和 Piotr Makowski 测试并确认有效：

- 所有采样率下的播放和捕获
- 输入/输出电平
- 交叉混音
- 线路/麦克风切换
- 幻象电源开关
- 模拟监听（即旁通）

以下功能应该有效，但尚未完全测试：

- 通道3+4模拟 - S/PDIF输入切换
- S/PDIF输出
- M/IO/DIO扩展卡上的所有输入/输出
- 内部/外部时钟选择

*特别是希望拥有 M/IO/DIO 扩展卡的人士能够对这些功能进行测试。*

似乎不正常的功能：

- 'alsamixer' 中的电平计（“多轨”）似乎不对信号作出反应（如果这是一个错误，可能存在于现有的 ICE1724 代码中）
- Ardour 2.1 似乎只能通过 JACK 工作，而不能直接使用 ALSA 或通过 OSS。这个问题还需要进一步调查

### 驱动细节
==============

添加了以下文件：

* pci/ice1724/maya44.c - Maya44 特定代码
* pci/ice1724/maya44.h
* pci/ice1724/ice1724.patch
* pci/ice1724/ice1724.h.patch - 建议对 ice1724.h 的补丁（见采样率）
* i2c/other/wm8776.c - Wolfson WM8776 编解码器的低级访问例程
* include/wm8776.h

请注意，wm8776.c 代码旨在独立于卡片，并且实际上并未将编解码器注册到 ALSA 架构中。这主要在 maya44.c 中完成，主要是因为 WM8776 的一些控制以特定于 Maya44 的方式使用，并应适当命名。

在 pci/ice1724 目录中创建了以下文件，简单地 #include 了 alsa-kernel 树中的相应文件：

* wtm.h
* vt1720_mobo.h
* revo.h
* prodigy192.h
* pontis.h
* phase.h
* maya44.h
* juli.h
* aureon.h
* amp.h
* envy24ht.h
* se.h
* prodigy_hifi.h

*希望这样做是正确的。*

### 采样率
==================

Maya44 卡（更确切地说，Wolfson WM8776 编解码器）允许的最大采样率为播放时 192 kHz，捕获时 92 kHz。
由于ICE1724芯片只允许一个全局采样率，因此处理方式如下：

* 在maya44卡上的任何打开的PCM设备上设置采样率将始终为所有播放和捕获通道设置*全局*采样率。
* 在当前驱动程序状态下，即使对于捕获设备，也允许设置最高达192 kHz的采样率。
* 避免在高于96 kHz的采样率下进行捕获*，尽管看起来可以工作。编解码器实际上无法在这些速率下进行捕获，这意味着质量较差。

我建议在设置捕获PCM设备时添加一些代码来限制采样率。但由于全局采样率的存在，这种逻辑会有些问题。
建议的代码（目前未激活）位于ice1712.h.patch、ice1724.c 和 maya44.c（在pci/ice1712目录中）。

声音设备
=========

PCM设备对应的输入/输出如下（假设Maya44是第0号声卡）：

* hw:0,0 输入 - 立体声，模拟输入1+2
* hw:0,0 输出 - 立体声，模拟输出1+2
* hw:0,1 输入 - 立体声，模拟输入3+4 或 S/PDIF输入
* hw:0,1 输出 - 立体声，模拟输出3+4（以及SPDIF输出）

混音器控制命名
==================

（有关信号流程的更多信息，请参阅ESI Maya44手册第24页的方框图或ESI Windows软件中的图示）

PCM
    （数字）1+2通道的输出电平
PCM 1
    3+4通道的输出电平相同

麦克风幻象电源+48V
    开关用于1/2输入端口上的静电麦克风的+48V幻象电源
确保在连接其他任何信号源到1/2输入端口时不要开启此开关，否则可能会损坏信号源和/或Maya44卡
麦克风/线路输入
    如果开关打开，则输入插孔1/2为麦克风输入（单声道），否则为线路输入（立体声）
旁路
    从ADC输入到输出的模拟旁路，适用于通道1+2。与Windows驱动程序中的“监控”功能相同。
旁路1
    同样适用于通道3+4。
交叉混音
    从通道1+2到通道3+4的交叉混音器。
交叉混音1
    从通道3+4到通道1+2的交叉混音器。

IEC958 输出
    S/PDIF输出开关
此功能不被ESI Windows驱动程序支持。
S/PDIF应输出与通道3+4相同的信号。[未经测试！]

数字输出选择器
    这些开关允许从ADC直接进行数字路由到DAC。
每个开关决定了某个DAC的数字输入数据来源。
它们不被ESI Windows驱动程序支持。
正常操作时，所有开关都应设置为“PCM out”。
硬件1
    输出源通道1
硬件1
    输出源通道2
硬件2
    输出源通道3
硬件3
    输出源通道4

硬件4 ... 硬件9
    功能未知，保留以便进行测试。
可能其中一些控制S/PDIF输出。
如果这些选项最终未被使用，它们将在后续的驱动程序版本中移除。
每个数字输出选择器可选的值如下：

PCM 输出
对应通道的 DAC 输出（默认设置）
输入 1 ... 输入 4
从所选输入通道的 ADC 输出直接路由
