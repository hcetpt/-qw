======================================
关于 C-Media 8338/8738/8768/8770 驱动的简要说明
======================================

Takashi Iwai <tiwai@suse.de>

前/后多声道播放
-----------------

CM8x38 芯片可以将 ADC 用作第二个 DAC，从而实现两个不同的立体声通道用于前后播放。由于有两个 DAC，这两个流是独立处理的，与下面部分提到的 4/6 声道多声道播放不同。

默认情况下，ALSA 驱动将第一个 PCM 设备（即对于 card#0 为 hw:0,0）分配给前部和 4/6 声道播放，而第二个 PCM 设备（hw:0,1）则分配给第二个 DAC 用于后部播放。两个 DAC 之间有一些细微差别：

- 第一个 DAC 支持 U8 和 S16LE 格式，而第二个 DAC 只支持 S16LE。
- 第二个 DAC 只支持两声道立体声。

请注意，CM8x38 DAC 不支持连续播放率，只支持固定速率：5512、8000、11025、16000、22050、32000、44100 和 48000 Hz。

只有在“四声道模式”开关关闭时才能听到后置输出。否则，信号不会路由到后置扬声器。默认情况下，这个开关是开启的。

.. WARNING::

  当“四声道模式”开关关闭时，后置扬声器的输出将是全音量，无论主音量和 PCM 音量如何设置 [#]_。

这可能会损坏您的音频设备。请在关闭此开关之前断开扬声器连接。

.. [#]

  嗯……有一次我得到了正确的音量输出（即与前置扬声器相同），非常兴奋。即使在“四声道”位开启且处于“双 DAC”模式下，我也能从前后扬声器听到四个独立的声道！但是……重启之后，一切又恢复了原状。
非常遗憾的是，当时我没有保存寄存器转储。也许有一个未知的寄存器可以实现这个功能。
如果你的声卡有一个额外的输出插孔用于后置输出，默认情况下后置回放应该被路由到该插孔。如果没有，则驱动程序中有一个名为“Line-In As Rear”的控制开关，你可以通过alsamixer或其他工具进行更改。当此开关打开时，线路输入插孔将用作后置输出。
还有两个与后置输出相关的控制选项：
“Exchange DAC”开关用于交换前后置回放路径，即第二个DAC从前置输出。
4/6 多声道回放
--------------------------

最近的CM8738芯片支持4/6多声道回放功能。这对于AC3解码特别有用。
当支持多声道回放时，驱动程序名称会有一个后缀“-MC”，例如“CMI8738-MC6”。你可以在/proc/asound/cards中查看这个名称。
当启用4/6声道输出时，第二个DAC最多可处理6（或4）个声道。虽然双DAC支持两种不同的采样率或格式，但4/6声道回放仅支持所有声道相同的条件。由于多声道回放模式使用了两个DAC，因此不能以全双工方式运行。
4.0和5.1模式在alsa-lib中定义为pcm “surround40”和“surround51”。例如，你可以像这样播放一个包含6个声道的WAV文件：
```
% aplay -Dsurround51 sixchannels.wav
```

为了编程4/6声道回放，你需要指定所需的PCM声道数并设置S16LE格式。例如，对于4声道回放，
```
snd_pcm_hw_params_set_access(pcm, hw, SND_PCM_ACCESS_RW_INTERLEAVED);
    // 或使用mmap，如果你愿意的话
snd_pcm_hw_params_set_format(pcm, hw, SND_PCM_FORMAT_S16_LE);
snd_pcm_hw_params_set_channels(pcm, hw, 4);
```
然后使用交错的4声道数据。
还有一些影响扬声器连接的控制开关：

线路输入模式
一个枚举控制开关，用于改变线路输入插孔的行为。可以选择“Line-In”、“Rear Output”或“Bass Output”。最后一个选项仅适用于型号039或更新版本。
当选择“Rear Output”时，环绕声道3和4将输出到线路输入插孔。
麦克风输入模式
一个枚举控制开关，用于改变麦克风输入插孔的行为。可以选择“Mic-In”或“Center/LFE Output”。
当选择“Center/LFE Output”时，中心和低频效果（LFE）声道（通道5和6）将输出到麦克风输入插孔。

数字I/O
--------------

CM8x38提供了出色的SPDIF功能，并且价格非常便宜（是的，这就是我买这张卡的原因：）

SPDIF回放和捕获是通过第三个PCM设备（hw:0,2）完成的。通常这会被分配给“spdif”PCM设备。
可用的采样率是 44100 和 48000 Hz。
使用 aplay 播放时，可以如下运行：

```
% aplay -Dhw:0,2 foo.wav
```

或者

```
% aplay -Dspdif foo.wav
```

24位格式也实验性地得到支持。
通过 SPDIF 进行播放和录音分别使用正常的 DAC 和 ADC，因此你不能同时播放模拟和数字流。
要启用 SPDIF 输出，你需要通过混音器或 alsactl 打开“IEC958 输出开关”控制（“IEC958”是所谓的 S/PDIF 的官方名称）。然后你会看到卡片上的红灯亮起，这样你就知道它正在工作了 :).

SPDIF 输入始终是启用的，因此你可以随时通过“IEC958 输入监听”开关从线路输出听到 SPDIF 输入数据（见下文）。
即使使用第一个设备（hw:0,0），也可以通过 SPDIF 播放，但只有在使用正确的格式（S16LE）、采样率（44100 或 48000）和通道数（2）时才会启用 SPDIF。否则，它会被关闭。（也不要忘记打开“IEC958 输出开关”。）

此外还有一些相关的控制开关：

IEC958 混合模拟
混合模拟 PCM 播放和 FM-OPL/3 流，并通过 SPDIF 输出。这个开关只出现在旧型号芯片上（CM8738 033 和 037）。
注意：没有这个控制，你仍然可以将 PCM 输出到 SPDIF。
这是流的“混合”，例如，它不是用于 AC3 输出（见下一部分）。

IEC958 输入选择
选择 SPDIF 输入、内部 CD 输入（假）和外部输入（真）。

IEC958 循环
SPDIF 输入数据被循环回 SPDIF 输出（即旁路）。

IEC958 版权
设置版权位。

IEC958 5V
选择 0.5V（同轴）或 5V（光纤）接口。
在某些声卡上，这种方法不起作用，你需要通过硬件拨码开关来更改配置。

IEC958 在监视器中
   SPDIF 输入被路由到 DAC（数字模拟转换器）。

IEC958 在相位反转中
   设置 SPDIF 输入格式为反向。

[待修复：这并不适用于所有芯片...]

IEC958 在有效输入
   设置输入有效性标志检测。

注意：当“PCM 播放开关”开启时，你将通过模拟线路输出听到数字输出流。
AC3（原始数字）输出
-------------------

该驱动支持通过 SPDIF 进行原始数字（通常为 AC3）输入/输出。这可以通过 IEC958 播放控制进行切换，但通常需要通过 alsa-lib 访问。详见 alsa-lib 文档以获取更多细节。

在原始数字模式下，“PCM 播放开关”会自动关闭，以便非音频数据不会从模拟线路输出。同样地，以下开关也会关闭：“IEC958 模拟混合”和“IEC958 循环”。在关闭 SPDIF PCM 设备后，这些开关会自动恢复到之前的状态。

对于型号 033，AC3 是通过 alsa-lib 中的软件转换实现的。如果你需要绕过 IEC958 子帧的软件转换，请传递模块选项 "soft_ac3=0"。对于较新型号，这一点无关紧要。

模拟混音接口
-------------

CM8x38 的混音接口与 SB16 类似。
有 Master、PCM、Synth、CD、Line、Mic 和 PC Speaker 播放音量。Synth、CD、Line 和 Mic 还具有播放和捕获开关，以及 SB16。

除了标准的 SB 混音器外，CM8x38 还提供了更多功能：
- PCM 播放开关
- PCM 捕获开关（用于捕获发送到 DAC 的数据）
- Mic 增益开关
- Mic 捕获音量
- Aux 播放音量/开关和捕获开关
- 3D 控制开关

### MIDI 控制器
----------------

使用 CMI8338 芯片时，默认禁用 MPU401-UART 接口。你需要将模块选项 "mpu_port" 设置为有效的 I/O 端口地址以启用 MIDI 支持。有效的 I/O 端口地址是 0x300、0x310、0x320 和 0x330。选择一个不会与其他卡冲突的值。
对于 CMI8738 及更新的芯片，默认启用了 MIDI 接口，并且驱动程序会自动选择一个端口地址。
此芯片上没有硬件波表功能（除了下面的 OPL3 合成器）。
Windows 上所说的 MIDI 合成器实际上是一个软件合成器仿真。在 Linux 上可以使用 TiMidity 或其他软合成器程序来播放 MIDI 音乐。

### FM OPL/3 合成器
-------------------

FM OPL/3 默认仅对第一张卡启用。
对于更多的卡，需要设置 "fm_port" 模块选项。
然而，FM OPL/3 的输出质量非常奇怪。
我不知道为什么。

CMI8768 及更新的芯片没有 FM 合成器。

游戏杆和调制解调器
-------------------

传统的游戏杆是受支持的。要启用游戏杆支持，请传递模块选项 joystick_port=1。值为 1 表示自动检测。
如果自动检测失败，请尝试传递确切的 I/O 地址。
调制解调器通过一个名为“Modem”的卡控开关动态启用。

调试信息
---------------------
寄存器显示在 /proc/asound/cardX/cmipci 中。如果您遇到任何问题（特别是混音器的异常行为），请在提交错误报告时附上此 proc 文件的输出。
