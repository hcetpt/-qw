SPDX 许可证标识符：（GPL-2.0-only 或 BSD-3-Clause）
.. include:: <isonum.txt>

================================================
Intel 平台上的 HDAudio 多链路扩展
================================================

:版权: |copy| 2023 Intel 公司

本文件记录了 2015 年在 Skylake 处理器中引入并在最近的 Intel 平台上扩展的“多链路结构”。

HDAudio 现有的链路映射（2015 年 Skylake 添加）
========================================================

外部 HDAudio 编解码器通过链路 #0 处理，而 HDMI/DisplayPort 的 iDISP 编解码器通过链路 #1 处理。
对 2015 年定义的唯一更改是声明 LCAP.ALT=0x0 ——由于 ALT 位之前被保留，因此这是一个向后兼容的更改。
LCTL.SPA 和 LCTL.CPA 在退出复位时自动设置。它们仅在现有驱动程序中需要修正 SCF 值时使用。

HDAudio 编解码器的基本结构
----------------------------------

::

  +-----------+
  | ML cap #0 |
  +-----------+
  | ML cap #1 |---+
  +-----------+   |
                  |
                  +--> 0x0 +---------------+ LCAP
                           | ALT=0         |
                           +---------------+
                           | S192          |
                           +---------------+
                           | S96           |
                           +---------------+
                           | S48           |
                           +---------------+
                           | S24           |
                           +---------------+
                           | S12           |
                           +---------------+
                           | S6            |
                           +---------------+

                       0x4 +---------------+ LCTL
                           | INTSTS        |
                           +---------------+
                           | CPA           |
                           +---------------+
                           | SPA           |
                           +---------------+
                           | SCF           |
                           +---------------+

                       0x8 +---------------+ LOSIDV
                           | L1OSIVD15     |
                           +---------------+
                           | L1OSIDV..     |
                           +---------------+
                           | L1OSIDV1      |
                           +---------------+

                       0xC +---------------+ LSDIID
                           | SDIID14       |
                           +---------------+
                           | SDIID...      |
                           +---------------+
                           | SDIID0        |
                           +---------------+

SoundWire HDAudio 扩展链路映射
=======================================

当 LCAP.ALT=1 且 LEPTR.ID=0 时，标识一个 SoundWire 扩展链路。
DMA 控制使用现有的 LOSIDV 寄存器。
更改包括额外的枚举描述，这些描述在早期版本中不存在：
- 多链路同步：LCAP.LSS 中的能力和 LSYNC 中的控制
- 子链路数量（管理 IP）在 LCAP.LSCOUNT 中
- 功耗管理从 SHIM 移到 LCTL.SPA 位
- 将 DSP 访问多链路寄存器的权限移交给 SHIM/IP，使用 LCTL.OFLEN
- SoundWire 编解码器与 SDI ID 位的映射
- SHIM 和 Cadence 寄存器移到不同的偏移地址，功能不变。LEPTR.PTR 值是从 ML 地址的偏移量，默认值为 0x30000。

假设存在 4 个 Manager IP 的 SoundWire 扩展结构
--------------------------------------------------------

::

  +-----------+
  | ML cap #0 |
  +-----------+
  | ML cap #1 |
  +-----------+
  | ML cap #2 |---+
  +-----------+   |
                  |
                  +--> 0x0 +---------------+ LCAP
                           | ALT=1         |
                           +---------------+
                           | INTC          |
                           +---------------+
                           | OFLS          |
                           +---------------+
                           | LSS           |
                           +---------------+
                           | SLCOUNT=4     |-----------+
                           +---------------+           |
                                                       |
                       0x4 +---------------+ LCTL      |
                           | INTSTS        |           |
                           +---------------+           |
                           | CPA (x bits)  |           |
                           +---------------+           |
                           | SPA (x bits)  |           |
                           +---------------+         对于每个子链路 x
                           | INTEN         |           |
                           +---------------+           |
                           | OFLEN         |           |
                           +---------------+           |
                                                       |
                       0x8 +---------------+ LOSIDV    |
                           | L1OSIVD15     |           |
                           +---------------+           |
                           | L1OSIDV..     |           |
                           +---------------+           |
                           | L1OSIDV1      |       +---+----------------------------------------------------------+
                           +---------------+       |                                                              |
                                                   v                                                              |
             0xC + 0x2 * x +---------------+ LSDIIDx    +---> 0x30000  +-----------------+  0x00030000            |
                           | SDIID14       |            |              | SoundWire SHIM  |                        |
                           +---------------+            |              | generic         |                        |
                           | SDIID...      |            |              +-----------------+  0x00030100            |
                           +---------------+            |              | SoundWire IP    |                        |
                           | SDIID0        |            |              +-----------------+  0x00036000            |
                           +---------------+            |              | SoundWire SHIM  |                        |
                                                        |              | vendor-specific |                        |
                      0x1C +---------------+ LSYNC      |              +-----------------+                        |
                           | CMDSYNC       |            |                                                         v
                           +---------------+            |              +-----------------+  0x00030000 + 0x8000 * x
                           | SYNCGO        |            |              | SoundWire SHIM  |
                           +---------------+            |              | generic         |
                           | SYNCPU        |            |              +-----------------+  0x00030100 + 0x8000 * x
                           +---------------+            |              | SoundWire IP    |
                           | SYNPRD        |            |              +-----------------+  0x00036000 + 0x8000 * x
                           +---------------+            |              | SoundWire SHIM  |
                                                        |              | vendor-specific |
                      0x20 +---------------+ LEPTR      |              +-----------------+
                           | ID = 0        |            |
                           +---------------+            |
                           | VER           |            |
                           +---------------+            |
                           | PTR           |------------+
                           +---------------+

DMIC HDAudio 扩展链路映射
==================================

当 LCAP.ALT=1 且 LEPTR.ID=0xC1 被设置时，标识一个 DMIC 扩展链路。
DMA 控制使用现有的 LOSIDV 寄存器。

更改包括额外的枚举描述，这些描述在早期版本中不存在：
- 多链路同步：LCAP.LSS 中的能力和 LSYNC 中的控制
- 使用 LCTL.SPA 位进行功耗管理
- 将 DSP 访问多链路寄存器的权限移交给 SHIM/IP，使用 LCTL.OFLEN
- 将 DMIC 寄存器移到不同的偏移地址，功能不变。LEPTR.PTR 值是从 ML 地址的偏移量，默认值为 0x10000。
DMIC 扩展结构
---------------------------

::

  +-----------+
  | ML cap #0 |
  +-----------+
  | ML cap #1 |
  +-----------+
  | ML cap #2 |---+
  +-----------+   |
                  |
                  +--> 0x0 +---------------+ LCAP
                           | ALT=1         |
                           +---------------+
                           | INTC          |
                           +---------------+
                           | OFLS          |
                           +---------------+
                           | SLCOUNT=1     |
                           +---------------+

                       0x4 +---------------+ LCTL
                           | INTSTS        |
                           +---------------+
                           | CPA           |
                           +---------------+
                           | SPA           |
                           +---------------+
                           | INTEN         |
                           +---------------+
                           | OFLEN         |
                           +---------------+           +---> 0x10000  +-----------------+  0x00010000
                                                       |              | DMIC SHIM       |
                       0x8 +---------------+ LOSIDV    |              | generic         |
                           | L1OSIVD15     |           |              +-----------------+  0x00010100
                           +---------------+           |              | DMIC IP         |
                           | L1OSIDV..     |           |              +-----------------+  0x00016000
                           +---------------+           |              | DMIC SHIM       |
                           | L1OSIDV1      |           |              | vendor-specific |
                           +---------------+           |              +-----------------+
                                                       |
                      0x20 +---------------+ LEPTR     |
                           | ID = 0xC1     |           |
                           +---------------+           |
                           | VER           |           |
                           +---------------+           |
                           | PTR           |-----------+
                           +---------------+

SSP HDaudio 扩展链路映射
=================================

当 LCAP.ALT=1 和 LEPTR.ID=0xC0 被设置时，可以识别一个 DMIC 扩展链路。
DMA 控制使用现有的 LOSIDV 寄存器。

变化包括添加了在早期版本中没有的枚举和控制描述：
- LCAP.LSCOUNT 中子链路（SSP IP 实例）的数量
- 功耗管理从 SHIM 移动到 LCTL.SPA 位
- 使用 LCTL.OFLEN 将对多链路寄存器的访问权移交给 DSP
- 将 SHIM 和 SSP IP 寄存器移到不同的偏移地址，功能不变。LEPTR.PTR 的值是从 ML 地址的偏移量，默认为 0x28000

扩展结构用于 SSP（假设有 3 个 IP 实例）
-----------------------------------------------------------

::

  +-----------+
  | ML cap #0 |
  +-----------+
  | ML cap #1 |
  +-----------+
  | ML cap #2 |---+
  +-----------+   |
                  |
                  +--> 0x0 +---------------+ LCAP
                           | ALT=1         |
                           +---------------+
                           | INTC          |
                           +---------------+
                           | OFLS          |
                           +---------------+
                           | SLCOUNT=3     |-------------------------对于每个子链路 x -------------------------+
                           +---------------+                                                                     |
                                                                                                                 |
                       0x4 +---------------+ LCTL                                                                |
                           | INTSTS        |                                                                     |
                           +---------------+                                                                     |
                           | CPA (x bits)  |                                                                     |
                           +---------------+                                                                     |
                           | SPA (x bits)  |                                                                     |
                           +---------------+                                                                     |
                           | INTEN         |                                                                     |
                           +---------------+                                                                     |
                           | OFLEN         |                                                                     |
                           +---------------+           +---> 0x28000  +-----------------+  0x00028000            |
                                                       |              | SSP SHIM        |                        |
                       0x8 +---------------+ LOSIDV    |              | generic         |                        |
                           | L1OSIVD15     |           |              +-----------------+  0x00028100            |
                           +---------------+           |              | SSP IP          |                        |
                           | L1OSIDV..     |           |              +-----------------+  0x00028C00            |
                           +---------------+           |              | SSP SHIM        |                        |
                           | L1OSIDV1      |           |              | vendor-specific |                        |
                           +---------------+           |              +-----------------+                        |
                                                       |                                                         v
                      0x20 +---------------+ LEPTR     |              +-----------------+  0x00028000 + 0x1000 * x
                           | ID = 0xC0     |           |              | SSP SHIM        |
                           +---------------+           |              | generic         |
                           | VER           |           |              +-----------------+  0x00028100 + 0x1000 * x
                           +---------------+           |              | SSP IP          |
                           | PTR           |-----------+              +-----------------+  0x00028C00 + 0x1000 * x
                           +---------------+                          | SSP SHIM        |
                                                                      | vendor-specific |
                                                                      +-----------------+
