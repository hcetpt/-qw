关于HD-Audio驱动程序的更多说明
=================================

Takashi Iwai <tiwai@suse.de>

概述
=====

HD-Audio是继AC97之后现代PC上新的板载音频组件标准。尽管Linux很久以前就开始支持HD-Audio，但新机器上经常会出现问题。部分问题是由于BIOS的问题，其余的是驱动程序实现方面的问题。本文档解释了针对HD-Audio硬件的基本故障排查和调试方法。
HD-Audio组件由两部分组成：控制器芯片和HD-Audio总线上的编解码器芯片。Linux为所有控制器提供了一个单一的驱动程序snd-hda-intel。虽然驱动程序名称包含了一个知名硬件供应商的名字，但它并不是特指这家公司的产品，而是适用于其他公司的所有控制器芯片。由于HD-Audio控制器被设计为兼容的，因此单一的snd-hda-driver在大多数情况下都应该能正常工作。然而，并不令人意外的是，每种类型的控制器都存在已知的bug和问题。snd-hda-intel驱动程序中有一系列的解决办法来处理这些问题，如下所述。
一个控制器可能有多个编解码器。通常你有一个音频编解码器，可选地还有一个调制解调器编解码器。理论上，可能存在多个音频编解码器，例如用于模拟和数字输出，而驱动程序可能无法正常工作，因为混音器元素之间的冲突。如果这种硬件真的存在，这个问题将来应该得到修复。
snd-hda-intel驱动程序根据不同的编解码器有不同的解析器。它有一个通用解析器作为备选方案，但到目前为止这个功能还相当有限。通常使用特定于编解码器的解析器（在patch_*.c中编码）来进行特定于编解码器的实现。关于特定于编解码器的问题的详细信息将在后面的章节中解释。
如果你对深入调试HD-Audio感兴趣，首先阅读HD-Audio规范。该规范可以在Intel的网页上找到，例如：

* https://www.intel.com/standards/hdaudio/

HD-Audio控制器
===============

DMA位置问题
------------
控制器最常见的问题是DMA指针报告不准确。播放和捕获的DMA指针可以通过两种方式读取，一种是通过LPIB寄存器，另一种是通过位置缓冲区映射。默认情况下，驱动程序尝试从io映射的位置缓冲区读取，并且如果位置缓冲区看起来无效则回退到LPIB。然而，在某些设备上，这种检测并不完美。在这种情况下，你可以通过`position_fix`选项改变默认的方法：
`position_fix=1`表示明确使用LPIB方法
`position_fix=2`表示使用位置缓冲区
`position_fix=3`表示使用两种方法的组合，这是某些VIA控制器所需要的。捕获流的位置通过比较LPIB和位置缓冲区的值进行校正。
`position_fix=4` 是所有控制器可用的另一种组合，它使用 LPIB 进行回放，并使用位置缓冲区进行捕获流。

`position_fix=5` 特定于 Intel 平台，目前为止，适用于 Skylake 及以后的平台。它应用于精确位置报告的延迟计算。

`position_fix=6` 旨在通过固定FIFO大小来修正位置，主要针对近期的 AMD 控制器。

0 是所有其他控制器的默认值，即上述描述中的自动检查并回退到 LPIB。如果你遇到重复声音的问题，这个选项可能会有所帮助。

此外，每个控制器在唤醒定时方面都存在已知问题。它们会在实际处理缓冲区上的数据之前提前几个样本唤醒。这导致了许多问题，例如与 ALSA dmix 或 JACK 的问题。自 2.6.27 内核版本起，驱动程序对唤醒定时添加了人工延迟。此延迟由 `bdl_pos_adj` 选项控制。

当 `bdl_pos_adj` 是一个负值（作为默认值）时，它会被分配为根据控制器芯片适当调整的值。对于 Intel 芯片，该值为 1，而对于其他芯片则为 32。通常情况下，这样做是有效的。

只有当不起作用并且你收到警告信息时，才应该将此参数更改为其他值。

### 编解码器探测问题

不那么常见但更为严重的一个问题是编解码器探测。当 BIOS 错误报告可用的编解码器插槽时，驱动程序会变得混乱，并尝试访问不存在的编解码器插槽。这通常会导致完全混乱，并破坏与编解码器芯片的进一步通信。其症状通常表现为如下错误信息：

```
hda_intel: azx_get_response timeout, switching to polling mode: 
          last cmd=0x12345678
hda_intel: azx_get_response timeout, switching to single_cmd mode: 
          last cmd=0x12345678
```

第一行是一个警告，这通常是相对无害的。这意味着编解码器响应不是通过 IRQ 通知的。驱动程序使用显式轮询方法读取响应。这会给 CPU 带来非常轻微的开销，但你可能不会注意到。

然而，第二行是一个致命错误。如果发生这种情况，通常意味着确实出了什么问题。最有可能的情况是你正在访问一个不存在的编解码器插槽。
因此，如果出现第二个错误消息，尝试通过 `probe_mask` 选项来缩小探测的编解码器插槽范围。这是一个位掩码，其中每一位都对应一个编解码器插槽。例如，要仅探测第一个插槽，请传递 `probe_mask=1`。对于第一个和第三个插槽，请传递 `probe_mask=5`（其中 5 = 1 | 4），依此类推。
自 2.6.29 内核起，驱动程序具备了一种更健壮的探测方法，因此这种错误可能很少发生。
在具有故障 BIOS 的机器上，有时需要强制驱动程序探测硬件未报告使用的编解码器插槽。
在这种情况下，请打开 `probe_mask` 选项中的第 8 位（0x100）。
然后其余的 8 位将无条件地作为要探测的编解码器插槽传递。例如，`probe_mask=0x103` 将强制探测编解码器插槽 0 和 1，无论硬件报告什么信息。

中断处理
---------
HD-Audio 驱动程序自 2.6.33 内核起默认使用 MSI（如果可用），因为 MSI 在某些机器上表现更好，并且通常来说对性能更有利。然而，Nvidia 控制器与 MSI 结合使用时出现了严重倒退（尤其是在与 AMD 芯片组结合时），因此我们禁用了它们的 MSI 功能。
似乎还有其他设备不支持 MSI。如果你看到最近内核中音质（如断断续续等）或锁定出现问题，请尝试传递 `enable_msi=0` 选项以禁用 MSI。如果这样做有效，你可以将已知的不良设备添加到 hda_intel.c 中定义的黑名单中。在这种情况下，请报告问题并将补丁反馈给上游开发者。

HD-Audio 编解码器
==================

模型选项
------------
关于 HD-Audio 驱动程序最常见的问题是不支持的编解码器特性或设备配置不匹配。
大多数特定于编解码器的代码都有几种预设模型，要么用于覆盖 BIOS 设置，要么提供更全面的功能。
驱动程序会检查 PCI SSID 并遍历静态配置表直到找到匹配项。如果你有一台新机器，可能会看到类似下面的消息：
::

    hda_codec: ALC880: BIOS auto-probing
与此同时，在早期版本中，你会看到类似这样的消息：

    hda_codec: 对于ALC880，未知的型号，尝试从BIOS进行自动探测...

即使你看到了这样的消息，也不要惊慌。深呼吸，保持冷静。首先，这只是一个信息提示，并非警告或错误。这意味着你的设备的PCI SSID并未列在已知预设型号（白名单）中。但这并不意味着驱动程序有问题。许多编解码器驱动程序都提供了基于BIOS设置的自动配置机制。
高清音频编解码器通常有“引脚”小部件，而BIOS会为每个引脚设置默认配置，这些配置指示了位置、连接类型、插孔颜色等。高清音频驱动程序可以根据这些默认配置值来判断正确的连接方式。
然而——有些编解码器支持代码（如patch_analog.c），在2.6.28及更早版本中还不支持自动探测。而且，BIOS往往，是的，非常频繁地存在问题。它可能会设置错误的值，从而导致驱动程序出错。
预设型号（最近也称为“修复”）主要是为了应对这种情况而提供的。当在白名单中找到匹配的预设型号时，驱动程序会假设该预设的静态配置，包括正确的引脚设置等。
因此，如果你有一台较新的机器，其PCI SSID（或编解码器SSID）与现有的略有不同，你有很大的机会可以重用相同的型号。你可以通过传递`model`选项来指定预设型号，而不是通过PCI（和编解码器）SSID查找。
可用的`model`选项值取决于编解码器芯片。从编解码器进程文件中检查你的编解码器芯片（参见下面的“编解码器进程文件”部分）。它将显示你的编解码器芯片的供应商/产品名称。然后，查看Documentation/sound/hd-audio/models.rst文件，即高清音频驱动程序的部分。你可以找到属于每个编解码器的列表以及相应的`model`选项。例如，对于Realtek ALC262编解码器芯片，对于兼容三星Q1 Ultra的设备，可以传递`model=ultra`。
因此，对于任何全新的、不受支持且无法正常工作的高清音频硬件，你可以做的第一件事就是检查高清音频编解码器及其几种不同的`model`选项值。如果你运气好，其中一些可能非常适合你的设备。
有一些特殊的`model`选项值：

* 当传递`nofixup`时，会跳过编解码器解析器中的特定于设备的修复。
当传递“generic”时，会跳过编解码器特定的解析器，仅使用通用解析器。

自5.15内核引入的一种新型的模型选项风格是通过`model=XXXX:YYYY`的形式传递PCI或编解码器SSID，其中XXXX和YYYY分别是十六进制形式的子供应商和子设备ID。这相当于对另一个设备的别名；当给出这种格式时，驱动程序将参照该SSID作为特性表的引用。特别是当目标特性没有列在模型表中时，这会特别有用。例如，传递model=103c:8862将会应用HP ProBook 445 G8的特性（撰写本文时，该特性并未出现在模型表中），只要该设备由同一个驱动程序以等效方式处理即可。

扬声器和耳机输出
------------------

最常见（也是最明显的）的HD音频问题之一是内置扬声器或耳机插孔无声输出。一般来说，你应该首先尝试耳机输出。扬声器输出通常需要更多的额外控制，比如外部放大器位。因此，耳机输出有稍微更好的机会成功。

在提交错误报告之前，请务必检查混音器设置是否正确。近期版本的snd-hda-intel驱动程序主要提供了“主”音量控制以及“前”音量控制（其中“前”表示前置声道）。此外，还可能有个别的“耳机”和“扬声器”控制。

对于扬声器输出也是一样。某些编解码器上可能会有“外部放大器”的开关。如果存在，请打开它。

另一个相关的问题是插入耳机后自动静音扬声器输出。此功能大多数情况下都已实现，但并非所有预设模型或编解码器支持代码都有这个功能。

无论如何，如果你遇到这类问题，可以尝试不同的模型选项。其他一些模型可能更匹配，并为你提供更多的匹配功能。如果现有的任何模型都无法工作，请提交一个错误报告。详细信息请参阅错误报告部分。

如果你足够“受虐”并打算调试驱动程序问题，请注意以下几点：

* 扬声器输出（耳机输出也是如此）通常需要外部放大器。这通常可以通过EAPD命令或某个GPIO来设置。如果编解码器引脚支持EAPD，那么通过SET_EAPD_BTL命令（0x70c）你有更好的机会。在其他情况下，GPIO引脚（通常是GPIO0或GPIO1）可以用来开启/关闭EAPD。
* 某些Realtek编解码器需要特殊的厂商特定系数来开启放大器。请参阅patch_realtek.c文件。
* IDT 编码解码器可能在每个模拟引脚上具有额外的电源启用/禁用控制。请参阅 `patch_sigmatel.c`
* 非常罕见，但有些设备直到触发后才接受引脚检测动词。发出 `GET_PIN_SENSE` 动词 (0xf09) 可能会导致编码解码器通信停滞。一些示例可以在 `patch_realtek.c` 中找到

捕获问题
---------
捕获问题通常是因为缺少混音器设置。
因此，在提交错误报告之前，请确保正确设置了混音器。例如，“捕获音量”和“捕获开关”必须正确设置，此外还需要选择正确的“捕获源”或“输入源”。一些设备具有“麦克风增益”音量或开关。
当通过“默认”PCM（不带脉冲音频插件）打开 PCM 设备时，您可能会有“数字捕获音量”控制。
这是为了在软件中提供额外的增益/衰减信号，特别是对于没有硬件音量控制的输入，如数字麦克风。除非确实需要，否则应将其设置为正好 50%，对应于 0dB ——既无额外增益也无衰减。当您使用“hw”PCM，即原始访问 PCM 时，此控制将不会产生影响。
已知某些编码解码器/设备具有相当糟糕的模拟电路，并且录制的声音包含一定的直流偏移。这不是驱动程序的错误。
大多数现代笔记本电脑都没有模拟 CD 输入连接。因此，虽然驱动程序提供了作为捕获源的 CD 输入，但在许多情况下从 CD 输入进行录制将不起作用。请改用 CDDA。
自动切换内置和外部麦克风以根据插入情况实现仅在某些编码解码器型号上实施，但并非所有型号都支持。这主要是因为缺乏测试人员，但也有一部分是因为我的懒惰。欢迎提交改进补丁给作者。

直接调试
---------
如果没有任何模型选项能给您带来更好的结果，并且您是一个勇于对抗邪恶的人，请尝试通过向设备发送原始 HD 音频编码解码器动词来调试。有一些工具可用：`hda-emu` 和 `hda-analyzer`。详细描述请参见以下章节。您需要启用 hwdep 才能使用这些工具。请参阅“内核配置”部分。
其他问题
============

内核配置
--------------------
通常，我建议您启用声音调试选项，
``CONFIG_SND_DEBUG=y``，无论您是否在进行调试。
这会启用 `snd_printd()` 宏和其他功能，并且您会在探测时获得额外的内核消息。
此外，您可以启用 ``CONFIG_SND_DEBUG_VERBOSE=y``。但这会给您带来更多的消息。因此，请仅在确定需要时才开启此选项。
不要忘记启用适当的 ``CONFIG_SND_HDA_CODEC_*`` 选项。请注意，这些选项对应的是编解码器芯片，而不是控制器芯片。因此，即使 `lspci` 显示的是 Nvidia 控制器，您也可能需要选择其他厂商的选项。如果您不确定，可以将所有选项都设为“是”。
``CONFIG_SND_HDA_HWDEP`` 是一个对调试驱动程序非常有用的选项。
当启用此选项时，驱动程序会为每个编解码器创建硬件依赖设备（每张卡一个）。通过这些设备文件，您可以直接访问设备。例如，对于第一张卡（#0）上的第二个编解码器插槽，将创建名为 `hwC0D2` 的设备文件。对于如 `hda-verb` 和 `hda-analyzer` 这样的调试工具而言，必须启用 hwdep 设备。
因此，最好始终启用此选项。
``CONFIG_SND_HDA_RECONFIG`` 是一个新的选项，并且它依赖于上面提到的 hwdep 选项。当启用此选项时，在对应的 hwdep 目录下会有一些 sysfs 文件。请参阅下面的“高清音频重新配置”部分。
``CONFIG_SND_HDA_POWER_SAVE`` 选项启用了节能功能。
请参阅下面的“节能”部分。
### Codec Proc-File
------------------

Codec proc-file 是调试 HD 音频的宝库。
它显示了每个 codec 组件的大多数有用信息。
proc 文件位于 `/proc/asound/card*/codec#*`，每个 codec 插槽一个文件。
你可以通过这个文件了解 codec 厂商、产品 ID 和名称、各组件类型、功能等信息。
然而，此文件目前不显示插孔感应状态。这是因为插孔感应可能依赖于触发状态。
此文件将被调试工具读取，并且还可以作为主要的 codec 信息提供给模拟器使用。请参见下面的调试工具部分。
此外，此 proc 文件也可以用来检查是否使用了通用解析器