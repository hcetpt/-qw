Iforce 协议
===============

:作者: Johann Deneux <johann.deneux@gmail.com>

主页: `<http://web.archive.org/web/*/http://www.esil.univ-mrs.fr>`_

:增补: Vojtech Pavlik

简介
============

本文档描述了我对用于向 I-Force 2.0 设备指定力效果的协议所了解到的内容。所有这些信息均非来自 Immerse。因此，你不应该完全信任本文档中的内容。本文档旨在帮助理解该协议，并非参考手册。欢迎评论和纠正。要联系我，请发送电子邮件至：johann.deneux@gmail.com

.. 警告::

    如果你根据本文档中读到的内容尝试向你的 I-Force 设备发送数据，我将不对由此造成的任何损害或伤害负责。

初步说明
=================

所有值均为十六进制并使用大端编码（高位在左）。请注意，包内的值使用小端编码。未知作用的字节标记为??? 需要进一步检查的信息标记为(?)

包的一般形式
------------------------

当设备使用 RS232 通信时，包的格式如下：
== == === ==== ==
2B OP LEN DATA CS
== == === ==== ==

CS 是校验和。它等于所有字节的异或结果。
当使用 USB 时：

== ====
OP DATA
== ====

2B、LEN 和 CS 字段已消失，可能是因为 USB 处理帧并且数据损坏已得到处理或不重要。
首先，我描述由设备发送给计算机的效果。

设备输入状态
==================

此包用于指示每个按钮的状态及每个轴的值：
    
    OP= 01 对于操纵杆，03 对于方向盘
    LEN= 根据设备而变化
    00 X 轴低位
    01 X 轴高位
    02 Y 轴低位，对于方向盘是油门踏板
    03 Y 轴高位，对于方向盘是刹车踏板
    04 油门
    05 按钮
    06 低四位：按钮
       高四位：摇杆帽
    07 方向舵

设备效果状态
=====================

::

    OP= 02
    LEN= 变化
    00 ? 第一位（值为 2）表示死人开关的状态
    01 第八位如果效果正在播放则设置。第 0 到第 7 位是效果 ID
    02 ??
    03 参数块地址更改（低位）
    04 参数块地址更改（高位）
    05 第二个参数块地址更改（低位）
    ... 根据更新的参数块数量变化

力效果
------------

::

    OP= 01
    LEN= 0e
    00 通道（当同时播放多个效果时，每个效果必须分配一个通道）
    01 波形
        值 00 常量
        值 20 方波
        值 21 三角波
        值 22 正弦波
        值 23 上锯齿波
        值 24 下锯齿波
        值 40 弹簧（力 = f(位置)）
        值 41 摩擦（力 = f(速度)) 和 惯性（力 = f(加速度))

    02 受影响的轴和触发器
        位 4-7：值 2 = 沿一个轴的效果。字节 05 表示方向
            值 4 = 仅 X 轴。字节 05 必须包含 5a
            值 8 = 仅 Y 轴。字节 05 必须包含 b4
            值 c = X 和 Y 轴。字节 05 必须包含 60
        位 0-3：值 0 = 无触发器
            值 x+1 = 按钮 x 触发效果
        当整个字节为 0 时，取消先前设置的触发器

    03-04 效果持续时间（小端编码，以毫秒为单位）

    05 效果的方向（如适用）。否则，参见 02 中的赋值
    06-07 触发之间的最短时间
    08-09 周期性或幅度参数地址
    0a-0b 攻击和衰减参数地址，如果没有则为 ffff
*或*

08-09 X轴的交互参数地址，或ffff（如果不可用）
0a-0b Y轴的交互参数地址，或ffff（如果不可用）

0c-0d 效果执行前的延迟（小端字节序编码，单位：毫秒）

基于时间的参数
---------------------

攻击和衰减
^^^^^^^^^^^^^^^

```
OP=  02
LEN= 08
00-01 存储参数的地址
02-03 攻击持续时间（小端字节序编码，单位：毫秒）
04 攻击结束时的电平。有符号字节
05-06 衰减持续时间
07 衰减结束时的电平
幅度
^^^^^^^^^

```

```
OP=  03
LEN= 03
00-01 地址
02 电平。有符号字节
周期性
^^^^^^^^^^^

```

```
OP=  04
LEN= 07
00-01 地址
02 幅度。有符号字节
03 偏移量。有符号字节
04 相位。值00 = 0度，值40 = 90度
05-06 周期（小端字节序编码，单位：毫秒）
```

交互参数
----------------------

```
OP=  05
LEN= 0a
00-01 地址
02 正系数
03 负系数
04-05 偏移量（中心）
06-07 死区（值01F4 = 5000（十进制））
08 正饱和（值0a = 1000（十进制），值64 = 10000（十进制））
09 负饱和
```

这里的编码有些特殊：对于系数，它们是有符号值。最大值为64（十进制100），最小值为9c。
对于偏移量，最小值为FE0C，最大值为01F4。
对于死区，最小值为0，最大值为03E8。
控制
--------

::

    OP=  41
    LEN= 03
    00 通道
    01 启动/停止
        值 00: 停止
        值 01: 启动并播放一次
    值 41: 启动并播放 n 次（参见下面的字节 02）
    02 迭代次数 n
初始化
----

查询功能
^^^^^^^^^^^^^^^^^^

::

    OP=  ff
    查询命令。长度根据查询类型变化
此类数据包的一般格式为：
    ff 01 QUERY [INDEX] CHECKSUM
响应的形式相同：
    FF LEN QUERY VALUE_QUERIED CHECKSUM2
其中 LEN = 1 + VALUE_QUERIED 的长度

查询内存大小
~~~~~~~~~~~~~~

::

    QUERY = 42 （'B'uffer 大小）

设备应回复相同的包加上两个额外的字节，包含内存的大小：
ff 03 42 03 e8 CS 表示设备有 1000 字节的 RAM 可用
查询效果数量
~~~~~~~~~~~~~~~~~~~~~~~

::

    QUERY = 4e （'N'umber of 效果）

设备应通过发送可以同时播放的效果数量来响应（一个字节）
ff 02 4e 14 CS 表示有 20 个效果
供应商 ID
~~~~~~~~~~~

::

    QUERY = 4d ('M'anufacturer)

查询供应商 ID（2 个字节）

产品 ID
~~~~~~~~~~

::

    QUERY = 50 ('P'roduct)

查询产品 ID（2 个字节）

打开设备
~~~~~~~~~~~

::

    QUERY = 4f ('O'pen)

无数据返回
关闭设备
~~~~~~~~~~~~

::

    QUERY = 43 ('C')lose

无数据返回
查询效果
~~~~~~~~~~~~

::

    QUERY = 45 ('E')

发送效果类型
如果支持则返回非零值（2 个字节）

固件版本
~~~~~~~~~~~~~~~~

::

    QUERY = 56 ('V'ersion)

返回 3 个字节 - 主版本、次版本、子版本

设备初始化
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

设置控制
~~~~~~~~~~~

.. note::
    设备依赖，不同型号可能有所不同！

::

    OP=  40 <idx> <val> [<val>]
    LEN= 2 或 3
    00 Idx
       Idx 00 设置死区（0..2048）
       Idx 01 忽略 Deadman 传感器（0..1）
       Idx 02 启用通信看门狗（0..1）
       Idx 03 设置弹簧的强度（0..100）
       Idx 04 启用或禁用弹簧（0/1）
       Idx 05 设置轴饱和阈值（0..2048）

设置效果状态
~~~~~~~~~~~~~~~~

::

    OP=  42 <val>
    LEN= 1
    00 状态
       第 3 位 暂停力反馈
       第 2 位 启用力反馈
       第 0 位 停止所有效果

设置整体增益
~~~~~~~~~~~

::

    OP=  43 <val>
    LEN= 1
    00 增益
       值 00 = 0%
       值 40 = 50%
       值 80 = 100%

参数内存
----------------

每个设备都有一定量的内存来存储效果参数
RAM 的数量可能会有所不同，我遇到过从 200 到 1000 字节的值。下面是每组参数显然所需的内存量：

- 周期：0c
- 幅度：02
- 攻击和褪色：0e
- 互动：08

附录：如何研究协议？
=====================

1. 使用 DirectX SDK 提供的力编辑器生成效果，或者使用 Immersion Studio（在他们的开发者部分免费提供：www.immersion.com）
2. 开启软窥探 RS232 或 USB（取决于你连接了操纵杆/方向盘的位置）。我使用的是 fCoder 的 ComPortSpy（Alpha 版本！）
3. 播放效果，并观察监视屏幕上的情况
关于ComPortSpy的几点说明：
乍一看，这个软件似乎有些，嗯，好吧……有点bug。实际上，数据显示时会有几秒钟的延迟。就我个人而言，每次播放效果时我都会重启它。
请记住，它是免费的（免费啤酒的那种）并且仍处于alpha测试阶段！

网址
====
如需了解Immersion Studio，请访问 http://www.immerse.com
如需了解ComPortSpy，请访问 http://www.fcoder.com
I-Force是Immersion Corp的商标
