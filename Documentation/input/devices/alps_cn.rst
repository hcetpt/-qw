----------------------
ALPS 触摸板协议
----------------------

介绍
------------
目前，ALPS 触摸板驱动程序支持七个由 ALPS 触摸板使用的协议版本，称为版本 1、2、3、4、5、6、7 和 8。自大约 2010 年中期以来，已经发布了几种新的 ALPS 触摸板，并集成到各种笔记本电脑和上网本中。这些新触摸板的行为差异足够大，使得描述不同版本特性的 alps_model_data 定义表已不再适用。设计选择是重新定义 alps_model_data 表，但存在回归测试现有设备的风险，或者将新设备隔离在 alps_model_data 表之外。选择了后者。新的触摸板签名命名为：“Rushmore”、“Pinnacle”和“Dolphin”，你可以在 alps.c 代码中看到。

为了本文档的目的，这一组 ALPS 触摸板将统称为“新的 ALPS 触摸板”。我们尝试通过探测 ACPI 接口的 _HID（硬件 ID）/_CID（兼容性 ID）定义来唯一识别不同的 ALPS 变体，但似乎没有一对一的映射关系。实际上，_HID 与实际硬件类型之间似乎是一个多对多的映射关系。

检测
---------
所有 ALPS 触摸板都应响应“E6 报告”命令序列：E8-E6-E6-E6-E9。如果没有任何按键被按下，ALPS 触摸板应该响应 00-00-0A 或 00-00-64。如果某些按键被按下，第一个字节的位 0-2 将为 1。

如果 E6 报告成功，使用“E7 报告”序列：E8-E7-E7-E7-E9 来识别触摸板型号。响应是模型签名，并与 alps_model_data_array 中的已知模型进行匹配。

对于支持协议版本 3 和 4 的旧触摸板，E7 报告模型签名始终为 73-02-64。要区分这些版本，必须检查“进入命令模式”序列的响应，如下面所述。

新的 ALPS 触摸板具有 E7 签名 73-03-50 或 73-03-0A，但似乎通过 EC 命令模式响应更好地进行区分。

命令模式
------------

协议版本 3 和 4 具有一种命令模式，用于在一个 16 位地址空间内读写一个字节的设备寄存器。命令序列 EC-EC-EC-E9 将设备置于命令模式，设备将响应 88-07 后跟第三个字节。这个第三个字节可用于确定设备是否使用版本 3 或 4 协议。
为了退出命令模式，需要向触摸板发送 `PSMOUSE_CMD_SETSTREAM (EA)`。
在命令模式下，可以通过发送特定命令来设置寄存器地址，对于版本3的设备使用 `EC` 命令，对于版本4的设备使用 `F5` 命令。然后逐个发送地址的四位（nibble），每个四位被编码为一个带有可选数据的命令。这种编码在版本3和版本4协议之间略有不同。
一旦设置了地址，就可以通过发送 `PSMOUSE_CMD_GETINFO (E9)` 来读取该地址的寄存器。响应的前两个字节包含正在读取的寄存器地址，第三个字节包含寄存器的值。写入寄存器时，使用与地址相同的编码逐个四位进行写入。
对于新的ALPS触摸板，使用 `EC` 命令进入命令模式。新ALPS触摸板的响应显著不同，并且在确定行为方面更为重要。这段代码已经从原始的 `alps_model_data` 表中分离出来，并放在了 `alps_identify` 函数中。例如，“Dolphin” 触摸板似乎有两种硬件初始化序列，这取决于 `EC` 响应的第二个字节。

### 包格式
在以下表格中，使用如下表示法：
- 大写字母 = 指点杆
- 小写字母 = 触摸板

“?” 在不同的模型上可以有不同的含义，例如滚轮旋转、额外按钮、双指指点杆的按钮等。

### PS/2包格式
```
字节 0:  0    0 YSGN XSGN    1    M    R    L
字节 1: X7   X6   X5   X4   X3   X2   X1   X0
字节 2: Y7   Y6   Y5   Y4   Y3   Y2   Y1   Y0
```

注意，设备从未发出溢出条件信号。
对于版本2设备，在使用指点杆并且手指未接触触摸板时，M R L位指示指点杆和触摸板按钮的组合状态。

### ALPS 绝对模式 - 协议版本 1
```
字节 0:  1    0    0    0    1   x9   x8   x7
字节 1:  0   x6   x5   x4   x3   x2   x1   x0
字节 2:  0    ?    ?    l    r    ?  fin  ges
字节 3:  0    ?    ?    ?    ?   y9   y8   y7
字节 4:  0   y6   y5   y4   y3   y2   y1   y0
字节 5:  0   z6   z5   z4   z3   z2   z1   z0
```

### ALPS 绝对模式 - 协议版本 2
```
字节 0:  1    ?    ?    ?    1  PSM  PSR  PSL
字节 1:  0   x6   x5   x4   x3   x2   x1   x0
字节 2:  0  x10   x9   x8   x7    ?  fin  ges
字节 3:  0   y9   y8   y7    1    M    R    L
字节 4:  0   y6   y5   y4   y3   y2   y1   y0
字节 5:  0   z6   z5   z4   z3   z2   z1   z0
```

版本2的双指设备会为双指指点杆发送标准PS/2鼠标包。M, R 和 L位指示指点杆和触摸板按钮的组合状态，但对于戴尔双指设备，指点杆的按钮会在PSM, PSR 和 PSL位中单独报告。

### 双指设备 —— 交错包格式
```
字节 0:    1    1    0    0    1    1    1    1
字节 1:    0   x6   x5   x4   x3   x2   x1   x0
字节 2:    0  x10   x9   x8   x7    0  fin  ges
字节 3:    0    0 YSGN XSGN    1    1    1    1
字节 4:   X7   X6   X5   X4   X3   X2   X1   X0
字节 5:   Y7   Y6   Y5   Y4   Y3   Y2   Y1   Y0
字节 6:    0   y9   y8   y7    1    m    r    l
字节 7:    0   y6   y5   y4   y3   y2   y1   y0
字节 8:    0   z6   z5   z4   z3   z2   z1   z0
```

使用交错格式的设备通常为双指指点杆发送标准PS/2鼠标包，并为触摸板发送ALPS绝对模式包，在同时使用指点杆和触摸板时切换到交错包格式。

### ALPS 绝对模式 - 协议版本 3
ALPS 协议版本3有三种不同的包格式。前两种与触摸板事件相关，第三种与指点杆事件相关。
第一种类型是触控板位置数据包：

字节 0:    1    ?   x1   x0    1    1    1    1  
字节 1:    0  x10   x9   x8   x7   x6   x5   x4  
字节 2:    0  y10   y9   y8   y7   y6   y5   y4  
字节 3:    0    M    R    L    1    m    r    l  
字节 4:    0   mt   x3   x2   y3   y2   y1   y0  
字节 5:    0   z6   z5   z4   z3   z2   z1   z0  

请注意，对于某些设备，轨迹棒按钮会在此数据包中报告，而在其他设备中则在轨迹棒数据包中报告。
第二种数据包类型包含代表X轴和Y轴的位图。在这些位图中，如果某一位被设置，则表示在给定轴上有手指覆盖该位置。因此，位图数据包可用于低分辨率的多点触摸数据，尽管无法进行手指跟踪。此数据包还编码了接触点的数量（表中的f1和f0）：

字节 0:    1    1   x1   x0    1    1    1    1  
字节 1:    0   x8   x7   x6   x5   x4   x3   x2  
字节 2:    0   y7   y6   y5   y4   y3   y2   y1  
字节 3:    0  y10   y9   y8    1    1    1    1  
字节 4:    0  x14  x13  x12  x11  x10   x9   y0  
字节 5:    0    1    ?    ?    ?    ?   f1   f0  

此数据包仅出现在设置了mt位的位置数据包之后，并且通常只有在有两个或更多接触点时才会出现（尽管偶尔也会在只有一个接触点时看到）。
最后一种v3数据包类型是轨迹棒数据包：

字节 0:    1    1   x7   y7    1    1    1    1  
字节 1:    0   x6   x5   x4   x3   x2   x1   x0  
字节 2:    0   y6   y5   y4   y3   y2   y1   y0  
字节 3:    0    1   TP   SW    1    M    R    L  
字节 4:    0   z6   z5   z4   z3   z2   z1   z0  
字节 5:    0    0    1    1    1    1    1    1  

TP 表示当启用点击处理时为点击状态，当启用按压处理时为按压状态。SW 表示当有四个按钮可用时为向上滚动。

ALPS 绝对模式 - 协议版本 4
-------------------------------

协议版本 4 有一个8字节的数据包格式：

字节 0:    1    ?   x1   x0    1    1    1    1  
字节 1:    0  x10   x9   x8   x7   x6   x5   x4  
字节 2:    0  y10   y9   y8   y7   y6   y5   y4  
字节 3:    0    1   x3   x2   y3   y2   y1   y0  
字节 4:    0    ?    ?    ?    1    ?    r    l  
字节 5:    0   z6   z5   z4   z3   z2   z1   z0  
字节 6:    位图数据（如下描述）  
字节 7:    位图数据（如下描述）

最后两个字节代表一个部分位图数据包，需要三个完整的数据包才能构建一个完整的位图数据包。一旦组装完成，6字节的位图数据包具有以下格式：

字节 0:    0    1   x7   x6   x5   x4   x3   x2  
字节 1:    0   x1   x0   y4   y3   y2   y1   y0  
字节 2:    0    0    ?  x14  x13  x12  x11  x10  
字节 3:    0   x9   x8   y9   y8   y7   y6   y5  
字节 4:    0    0    0    0    0    0    0    0  
字节 5:    0    0    0    0    0    0    0  y10  

这里有几个值得注意的地方：
1) 在位图数据中，字节 0 的第6位作为同步字节，用于标识位图数据包的第一个片段。
2) 位图代表与v3位图数据包相同的数据，尽管数据包布局不同。
3) 在v4协议数据包中似乎没有接触点数量的计数。必须通过分析位图来推导出接触点数量。
4) 位置数据包与位图数据包的比例为3:1。因此，MT位置只能在每第三次ST位置更新时更新，并且接触点数量也只能每隔第三个数据包更新一次。
到目前为止，尚未遇到任何带有轨迹棒的v4设备。

ALPS 绝对模式 - 协议版本 5
-------------------------------

这基本上是协议版本 3，但使用了不同的数据包解码逻辑。它使用相同的alps_process_touchpad_packet_v3调用，并通过一个专门的decode_fields函数指针正确解释数据包。这似乎只被Dolphin设备所使用。
对于单点触摸，6字节数据包格式如下：

字节 0:    1    1    0    0    1    0    0    0
字节 1:    0   x6   x5   x4   x3   x2   x1   x0
字节 2:    0   y6   y5   y4   y3   y2   y1   y0
字节 3:    0    M    R    L    1    m    r    l
字节 4:   y10  y9   y8   y7  x10   x9   x8   x7
字节 5:    0   z6   z5   z4   z3   z2   z1   z0

对于多点触摸，格式如下：

字节 0:    1    1    1    n3   1   n2   n1   x24
字节 1:    1   y7   y6    y5  y4   y3   y2    y1
字节 2:    ?   x2   x1   y12 y11  y10   y9    y8
字节 3:    0  x23  x22   x21 x20  x19  x18   x17
字节 4:    0   x9   x8    x7  x6   x5   x4    x3
字节 5:    0  x16  x15   x14 x13  x12  x11   x10

ALPS 绝对模式 - 协议版本 6
---------------------------------------

对于轨迹棒数据包，格式如下：

字节 0:    1    1    1    1    1    1    1    1
字节 1:    0   X6   X5   X4   X3   X2   X1   X0
字节 2:    0   Y6   Y5   Y4   Y3   Y2   Y1   Y0
字节 3:    ?   Y7   X7    ?    ?    M    R    L
字节 4:   Z7   Z6   Z5   Z4   Z3   Z2   Z1   Z0
字节 5:    0    1    1    1    1    1    1    1

对于触摸板数据包，格式如下：

字节 0:    1    1    1    1    1    1    1    1
字节 1:    0    0    0    0   x3   x2   x1   x0
字节 2:    0    0    0    0   y3   y2   y1   y0
字节 3:    ?   x7   x6   x5   x4    ?    r    l
字节 4:    ?   y7   y6   y5   y4    ?    ?    ?
字节 5:   z7   z6   z5   z4   z3   z2   z1   z0

（V6 触摸板没有中间按钮）

ALPS 绝对模式 - 协议版本 7
---------------------------------------

对于轨迹棒数据包，格式如下：

字节 0:    0    1    0    0    1    0    0    0
字节 1:    1    1    *    *    1    M    R    L
字节 2:   X7    1   X5   X4   X3   X2   X1   X0
字节 3:   Z6    1   Y6   X6    1   Y2   Y1   Y0
字节 4:   Y7    0   Y5   Y4   Y3    1    1    0
字节 5:  T&P    0   Z5   Z4   Z3   Z2   Z1   Z0

对于触摸板数据包，格式如下：

         数据包格式     b7     b6     b5     b4     b3     b2     b1     b0
字节 0: TWO & MULTI     L      1      R      M      1   Y0-2   Y0-1   Y0-0
字节 0: NEW             L      1   X1-5      1      1   Y0-2   Y0-1   Y0-0
字节 1:             Y0-10   Y0-9   Y0-8   Y0-7   Y0-6   Y0-5   Y0-4   Y0-3
字节 2:             X0-11      1  X0-10   X0-9   X0-8   X0-7   X0-6   X0-5
字节 3:             X1-11      1   X0-4   X0-3      1   X0-2   X0-1   X0-0
字节 4: TWO         X1-10    TWO   X1-9   X1-8   X1-7   X1-6   X1-5   X1-4
字节 4: MULTI       X1-10    TWO   X1-9   X1-8   X1-7   X1-6   Y1-5      1
字节 4: NEW         X1-10    TWO   X1-9   X1-8   X1-7   X1-6      0      0
字节 5: TWO & NEW   Y1-10      0   Y1-9   Y1-8   Y1-7   Y1-6   Y1-5   Y1-4
字节 5: MULTI       Y1-10      0   Y1-9   Y1-8   Y1-7   Y1-6    F-1    F-0

L:         左键
R / M:     非点击式触摸板：右键 / 中间键
            点击式触摸板：当有超过两个手指时，并且有些手指位于按钮区域，
            报告的两个坐标是位于按钮区域外的手指，并报告在右 / 左按钮区域内存在额外的手指。
            注意这些手指不会被添加到 F 字段！因此如果接收到 TWO 数据包并且 R = 1，
            则有三个手指放在触摸板上等
TWO:       1: 有两个触摸点，字节 0/4/5 为 TWO 格式
            0: 如果字节 4 的第 0 位为 1，则字节 0/4/5 为 MULTI 格式
               否则字节 0 的第 4 位必须设置，并且字节 0/4/5 为 NEW 格式
F:         手指数量 - 3，0 表示 3 个手指，1 表示 4 个手指等

ALPS 绝对模式 - 协议版本 8
---------------------------------------

由 SS4 (73 03 14) 和 SS5 (73 03 28) 硬件支持
数据包类型由 APD 字段给出，即字节 3 的第 4-5 位
触摸板数据包 (APD = 0x2)::

           b7   b6   b5   b4   b3   b2   b1   b0
字节 0:  SWM  SWR  SWL    1    1    0    0   X7
字节 1:    0   X6   X5   X4   X3   X2   X1   X0
字节 2:    0   Y6   Y5   Y4   Y3   Y2   Y1   Y0
字节 3:    0  T&P    1    0    1    0    0   Y7
字节 4:    0   Z6   Z5   Z4   Z3   Z2   Z1   Z0
字节 5:    0    0    0    0    0    0    0    0

SWM, SWR, SWL: 中间、右、左按钮状态

触摸板单指数据包 (APD = 0x0)::

           b7   b6   b5   b4   b3   b2   b1   b0
字节 0:  SWM  SWR  SWL    1    1   X2   X1   X0
字节 1:   X9   X8   X7    1   X6   X5   X4   X3
字节 2:    0  X11  X10  LFB   Y3   Y2   Y1   Y0
字节 3:   Y5   Y4    0    0    1 TAPF2 TAPF1 TAPF0
字节 4:  Zv7  Y11  Y10    1   Y9   Y8   Y7   Y6
字节 5:  Zv6  Zv5  Zv4    0  Zv3  Zv2  Zv1  Zv0

TAPF: ???
LFB:  ???

触摸板双指数据包 (APD = 0x1)::

           b7   b6   b5   b4   b3   b2   b1   b0
字节 0:  SWM  SWR  SWL    1    1  AX6  AX5  AX4
字节 1: AX11 AX10  AX9  AX8  AX7  AZ1  AY4  AZ0
字节 2: AY11 AY10  AY9  CONT AY8  AY7  AY6  AY5
字节 3:    0    0    0    1    1  BX6  BX5  BX4
字节 4: BX11 BX10  BX9  BX8  BX7  BZ1  BY4  BZ0
字节 5: BY11 BY10  BY9    0  BY8  BY7  BY5  BY5

CONT: 接下来是一个 3 或 4 指数据包

触摸板 3 或 4 指数据包 (APD = 0x3)::

           b7   b6   b5   b4   b3   b2   b1   b0
字节 0:  SWM  SWR  SWL    1    1  AX6  AX5  AX4
字节 1: AX11 AX10  AX9  AX8  AX7  AZ1  AY4  AZ0
字节 2: AY11 AY10  AY9  OVF  AY8  AY7  AY6  AY5
字节 3:    0    0    1    1    1  BX6  BX5  BX4
字节 4: BX11 BX10  BX9  BX8  BX7  BZ1  BY4  BZ0
字节 5: BY11 BY10  BY9    0  BY8  BY7  BY5  BY5

OVF: 检测到第五个手指
