### SPDX 许可证标识符: GPL-2.0

#### PCI vNTB 功能

##### 作者: Frank Li <Frank.Li@nxp.com>

PCI NTB 功能与 PCI vNTB 功能之间的区别在于：

- PCI NTB 功能需要两个端点实例并连接 HOST1 和 HOST2；
- PCI vNTB 功能仅使用一个主机和一个端点（EP），通过 NTB 连接 EP 和 PCI 主机。

```plaintext
+------------+         +---------------------------------------+
|            |         |                                       |
+------------+         |                        +--------------+
| NTB        |         |                        | NTB          |
| NetDev     |         |                        | NetDev       |
+------------+         |                        +--------------+
| NTB        |         |                        | NTB          |
| Transfer   |         |                        | Transfer     |
+------------+         |                        +--------------+
|            |         |                        |              |
|  PCI NTB   |         |                        |              |
|    EPF     |         |                        |              |
|   Driver   |         |                        | PCI Virtual  |
|            |         |                        | NTB Driver   |
+------------+         |                        +--------------+
|            |         |                        |              |
|  PCI BUS   | <-----> |  PCI EP BUS   |        |  Virtual PCI |
|            |  PCI    |               |        |     BUS      |
+------------+         +---------------+--------+--------------+
      PCI RC                        PCI EP
```

用于实现 vNTB 的构造
=====================

1. 配置区域
2. 自用暂存区寄存器
3. 对等方暂存区寄存器
4. 门铃（DB）寄存器
5. 内存窗口（MW）

配置区域：
--------------

与 PCI NTB 功能驱动相同

暂存区寄存器：
---------------------

位于配置区域之后
```plaintext
+--------------------------------------------------+ Base
|                                                  |
|                                                  |
|                                                  |
|          公共配置寄存器                          |
|                                                  |
|                                                  |
|                                                  |
+-----------------------+--------------------------+ Base + span_offset
|                       |                          |
|    对等方跨度空间     |    跨度空间              |
|                       |                          |
|                       |                          |
+-----------------------+--------------------------+ Base + span_offset
|                       |                          |      + span_count * 4
|                       |                          |
|     跨度空间          |   对等方跨度空间         |
|                       |                          |
+-----------------------+--------------------------+
        虚拟 PCI             PCIe 端点
        NTB 驱动               NTB 驱动
```

门铃寄存器：
-------------------

由主机用来互相中断

内存窗口：
--------------

两个主机之间实际的数据传输是通过内存窗口完成的

建模构造：
=============

32位 BAR
======  ===============
BAR 编号  使用的构造
======  ===============
BAR0    配置区域
BAR1    门铃
BAR2    内存窗口 1
BAR3    内存窗口 2
BAR4    内存窗口 3
BAR5    内存窗口 4
======  ===============

64位 BAR
======  ===============================
BAR 编号  使用的构造
======  ===============================
BAR0    配置区域 + 暂存区
BAR1
BAR2    门铃
BAR3
BAR4    内存窗口 1
BAR5
======  ===============================
```
