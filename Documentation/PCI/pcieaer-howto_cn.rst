### SPDX 许可证标识符: GPL-2.0
### 包含: <isonum.txt>

===========================================================
PCI Express 高级错误报告驱动程序指南 HOWTO
===========================================================

**作者:** - T. Long Nguyen <tom.l.nguyen@intel.com>
          - Yanmin Zhang <yanmin.zhang@intel.com>

**版权:** © 2006 Intel Corporation

概述
===========

#### 关于本指南

本指南描述了 PCI Express (PCIe) 高级错误报告 (AER) 驱动程序的基础知识，并提供了如何使用它的信息，以及如何使终端设备的驱动程序符合 PCIe AER 驱动程序的要求。

#### 什么是 PCIe AER 驱动程序？

PCIe 错误信号可能发生在 PCIe 链路上或由链路上发起的事务触发。PCIe 定义了两种错误报告范式：基线能力和高级错误报告能力。基线能力是所有 PCIe 组件必须具备的，提供了一组最低定义的错误报告要求。高级错误报告能力通过一个 PCIe 高级错误报告扩展功能结构实现，提供更强大的错误报告。

PCIe AER 驱动程序提供了支持 PCIe 高级错误报告能力所需的基础设施。PCIe AER 驱动程序提供了以下三个基本功能：

  - 如果发生错误，则收集全面的错误信息
  - 向用户报告错误
  - 执行错误恢复操作
AER 驱动程序仅附加到支持 PCIe AER 能力的根端口和 RCEC 上。

用户指南
==========

#### 将 PCIe AER 根驱动程序包含到 Linux 内核中

PCIe AER 驱动程序是一个根端口服务驱动程序，通过 PCIe 端口总线驱动程序进行连接。如果用户想要使用它，必须编译该驱动程序。它通过 CONFIG_PCIEAER 进行启用，这依赖于 CONFIG_PCIEPORTBUS。

#### 加载 PCIe AER 根驱动程序

某些系统在固件中支持 AER。同时启用固件处理 AER 和 Linux AER 支持可能会导致不可预测的行为。因此，除非固件通过 ACPI _OSC 方法将 AER 控制权授予操作系统，否则 Linux 不会处理 AER 事件。关于 _OSC 使用的详细信息，请参阅 PCI 固件规范。

#### AER 错误输出

当捕获到 PCIe AER 错误时，将在控制台上输出一条错误消息。如果是可纠正的错误，则作为信息消息输出；否则，将以错误的形式打印。因此，用户可以选择不同的日志级别来过滤掉可纠正的错误消息。
Below shows an example:

  0000:50:00.0: PCIe Bus 错误: 严重性=未校正 (致命), 类型=传输层, id=0500(请求者ID)
  0000:50:00.0:   设备 [8086:0329] 错误状态/掩码=00100000/00000000
  0000:50:00.0:    [20] 不支持的请求    (首次)
  0000:50:00.0:   TLP 头部: 04000001 00200a03 05010000 00050100

在示例中，“请求者ID”指的是发送错误信息到根端口的设备的ID。请参考PCIe规范了解其他字段。
AER统计信息/计数器
-------------------------
当捕获PCIe AER错误时，也会以sysfs属性的形式暴露计数器/统计信息，这些内容记录在Documentation/ABI/testing/sysfs-bus-pci-devices-aer_stats中。

开发者指南
===============
为了启用错误恢复，软件驱动程序必须提供回调函数。
为了更好地支持AER，开发者需要理解AER的工作原理。
PCIe错误被分为两类：可校正错误和不可校正错误。这种分类基于这些错误的影响，可能导致性能下降或功能失败。
可校正错误对接口的功能没有影响。PCIe协议可以在没有任何软件干预或数据丢失的情况下自行恢复。这些错误由硬件检测并校正。
与可校正错误不同，不可校正错误会影响接口的功能。不可校正错误可能导致特定的事务处理或特定的PCIe链路变得不可靠。根据不同的错误情况，不可校正错误进一步分为非致命错误和致命错误。
非致命错误会导致特定事务处理变得不可靠，但PCIe链路本身仍然完全可用。而致命错误则导致链路变得不可靠。
当PCIe错误报告被启用时，设备在捕获错误时会自动向其上方的根端口发送错误消息。根端口在接收到错误报告消息后，会在其AER能力结构内部处理并记录错误消息。记录的错误信息包括将错误报告代理的请求者ID存储在错误源识别寄存器中，并相应地设置根错误状态寄存器中的错误位。如果在根错误命令寄存器中启用了AER错误报告，则根端口在检测到错误时会生成中断。
需要注意的是，上述提到的错误与PCIe层次结构和链路相关。这些错误不包括任何特定于设备的错误，因为特定于设备的错误仍会直接发送给设备驱动程序。
提供回调函数
-----------------
回调函数reset_link用于重置PCIe链路
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
此回调函数用于在发生致命错误时重置PCIe物理链路。根端口AER服务驱动程序提供了一个默认的reset_link函数，但由于不同的上游端口可能有不同的重置PCIe链路的规范，因此上游端口驱动程序可能会提供自己的reset_link函数。
### 第 3.2.2.2 节 提供了何时调用 `reset_link` 的更详细信息
PCI 错误恢复回调
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

PCIe AER 根驱动程序使用错误回调来与相关层次结构中的下游设备驱动程序进行协调，执行错误恢复操作。
数据结构 `struct pci_driver` 包含一个指针 `err_handler`，指向 `pci_error_handlers`，后者包含几个回调函数指针。AER 驱动遵循在 `pci-error-recovery.rst` 中定义的规则，除了 PCI Express 特定的部分（例如 `reset_link`）。请参阅 `pci-error-recovery.rst` 获取关于这些回调的详细定义。

下面的各节指定了何时调用错误回调函数。

可校正错误
~~~~~~~~~~~~~~~~~~

可校正错误对接口的功能没有影响。PCIe 协议可以在没有任何软件干预或数据丢失的情况下自行恢复。这些错误不需要任何恢复措施。AER 驱动程序会相应地清除设备的可校正错误状态寄存器，并记录这些错误。

不可校正（非致命和致命）错误
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

如果错误消息指示的是非致命错误，则无需在上游执行链路重置。AER 驱动程序将调用 `error_detected(dev, pci_channel_io_normal)` 给该层次结构内的所有驱动程序。例如：

```
终端 <==> 下游端口 B <==> 上游端口 A <==> 根端口
```

如果上游端口 A 捕获了一个 AER 错误，那么这个层次结构包括下游端口 B 和终端。
驱动程序可能会返回 `PCI_ERS_RESULT_CAN_RECOVER`、`PCI_ERS_RESULT_DISCONNECT` 或 `PCI_ERS_RESULT_NEED_RESET`，这取决于它是否能够恢复或者 AER 驱动程序接下来调用 `mmio_enabled`。

如果错误消息指示的是致命错误，内核将广播 `error_detected(dev, pci_channel_io_frozen)` 给该层次结构内的所有驱动程序。此时，在上游执行链路重置是必要的。由于不同类型的设备可能采用不同的链路重置方法，因此需要 AER 端口服务驱动程序通过 `pcie_do_recovery()` 函数的回调参数提供重置链路的函数。如果 `reset_link` 不为 `NULL`，恢复函数将使用它来重置链路。如果 `error_detected` 返回 `PCI_ERS_RESULT_CAN_RECOVER` 并且 `reset_link` 返回 `PCI_ERS_RESULT_RECOVERED`，则错误处理将进入 `mmio_enabled`。

常见问题解答
------------------------

**问：**
如果 PCIe 设备驱动程序没有提供错误恢复处理器（即 `pci_driver->err_handler` 等于 `NULL`），会发生什么？

**答：**
与该驱动程序关联的设备将不会被恢复。如果是致命错误，内核将打印警告消息。更多信息请参考第 3 节。
### Q:
如果上游端口服务驱动程序未提供回调函数`reset_link`，会发生什么？

### A:
如果由服务驱动程序连接的上游端口报告错误，则致命错误恢复将失败。

### 软件错误注入
####

调试PCIe AER错误恢复代码非常困难，因为很难触发真实的硬件错误。可以使用基于软件的错误注入来模拟各种类型的PCIe错误。
首先，您需要在内核配置中启用PCIe AER软件错误注入，也就是说，您的`.config`文件中应该包含以下项：
```
CONFIG_PCIEAER_INJECT=y
```
或者
```
CONFIG_PCIEAER_INJECT=m
```

使用新内核重启系统或加载模块后，会创建一个名为`/dev/aer_inject`的设备文件。
然后，您需要一个用户空间工具，名为`aer-inject`，可以从以下地址获取：

    https://github.com/intel/aer-inject.git

关于`aer-inject`的更多信息可以在其源代码文档中找到。
