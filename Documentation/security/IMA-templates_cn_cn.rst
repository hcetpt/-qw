### IMA 模板管理机制

#### 引言

原始的 ``ima`` 模板是固定长度的，包含文件数据哈希和路径名。文件数据哈希限制为20字节（md5/sha1）。路径名是一个以空字符终止的字符串，限制为255个字符。为了克服这些限制并添加额外的文件元数据，有必要通过定义额外的模板来扩展当前版本的 IMA。例如，可能报告的信息包括inode的UID/GID或inode以及访问它的进程的LSM标签。然而，引入此功能的主要问题是：每当定义新的模板时，生成和显示测量列表的函数将包含处理新格式的代码，并且随着时间的推移会显著增加。

提出的解决方案通过将模板管理与剩余的 IMA 代码分离来解决这个问题。该解决方案的核心是定义两种新的数据结构：一个模板描述符，用于确定应该在测量列表中包含哪些信息；一个模板字段，用于生成和显示给定类型的数据。

使用这些结构来管理模板非常简单。为了支持新的数据类型，开发人员定义字段标识符并实现两个函数 `init()` 和 `show()`，分别用于生成和显示测量条目。定义一个新的模板描述符需要通过 `ima_template_fmt` 内核命令行参数指定模板格式（由字段标识符组成的字符串，字段之间用 `|` 字符分隔）。在启动时，IMA 通过将格式转换为从支持的集合中提取的一组模板字段结构来初始化所选的模板描述符。

初始化步骤之后，IMA 将调用 `ima_alloc_init_template()`（在用于新模板管理机制的补丁中定义的新函数），以使用内核配置或新引入的 `ima_template` 和 `ima_template_fmt` 内核命令行参数选择的模板描述符生成新的测量条目。在此阶段，新架构的优势明显显现出来：后一个函数不会包含处理特定模板的具体代码，而是简单地调用与所选模板描述符关联的模板字段的 `init()` 方法，并将结果（分配的数据指针和数据长度）存储在测量条目结构中。

同样的机制用于显示测量条目。函数 `ima[_ascii]_measurements_show()` 对于每个条目，检索用于生成该条目的模板描述符，并调用模板字段结构数组中每个项的 `show()` 方法。

#### 支持的模板字段和描述符

以下列出了支持的模板字段 ``('<identifier>': description)``，这些字段可用于通过将它们的标识符添加到格式字符串中来定义新的模板描述符（后续将支持更多数据类型）：

- `'d'`: 事件的摘要（即测量文件的摘要），使用SHA1或MD5哈希算法计算；
- `'n'`: 事件的名称（即文件名），长度最多为255字节；
- `'d-ng'`: 使用任意哈希算法计算的事件摘要（字段格式：<hash algo>:digest）；
- `'d-ngv2'`: 与'd-ng'相同，但前缀为"ima"或"verity"摘要类型（字段格式：<digest type>:<hash algo>:digest）；
- `'d-modsig'`: 不附加modsig的事件摘要；
- `'n-ng'`: 事件的名称，没有大小限制；
- `'sig'`: 文件签名，基于文件或fsverity的摘要[1]，如果'security.ima'包含文件哈希，则为EVM可移植签名；
- `'modsig'`: 附加的文件签名；
- `'buf'`: 用于生成哈希的缓冲区数据，没有大小限制；
- `'evmsig'`: EVM可移植签名；
- `'iuid'`: inode的UID；
- `'igid'`: inode的GID；
- `'imode'`: inode的模式；
- `'xattrnames'`: xattr名称列表（用``|``分隔），仅当存在xattr时；
- `'xattrlengths'`: xattr长度列表（u32），仅当存在xattr时；
- `'xattrvalues'`: xattr值列表；

以下是已定义的模板描述符列表：

- `"ima"`: 其格式为 ``d|n``；
- `"ima-ng"`（默认）: 其格式为 ``d-ng|n-ng``；
- `"ima-ngv2"`: 其格式为 ``d-ngv2|n-ng``；
- `"ima-sig"`: 其格式为 ``d-ng|n-ng|sig``；
- `"ima-sigv2"`: 其格式为 ``d-ngv2|n-ng|sig``；
- `"ima-buf"`: 其格式为 ``d-ng|n-ng|buf``；
- `"ima-modsig"`: 其格式为 ``d-ng|n-ng|sig|d-modsig|modsig``；
- `"evm-sig"`: 其格式为 ``d-ng|n-ng|evmsig|xattrnames|xattrlengths|xattrvalues|iuid|igid|imode``；

#### 使用

要指定用于生成测量条目的模板描述符，目前支持以下方法：

- 从内核配置中支持的模板描述符中选择一个（默认选择为 ``ima-ng``）；
- 通过内核命令行参数 ``ima_template=`` 指定模板描述符名称；
- 通过内核命令行参数 ``ima_template_fmt=`` 注册具有自定义格式的新模板描述符。
