==============================
Linux 容器的虚拟可信平台模块代理驱动
==============================

| 作者:
| Stefan Berger <stefanb@linux.vnet.ibm.com>

本文档描述了为 Linux 容器提供的虚拟可信平台模块 (vTPM) 代理设备驱动。
简介
============

本工作的目标是为每个 Linux 容器提供 TPM 功能。这使得容器中的程序可以像在物理系统上与 TPM 交互一样与 TPM 进行交互。每个容器都会获得一个唯一的、模拟的、软件 TPM。
设计
======

为了使每个容器都能访问模拟的软件 TPM，容器管理堆栈需要创建一个设备对，包括客户端 TPM 字符设备 `/dev/tpmX`（其中 X=0,1,2...）和一个“服务器端”文件描述符。前者通过创建具有适当主次号的字符设备放入容器中，而后者则传递给 TPM 模拟器。这样容器内的软件就可以通过字符设备发送 TPM 命令，而模拟器可以通过文件描述符接收这些命令并用它来发送响应。

为了支持这一点，虚拟 TPM 代理驱动提供了一个设备 `/dev/vtpmx`，用于使用 ioctl 创建设备对。ioctl 接受配置设备的标志作为输入。例如，这些标志表明 TPM 模拟器是否支持 TPM 1.2 或 TPM 2 的功能。

ioctl 的结果是返回“服务器端”的文件描述符以及创建的字符设备的主次号。此外还会返回 TPM 字符设备的编号。例如，如果创建了 `/dev/tpm10`，那么返回的编号 (`dev_num`) 将是 10。

一旦创建了设备，驱动程序将立即尝试与 TPM 通信。所有来自驱动程序的命令都可以从 ioctl 返回的文件描述符读取。这些命令应立即得到响应。
用户空间 API
====

.. kernel-doc:: include/uapi/linux/vtpm_proxy.h

.. kernel-doc:: drivers/char/tpm/tpm_vtpm_proxy.c
   :functions: vtpmx_ioc_new_dev
