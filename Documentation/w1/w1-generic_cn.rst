======================
一总线（w1）子系统简介
======================

一总线是一种简单的主从总线，通过单一信号线（加上地线，因此共有两条线）进行通信。
设备通过开放漏极输出将信号拉至地来在总线上通信，并通过采样信号线的逻辑电平来进行数据读取。
w1子系统提供了管理w1主设备和与从设备通信的框架。
所有w1从设备必须连接到一个w1总线主设备上。
示例w1主设备：

    - DS9490 USB设备
    - 基于GPIO的一线通
    - DS2482（I2C到w1桥接器）
    - 模拟设备，如RS232转换器、并口适配器等

w1子系统做什么？
------------------

当一个w1主驱动程序注册到w1子系统时，会发生以下情况：

 - 为该w1主设备创建sysfs条目
 - 定期搜索w1总线上的新从设备

当在总线上发现设备时，w1核心尝试加载其家族的驱动程序并检查是否已加载。如果加载了，家族驱动程序将被附加到从设备上。
如果没有家族的驱动程序，将分配默认的驱动程序，这允许执行几乎所有类型的操作。每个逻辑操作本质上是一次交易，可以包含几个（两个或一个）低级操作。
让我们看看如何读取EEPROM上下文：
1. 必须写入控制缓冲区，即包含命令字节和两个字节地址的缓冲区。在此步骤中，总线被复位，并使用W1_SKIP_ROM或W1_MATCH_ROM命令选择适当的设备。然后将提供的控制缓冲区写入总线。
2. 读取。这将触发读取EEPROM响应
在1.和2.之间，可能w1主线程会为了搜索而重置总线，甚至移除从设备，但这种情况下会读取0xff，因为没有设备被选中。
W1设备家族
------------------

从属设备由为一组W1设备编写的驱动程序处理。
一个家族驱动程序填充了一个`struct w1_family_ops`结构（参见`w1_family.h`），并注册到W1子系统中。
当前的家族驱动程序包括：

w1_therm
  - （ds18?20温度传感器家族驱动）
    提供了温度读取功能，该功能绑定到上述`w1_family_ops`结构中的`->rbin()`方法。
w1_smem
  - 简单64位内存单元的驱动，提供了ID读取方法。
你可以通过读取相应的sysfs文件来调用上述方法。

W1主控驱动需要实现什么？
-----------------------------------------------

W1总线主控的驱动程序至少需要提供两个函数。
模拟设备必须提供设置输出信号电平（write_bit）和采样信号电平（read_bit）的能力。
原生支持1线的设备必须提供写入和采样比特（touch_bit）以及重置总线（reset_bus）的能力。
大多数硬件提供了更高级别的功能，以卸载W1的处理。
有关详细信息，请参阅`w1.h`中`struct w1_bus_master`定义。
### w1 主控 sysfs 接口
-------------------------

========================= =====================================================
<xx-xxxxxxxxxxxx>         已检测到设备的目录。格式为
                          家族-序列号
bus                       （标准）指向 w1 总线的符号链接
driver                    （标准）指向 w1 驱动的符号链接
w1_master_add             （读写）手动注册从属设备
w1_master_attempts        （只读）搜索尝试的次数
w1_master_max_slave_count （读写）一次可搜索的最大从属设备数
w1_master_name            （只读）设备名称（w1_bus_masterX）
w1_master_pullup          （读写）5V 强上拉 0 启用，1 禁用
w1_master_remove          （读写）手动移除从属设备
w1_master_search          （读写）剩余的搜索次数，
                          -1=持续（默认）
w1_master_slave_count     （只读）已找到的从属设备数量
w1_master_slaves          （只读）从属设备的名称，每行一个
w1_master_timeout         （只读）两次搜索之间的秒延迟
w1_master_timeout_us      （只读）两次搜索之间的微秒延迟
========================= =====================================================

如果您有一个永远不会变化的 w1 总线（您不会添加或移除设备），则可以将模块参数 `search_count` 设置为一个小的正整数以进行初始少量的总线搜索。或者，您可以将其设置为零，然后通过 `w1_master_add` 设备文件手动添加从属设备序列号。当禁用了搜索时，`w1_master_add` 和 `w1_master_remove` 文件通常才有意义，因为搜索会重新检测手动移除的仍在总线上的设备，并且超时手动添加的不在总线上的设备。
总线搜索按照由 `timeout` 和 `timeout_us` 模块参数（其中任何一个都可以是 0）指定的时间间隔进行，只要 `w1_master_search` 大于 0 或者为 -1。每次搜索尝试会使 `w1_master_search` 减少 1（降至 0），并且使 `w1_master_attempts` 增加 1。

### w1 从属 sysfs 接口
------------------------

=================== ============================================================
bus                 （标准）指向 w1 总线的符号链接
driver              （标准）指向 w1 驱动的符号链接
name                设备名称，通常与目录名称相同
w1_slave            （可选）二进制文件，其含义取决于家族驱动
rw                  （可选）为没有适当家族驱动的从属设备创建。允许读写二进制数据
=================== ============================================================
