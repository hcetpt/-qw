======================
内核驱动程序 w1_therm
======================

支持的芯片：

  * 基于 Maxim ds18*20 的温度传感器
* 基于 Maxim ds1825 的温度传感器
* GXCAS GX20MH01 温度传感器
* Maxim MAX31850 热电偶接口
作者: Evgeniy Polyakov <johnpol@2ka.mipt.ru>

描述
-----------

w1_therm 为 ds18*20、ds28ea00、GX20MH01 和 MAX31850 设备提供基本的温度转换功能。
支持的家庭代码：

====================	====
W1_THERM_DS18S20	0x10
W1_THERM_DS1822		0x22
W1_THERM_DS18B20	0x28
W1_THERM_DS1825		0x3B
W1_THERM_DS28EA00	0x42
====================	====

支持是通过 sysfs 入口 `w1_slave` 提供的。每次打开和读取序列都会启动一次温度转换，然后提供两行 ASCII 输出。第一行包含读取的九个十六进制字节以及计算出的 CRC 值，并标记 YES 或 NO 表示是否匹配；如果 CRC 匹配，则保留返回的值。第二行显示保留的值以及在 `t=` 后面的摄氏度千分之一的温度。
或者，可以通过使用 `temperature` sysfs 来读取温度，它仅返回摄氏度千分之一的温度。
可以对总线上的所有设备进行批量读取，方法是在 w1_bus_master 层级将 `trigger` 写入到 `therm_bulk_read` 入口。这会向总线上的所有设备发送转换命令，并且如果检测到寄生供电的设备（并且模块中启用了强上拉），则会在寄生供电设备所需的较长转换时间内使线路保持高电平。读取 `therm_bulk_read` 将返回 0 表示没有待处理的批量转换，-1 表示至少有一个传感器仍在转换过程中，1 表示转换已完成但至少有一个传感器的值尚未被读取。结果温度通过读取每个设备的 `temperature` 入口获得，如果转换还在进行中可能会返回空。需要注意的是，如果发起了批量读取但未立即读取一个传感器，则下次访问该设备的 `temperature` 时将返回批量读取命令发出时测量的温度（而非当前温度）。
如果需要，在转换期间将应用强上拉。
``conv_time`` 用于获取当前的转换时间（读取），并调整它（写入）。温度转换时间取决于设备类型及其当前分辨率。默认的转换时间由驱动程序根据设备数据手册设置。许多原始设备克隆的转换时间与数据手册规格有所偏差。有三种选择：1) 通过向 ``conv_time`` 写入毫秒值手动设置正确的转换时间；2) 通过向 ``conv_time`` 写入 ``1`` 自动测量和设置转换时间；3) 使用 ``features`` 启用轮询以完成转换。选项 2 和 3 在寄生供电模式下不可用。要恢复到默认转换时间，请向 ``conv_time`` 写入 ``0``。
向 ``w1_slave`` 写入分辨率值（位数）将改变传感器下次读取的精度。允许的分辨率由传感器定义。当传感器重新上电时，分辨率会被重置。
为了在 EEPROM 中存储当前分辨率，请向 ``w1_slave`` 写入 ``0``。
由于 EEPROM 的写入次数有限（>50k 次），因此应谨慎使用此命令。
或者，如果传感器支持的话，可以使用每个设备上的专用 ``resolution`` 条目来读取或写入分辨率。
一些非原装的 DS18B20 芯片仅固定在 12 位模式，因此实际分辨率从芯片读回并验证。
注意：更改分辨率会将转换时间恢复为默认值。
只写入的 sysfs 条目 ``eeprom_cmd`` 是 EEPROM 操作的另一种选择。
写入 ``save`` 以将设备 RAM 保存到 EEPROM。写入 ``restore`` 以在设备 RAM 中恢复 EEPROM 数据。
``ext_power`` 条目允许检查每个设备的电源状态。如果设备是寄生供电，则读取 ``0``；如果是外部供电，则读取 ``1``。
Sysfs "alarms" 允许读取或写入 TH 和 TL（温度高和低）报警值。这些值应为空格分隔，并且在设备范围内（通常为 -55°C 到 125°C）。这些值是整数，因为它们存储在设备中的一个8位寄存器中。最低值会自动设置为 TL。一旦设置，可以在主控级别搜索这些报警值。

模块参数 `strong_pullup` 可以设置为 0 来禁用强上拉，设置为 1 来启用自动检测，或者设置为 2 来强制启用强上拉。
在自动检测的情况下，驱动程序将使用 "READ POWER SUPPLY" 命令来检查总线上是否有寄生供电的设备。
如果存在这样的设备，则激活主控的强上拉。
如果使用该命令检测寄生设备失败（对于某些 DS18S20 型号似乎就是这种情况），则可以强制启用强上拉。
如果启用了强上拉，当进行转换时，只要主控驱动支持强上拉（否则回退到上拉电阻），主控的强上拉将被驱动。DS18b20 温度传感器规格表明最大电流消耗为 1.5mA，并且 5k 的上拉电阻是不够的。强上拉的设计就是为了提供所需的额外电流。
DS28EA00 提供了另外两个引脚用于实现序列检测算法。此功能允许您确定芯片在 1-Wire 总线上的物理位置，而无需预先了解总线的排序情况。此功能通过 sysfs 的 "w1_seq" 提供支持。文件将包含一行带有整数值的内容，表示设备在总线上的索引，从 0 开始计数。
"features" sysfs 入口控制每个设备可选的驱动设置。
寄生模式下电源不足、线路噪声以及转换时间不足都可能导致转换失败。原始的 DS18B20 和一些克隆版本允许检测无效的转换。向 "features" 写入位掩码 `1` 来启用转换成功的检查。如果转换后刮板内存的第 6 字节为 0xC 并且温度读数为 85.00（上电值）或 127.94（电源不足），则驱动程序返回转换错误。位掩码 `2` 启用通过在转换开始后在总线上生成读周期来检测转换完成（仅限正常供电）。在寄生供电模式下，此功能不可用。
特性位掩码可以进行组合（使用 OR 操作）。更多细节请参考
Documentation/ABI/testing/sysfs-driver-w1_therm

GX20MH01 设备与 DS18*20 共享家族编号 0x28。该设备通常
与 DS18B20 兼容。在配置寄存器中新增了最低的 2\ :sup:`-5`，2\ :sup:`-6` 温度
位；在配置寄存器中的 R2 位支持 13 和 14 位分辨率。设备上电时处于 14 位分辨率模式。数据手册中规定的转换时间过低，需要增加。该设备支持驱动特性 ``1`` 和 ``2``。
MAX31850 设备与 DS1825 共享家族编号 0x3B。该设备通常
与 DS1825 兼容。配置寄存器的高 4 位读取值全为 1，指示为 15，但设备始终运行在 14 位分辨率模式下。
