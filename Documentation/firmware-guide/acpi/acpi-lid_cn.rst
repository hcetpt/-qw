SPDX 许可证标识符: GPL-2.0
.. include:: <isonum.txt>

=========================================================
ACPI 控制方法盖板设备的特殊使用模型
=========================================================

:版权所有: |copy| 2016, Intel 公司

:作者: Lv Zheng <lv.zheng@intel.com>

摘要
========
包含盖板的平台通过控制方法盖板设备向操作系统内核（OSPMs）传达盖板状态（打开/关闭）。为此，AML 表会发出 Notify(盖板设备, 0x80)，以在盖板状态发生改变时通知操作系统内核。盖板设备的 _LID 控制方法必须实现来报告盖板的“当前”状态为“打开”或“关闭”。对于大多数平台而言，_LID 方法和盖板通知都是可靠的。然而，存在例外情况。为了处理这些异常的有缺陷平台，需要特别考虑一些限制和例外。本文档描述了 Linux ACPI 盖板设备驱动程序的限制和例外。

_LID 控制方法返回值的限制
================================

_LID 控制方法被描述为返回“当前”的盖板状态。但是，“当前”这个词具有模糊性，某些有缺陷的 AML 表返回的是最后一次盖板通知时的状态，而不是最后一次评估 _LID 方法时的状态。当在运行时评估 _LID 控制方法时，这不会产生差异，问题在于其初始返回值。如果 AML 表实现此控制方法时使用缓存值，则初始返回值可能不可靠。有些平台始终将初始盖板状态返回为“关闭”。

盖板状态更改通知的限制
================================

有些有缺陷的 AML 表在盖板状态变更为“打开”时从未发出通知。因此，“打开”通知无法保证。但是，当盖板状态变为“关闭”时，AML 表始终会发出“关闭”通知。该“关闭”通知通常用于触发 Windows 上的一些系统节能操作。由于经过全面测试，它从所有 AML 表中都是可靠的。

ACPI 盖板设备驱动程序用户空间用户的例外情况
=================================================================================

ACPI 按钮驱动程序通过以下文件将盖板状态导出到用户空间：

  /proc/acpi/button/lid/LID0/state

此文件实际上调用了上述的 _LID 控制方法。鉴于前面的解释，在某些平台上，这种方法并不足够可靠。因此，建议用户空间程序不要仅依赖此文件来确定实际的盖板状态。

ACPI 按钮驱动程序向用户空间发出以下输入事件：
  * SW_LID

ACPI 盖板设备驱动程序旨在尝试将平台触发的事件传递给用户空间。然而，考虑到有缺陷的固件无法确保“打开”/“关闭”事件成对出现，ACPI 按钮驱动程序使用以下三种模式以避免触发问题。
如果用户空间尚未准备好忽略不可靠的“打开”事件和不可靠的初始状态通知，Linux 用户可以使用以下内核参数来处理可能出现的问题：

A. button.lid_init_state=method:
   当指定此选项时，ACPI 按钮驱动程序使用 _LID 控制方法的返回值来报告初始盖板状态，并且“打开”/“关闭”事件是否完全配对则完全依赖于固件实现。
此选项可用于修复某些平台上的问题，在这些平台上，_LID 控制方法的返回值是可靠的，但缺少初始盖板状态通知。
此选项是在用户空间尚未准备好处理有问题的AML表时的默认行为。

B. button.lid_init_state=open：
   当指定此选项时，ACPI按钮驱动程序始终报告初始盖子状态为“打开”，而“打开”/“关闭”事件是否完全配对则完全依赖于固件实现。
这可能修复了一些平台上的问题，在这些平台上，_LID控制方法的返回值不可靠，并且缺少初始盖子状态通知。
如果用户空间已经准备好忽略不可靠的“打开”事件和不可靠的初始状态通知，Linux用户应始终使用以下内核参数：

C. button.lid_init_state=ignore：
   当指定此选项时，ACPI按钮驱动程序从不报告初始盖子状态，并且实现了一种补偿机制，通过始终将“关闭”输入事件与补充的“打开”输入事件配对，以确保可靠的“关闭”通知能够始终传递给用户空间。但是，当盖子实际打开时，仍无法保证“打开”通知能够传递给用户空间，因为某些AML表不能可靠地发送“打开”通知。
在这种模式下，如果平台固件正确实现了所有内容，则旧的用户空间程序仍然可以工作。否则，需要新的用户空间程序来配合ACPI按钮驱动程序工作。
在用户空间准备好处理有问题的AML表之后，此选项将成为默认行为。
