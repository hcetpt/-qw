SPDX 许可证标识符: GPL-2.0

=====
IPsec
=====

本文档记录了在实际生产环境中部署各种 IPsec 配置时需要注意的一些已知边缘情况。
1. IPcomp：
   较小的 IP 数据包在发送方不会被压缩，并且会在接收方的策略检查中失败。

引用自 RFC3173:: 

  2.2. 不膨胀策略

   如果压缩后的负载和 IPComp 头（如第 3 节所定义）的总大小不小于原始负载的大小，则 IP 数据报必须以原始未压缩的形式发送。具体来说，如果 IP 数据报未被压缩，则不会向数据报添加 IPComp 头。此策略确保节省解压缩处理周期，并避免当扩展后的数据报大于最大传输单元（MTU）时发生 IP 数据报分片。

较小的 IP 数据报在压缩后很可能会膨胀。因此，在压缩之前应应用一个数值阈值，其中小于该阈值的数据报将以原始形式发送而不尝试压缩。数值阈值取决于实现。

当前的 IPComp 实现确实是按规范进行的。然而在实践中，当向对等体发送未压缩的数据包时（无论数据包长度是否小于阈值或压缩后的长度大于原始数据包长度），在策略检查时数据包会被丢弃，因为此数据包匹配选择器但不是来自任何 XFRM 层，即没有安全路径。这种裸数据包最终无法到达上层。

当使用不同负载长度对对等体进行 ping 操作时，这种情况对用户来说更加诡异。

一种解决方法是尝试为每个策略设置“使用级别”，如果用户观察到上述场景的话。这样做的后果是较小的数据包（未压缩）会在接收方跳过策略检查。
