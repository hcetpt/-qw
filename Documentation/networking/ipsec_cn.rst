SPDX 许可证标识符: GPL-2.0

===
IPsec
===

本文档记录了在实际生产环境中部署各种 IPsec 配置时需要考虑的一些已知的 IPsec 边缘案例：

1. IPcomp:
       较小的 IP 数据包在发送端不会被压缩，并且会在接收端的策略检查中失败。

根据 RFC3173 的描述:

  2.2. 不膨胀策略

   如果压缩后的负载与 IPComp 头的总大小（如第 3 节所述）不小于原始负载的大小，则必须以原始未压缩的形式发送 IP 数据报。为了明确：如果一个 IP 数据报被非压缩形式发送，那么数据报上不会添加任何 IPComp 头。该策略确保节省了解压缩处理周期，并避免了当扩展后的数据报大于最大传输单元（MTU）时产生的 IP 数据报分段问题。
较小的 IP 数据报在压缩后可能会膨胀。因此，在压缩之前应应用一个数值阈值，其中小于阈值大小的 IP 数据报将以原始形式发送而不尝试压缩。数值阈值取决于实现。
当前的 IPComp 实现确实遵循上述规则，然而在实践中，当向对等体发送未压缩的数据包（无论数据包长度是否小于阈值或压缩后的长度大于原始数据包长度），在策略检查时会丢弃该数据包，因为这个数据包匹配选择器但不是来自任何 XFRM 层，即没有安全路径。这种裸数据包最终无法到达上层。
当使用不同负载长度 ping 对等体时，这种情况对于用户来说显得更加诡异。
一种变通方法是尝试为每个策略设置“使用级别”，如果用户观察到上述场景。这样做的后果是小数据包（未压缩）将在接收端跳过策略检查。
