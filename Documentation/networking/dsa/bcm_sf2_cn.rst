博通Starfighter 2以太网交换机驱动程序
=============================================

博通的Starfighter 2以太网交换机硬件模块常见于以下产品中：

- xDSL网关，例如BCM63138
- 流媒体/多媒体机顶盒，例如BCM7445
- 电缆调制解调器/住宅网关，例如BCM7145/BCM3390

该交换机通常配置为5到13个端口之间，提供了一系列内置和可定制的接口：

- 单一集成千兆PHY
- 四个集成千兆PHY
- 四个外部千兆PHY带MDIO复用器
- 集成MoCA PHY
- 多个外部MII/RevMII/GMII/RGMII接口

该交换机还支持特定的拥塞控制功能，允许在MoCA角色重新选举期间不丢失数据包，并且在网络下游接口连接速度较低时向主机CPU网络接口提供带外反压。

交换机硬件块通常通过MMIO访问进行接口，并包含多个子块/寄存器：

- ``SWITCH_CORE``：通用交换机寄存器
- ``SWITCH_REG``：外部接口交换机寄存器
- ``SWITCH_MDIO``：外部MDIO总线控制器（在``SWITCH_CORE``中还有一个用于间接PHY访问）
- ``SWITCH_INDIR_RW``：64位宽寄存器辅助块
- ``SWITCH_INTRL2_0/1``：二级中断控制器
- ``SWITCH_ACB``：准入控制块
- ``SWITCH_FCB``：故障转移控制块

实现细节
======================

该驱动程序位于``drivers/net/dsa/bcm_sf2.c``中，并作为一个DSA驱动程序实现；请参阅``Documentation/networking/dsa/dsa.rst``了解有关子系统的详细信息及其提供的功能。
SF2交换机被配置为启用一个博通特有的4字节交换标签，该标签由交换机插入每个转发到CPU接口的数据包。相反，CPU网络接口应在进入CPU端口的数据包中插入类似的标签。标签格式在``net/dsa/tag_brcm.c``中描述。
总体而言，SF2驱动程序是一个相当标准的DSA驱动程序；下面将详细介绍一些具体特性。
设备树探测
-------------------

DSA平台设备驱动程序使用在``net/dsa/dsa.c``中提供的特定兼容字符串进行探测。原因是目前DSA子系统注册为一个平台设备驱动程序。DSA将提供所需的`device_node`指针，这些指针随后可以通过交换机驱动程序设置函数来设置资源，如寄存器范围和中断。这目前工作得很好，因为驱动程序使用的任何of_*函数都不需要将结构体`device`绑定到结构体`device_node`，但未来可能会有所变化。
MDIO间接访问
-----------------------

由于博通交换机设计上的限制，连接到SF2的外部博通交换机需要使用DSA用户MDIO总线来进行正确配置。默认情况下，SF2伪PHY地址和外部交换机伪PHY地址都会监听传入的MDIO事务，因为它们在同一地址（30），从而导致某种“双重”编程。通过使用DSA并相应地设置`ds->phys_mii_mask`，我们可以选择性地将读写操作重定向到外部博通交换机的伪PHY地址。SF2硬件的新版本引入了一个可配置的伪PHY地址，从而绕过了初始设计限制。
同轴电缆上的多媒体（MoCA）接口
-----------------------------------------

MoCA接口相对特殊，需要加载到MoCA处理器上进行数据包处理的固件。每当MoCA同轴电缆断开或固件重新加载时，交换机硬件会相应地断言/取消断言MoCA接口的链路状态。SF2驱动程序依赖于此类事件来正确设置其MoCA接口的载波状态，并正确报告给网络堆栈。
MoCA接口使用PHY库中的固定PHY/仿真PHY设备进行支持，并且交换机驱动程序为这些PHY注册了`fixed_link_update`回调，以反映从中断处理程序获得的链路状态。
电源管理
----------------

尽可能地，SF2驱动程序试图通过以下组合来最小化整体交换机的功耗：

- 关闭内部缓冲区/内存
- 禁用数据包处理逻辑
- 将集成PHY置于IDDQ/低功耗模式
- 根据活动端口数量降低交换机核心时钟
- 启用并宣传EEE
- 在链路断开时关闭RGMII数据处理逻辑

唤醒网络
-----------

唤醒网络当前通过利用主机处理器以太网MAC控制器的唤醒逻辑来实现。当请求唤醒网络时，会在用户请求和支持的主机以太网接口WoL能力之间进行交集，并将交集结果进行配置。在系统级挂起/恢复过程中，仅禁用不参与唤醒网络的端口。
