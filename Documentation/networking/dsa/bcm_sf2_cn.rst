Broadcom Starfighter 2 以太网交换机驱动程序

Broadcom 的 Starfighter 2 以太网交换机硬件模块常见于以下产品中并被广泛部署：

- xDSL 网关，例如 BCM63138
- 流媒体/多媒体机顶盒，例如 BCM7445
- 电缆调制解调器/住宅网关，例如 BCM7145/BCM3390

该交换机通常配置为包含 5 至 13 个端口，并提供一系列内置和可自定义的接口：

- 单一集成千兆 PHY
- 四个集成千兆 PHY
- 四个外部千兆 PHY，带 MDIO 复用器
- 集成 MoCA PHY
- 多个外部 MII/RevMII/GMII/RGMII 接口

此外，交换机支持特定的拥塞控制特性，允许在 MoCA 角色重新选举期间不丢失数据包的 MoCA 故障转移，以及当下游接口连接速度较低时对主机 CPU 网络接口进行带外反压。

交换机硬件模块通常使用 MMIO 访问接口，并包含多个子块/寄存器：

- `SWITCH_CORE`：通用交换机寄存器
- `SWITCH_REG`：外部接口交换机寄存器
- `SWITCH_MDIO`：外部 MDIO 总线控制器（还有一个位于 SWITCH_CORE 中，用于间接 PHY 访问）
- `SWITCH_INDIR_RW`：64 位宽寄存器辅助块
- `SWITCH_INTRL2_0/1`：二级中断控制器
- `SWITCH_ACB`：准入控制块
- `SWITCH_FCB`：故障转移控制块

实现细节
=========

驱动程序位于 `drivers/net/dsa/bcm_sf2.c`，作为一个 DSA 驱动程序实现；有关子系统的详细信息及其提供的功能，请参阅 `Documentation/networking/dsa/dsa.rst`。
SF2 交换机被配置以启用一个 Broadcom 特有的 4 字节交换机标签，该标签由交换机为转发到 CPU 接口的每个数据包插入；相反地，CPU 网络接口应该为进入 CPU 端口的数据包插入类似的标签。标签格式在 `net/dsa/tag_brcm.c` 中描述。
总体而言，SF2 驱动程序是一个相当标准的 DSA 驱动程序；下面将介绍一些具体细节。
设备树探测
--------------

DSA 平台设备驱动程序使用 `net/dsa/dsa.c` 中提供的特定兼容字符串进行探测。这是因为 DSA 子系统当前注册为平台设备驱动程序。DSA 将提供所需的设备节点指针，这些指针随后可以被交换机驱动程序设置函数访问，以设置资源如寄存器范围和中断。目前，这工作得很好，因为驱动程序使用的所有 of_* 函数都不需要将 struct device 绑定到 struct device_node，但未来可能会发生变化。
MDIO 间接访问
----------------

由于 Broadcom 交换机的设计限制，与 SF2 连接的外部 Broadcom 交换机需要使用 DSA 用户 MDIO 总线来进行正确配置。默认情况下，SF2 假 PHY 地址和外部交换机假 PHY 地址都会监听传入的 MDIO 事务，因为它们具有相同的地址 (30)，从而导致某种形式的“双重”编程。通过使用 DSA 并相应地设置 `ds->phys_mii_mask`，我们可以选择性地将读写操作导向外部 Broadcom 交换机的假 PHY 地址。SF2 硬件的新版本引入了一个可配置的假 PHY 地址，以规避最初的设计限制。
CoAxial 上的多媒体 (MoCA) 接口
---------------------------------

MoCA 接口非常特殊，需要加载到 MoCA 处理器上用于数据包处理的固件 blob。交换机硬件包含逻辑，在 MoCA 同轴电缆断开连接或固件重新加载时，会相应地设置/取消设置 MoCA 接口的链路状态。SF2 驱动程序依赖于此类事件来正确设置其 MoCA 接口的载波状态，并向网络堆栈正确报告此状态。
MoCA 接口使用 PHY 库中的固定 PHY/仿真 PHY 设备支持，并且交换机驱动程序为这些 PHY 注册了 `fixed_link_update` 回调，该回调反映了从中断处理程序获得的链路状态。
电源管理
--------------

尽可能的情况下，SF2 驱动程序试图通过以下组合来最小化整体交换机的功耗：

- 关闭内部缓冲器/内存
- 禁用数据包处理逻辑
- 将集成 PHY 设置为 IDDQ/低功耗模式
- 根据活动端口的数量降低交换机核心时钟
- 启用并宣传 EEE
- 当链路下降时关闭 RGMII 数据处理逻辑

网络唤醒
-----------

网络唤醒目前是通过利用主机处理器以太网 MAC 控制器的唤醒逻辑实现的。当请求网络唤醒时，会计算用户请求和支持的主机以太网接口 WoL 能力之间的交集，并配置该交集结果。在系统范围内的挂起/恢复过程中，仅禁用未参与网络唤醒的端口。
