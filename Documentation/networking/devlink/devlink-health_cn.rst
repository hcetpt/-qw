SPDX 许可证标识符: GPL-2.0

==============
Devlink 健康监控
==============

背景
==========

``devlink`` 健康机制的目标是实时告警，以便在 PCI 设备出现问题时能够及时获知。
* 提供告警调试信息
* 自愈功能
* 如果问题需要厂商支持，提供一种收集所有必要调试信息的方法

概述
========

主要想法是将驱动程序的健康报告统一集中到通用的 ``devlink`` 实例中，并允许用户设置健康报告和恢复过程的不同属性。 
``devlink`` 健康报告者：
设备驱动程序为每种错误/健康类型创建一个“健康报告者”。
错误/健康类型可以是已知/通用的（例如 PCI 错误、固件错误、收发错误）或未知的（驱动程序特定的）。
对于每个注册的健康报告者，驱动程序可以异步发出错误/健康报告。所有健康报告处理由 ``devlink`` 完成。
设备驱动程序可以为每个“健康报告者”提供特定的回调函数，例如：

  * 恢复过程
  * 诊断过程
  * 对象转储过程
  * 出厂初始参数

驱动程序的不同部分可以注册不同类型的健康报告者并带有不同的处理程序。

行动
=======

一旦报告了错误，devlink 健康监控将执行以下操作：

  * 向内核跟踪事件缓冲区发送日志
  * 更新报告实例中的健康状态和统计信息
  * 在报告实例中进行对象转储并保存（前提是自动转储已设置且没有其他已存储的转储）
  * 尝试自动恢复。这取决于：

    - 自动恢复配置
    - 宽限期与自上次恢复以来的时间

devlink 格式化消息
=====================

为了处理 devlink 健康诊断和健康转储请求，devlink 创建了一个格式化的消息结构 ``devlink_fmsg`` 并将其发送到驱动程序的回调函数以使用 devlink fmsg API 填充数据。
Devlink fmsg 是一种机制，用于在驱动程序和 devlink 之间传递描述符，格式类似于 JSON。该 API 允许驱动程序添加嵌套属性，如对象、对象对和值数组，以及名称和值等属性。

驱动程序应使用此 API 填充 fmsg 上下文，以便稍后由 devlink 翻译为 netlink 消息。当需要通过 SKBs 将数据发送到 netlink 层时，它会将数据分段到不同的 SKBs 中。为了实现这种分段，它使用虚拟嵌套属性，以避免实际嵌套的使用，因为实际嵌套不能在不同的 SKBs 之间分割。

用户界面
=========

用户可以通过 `devlink` 访问和更改每个报告器的参数和特定于驱动程序的回调，例如按错误类型（每健康报告器）：

  * 配置报告器的一般参数（如：禁用/启用自动恢复）
  * 触发恢复过程
  * 运行诊断
  * 对象转储

.. list-table:: Devlink 健康接口列表
   :widths: 10 90

   * - 名称
     - 描述
   * - ``DEVLINK_CMD_HEALTH_REPORTER_GET``
     - 获取每个 DEV 和报告器的状态和配置信息
   * - ``DEVLINK_CMD_HEALTH_REPORTER_SET``
     - 允许设置与报告器相关的配置
   * - ``DEVLINK_CMD_HEALTH_REPORTER_RECOVER``
     - 触发报告器的恢复过程
   * - ``DEVLINK_CMD_HEALTH_REPORTER_TEST``
     - 在报告器上触发一个假的健康事件。测试事件在恢复流程中的影响应该接近真实事件的影响
   * - ``DEVLINK_CMD_HEALTH_REPORTER_DIAGNOSE``
     - 获取与报告器相关的当前设备状态
   * - ``DEVLINK_CMD_HEALTH_REPORTER_DUMP_GET``
     - 获取最后一次存储的转储。Devlink 健康保存单个转储。如果 devlink 尚未为此报告器存储转储，则 devlink 生成一个新的转储
转储输出由报告器定义
   * - ``DEVLINK_CMD_HEALTH_REPORTER_DUMP_CLEAR``
     - 清除指定报告器的最后一次保存的转储文件
以下图提供了 ``devlink-health`` 的总体概述：

```
                                                  netlink
                                       +--------------------------+
                                       |                          |
                                       |            +             |
                                       |            |             |
                                       +--------------------------+
                                                        |请求操作
                                                        |(诊断，
      驱动程序                                devlink     |恢复，
                                                        |转储)
    +--------+                             +--------------------------+
    |        |                             |    reporter              |
    |        |                             |  +---------v----------+  |
    |        |                             |  |                    |  |
    |     <----------------------------------+                    |  |
    |        |                             |  |                    |  |
    |        |                             |  + ^------------------+  |
    |        |                             |    | 请求操作           |
    |        |                             |    | (恢复，转储)        |
    |        |                             |    |                     |
    |        |                             |  +-+------------------+  |
    |        |      健康报告               |  | 健康处理程序       |  |
    |        +------------------------------->                    |  |
    |        |                             |  +--------------------+  |
    |        |      创建健康报告器         |                          |
    |        +---------------------------->                          |
    +--------+                             +--------------------------+
```
