SPDX 许可证标识符: GPL-2.0

==============
设备链接健康
==============

背景
======

`devlink` 健康机制的目标是实时警报，以便在 PCI 设备出现问题时能够知晓：
* 提供警报调试信息
* 自我恢复
* 如果问题需要厂商支持，则提供一种方式来收集所有必要的调试信息
概述
======

主要思路是将驱动程序的健康报告统一集中到通用的 `devlink` 实例中，并允许用户设置健康报告和恢复过程的不同属性。
`devlink` 健康报告器：
对于每种错误/健康类型，设备驱动程序创建一个“健康报告器”
错误/健康类型可以是已知/通用的（例如，PCI 错误、固件错误、收发错误）或未知的（驱动程序特有的）
对于每个注册的健康报告器，驱动程序可以异步发出错误/健康报告。所有健康报告处理均由 `devlink` 完成
设备驱动程序可以为每个“健康报告器”提供特定的回调函数，例如：

  * 恢复程序
  * 诊断程序
  * 对象转储程序
  * 出厂初始参数

驱动程序的不同部分可以注册不同类型的健康报告器，并带有不同的处理器
动作
======

一旦报告了错误，`devlink` 健康将执行以下操作：

  * 将日志发送到内核跟踪事件缓冲区
  * 更新报告实例的健康状态和统计信息
  * 进行对象转储并保存在报告实例中（只要设置了自动转储并且没有其他已存储的转储）
  * 尝试自动恢复。取决于：

    - 自动恢复配置
    - 从上次恢复以来经过的时间与宽限期之间的比较

`devlink` 格式化消息
========================

为了处理 `devlink` 健康诊断和健康转储请求，`devlink` 创建了一个格式化的消息结构 `devlink_fmsg` 并将其发送给驱动程序的回调函数以使用 `devlink` fmsg API 填充数据。
### devlink fmsg 是一种机制，用于以类似JSON的格式在驱动程序和devlink之间传递描述符。该API允许驱动程序添加嵌套属性，如对象、对象对和值数组，除了名称和值等属性。
驱动程序应使用此API以一种格式填充fmsg上下文，该格式稍后将由devlink转换为netlink消息。当它需要使用SKBs将数据发送到netlink层时，它会在不同的SKBs之间分割数据。为了实现这种分割，它使用虚拟嵌套属性，避免实际嵌套使用，因为后者不能在不同的SKBs之间分割。

### 用户界面
####

用户可以通过`devlink`访问和更改每个报告器的参数以及与驱动程序相关的回调，例如按错误类型（按健康报告器）：

  * 配置报告器的一般参数（例如：禁用/启用自动恢复）
  * 触发恢复过程
  * 运行诊断
  * 对象转储

#### devlink健康接口列表
| 名称 | 描述 |
| --- | --- --- |
| `DEVLINK_CMD_HEALTH_REPORTER_GET` | 检索每个DEV和报告器的状态和配置信息 |
| `DEVLINK_CMD_HEALTH_REPORTER_SET` | 允许设置与报告器相关的配置 |
| `DEVLINK_CMD_HEALTH_REPORTER_RECOVER` | 触发报告器的恢复过程 |
| `DEVLINK_CMD_HEALTH_REPORTER_TEST` | 在报告器上触发一个模拟的健康事件。测试事件在恢复流程方面的影响应该接近真实事件的效果 |
| `DEVLINK_CMD_HEALTH_REPORTER_DIAGNOSE` | 获取与报告器相关的当前设备状态 |
| `DEVLINK_CMD_HEALTH_REPORTER_DUMP_GET` | 获取最后存储的转储。devlink健康仅保存一个转储。如果devlink尚未为此报告器存储转储，则devlink会生成一个新的转储。转储输出由报告器定义 |
| `DEVLINK_CMD_HEALTH_REPORTER_DUMP_CLEAR` | 清除指定报告器的最后保存的转储文件 |
以下的图表提供了一个关于 `devlink-health` 的总体概述：

                                                  网络链接层
                                       +--------------------------+
                                       |                          |
                                       |            +             |
                                       |            |             |
                                       +--------------------------+
                                                        |请求操作
                                                        |(诊断,
      驱动程序                               devlink     |恢复,
                                                        |导出)
    +--------+                            +--------------------------+
    |        |                            |    报告器|             |
    |        |                            |  +---------v----------+  |
    |        |                            |  |                    |  |
    |     <----------------------------------+                    |  |
    |        |                            |  |                    |  |
    |        |                            |  + ^------------------+  |
    |        |                            |    | 请求操作           |
    |        |                            |    | (恢复, 导出)         |
    |        |                            |    |                     |
    |        |                            |  +-+------------------+  |
    |        |     健康报告               |  | 健康处理程序     |  |
    |        +------------------------------->                    |  |
    |        |                            |  +--------------------+  |
    |        |     创建健康报告器         |                          |
    |        +---------------------------->                          |
    +--------+                            +--------------------------+
