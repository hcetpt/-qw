SPDX 许可证标识符: GPL-2.0

=================
Devlink 线卡
=================

背景
==========

``devlink-linecard`` 机制旨在操作作为模块化交换系统中的可拆卸 PHY 模块的线卡。提供了以下操作：

  * 获取支持的线卡类型列表
  * 在特定插槽中配置特定类型的线卡
  * 获取并监控线卡状态及其变化

根据类型，线卡可能包含一个或多个齿轮箱，用于将具有特定速度的通道复用到具有不同速度通道的多个端口。线卡确保了交换ASIC模块与物理前面板端口之间的N:M映射。

概述
========

每个线卡的devlink对象由设备驱动程序创建，根据设备上可用的实际线卡插槽创建。
类似于分路器电缆，设备可能无法检测分路器电缆的几何形状，对于这些设备，引入了配置的概念。这允许用户：

  * 将特定类型的线卡配置到某个插槽

    - 设备驱动程序将指示ASIC准备所有相应的资源。设备驱动程序将根据线卡类型创建所有实例，即位于线卡上的devlink端口和网络设备。
  * 即使没有实际连接或加电的线卡，也能操作线卡实体
  * 在线卡端口上设置分路器电缆

    - 类似于普通端口，用户可以配置某种类型的分路器电缆，而无需实际连接到端口
  * 配置devlink端口和网络设备

网络设备的载波决定如下：

  * 线卡未插入或已断电

    - 载波始终为关闭状态
  * 线卡已插入并加电

    - 载波决定方式同普通端口的网络设备

线卡状态
===============

``devlink-linecard`` 机制支持以下线卡状态：

  * ``未配置``：插槽上尚未配置线卡
  * ``正在取消配置``：当前正在取消配置线卡插槽
  * ``正在配置``：当前正在将一种线卡类型配置到线卡插槽
  * ``配置失败``：配置不成功
  * ``已配置``：插槽已配置了一种线卡类型
```* ``active``: 线卡已上电并处于活动状态
下图提供了 ``devlink-linecard`` 状态转换的一般概述：

                                          +-------------------------+
                                          |                         |
       +---------------------------------->      未配置      |
       |                                  |                         |
       |                                  +--------|-------^--------+
       |                                           |       |
       |                                           |       |
       |                                  +--------v-------|--------+
       |                                  |                         |
       |                                  |       正在配置      |
       |                                  |                         |
       |                                  +------------|------------+
       |                                               |
       |                 +-----------------------------+
       |                 |                             |
       |    +------------v------------+   +------------v------------+   +-------------------------+
       |    |                         |   |                         ---->                         |
       +-----   配置失败   |   |       已配置       |   |         活动状态          |
       |    |                         |   |                         <----                         |
       |    +------------^------------+   +------------|------------+   +-------------------------+
       |                 |                             |
       |                 |                             |
       |                 |                +------------v------------+
       |                 |                |                         |
       |                 |                |     正在取消配置      |
       |                 |                |                         |
       |                 |                +------------|------------+
       |                 |                             |
       |                 +-----------------------------+
       |                                               |
       +-----------------------------------------------+

示例用法
========

.. code:: shell

    $ devlink lc show [ DEV [ lc LC_INDEX ] ]
    $ devlink lc set DEV lc LC_INDEX [ { type LC_TYPE | notype } ]

    # 显示所有插槽的当前线卡配置和状态：
    $ devlink lc

    # 将第8个插槽设置为使用类型 "16x100G" 进行配置：
    $ devlink lc set pci/0000:01:00.0 lc 8 type 16x100G

    # 将第8个插槽设置为未配置：
    $ devlink lc set pci/0000:01:00.0 lc 8 notype
```
