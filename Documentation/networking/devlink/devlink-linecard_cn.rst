### SPDX 许可证标识符：GPL-2.0

#### Devlink 线卡

##### 背景

`devlink-linecard`机制旨在用于操作作为模块化交换系统中的可拆卸PHY模块的线卡。提供的操作包括：

  * 获取支持的线卡类型列表
  * 在特定槽位中配置指定类型的线卡
  * 获取和监控线卡的状态及其变化

根据类型，线卡可能包含一个或多个齿轮箱，以将具有特定速度的通道复用到具有不同速度的多个端口上。线卡确保了ASIC模块与物理前面板端口之间N:M的映射关系。

##### 概览

每个线卡devlink对象由设备驱动程序创建，依据设备上实际存在的物理线卡插槽。
类似于分路电缆的情况，设备可能无法检测分路电缆的具体几何形状，对于这类设备，引入了配置的概念。这允许用户：

  * 在某个槽位中配置特定类型的线卡

    - 设备驱动程序会指示ASIC准备所有相关资源。设备驱动程序会根据线卡类型创建所有实例，即位于线卡上的devlink端口和网络设备。
  * 即使在没有物理连接或未通电的情况下操作线卡实体
  * 在线卡端口上设置分路电缆

    - 类似于普通端口，用户可以配置某种类型的分路电缆，无需物理连接到端口
  * 配置devlink端口和网络设备

网络设备的载波状态决定如下：

  * 线卡未插入或关闭电源

    - 载波始终为关闭状态
  * 线卡已插入并通电

    - 载波状态与普通端口网络设备相同

#### 线卡状态

`devlink-linecard`机制支持以下线卡状态：

  * `未配置(unprovisioned)`：线卡未在该槽位中配置
  * `正在取消配置(unprovisioning)`：线卡槽位当前正在进行取消配置
  * `正在配置(provisioning)`：线卡槽位当前正在进行配置为某种类型的线卡
  * `配置失败(provisioning_failed)`：配置不成功
  * `已配置(provisioned)`：线卡槽位已配置为某种类型
以下图示提供了一个关于`devlink-linecard`状态转换的总体概览：

                                          +-------------------------+
                                          |                         |
       +---------------------------------->      未配置      |
       |                                  |                         |
       |                                  +--------|-------^--------+
       |                                           |       |
       |                                           |       |
       |                                  +--------v-------|--------+
       |                                  |                         |
       |                                  |       正在配置      |
       |                                  |                         |
       |                                  +------------|------------+
       |                                               |
       |                 +-----------------------------+
       |                 |                             |
       |    +------------v------------+   +------------v------------+   +-------------------------+
       |    |                         |   |                         ---->                         |
       +-----   配置失败   |   |       已配置       |   |         激活中          |
       |    |                         |   |                         <----                         |
       |    +------------^------------+   +------------|------------+   +-------------------------+
       |                 |                             |
       |                 |                             |
       |                 |                +------------v------------+
       |                 |                |                         |
       |                 |                |     未配置中      |
       |                 |                |                         |
       |                 |                +------------|------------+
       |                 |                             |
       |                 +-----------------------------+
       |                                               |
       +-----------------------------------------------+

使用示例
========

.. code:: shell

    $ devlink lc show [ 设备 [ 线卡 LC_INDEX ] ]
    $ devlink lc set 设备 lc LC_INDEX [ { 类型 LC_TYPE | 无类型 } ]

    # 显示所有插槽的当前线卡配置和状态：
    $ devlink lc

    # 将第8号插槽设置为配备“16x100G”类型的线卡：
    $ devlink lc set pci/0000:01:00.0 lc 8 type 16x100G

    # 将第8号插槽设置为未配置：
    $ devlink lc set pci/0000:01:00.0 lc 8 notype
