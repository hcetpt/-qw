SPDX 许可证标识符: GPL-2.0

============
Rmnet 驱动程序
============

1. 引言
===============

Rmnet 驱动程序用于支持复用和聚合协议（MAP）。此协议被所有使用高通技术公司调制解调器的最新芯片组所采用。
该驱动程序可以在 IP 模式下注册到任何物理网络设备。物理传输方式包括 USB、HSIC、PCIe 和 IP 加速器。
复用允许创建逻辑网卡（rmnet 设备）来处理多个私有数据网络（PDN），如默认互联网、网络共享、多媒体信息服务（MMS）或 IP 媒体子系统（IMS）。硬件发送带有 MAP 头的包给 rmnet，根据复用器 ID，rmnet 在移除 MAP 头后将数据路由到相应的 PDN。
聚合是为了实现高数据速率所必需的。这涉及到硬件发送一组聚合的 MAP 帧。Rmnet 驱动程序将这些 MAP 帧解聚合，并将其发送到适当的 PDN。

2. 包格式
================

a. MAP 包 v1（数据/控制）

MAP 头字段采用大端字节序。
包格式如下所示：

```
  位            0             1           2-7      8-15           16-31
  功能    命令/数据    保留        填充   复用器ID    载荷长度

  位            32-x
  功能       原始字节
```

命令（1）/ 数据（0）位值用于指示该包是 MAP 命令包还是数据包。命令包用于传输层流量控制。数据包为标准 IP 包。
保留位在发送时必须为零，在接收时忽略。
填充是附加到载荷末尾的字节数，以确保 4 字节对齐。
复用器 ID 用于指示要发送数据的 PDN。
载荷长度包含填充长度，但不包括 MAP 头长度。
b. 地图数据包 v4（数据/控制）

MAP 头字段采用大端格式
数据包格式如下：

  位               0              1           2-7       8-15             16-31
  功能   命令/数据   保留位     填充   复用器ID    载荷长度

  位             32-(x-33)      (x-32)-x
  功能          原始字节       校验和卸载头

命令（1）/ 数据（0）位的值用于指示数据包是 MAP 命令还是数据包。命令数据包用于传输层的流量控制。数据包是标准的 IP 数据包。
保留位在发送时必须为零，在接收时被忽略。
填充是指附加到载荷末尾的字节数，以确保 4 字节对齐。
复用器 ID 用于指示数据应发送到的 PDN（分组数据网络）。
载荷长度包括填充长度，但不包括 MAP 头的长度。
校验和卸载头包含硬件完成的校验和处理信息。校验和卸载头字段采用大端格式。
数据包格式如下：

  位               0-14         15            16-31
  功能           保留位   有效位   校验和起始偏移

  位                 31-47                       48-64
  功能           校验和长度               校验和值

保留位在发送时必须为零，在接收时被忽略。
有效位表示部分校验和是否已被计算并且有效。
如果有效，则设置为 1；否则设置为 0。
填充是指附加到有效负载末尾的字节数，以确保4字节对齐。
校验和起始偏移量，表示从IP头开始处计算校验和的偏移量（以字节为单位）。
校验和长度是从CKSUM_START_OFFSET开始的字节数，用于计算校验和。
校验和值，表示计算出的校验和。

MAP数据包v5（数据/控制）

MAP头部字段采用大端格式。
数据包格式如下：

  位             0             1         2-7      8-15           16-31
  功能   命令 / 数据  下一个头部  填充   复用器ID   有效负载长度

  位            32-x
  功能      原始字节

命令（1）/ 数据（0）位的值用于指示数据包是MAP命令还是数据包。命令包用于传输层流量控制。数据包是标准的IP数据包。
下一个头部用于指示另一个头部的存在，目前仅限于校验和头部。
填充是指附加到有效负载末尾的字节数，以确保4字节对齐。
复用器ID用于指示要发送数据的PDN。
有效负载长度包括填充长度，但不包括MAP头部长度。
### d. 校验和卸载头版本5

校验和卸载头字段采用大端格式。
位            0 - 6          7               8-15              16-31  
功能     头类型    下一个头       校验和有效       保留  

头类型用于指示头的类型，通常设置为 CHECKSUM。

头类型
= ==========================================
0 保留  
1 保留  
2 校验和头  

校验和有效位用于指示头校验和是否有效。值为 1 表示该数据包已计算校验和且有效；值为 0 表示计算的数据包校验和无效。
保留位在发送时必须为零，在接收时被忽略。

### e. MAP 数据包版本1/5（特定于命令）：

    位             0             1         2-7      8 - 15           16 - 31  
    功能   命令         保留         填充   复用器ID    载荷长度  
    位          32 - 39        40 - 45    46 - 47       48 - 63  
    功能   命令名称    保留   命令类型   保留  
    位          64 - 95  
    功能   事务ID  
    位          96 - 127  
    功能   命令数据  

命令 1 表示禁用流，而命令 2 表示启用流。

命令类型
= ==========================================
0 表示 MAP 命令请求  
1 表示确认收到命令  
2 表示不支持的命令  
3 表示处理命令时出错  

### f. 聚合

聚合是指多个 MAP 数据包（可以是数据或命令）以单个线性 skb 的形式传递给 rmnet。rmnet 将处理各个数据包，并根据需要确认 MAP 命令或将 IP 数据包交付给网络堆栈。

MAP 头|IP 数据包|可选填充|MAP 头|IP 数据包|可选填充...
MAP 头|IP 数据包|可选填充|MAP 头|命令数据包|可选填充..

### 3. 用户空间配置
==========================

rmnet 用户空间配置通过 netlink 使用 iproute2 完成：
https://git.kernel.org/pub/scm/network/iproute2/iproute2.git/

驱动程序使用 rtnl_link_ops 进行通信。
