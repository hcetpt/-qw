SPDX 许可证标识符: GPL-2.0+

=================================================================
Intel(R) 以太网自适应虚拟功能的 Linux 基础驱动程序
=================================================================

Intel 以太网自适应虚拟功能 Linux 驱动程序
版权所有 (c) 2013-2018 Intel Corporation
内容
========

- 概述
- 识别您的适配器
- 额外配置
- 已知问题/故障排除
- 支持

概述
========

本文件描述了 iavf Linux 基础驱动程序。该驱动程序之前被称为 i40evf。
iavf 驱动程序支持以下列出的虚拟功能设备，并且只能在运行 i40e 或更新版本的物理功能（PF）驱动程序（已编译为 CONFIG_PCI_IOV）的内核上激活。iavf 驱动程序要求启用 CONFIG_PCI_MSI。
加载 iavf 驱动程序的客户操作系统必须支持 MSI-X 中断。

识别您的适配器
========================

此内核中的驱动程序与以下基于的设备兼容：
 * Intel(R) XL710 X710 虚拟功能
 * Intel(R) X722 虚拟功能
 * Intel(R) XXV710 虚拟功能
 * Intel(R) 以太网自适应虚拟功能

为了获得最佳性能，请确保安装了最新的 NVM/FW 到您的设备。
有关如何识别您的适配器以及最新 NVM/FW 映像和 Intel 网络驱动程序的信息，请参阅 Intel 支持网站：
https://www.intel.com/support

额外特性和配置
======================================

查看链路消息
---------------------
如果发行版限制了系统消息，则不会将链路消息显示到控制台。为了在您的控制台上看到网络驱动程序的链路消息，请通过输入以下命令将 dmesg 设置为八级：

    # dmesg -n 8

注意：
  此设置不会在重新启动后保存。

ethtool
-------
该驱动程序使用 ethtool 接口进行驱动程序配置、诊断以及显示统计信息。为此功能需要最新版本的 ethtool。下载地址：
https://www.kernel.org/pub/software/network/ethtool/

设置 VLAN 标签剥离
--------------------------
如果您有需要虚拟功能（VF）接收带有 VLAN 标签的数据包的应用程序，您可以禁用 VF 的 VLAN 标签剥离。物理功能（PF）处理来自 VF 的请求以启用或禁用 VLAN 标签剥离。请注意，如果 PF 已经为一个 VF 分配了一个 VLAN，则来自该 VF 的设置 VLAN 标签剥离的请求将被忽略。
要启用/禁用 VF 的 VLAN 标签剥离，请从运行 VF 的虚拟机中发出以下命令：

    # ethtool -K <if_name> rxvlan on/off

或者替代地：

    # ethtool --offload <if_name> rxvlan on/off

自适应虚拟功能
-------------------------
自适应虚拟功能（AVF）允许虚拟功能驱动程序（VF）适应与其关联的物理功能驱动程序（PF）不断变化的功能集。这允许系统管理员更新 PF 而无需更新与其关联的所有 VF。所有 AVF 都有一个共同的设备 ID 和品牌字符串。
AVF 具有一组称为“基础模式”的最小功能集，但可能根据与其关联的 PF 中可用的功能提供其他功能。以下是基础模式功能：

- 4 对队列（QP）及其相关的配置状态寄存器（CSRs）用于发送/接收
- i40e 描述符和环格式
- 描述符写回完成
- 1 个控制队列，具有 i40e 描述符、CSRs 和环格式
- 5 个 MSI-X 中断向量及其相应的 i40e CSRs
- 1 个中断节流率（ITR）索引
- 每个 VF 1 个虚拟站接口（VSI）
- 1 个流量类别（TC），TC0
- 通过 PF 配置的包含 64 个条目的重定向表和密钥的接收侧扩展（RSS）
- 每个 VF 预留 1 个单播 MAC 地址
- 每个 VF 16 个 MAC 地址过滤器
- 无状态卸载 - 非隧道校验和
- AVF 设备 ID
- 硬件邮箱用于 VF 到 PF 的通信（包括在 Windows 上）

IEEE 802.1ad (QinQ) 支持
---------------------------
IEEE 802.1ad 标准，俗称 QinQ，允许在一个以太网帧内有多个 VLAN ID。VLAN ID 有时被称为“标签”，因此多个 VLAN ID 被称为“标签堆栈”。标签堆栈允许 L2 隧道化，并能够在特定 VLAN ID 内分割流量等用途。
以下是配置802.1ad (QinQ) 的示例：

    # ip link add link eth0 eth0.24 type vlan proto 802.1ad id 24
    # ip link add link eth0.24 eth0.24.371 type vlan proto 802.1Q id 371

其中，“24”和“371”是示例VLAN ID。

注意事项：
- 对于802.1ad (QinQ) 数据包，不支持接收校验和卸载、云过滤和VLAN加速。
应用设备队列 (ADq)
-------------------
应用设备队列 (ADq) 允许您将一个或多个队列专门分配给特定应用。这可以减少指定应用的延迟，并允许按应用对发送流量进行速率限制。请按照以下步骤设置ADq。

要求：

- 必须加载sch_mqprio、act_mirred和cls_flower模块。
- 需要iproute2的最新版本。
- 如果其他驱动程序（例如DPDK）已设置了云过滤，则无法启用ADQ。
- 根据底层PF设备的不同，在启用了以下功能时，无法启用ADQ：

  + 数据中心桥接 (DCB)
  + 每端口多功能 (MFP)
  + 辅助过滤器 (Sideband Filters)

1. 创建流量类别 (TCs)。每个接口最多可创建8个TCs。bw_rlimit参数是可选的。
示例：设置两个TCs，tc0和tc1，每个TC有16个队列，tc0的最大发送速率为1Gbit，tc1的最大发送速率为3Gbit。
::

    tc qdisc add dev <interface> root mqprio num_tc 2 map 0 0 0 0 1 1 1 1
    queues 16@0 16@16 hw 1 mode channel shaper bw_rlimit min_rate 1Gbit 2Gbit
    max_rate 1Gbit 3Gbit

map：为最多16个优先级到TCs的优先级映射（例如map 0 0 0 0 1 1 1 1将优先级0-3映射到tc0，优先级4-7映射到tc1）

queues：对于每个TC，<队列数>@<偏移量>（例如queues 16@0 16@16为tc0分配16个队列，偏移量为0；为tc1分配16个队列，偏移量为16。所有TCs的最大队列总数为64或核心数量，取较小值。）

hw 1 mode channel：‘channel’与‘hw’设置为1是在mqprio中的一种新的硬件卸载模式，充分利用了mqprio选项、TCs、队列配置和QoS参数。
shaper bw_rlimit：为每个TC设置最小和最大带宽速率。总和必须等于或小于端口速度。
例如：min_rate 1Gbit 3Gbit：使用网络监控工具如`ifstat`或`sar -n DEV [interval] [number of samples]`验证带宽限制。

注意：
  当使用mqprio配置TCs时，通过ethtool（ethtool -L）设置通道不受支持。
### 翻译：

2. 在接口上启用硬件TC卸载:

    ```shell
    # ethtool -K <interface> hw-tc-offload on
    ```

3. 将TC应用于接口的入站（RX）流量:

    ```shell
    # tc qdisc add dev <interface> ingress
    ```

**注意事项:**
- 所有`tc`命令必须从`iproute2`目录`<pathtoiproute2>/tc/`中运行。
- ADq不兼容云过滤器。
- 当使用mqprio配置TC时，不支持通过`ethtool`（`ethtool -L`）设置通道。
- 必须使用最新版本的`iproute2`。
- 需要NVM版本6.01或更高版本。
- 如果启用了以下功能中的任何一个：数据中心桥接（DCB）、每个端口多个功能（MFP）或旁路过滤器，则无法启用ADq。
- 如果另一个驱动程序（例如DPDK）设置了云过滤器，则不能启用ADq。
- 不支持隧道过滤器。如果在非隧道模式下收到封装数据包，将对内部报头进行过滤。例如，在非隧道模式下的VXLAN流量中，PCTYPE被识别为VXLAN封装的数据包，外部报头将被忽略，因此匹配内部报头。
- 如果PF上的TC过滤器匹配了通过VF（在PF上）的流量，该流量将被路由到PF的适当队列，并且不会传递给VF。这种流量将在TCP/IP栈的较高层被丢弃，因为它不匹配PF地址数据。
- 如果流量匹配了指向不同TC的多个TC过滤器，该流量将被复制并发送到所有匹配的TC队列。当多个过滤器匹配时，硬件交换机会将数据包镜像到VSI列表。
  
**已知问题和故障排除**

#### 绑定失败：带有VFs的Intel(R)以太网控制器700系列设备
如果将虚拟功能（VFs）绑定到基于Intel(R)以太网控制器700系列的设备，当它们成为活动从属时，VF从属可能会失败。
如果VF的MAC地址由设备的物理功能（PF）设置，当你添加一个从属或更改活动备份从属时，Linux绑定会尝试将备份从属的MAC地址同步到与活动从属相同的MAC地址。此时Linux绑定将会失败。如果VF的MAC地址不由PF设置，此问题不会发生。

#### 客户端与虚拟机之间的流量无法传输
如果你在单独主机上运行的虚拟机（VM）上的虚拟功能（VF，或虚拟NIC）不在可信模式，并且在VF上启用了防欺骗检查，你可能无法在客户端系统和虚拟机之间传输流量。请注意，这种情况可以发生在任何组合的客户端、主机和客户操作系统中。有关如何将VF设置为可信模式的信息，请参阅此文档中的“VLAN标签包转向”部分。有关设置防欺骗检查的信息，请参阅此文档中的“MAC和VLAN防欺骗功能”部分。

#### 不要在绑定了具有活动VM的VF的情况下卸载端口驱动程序
如果绑定了具有活动虚拟机（VM）的虚拟功能（VF），请不要卸载端口的驱动程序。这样做会导致端口看起来挂起。
一旦VM关闭或以其他方式释放VF，命令将完成。

#### 使用四个流量类失败
不要尝试在iavf驱动程序中预留超过三个流量类。这样做将无法设置任何流量类，并导致驱动程序向标准输出写入错误信息。为了避免此问题，请使用最多三个队列。

#### 在移除iavf驱动程序时出现多个日志错误消息
如果你有几个VF并且移除了iavf驱动程序，日志中会出现多次以下错误信息：
```
Unable to send opcode 2 to PF, err I40E_ERR_QUEUE_EMPTY, aq_err ok
Unable to send the message to VF 2 aq_err 12
ARQ Overflow Error detected
```

#### 虚拟机无法获取链路
如果虚拟机分配了多个虚拟端口，并且这些虚拟端口绑定到了不同的物理端口，你可能无法在所有虚拟端口上获得链路。以下命令可能解决此问题：
```shell
# ethtool -r <PF>
```
其中`<PF>`是主机中的PF接口，例如：p5p1。你可能需要多次运行该命令才能在所有虚拟端口上获得链路。
虚拟功能（Virtual Function）的 MAC 地址意外变化
----------------------------------------------------
如果虚拟功能（VF）的 MAC 地址在主机上未分配，则 VF 驱动程序将使用随机 MAC 地址。这个随机 MAC 地址可能在每次重新加载 VF 驱动程序时发生变化。您可以在主机上分配一个静态 MAC 地址，这个静态 MAC 地址将在 VF 驱动程序重新加载时保持不变。

驱动程序缓冲区溢出修复
--------------------------
为了解决 CVE-2016-8105 问题（参见 Intel SA-00069）
https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00069.html
此修复已包含在此版本及后续版本的驱动程序中。

同一以太网广播网络中的多个接口
--------------------------------
由于 Linux 上默认的 ARP 行为，在同一个以太网广播域（非分区交换机）内，一个系统无法在两个 IP 网络中正常工作。所有以太网接口都会响应分配给系统的任何 IP 地址的数据包，这会导致接收流量不平衡。

如果您在一个服务器中有多个接口，可以通过以下命令开启 ARP 过滤：

    # echo 1 > /proc/sys/net/ipv4/conf/all/arp_filter

注意：
  此设置不会在重启后保留。可以通过在文件 `/etc/sysctl.conf` 中添加以下行来使配置永久生效：

    net.ipv4.conf.all.arp_filter = 1

另一个选择是将接口安装在不同的广播域中（要么在不同的交换机中，要么在一个被划分为 VLAN 的交换机中）。

接收页面分配错误
---------------------
在压力测试下可能会出现 'Page allocation failure. order:0' 错误。
这是由 Linux 内核报告这种压力状态的方式导致的。

支持
======
对于一般信息，请访问 Intel 支持网站：
https://support.intel.com

如果在支持的内核和适配器上发现发布的源代码存在问题，请将与问题相关的信息发送到 intel-wired-lan@lists.osuosl.org。
