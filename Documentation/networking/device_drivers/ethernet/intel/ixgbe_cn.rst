SPDX 许可声明标识符：GPL-2.0+

===========================================================================
英特尔® 以太网 10 千兆位 PCI Express 适配器的 Linux 基础驱动程序
===========================================================================

英特尔 10 千兆位 Linux 驱动程序
版权所有 © 1999-2018 英特尔公司
内容
========

- 识别您的适配器
- 命令行参数
- 额外配置
- 已知问题
- 支持

识别您的适配器
========================

该驱动程序与基于以下设备兼容：

* 英特尔® 以太网控制器 82598
* 英特尔® 以太网控制器 82599
* 英特尔® 以太网控制器 X520
* 英特尔® 以太网控制器 X540
* 英特尔® 以太网控制器 x550
* 英特尔® 以太网控制器 X552
* 英特尔® 以太网控制器 X553

有关如何识别您的适配器的信息，以及最新的英特尔网络驱动程序，请参阅英特尔支持网站：
https://www.intel.com/support

带有可插拔光学模块的 SFP+ 设备
----------------------------------

基于 82599 的适配器
~~~~~~~~~~~~~~~~~~~~
注意事项：
- 如果您的基于 82599 的英特尔® 网络适配器配备了英特尔光学模块或为英特尔® 以太网服务器适配器 X520-2，则仅支持英特尔光学模块和/或以下列出的直接连接电缆
- 当基于 82599 的 SFP+ 设备背对背连接时，应通过 ethtool 设置相同的速度设置。如果混合使用速度设置，结果可能会有所不同
+---------------+---------------------------------------+------------------+
| 供应商       | 类型                                  | 零件编号         |
+===============+=======================================+==================+
| SR 模块                                                             |
+---------------+---------------------------------------+------------------+
| 英特尔        | 双速率 1G/10G SFP+ SR（带固定）        | FTLX8571D3BCV-IT |
+---------------+---------------------------------------+------------------+
| 英特尔        | 双速率 1G/10G SFP+ SR（带固定）        | AFBR-703SDZ-IN2  |
+---------------+---------------------------------------+------------------+
| 英特尔        | 双速率 1G/10G SFP+ SR（带固定）        | AFBR-703SDDZ-IN1 |
+---------------+---------------------------------------+------------------+
| LR 模块                                                             |
+---------------+---------------------------------------+------------------+
| 英特尔        | 双速率 1G/10G SFP+ LR（带固定）        | FTLX1471D3BCV-IT |
+---------------+---------------------------------------+------------------+
| 英特尔        | 双速率 1G/10G SFP+ LR（带固定）        | AFCT-701SDZ-IN2  |
+---------------+---------------------------------------+------------------+
| 英特尔        | 双速率 1G/10G SFP+ LR（带固定）        | AFCT-701SDDZ-IN1 |
+---------------+---------------------------------------+------------------+

以下是经过部分测试的第三方 SFP+ 模块列表。并非所有模块都适用于所有设备
+---------------+---------------------------------------+------------------+
| 供应商       | 类型                                  | 零件编号         |
+===============+=======================================+==================+
| Finisar       | SFP+ SR 固定，10G 单速                 | FTLX8571D3BCL    |
+---------------+---------------------------------------+------------------+
| Avago         | SFP+ SR 固定，10G 单速                 | AFBR-700SDZ      |
+---------------+---------------------------------------+------------------+
| Finisar       | SFP+ LR 固定，10G 单速                 | FTLX1471D3BCL    |
+---------------+---------------------------------------+------------------+
| Finisar       | 双速率 1G/10G SFP+ SR（无固定）        | FTLX8571D3QCV-IT |
+---------------+---------------------------------------+------------------+
| Avago         | 双速率 1G/10G SFP+ SR（无固定）        | AFBR-703SDZ-IN1  |
+---------------+---------------------------------------+------------------+
| Finisar       | 双速率 1G/10G SFP+ LR（无固定）        | FTLX1471D3QCV-IT |
+---------------+---------------------------------------+------------------+
| Avago         | 双速率 1G/10G SFP+ LR（无固定）        | AFCT-701SDZ-IN1  |
+---------------+---------------------------------------+------------------+
| Finisar       | 1000BASE-T SFP                        | FCLF8522P2BTL    |
+---------------+---------------------------------------+------------------+
| Avago         | 1000BASE-T                            | ABCU-5710RZ      |
+---------------+---------------------------------------+------------------+
| HP            | 1000BASE-SX SFP                       | 453153-001       |
+---------------+---------------------------------------+------------------+

基于 82599 的适配器支持所有符合 SFF-8431 v4.1 和 SFF-8472 v10.4 规范的被动和主动限制直接连接电缆
当使用 `ifconfig ethX down` 关闭 SFP+ 时激光关闭
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
`ifconfig ethX down` 会关闭基于 82599 的 SFP+ 光纤适配器的激光
`ifconfig ethX up` 会开启激光
或者，您可以使用 `ip link set [down/up] dev ethX` 来关闭和开启激光
基于 82599 的 QSFP+ 适配器
~~~~~~~~~~~~~~~~~~~~~~~~~~
注意事项：
- 如果您的基于 82599 的英特尔® 网络适配器配备了英特尔光学模块，则仅支持英特尔光学模块
基于82599的QSFP+适配器仅支持4x10 Gbps连接。不支持1x40 Gbps连接。QSFP+链路伙伴必须配置为4x10 Gbps。
- 基于82599的QSFP+适配器不支持自动链路速度检测。链路速度必须配置为10 Gbps或1 Gbps以匹配链路伙伴的速度能力。错误的速度配置将导致链路失败。
- Intel® Ethernet Converged Network Adapter X520-Q1仅支持以下列出的光模块和直接连接电缆。
| 供应商    | 类型                                      | 零件编号         |
|-----------|-----------------------------------------|----------------|
| Intel     | 双速率1G/10G QSFP+ SRL（捆绑）            | E10GQSFPSR     |

基于82599的QSFP+适配器支持所有符合SFF-8436 v4.1规范的被动式和主动限流QSFP+直接连接电缆。

基于82598的适配器
~~~~~~~~~~~~~~~~~~~~
注意事项：
- 支持可拆卸光模块的Intel® Ethernet网络适配器仅支持其原始模块类型（例如，Intel® 10 Gigabit SR Dual Port Express Module仅支持SR光模块）。如果您插入不同类型的模块，驱动程序将不会加载。
- 不支持热插拔/热交换光模块。
- 仅支持单一速度、10千兆位模块。
- 主板上的局域网（LOMs）可能支持DA、SR或LR模块。不支持其他类型的模块。请参阅您的系统文档了解详细信息。
以下是经过一些测试的SFP+模块和直接连接电缆列表。并非所有模块都适用于所有设备。
### 供应商信息表

| 供应商   | 类型                                       | 零件编号          |
|----------|--------------------------------------------|-------------------|
| Finisar  | SFP+ SR 带扣环，10G 单速率                 | FTLX8571D3BCL     |
| Avago    | SFP+ SR 带扣环，10G 单速率                 | AFBR-700SDZ       |
| Finisar  | SFP+ LR 带扣环，10G 单速率                 | FTLX1471D3BCL     |

基于82598的适配器支持所有符合SFF-8431 v4.1和SFF-8472 v10.4规范的无源直连电缆。不支持有源直连电缆。

上述提及的第三方光模块和电缆仅用于突出第三方规格及潜在兼容性，并非英特尔对任何第三方产品的推荐、认可或赞助。英特尔并不认可或推广第三方制造的产品，并且提供这些第三方参考信息仅为了共享有关具有上述规格的某些光模块和电缆的信息。可能还有其他制造商或供应商生产或供应具有相似或匹配描述的光模块和电缆。客户必须自行判断并谨慎从他们选择的第三方购买光模块和电缆。客户全权负责评估产品和/或设备的适用性以及选择供应商来购买任何产品。**上述提及的光模块和电缆不受英特尔保证和支持。**英特尔不对第三方产品的销售和/或使用承担任何责任，也不对客户选择供应商承担任何明示或暗示的保证。

### 命令行参数

#### max_vfs
- **有效范围：** 1-63

此参数增加了SR-IOV的支持。它导致驱动程序生成最多`max_vfs`数量的虚拟功能。
- 如果值大于0，还将强制VMDq参数为1或更大。
- **注意：** 此参数仅在内核3.7.x及以下版本中使用。对于内核3.8.x及以上版本，请使用sysfs启用VF。此外，对于红帽发行版，此参数仅在版本6.6及更早版本中使用。对于版本6.7及更高版本，请使用sysfs。例如：
  
  ```shell
  #echo $num_vf_enabled > /sys/class/net/$dev/device/sriov_numvfs // 启用VF
  #echo 0 > /sys/class/net/$dev/device/sriov_numvfs               // 禁用VF
  ```

驱动程序的参数通过位置引用。因此，如果您有一个双端口适配器或多于一个适配器在您的系统中，并希望每个端口有N个虚拟功能，您必须为每个端口指定一个数字，参数之间以逗号分隔。例如：

```shell
modprobe ixgbe max_vfs=4
```
这将在第一个端口上生成4个VF。

```shell
modprobe ixgbe max_vfs=2,4
```
这将在第一个端口上生成2个VF，在第二个端口上生成4个VF。

**注意：** 在加载带有这些参数的驱动程序时必须小心。
- 根据您的系统配置、插槽数量等，无法预测在所有情况下命令行上的位置。
- **注意：** 设备或驱动程序不控制VF如何映射到配置空间。总线布局将因操作系统而异。在支持它的操作系统上，您可以检查sysfs来找到映射关系。
注：当启用 SR-IOV 模式或 VMDq 模式时，硬件 VLAN 过滤和 VLAN 标签剥离/插入将保持启用状态。请在添加新的 VLAN 过滤器之前移除旧的过滤器。例如，

::

  ip link set eth0 vf 0 vlan 100 // 为 VF 0 设置 VLAN 100
  ip link set eth0 vf 0 vlan 0   // 删除 VLAN 100
  ip link set eth0 vf 0 vlan 200 // 为 VF 0 设置新的 VLAN 200

在内核 3.6 中，驱动程序支持 max_vfs 和 DCB 特性的同时使用，但需遵循以下限制。在内核 3.6 之前，驱动程序不支持 max_vfs 大于 0 与 DCB 特性（多个流量类别利用优先流控制和扩展传输选择）同时运行。
当启用 DCB 时，网络流量通过多个流量类别（NIC 中的数据包缓冲区）进行发送和接收。流量根据优先级与特定类别相关联，优先级值范围从 0 到 7，在 VLAN 标签中使用。当未启用 SR-IOV 时，每个流量类别都与一组接收/发送描述符队列对相关联。给定流量类别的队列对数量取决于硬件配置。当启用 SR-IOV 时，描述符队列对被分组到池中。物理功能（PF）和每个虚拟功能（VF）被分配了一组接收/发送描述符队列对的池。当配置了多个流量类别（例如，启用了 DCB），每个池包含来自每个流量类别的一个队列对。当硬件中配置了一个流量类别时，池包含来自单个流量类别的多个队列对。
可以分配的 VF 数量取决于可以启用的流量类别的数量。对于每个启用的 VF 的可配置流量类别的数量如下：
0 - 15 VF = 最多 8 个流量类别，具体取决于设备支持
16 - 31 VF = 最多 4 个流量类别
32 - 63 VF = 1 个流量类别

当配置了 VF 时，PF 也被分配了一个池。PF 支持 DCB 特性，但受到每个流量类别仅使用一个队列对的限制。当没有配置任何 VF 时，PF 可以支持每个流量类别多个队列对。
allow_unsupported_sfp
---------------------
:有效范围: 0,1
:默认值: 0（禁用）

此参数允许在基于 82599 的适配器上使用不受支持且未经测试的 SFP+ 模块，前提是模块类型为驱动程序所知。
debug
-----
:有效范围: 0-16 (0=无,...,16=全部)
:默认值: 0

此参数调整系统日志中显示的调试消息级别。
其他特性和配置
==================

流量控制
---------
可以通过 ethtool 配置以太网流量控制 (IEEE 802.3x)，以便为 ixgbe 启用接收和发送暂停帧。当启用发送时，如果接收数据包缓冲区超过预定义阈值，则生成暂停帧。当启用接收时，接收到暂停帧时，发送单元将停止指定的时间延迟。
注意：您必须有一个支持流量控制的链路伙伴。
默认情况下启用流量控制。
使用 ethtool 更改流量控制设置。要启用或禁用 Rx 或 Tx 流量控制，请执行：

  ethtool -A eth? rx <on|off> tx <on|off>

注意：此命令仅在禁用了自动协商的情况下启用或禁用流量控制。如果启用了自动协商，此命令会更改与链路伙伴进行自动协商时使用的参数。
要启用或禁用自动协商，请执行：

  ethtool -s eth? autoneg <on|off>

注意：流量控制自动协商是链路自动协商的一部分。根据您的设备，您可能无法更改自动协商设置。
注释：对于进入1千兆模式的82598背板卡，其流控制默认行为被更改为关闭。在这些设备的1千兆模式下启用流控制可能会导致传输挂起。

英特尔® 以太网流导向器
-----------------------
英特尔以太网流导向器执行以下任务：

- 根据数据流将接收的数据包导向不同的队列
- 在平台上对数据流进行精确控制
- 匹配数据流与CPU核心以实现流亲和性
- 支持多种参数以实现灵活的数据流分类和负载均衡（仅在SFP模式下支持）
  
注释：英特尔以太网流导向器的掩码工作方式与子网掩码相反。在以下命令中：

  #ethtool -N eth11 flow-type ip4 src-ip 172.4.1.2 m 255.0.0.0 dst-ip \
  172.21.1.1 m 255.128.0.0 action 31

写入过滤器中的src-ip值将是0.4.1.2，而不是可能预期的172.0.0.0。类似地，写入过滤器中的dst-ip值将是0.21.1.1，而不是172.0.0.0。
要启用或禁用英特尔以太网流导向器：

  # ethtool -K ethX ntuple <on|off>

当禁用ntuple过滤器时，所有用户编程的过滤器都会从驱动程序缓存和硬件中清除。重新启用ntuple时，必须重新添加所有需要的过滤器。
要添加一个将数据包导向队列2的过滤器，请使用-U或-N开关：

  # ethtool -N ethX flow-type tcp4 src-ip 192.168.10.1 dst-ip \
  192.168.10.2 src-port 2000 dst-port 2001 action 2 [loc 1]

要查看当前存在的过滤器列表：

  # ethtool <-u|-n> ethX

旁路完美过滤器
----------------
旁路完美过滤器用于定向匹配指定特性的流量。它们是通过ethtool的ntuple接口启用的。要添加一个新的过滤器，请使用以下命令：

  ethtool -U <device> flow-type <type> src-ip <ip> dst-ip <ip> src-port <port> \
  dst-port <port> action <queue>

其中：
  <device> - 要编程的以太网设备
  <type> - 可以是ip4、tcp4、udp4或sctp4
  <ip> - 要匹配的IP地址
  <port> - 要匹配的端口号
  <queue> - 要导向流量的队列（-1会丢弃匹配到的流量）

要删除一个过滤器，请使用以下命令：

  ethtool -U <device> delete <N>

其中<N>是在打印所有活动过滤器时显示的过滤器ID，也可以在添加过滤器时使用"loc <N>"指定。
以下示例匹配从192.168.0.1端口5300发送的TCP流量，目标为192.168.0.5端口80，并将其发送到队列7：

  ethtool -U enp130s0 flow-type tcp4 src-ip 192.168.0.1 dst-ip 192.168.0.5 \
  src-port 5300 dst-port 80 action 7

对于每种流类型，编程的过滤器都必须具有相同的匹配输入集。例如，发出以下两个命令是可以接受的：

  ethtool -U enp130s0 flow-type ip4 src-ip 192.168.0.1 src-port 5300 action 7
  ethtool -U enp130s0 flow-type ip4 src-ip 192.168.0.5 src-port 55 action 10

然而，发出下面两个命令是不可以接受的，因为第一个指定了src-ip而第二个指定了dst-ip：

  ethtool -U enp130s0 flow-type ip4 src-ip 192.168.0.1 src-port 5300 action 7
  ethtool -U enp130s0 flow-type ip4 dst-ip 192.168.0.5 src-port 55 action 10

第二个命令将以错误失败。您可以为同一字段使用不同值编程多个过滤器，但不能在同一设备上编程两个TCP4过滤器，如果它们具有不同的匹配字段。
ixgbe驱动程序不支持对字段的子部分进行匹配，因此不支持部分掩码字段。
为了创建将流量导向特定虚拟功能（Virtual Function，VF）的过滤器，请使用“user-def”参数。将 user-def 指定为一个 64 位值，其中较低的 32 位表示队列编号，而接下来的 8 位则表示是哪个 VF。请注意，0 表示物理功能（Physical Function，PF），因此 VF 的标识符需要偏移 1。例如：

  ... user-def 0x800000002 ..
这指定了将流量导向虚拟功能 7（8 减 1）中的队列 2。
请注意，这些过滤器不会破坏内部路由规则，并且不会将原本不应发送到指定虚拟功能的流量进行路由。

### 巨型帧支持
通过将最大传输单元（Maximum Transmission Unit，MTU）设置为大于默认值 1500 的值来启用巨型帧支持。
使用 ifconfig 命令来增加 MTU 大小。例如，对于接口号 <x>，输入以下命令：

  ifconfig eth<x> mtu 9000 up

或者，您也可以使用 ip 命令如下所示：

  ip link set mtu 9000 dev eth<x>
  ip link set up dev eth<x>

此设置在重启后不会保存。可以通过向文件中添加 'MTU=9000' 来永久更改设置：

  /etc/sysconfig/network-scripts/ifcfg-eth<x> // 对于 RHEL
  /etc/sysconfig/network/<config_file> // 对于 SLES

**注意：** 巨型帧的最大 MTU 设置为 9710。这个值与最大巨型帧大小 9728 字节相匹配。
**注意：** 此驱动程序会尝试使用多个页面大小的缓冲区来接收每个巨型数据包。这有助于避免在分配接收数据包时出现缓冲区饥饿问题。
**注意：** 对于基于 82599 的网络连接，如果要在虚拟功能（VF）中启用巨型帧，则必须首先在物理功能（PF）中启用巨型帧。VF 的 MTU 设置不能大于 PF 的 MTU。

### NBASE-T 支持
ixgbe 驱动程序在某些设备上支持 NBASE-T。但是，默认情况下会抑制 NBASE-T 速度的通告，以适应无法处理所通告的 NBASE-T 速度的故障网络交换机。使用 ethtool 命令在支持它的设备上启用 NBASE-T 速度的通告：

  ethtool -s eth? advertise 0x1800000001028

在具有 INTERFACES(5) 的 Linux 系统上，可以在 /etc/network/interfaces 中将其指定为预启动命令，以便接口始终以 NBASE-T 支持启动，例如：

  iface eth? inet dhcp
       pre-up ethtool -s eth? advertise 0x1800000001028 || true

### 通用接收卸载（GRO）
该驱动程序支持内核软件实现的 GRO（Generic Receive Offload）。通过将接收（Rx）流量合并成更大的数据块，GRO 在高 Rx 负载下可以显著降低 CPU 利用率。GRO 是之前使用的 LRO 接口的演进版本。GRO 可以合并除 TCP 之外的其他协议。它也可以安全地用于 LRO 有问题的配置，比如桥接和 iSCSI。

### 数据中心桥接（DCB）
**注意：**
内核假设 TC0 可用，并且如果 TC0 不可用，则会在设备上禁用优先流控制（Priority Flow Control，PFC）。要解决这个问题，在设置交换机上的 DCB 时，请确保启用了 TC0。
DCB 是一种在硬件中实现的质量服务(QoS)配置方案。它使用VLAN优先级标签(802.1p)来过滤流量，这意味着存在8种不同的优先级，流量可以根据这些优先级进行过滤。此外，它还支持优先流控制(802.1Qbb)，可以在网络压力下限制或消除丢包的数量。可以为每个优先级分配带宽，并且这种分配是在硬件级别强制执行的(802.1Qaz)。
适配器固件实现了LLDP和DCBX协议代理，遵循802.1AB和802.1Qaz标准。基于固件的DCBX代理仅运行在愿意模式下，并可以从支持DCBX的对等端接受设置。不支持通过dcbtool/lldptool软件配置DCBX参数。
ixgbe驱动程序实现了DCB netlink接口层，以便用户空间能够与驱动程序通信并查询端口的DCB配置。
ethtool
-------
驱动程序利用ethtool接口来进行驱动配置、诊断以及显示统计信息。为了实现这一功能，需要最新版本的ethtool。可以从以下地址下载：
https://www.kernel.org/pub/software/network/ethtool/

FCoE
----
ixgbe驱动程序支持光纤通道通过以太网(FCoE)和数据中心桥接(DCB)。此代码对常规驱动操作没有默认影响。配置DCB和FCoE超出了本README文档的范围。有关FCoE项目的更多信息，请参阅：http://www.open-fcoe.org/ 。对于DCB信息，请联系ixgbe-eedc@lists.sourceforge.net。
MAC和VLAN反欺骗功能
-------------------
当恶意驱动试图发送被欺骗的数据包时，硬件会将其丢弃而不会进行传输。向PF驱动程序发送中断，通知其发生了欺骗尝试。当检测到被欺骗的数据包时，PF驱动程序会向系统日志发送以下消息（可通过“dmesg”命令显示）：

  ixgbe ethX: ixgbe_spoof_check: 检测到 n 个被欺骗的数据包

其中"x"是PF接口编号；"n"是被欺骗数据包的数量。
注意：可以针对特定虚拟功能(VF)禁用此功能：

  ip link set <pf dev> vf <vf id> spoofchk {off|on}

IPsec卸载
----------
ixgbe驱动程序支持IPsec硬件卸载。创建安全关联("ip xfrm ...")时，可以使用'offload'标签选项将IPsec SA注册到驱动程序，以实现更高速度的安全通信。
卸载也支持ixgbe的VF，但VF必须设置为“可信”，并且需要启用该支持：

  ethtool --set-priv-flags eth<x> vf-ipsec on
  ip link set eth<x> vf <y> trust on

已知问题/故障排除
==================

在64位Microsoft Windows Server 2012/R2客户操作系统中启用SR-IOV
---------------------------------------------------------------------------------
Linux KVM Hypervisor/VMM支持将PCIe设备直接分配给虚拟机。这包括传统的PCIe设备，以及基于Intel Ethernet Controller XL710的SR-IOV功能设备。
支持
======
有关一般信息，请访问Intel支持网站：
https://www.intel.com/support/

如果在受支持内核上使用受支持的适配器时发现发布的源代码存在问题，请将与问题相关的确切信息发送至intel-wired-lan@lists.osuosl.org。
您没有提供需要翻译的文本。请提供需要翻译成中文的英文或其他语言的文本。
