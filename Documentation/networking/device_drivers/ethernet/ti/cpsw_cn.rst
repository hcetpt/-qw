### SPDX 许可证标识符: GPL-2.0

======================================
德克萨斯仪器公司 (TI) 的 CPSW 以太网驱动程序
======================================

多队列 & CBS & MQPRIO
=========================

CPSW 拥有每个外部端口 3 个 CBS 塑形器。本文档基于示例描述了 CPSW 驱动程序的 MQPRIO 和 CBS 队列调度器卸载配置。它潜在地可用于音频视频桥接 (AVB) 和时间敏感网络 (TSN)。
以下示例已在 AM572x EVM 和 BeagleBone Black (BBB) 板上进行了测试。

#### 测试设置

考虑两个使用 AM572x EVM 运行 CPSW 驱动程序的双 EMAC 模式的示例。有几个前提条件：

- 发送队列（TX 队列）必须从 txq0 开始进行优先级排序，txq0 具有最高优先级。
- 交通类别从 0 开始使用，具有最高优先级。
- CBS 塑形器应与已排序的队列一起使用。
- CBS 塑形器的带宽需要稍微大于潜在的输入速率，因此所有输入 TX 队列的速率必须略低。
- 实际速率可能有所不同，因为存在离散性。
- 映射 skb-priority 到 TX 队列是不够的，还需要通过 ip 或 vconfig 工具创建 skb-priority 到 L2 优先级映射。
- 可以为类别使用任何 L2/socket 优先级 (0 - 7)，但为了简单起见，默认值被使用：3 和 2。
- 只测试了两个类别：A 类和 B 类，但已检查并且可以工作更多的类别，最大允许 4 个，但只能为 3 个设置速率。
  
#### 示例测试设置

```
+-------------------------------+
|--+                            |
|  |      Workstation0          |
|E |  MAC 18:03:73:66:87:42     |
|t |./tsn_listener -d \         |
|h | 18:03:73:66:87:42 -i eth0 \|
|0 | -s 1500                    |
|--+                            |
+-------------------------------+

Target Board: AM572x EVM
Only 2 classes: class A, class B

+-----------------------------+
|                    | 1  | E |  |
|                    | 0  | t |  |
|                    | 0  | h |--+ ./tsn_listener -d \ 
|                    |Mb  | 0 |  18:03:73:66:87:42 -i eth0 \ 
|                    +---+     -s 1500                    |
|                                        |
|                                        |
|                                        |
|                                        |
+-----------------------------+
|                    | 1  | E |  |
|                    | 0  | t |  |
|                    | 0  | h |--+ ./tsn_listener -d \ 
|                    |Mb  | 1 |  20:cf:30:85:7d:fd -i eth0 \ 
|                    +---+     -s 1500                    |
+-------------------------------+
|  |      Workstation1          |
|E |  MAC 20:cf:30:85:7d:fd     |
|t |./tsn_listener -d \         |
|h | 20:cf:30:85:7d:fd -i eth0 \|
|0 | -s 1500                    |
|--+                            |
+-------------------------------+
```

#### 示例 1: 目标板单端口 AVB 配置方案

（适用于 AM572x EVM 的打印和方案，适用于单端口板）

- tc - 交通类别
- txq - 发送队列
- p - 优先级
- f - 队列（FIFO）
- S - 已配置塑形器

```
+------------------------------------------------------------------+
| +---------------+  +---------------+  +------+ +------+          |
| |               |  |               |  |      | |      |          |
| | App 1         |  | App 2         |  | Apps | | Apps |          |
| | Class A       |  | Class B       |  | Rest | | Rest |          |
| | Eth0          |  | Eth0          |  | Eth0 | | Eth1 |          |
| | VLAN100       |  | VLAN100       |  |   |  | |   |  |          |
| | 40 Mb/s       |  | 20 Mb/s       |  |   |  | |   |  |          |
| | SO_PRIORITY=3 |  | SO_PRIORITY=2 |  |   |  | |   |  |          |
| |   |           |  |   |           |  |   |  | |   |  |          |
| +---|-----------+  +---|-----------+  +---|--+ +---|--+          |
+-----|------------------|------------------|--------|-------------+
	+-+     +------------+                  |        |
	|       |             +-----------------+     +--+
	|       |             |                       |
    +---|-------|-------------|-----------------------|----------------+
    | +----+ +----+ +----+ +----+                   +----+             |
    | | p3 | | p2 | | p1 | | p0 |                   | p0 |             |
    | \    / \    / \    / \    /                   \    /             |
    |  \  /   \  /   \  /   \  /                     \  /              |
    |   \/     \/     \/     \/                       \/               |
    |   |      |             |                        |                |
    |   |      |       +-----+                        |                |
    |   |      |       |                              |                |
    | +----+ +----+ +----+                          +----+             |
    | |tc0 | |tc1 | |tc2 |                          |tc0 |             |
    | \    / \    / \    /                          \    /             |
    |  \  /   \  /   \  /                            \  /              |
    |   \/     \/     \/                              \/               |
    |   |      |       +-----+                        |                |
    |   |      |       |     |                        |                |
    |   |      |       |     |                        |                |
    |   |      |       |     |                        |                |
    | +----+ +----+ +----+ +----+                   +----+             |
    | |txq0| |txq1| |txq2| |txq3|                   |txq4|             |
    | \    / \    / \    / \    /                   \    /             |
    |  \  /   \  /   \  /   \  /                     \  /              |
    |   \/     \/     \/     \/                       \/               |
    | +-|------|------|------|--+                  +--|--------------+ |
    | | |      |      |      |  | Eth0.100         |  |     Eth1     | |
    +---|------|------|------|------------------------|----------------+
	|      |      |      |                        |
	p      p      p      p                        |
	3      2      0-1, 4-7  <- L2 priority        |
	|      |      |      |                        |
	|      |      |      |                        |
    +---|------|------|------|------------------------|----------------+
    |   |      |      |      |             |----------+                |
    | +----+ +----+ +----+ +----+       +----+                         |
    | |dma7| |dma6| |dma5| |dma4|       |dma3|                         |
    | \    / \    / \    / \    /       \    /                         |
    |  \S /   \S /   \  /   \  /         \  /                          |
    |   \/     \/     \/     \/           \/                           |
+------------------------------------------------------------------+
```

步骤 1 至 14 的详细说明省略。

#### 示例 2: 目标板双端口 AVB 配置方案

（适用于 AM572x EVM 的打印和方案，仅适用于双 EMAC 板）

```
+------------------------------------------------------------------+
| +----------+  +----------+  +------+  +----------+  +----------+ |
| |          |  |          |  |      |  |          |  |          | |
| | App 1    |  | App 2    |  | Apps |  | App 3    |  | App 4    | |
| | Class A  |  | Class B  |  | Rest |  | Class B  |  | Class A  | |
| | Eth0     |  | Eth0     |  |   |  |  | Eth1     |  | Eth1     | |
| | VLAN100  |  | VLAN100  |  |   |  |  | VLAN100  |  | VLAN100  | |
| | 40 Mb/s  |  | 20 Mb/s  |  |   |  |  | 10 Mb/s  |  | 30 Mb/s  | |
| | SO_PRI=3 |  | SO_PRI=2 |  |   |  |  | SO_PRI=3 |  | SO_PRI=2 | |
| |   |      |  |   |      |  |   |  |  |   |      |  |   |      | |
| +---|------+  +---|------+  +---|--+  +---|------+  +---|------+ |
+-----|-------------|-------------|---------|-------------|--------+
	+-+     +-------+             |         +----------+  +----+
	|       |             +-------+------+             |       |
	|       |             |              |             |       |
    +---|-------|-------------|--------------|-------------|-------|---+
    | +----+ +----+ +----+ +----+          +----+ +----+ +----+ +----+ |
    | | p3 | | p2 | | p1 | | p0 |          | p0 | | p1 | | p2 | | p3 | |
    | \    / \    / \    / \    /          \    / \    / \    / \    / |
    |  \  /   \  /   \  /   \  /            \  /   \  /   \  /   \  /  |
    |   \/     \/     \/     \/              \/     \/     \/     \/   |
    |   |      |             |                |             |      |   |
    |   |      |        +----+                +----+        |      |   |
    |   |      |        |                          |        |      |   |
    | +----+ +----+ +----+                        +----+ +----+ +----+ |
    | |tc0 | |tc1 | |tc2 |                        |tc2 | |tc1 | |tc0 | |
    | \    / \    / \    /                        \    / \    / \    / |
    |  \  /   \  /   \  /                          \  /   \  /   \  /  |
    |   \/     \/     \/                            \/     \/     \/   |
    |   |      |       +-----+                +-----+      |       |   |
    |   |      |       |     |                |     |      |       |   |
    |   |      |       |     |                |     |      |       |   |
    |   |      |       |     |    E      E    |     |      |       |   |
    | +----+ +----+ +----+ +----+ t      t +----+ +----+ +----+ +----+ |
    | |txq0| |txq1| |txq4| |txq5| h      h |txq6| |txq7| |txq3| |txq2| |
    | \    / \    / \    / \    / 0      1 \    / \    / \    / \    / |
    |  \  /   \  /   \  /   \  /  .      .  \  /   \  /   \  /   \  /  |
    |   \/     \/     \/     \/   1      1   \/     \/     \/     \/   |
    | +-|------|------|------|--+ 0      0 +-|------|------|------|--+ |
    | | |      |      |      |  | 0      0 | |      |      |      |  | |
    +---|------|------|------|---------------|------|------|------|----+
	|      |      |      |               |      |      |      |
	p      p      p      p               p      p      p      p
	3      2      0-1, 4-7   <-L2 pri->  0-1, 4-7      2      3
	|      |      |      |               |      |      |      |
	|      |      |      |               |      |      |      |
    +---|------|------|------|---------------|------|------|------|----+
    |   |      |      |      |               |      |      |      |    |
    | +----+ +----+ +----+ +----+          +----+ +----+ +----+ +----+ |
    | |dma7| |dma6| |dma3| |dma2|          |dma1| |dma0| |dma4| |dma5| |
    | \    / \    / \    / \    /          \    / \    / \    / \    / |
    |  \S /   \S /   \  /   \  /            \S /   \  /   \S /   \S /  |
    |   \/     \/     \/     \/              \/     \/     \/     \/   |
+------------------------------------------------------------------+
```

步骤 1 至 14 的详细说明省略。
Here's the translation of the provided commands and comments into Chinese:

15) ::

   // 为类B设置速率 - 11Mbps（tc1, txq3）使用CBS队列调度器针对Eth1
   // 为其预留+1Mbps（重要！）
   $ tc qdisc add dev eth1 parent 100:4 cbs locredit -1335 \
   hicredit 405 sendslope -89000 idleslope 11000 offload 1
   net eth1: 设置FIFO2带宽 = 11

16) ::

   // 创建VLAN 100，将sk->priority映射到Eth1的VLAN QoS
   $ ip link add link eth1 name eth1.100 type vlan id 100
   net eth1: 向VLAN过滤器添加vlanid 100

17) ::

   // 将skb->priority映射到Eth1.100的第二层优先级，一对一映射
   $ ip link set eth1.100 type vlan \
   egress 0:0 1:1 2:2 3:3 4:4 5:5 6:6 7:7

18) ::

   // 检查vlan 100的egress映射
   $ cat /proc/net/vlan/eth1.100
   [...]
   INGRESS优先级映射: 0:0  1:0  2:0  3:0  4:0  5:0  6:0 7:0
   EGRESS优先级映射: 0:0 1:1 2:2 3:3 4:4 5:5 6:6 7:7

19) ::

   // 使用socket选项"SO_PRIORITY"为3运行相应的工具以用于A类，为2用于B类。对于两个接口
   ./tsn_talker -d 18:03:73:66:87:42 -i eth0.100 -p2 -s 1500&
   ./tsn_talker -d 18:03:73:66:87:42 -i eth0.100 -p3 -s 1500&
   ./tsn_talker -d 20:cf:30:85:7d:fd -i eth1.100 -p2 -s 1500&
   ./tsn_talker -d 20:cf:30:85:7d:fd -i eth1.100 -p3 -s 1500&

20) ::

   // 在工作站上运行监听器（应该在同一VLAN内）
   // （参考自https://www.spinics.net/lists/netdev/msg460869.html）
   ./tsn_listener -d 18:03:73:66:87:42 -i enp5s0 -s 1500
   接收数据速率: 39012 kbps
   接收数据速率: 39012 kbps
   接收数据速率: 39012 kbps
   接收数据速率: 39012 kbps
   接收数据速率: 39012 kbps
   接收数据速率: 39012 kbps
   接收数据速率: 39012 kbps
   接收数据速率: 39012 kbps
   接收数据速率: 39012 kbps
   接收数据速率: 39012 kbps
   接收数据速率: 39012 kbps
   接收数据速率: 39000 kbps

21) ::

   // 如需恢复默认配置
   $ ip link del eth1.100
   $ ip link del eth0.100
   $ tc qdisc del dev eth1 root
   net eth1: 之前的FIFO2已进行整形
   net eth1: 设置FIFO3带宽 = 0
   net eth1: 设置FIFO2带宽 = 0
   $ tc qdisc del dev eth0 root
   net eth0: 之前的FIFO2已进行整形
   net eth0: 设置FIFO3带宽 = 0
   net eth0: 设置FIFO2带宽 = 0
   $ ethtool -L eth0 rx 1 tx 1
