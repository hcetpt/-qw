SPDX 许可证标识符: GPL-2.0

======================
Hyper-V 网络驱动程序
======================

兼容性
=============

此驱动程序与 Windows Server 2012 R2、2016 及 Windows 10 兼容。
特性
========

校验和卸载
----------------
  只要 Hyper-V 主机版本支持，netvsc 驱动程序就支持校验和卸载。Windows Server 2016 和 Azure 支持对于 TCP 和 UDP 的 IPv4 和 IPv6 的校验和卸载。Windows Server 2012 仅支持 TCP 的校验和卸载。
接收端扩展
--------------------
  Hyper-V 支持接收端扩展。对于 TCP 和 UDP，可以根据 IP 地址和端口号将数据包分配到可用队列中。
对于 TCP 和 UDP，我们可以通过 ethtool 命令在第 3 层和第 4 层之间切换哈希级别。TCP/UDP 过 IPv4 和 IPv6 可以设置为不同。默认的哈希级别是第 4 层。目前我们只允许从客户机内部切换 TX 哈希级别。
在 Azure 上，使用第 4 层哈希时分片的 UDP 数据包有很高的丢失率。在这种情况下建议使用第 3 层哈希。
例如，对于 eth0 上的 UDP 过 IPv4：

  要在哈希中包含 UDP 端口号，请执行如下命令::

	ethtool -N eth0 rx-flow-hash udp4 sdfn

  要在哈希中排除 UDP 端口号，请执行如下命令::

	ethtool -N eth0 rx-flow-hash udp4 sd

  查看 UDP 哈希级别，请执行如下命令::

	ethtool -n eth0 rx-flow-hash udp4

通用接收卸载（GRO）
--------------------------------
  驱动程序支持 GRO，并且默认启用。GRO 将相似的数据包合并，从而显著减少了在高接收负载下的 CPU 使用率。
大容量接收卸载（LRO）或接收端合并（RSC）
-------------------------------------------------------------
  驱动程序在虚拟交换机功能中支持 LRO/RSC。它通过可能的情况下合并多个 TCP 分段来减少每个数据包的处理开销。该特性默认在运行于 Windows Server 2019 及更高版本的虚拟机上启用。可以通过 ethtool 命令更改该设置::

	ethtool -K eth0 lro on
	ethtool -K eth0 lro off

SR-IOV 支持
--------------
  Hyper-V 支持 SR-IOV 作为硬件加速选项。如果在虚拟交换机和客户机配置中都启用了 SR-IOV，则虚拟功能（VF）设备将作为 PCI 设备传递给客户机。在这种情况下，客户机操作系统中可见的是合成（netvsc）设备和 VF 设备，且这两个网络接口卡具有相同的 MAC 地址。
VF 设备由 netvsc 设备管理。netvsc 驱动程序会在 VF 可用且处于活动状态时透明地切换数据路径至 VF。
网络状态（地址、防火墙等）应仅应用于 netvsc 设备；在大多数情况下，不应直接访问从属设备。例外情况是需要某些特殊的队列纪律或流量导向，这些应该直接应用于 VF 从属设备。
接收缓冲区
--------------
  数据包被接收进一个在设备探测时创建的接收区域。接收区域被划分为 MTU 大小的块，每个块可能包含一个或多个数据包。接收分区的数量可通过 ethtool 的 Rx 环参数进行更改。
存在一个类似的发送缓冲区，用于聚合待发送的数据包。发送区域被划分为多个块，通常每个块大小为6144字节，每个块中可能包含一个或多个数据包。小的数据包通常通过复制到发送缓冲区的方式进行传输。然而，如果缓冲区暂时耗尽，或者待发送的数据包是LSO数据包，驱动程序将向主机提供从SKB指向数据的指针。这试图在数据复制开销与重新映射VM内存以便主机访问的影响之间取得平衡。

### XDP支持
-----------------
XDP（eXpress Data Path）是一种特性，在数据包到达网卡的早期阶段运行eBPF字节码。其目标是提高数据包处理性能，减少SKB分配和其他上层网络层的开销。
hv_netvsc支持原生模式下的XDP，并且会透明地在其关联的VF NIC上设置XDP程序。

在合成NIC（netvsc）上设置/取消设置XDP程序会自动传播到VF NIC。直接在VF NIC上设置/取消设置XDP程序不被推荐，也不会传播到合成NIC，并且可能会被合成NIC上的设置覆盖。

XDP程序不能在LRO（RSC）启用的情况下运行，所以在运行XDP之前需要禁用LRO：

    ethtool -K eth0 lro off

目前还不支持XDP_REDIRECT操作。
