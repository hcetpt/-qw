.. SPDX-License-Identifier: GPL-2.0

======================
Hyper-V 网络驱动程序
======================

兼容性
=============

此驱动程序兼容 Windows Server 2012 R2、2016 和 Windows 10。
特性
========

校验和卸载
----------------
  只要 Hyper-V 主机版本支持，netvsc 驱动程序就支持校验和卸载。Windows Server 2016 和 Azure 支持针对 TCP 和 UDP 的 IPv4 和 IPv6 校验和卸载。Windows Server 2012 只支持 TCP 校验和卸载。
接收侧扩展
--------------------
  Hyper-V 支持接收侧扩展。对于 TCP 和 UDP，可以根据 IP 地址和端口号将数据包分发到可用队列中。
  对于 TCP 和 UDP，我们可以通过 ethtool 命令在第 3 层（L3）和第 4 层（L4）之间切换哈希级别。TCP/UDP 过 IPv4 和 IPv6 可以分别设置。默认的哈希级别是 L4。目前我们只允许从虚拟机内部切换 TX 哈希级别。
  在 Azure 上，使用 L4 哈希时，分片的 UDP 数据包有很高的丢包率。在这种情况下建议使用 L3 哈希。
  例如，对于 eth0 上的 UDP over IPv4：

  包含 UDP 端口号进行哈希处理::

    ethtool -N eth0 rx-flow-hash udp4 sdfn

  不包含 UDP 端口号进行哈希处理::

    ethtool -N eth0 rx-flow-hash udp4 sd

  显示 UDP 哈希级别::

    ethtool -n eth0 rx-flow-hash udp4

通用接收卸载（GRO）
--------------------------------
  驱动程序支持 GRO，并且默认启用。GRO 能够合并相似的数据包，在高接收负载下显著减少 CPU 使用率。
大接收卸载（LRO），或接收侧合并（RSC）
-------------------------------------------------------------
  驱动程序支持 vSwitch 特性中的 LRO/RSC。通过可能时合并多个 TCP 段来减少每个数据包的处理开销。该功能默认在运行 Windows Server 2019 及更高版本的虚拟机上启用。可以使用 ethtool 命令进行更改::

    ethtool -K eth0 lro on
    ethtool -K eth0 lro off

SR-IOV 支持
--------------
  Hyper-V 支持 SR-IOV 作为硬件加速选项。如果 vSwitch 和虚拟机配置中都启用了 SR-IOV，则虚拟功能（VF）设备会作为 PCI 设备传递给虚拟机。在这种情况下，虚拟机操作系统中同时可见合成设备（netvsc）和 VF 设备，并且这两个网卡具有相同的 MAC 地址。
  VF 被 netvsc 设备接管。当 VF 可用且正常工作时，netvsc 驱动程序会透明地切换数据路径到 VF。
  网络状态（地址、防火墙等）应仅应用于 netvsc 设备；通常不应直接访问从属设备。例外情况是需要特殊队列纪律或流量导向时，这些应直接应用于 VF 从属设备。
接收缓冲区
--------------
  数据包被接收进一个在设备探测时创建的接收区域。接收区域被划分为 MTU 大小的块，每个块可能包含一个或多个数据包。接收段的数量可以通过 ethtool 的 Rx 环参数进行更改。
有一个类似的发送缓冲区，用于聚合待发送的数据包。发送区域被划分为多个块，通常每个块大小为 6144 字节，每个块可能包含一个或多个数据包。小数据包通常通过复制到发送缓冲区进行传输。然而，如果缓冲区暂时耗尽，或者待发送的数据包是LSO数据包，驱动程序将向主机提供来自SKB的数据指针。这样做是为了在数据复制开销和使VM内存重新映射以便主机访问的影响之间取得平衡。

### XDP 支持
-----------------
XDP（eXpress Data Path）是一种在数据包到达网卡的早期阶段运行eBPF字节码的功能。其目标是提高数据包处理的性能，减少SKB分配和其他上层网络协议栈的开销。
hv_netvsc支持原生模式下的XDP，并且透明地在关联的VF网卡上设置XDP程序。
在合成网卡（netvsc）上设置/取消设置XDP程序会自动传播到VF网卡。直接在VF网卡上设置/取消设置XDP程序不被推荐，也不会传播到合成网卡，并且可能会被合成网卡上的设置覆盖。
XDP程序不能在启用LRO（RSC）的情况下运行，因此在运行XDP之前需要禁用LRO：

```
ethtool -K eth0 lro off
```

目前还不支持XDP_REDIRECT操作。
