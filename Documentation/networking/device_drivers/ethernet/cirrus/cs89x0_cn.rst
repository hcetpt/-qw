SPDX 许可声明标识符: GPL-2.0

================================================
Cirrus Logic LAN CS8900/CS8920 以太网适配器
================================================

.. 注意::

   本文件由 Cirrus Logic 为内核 2.2.5 版本提供。此版本已由 Andrew Morton 更新至 2.3.48。
   仍然过于过时！需要进行重大清理。
   Cirrus 在其网站上提供了该驱动程序的副本，如下面所述。通常情况下，您应使用随您的 Linux 发行版一起提供的驱动程序版本。
   Linux 网络接口驱动程序版本 2.00 <内核 2.3.48>

.. 目录

   1.0 Cirrus Logic LAN CS8900/CS8920 以太网适配器
      1.1 产品概述
      1.2 驱动程序描述
         1.2.1 驱动程序名称
         1.2.2 驱动程序包中的文件
      1.3 系统要求
      1.4 许可信息

   2.0 适配器安装与配置
      2.1 基于 CS8900 的适配器配置
      2.2 基于 CS8920 的适配器配置

   3.0 作为模块加载驱动程序

   4.0 编译驱动程序
      4.1 将驱动程序编译为可加载模块
      4.2 编译驱动程序以支持内存模式
      4.3 编译驱动程序以支持 Rx DMA

   5.0 测试与故障排除
      5.1 已知缺陷和限制
      5.2 测试适配器
         5.2.1 诊断自检
         5.2.2 诊断网络测试
      5.3 使用适配器的 LED
      5.4 解决 I/O 冲突

   6.0 技术支持
      6.1 联系 Cirrus Logic 的技术支持
      6.2 联系技术支持前所需的信息
      6.3 获取最新驱动程序版本
      6.4 当前维护者
      6.5 内核启动参数

1. Cirrus Logic LAN CS8900/CS8920 以太网适配器
===================================================

1.1. 产品概述
=====================

Cirrus Logic 的 CS8900 基础 ISA 以太网适配器遵循 IEEE 802.3 标准，并支持在 ISA 总线计算机上的 10 Mbps 以太网网络中进行半双工或全双工操作。这些适配器设计用于 16 位 ISA 或 EISA 总线扩展槽，并有仅支持 10BaseT 或支持三种介质（10BaseT、10Base2 和 AUI 用于 10Base-5 或光纤网络）的配置。

基于 CS8920 的适配器类似于基于 CS8900 的适配器，但增加了对即插即用（PnP）的支持和唤醒帧识别功能。因此，两种类型适配器的配置过程有所不同。请参阅“适配器配置”部分以获取有关配置这两种类型适配器的详细信息。

1.2. 驱动程序描述
=======================

CS8900/CS8920 以太网适配器驱动程序支持 Linux v2.3.48 或更高版本的内核。它可以被直接编译到内核中，或者在运行时作为设备驱动程序模块加载。

1.2.1 驱动程序名称：cs89x0

1.2.2 驱动程序包中的文件：

Cirrus 网站上的驱动程序包含以下文件：

  ===================  ====================================================
  readme.txt           本文件
  build                批处理文件，用于编译 cs89x0.c
  cs89x0.c             驱动程序 C 代码
  cs89x0.h             驱动程序头文件
  cs89x0.o             预编译模块（针对 v2.2.5 内核）
  config/Config.in     示例文件，用于将 cs89x0 驱动程序包含在内核中
  config/Makefile      示例文件，用于将 cs89x0 驱动程序包含在内核中
  config/Space.c       示例文件，用于将 cs89x0 驱动程序包含在内核中
1.3. 系统要求
------------------------

以下硬件是必需的：

   * 基于 Cirrus Logic LAN（CS8900/20）的以太网 ISA 适配器

   * IBM 或兼容 IBM 的 PC，需具备：
     * 80386 或更高处理器
     * 在 210h 到 370h 之间有 16 字节连续的 I/O 空间
     * 一个可用的 IRQ（CS8900 使用 5、10、11 或 12，CS8920 使用 3-7、9-15）
* 适用于您的网络拓扑结构的适当电缆（和 AUI、10BASE-2 连接器）

以下软件是必需的：

* LINUX 内核版本 2.3.48 或更高

   * CS8900/20 设置工具（基于 DOS）

   * 您内核的 LINUX 内核源代码（如果要编译到内核中）

   * GNU 工具包（gcc 和 make）v2.6 或更高版本（如果要编译为内核或模块）

1.4. 许可信息
--------------------------

本程序是自由软件；您可以根据由 Free Software Foundation 发布的 GNU 通用公共许可证第 1 版重新分发和/或修改它。
本程序以希望其有用的方式分发，但没有任何保证；甚至没有隐含的关于适销性或适合特定用途的保证。请参阅 GNU 通用公共许可证获取更多详细信息。
如需获得 GNU 通用公共许可证的完整副本，请写信至 Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA。

2. 适配器安装与配置
=========================

基于 CS8900 和 CS8920 的适配器可以通过存储在板载 EEPROM 中的参数进行配置。如果您想更改适配器在 EEPROM 中的配置，必须使用基于 DOS 的 CS8900/20 设置工具。
当作为模块加载驱动时，您可以在命令行上指定许多适配器的配置参数以覆盖 EEPROM 的设置，或者在没有使用 EEPROM 时进行接口配置。（基于 CS8920 的适配器必须使用 EEPROM。）详见第 3.0 节 加载驱动作为模块。
由于 CS8900/20 设置工具是一个基于 DOS 的应用程序，因此您必须在一个基于 DOS 的系统中使用 CS8900/20 设置工具来安装和配置适配器，然后再将其安装到目标 LINUX 系统中。（如果是安装基于 CS8900 的适配器且默认配置可以接受，则无需此步骤。）

2.1. 基于 CS8900 的适配器配置
---------------------------------------

从 Cirrus Logic 出厂的基于 CS8900 的适配器已使用以下“默认”设置进行配置：

  操作模式：内存模式
  IRQ：10
  基础 I/O 地址：300
  内存基地址：D0000
  优化：DOS 客户端
  传输模式：半双工
  BootProm：无
  媒体类型：自动检测（三媒体卡）或 10BASE-T（仅限 10BASE-T 适配器）

只有在与其他适配器存在冲突的情况下才应更改默认配置设置。要更改适配器的配置，请运行 CS8900/20 设置工具。

2.2. 基于 CS8920 的适配器配置
---------------------------------------

从 Cirrus Logic 出厂的基于 CS8920 的适配器已配置为即插即用（PnP）。然而，由于 cs89x0 驱动不支持 PnP，您必须将 CS8920 适配器安装在基于 DOS 的 PC 上，并运行 CS8900/20 设置工具以禁用 PnP 并在安装到目标 Linux 系统之前配置适配器。否则，适配器将无法激活，驱动也无法与其通信。

```
****************************************************************
*                  基于 CS8920 的适配器：                     *
*                                                              *
* 基于 CS8920 的适配器默认启用即插即用（PnP）。               *
* 由于 cs89x0 驱动不支持 PnP，因此您必须运行                   *
* CS8900/20 设置工具以禁用 PnP 支持并激活适配器。              *
****************************************************************
```

3. 加载驱动作为模块
============================

如果驱动被编译为可加载模块，您可以使用 'modprobe' 命令加载驱动模块。许多适配器的配置参数可以作为加载命令的命令行参数指定。这种功能提供了覆盖 EEPROM 设置或在未使用 EEPROM 时进行接口配置的方法。
示例：

    insmod cs89x0.o io=0x200 irq=0xA media=aui

此示例加载模块并将适配器配置为使用IO端口基地址200h、中断10以及AUI媒体连接。以下配置选项可以在命令行中指定：

  io=###               - 指定IO地址（200h-360h）
  irq=##               - 指定中断级别
  use_dma=1            - 启用DMA
  dma=#                - 指定DMA通道（驱动程序编译时仅支持接收DMA）
  dmasize=# (16或64)   - DMA大小为16K或64K，默认值设置为16
  media=rj45           - 指定媒体类型
  或 media=bnc
  或 media=aui
  或 media=auto
  duplex=full          - 指定强制半双工/全双工/自动协商模式
  或 duplex=half
  或 duplex=auto
  debug=#              - 调试级别（只有在驱动程序编译为调试时才可用）

**注意事项：**

a) 如果存在EEPROM，则任何指定的命令行参数将覆盖EEPROM中存储的相应配置值。
b) “io”参数必须在命令行中指定。
c) 驱动程序的硬件探测例程设计为避免写入I/O空间，直到它知道所写的地址处有一个cs89x0卡。这可能会导致设备探测问题。为了避免这种行为，可以在“io=”模块参数后加1。这实际上不会改变I/O地址，但它是一个标志，告诉驱动程序在尝试识别卡之前部分初始化硬件。如果你不确定提供的地址处是否有一个cs89x0卡，这样做可能是危险的。例如，要扫描位于IO基地址0x300的适配器，请指定IO地址为0x301。
d) “duplex=auto”参数仅适用于CS8920。
e) 如果不存在EEPROM，所需的最小命令行配置包括：
   io
   irq
   媒体类型（不支持自动检测）
f) 以下附加参数是CS89XX的默认值（没有EEPROM或命令行参数时使用的值）：
   * DMA Burst = 启用
   * IOCHRDY Enabled = 启用
   * UseSA = 启用
   * CS8900默认为半双工，如果未在命令行中指定
   * CS8920默认为自动协商，如果未在命令行中指定
   * 对其他配置参数使用重置默认值
   * dma_mode = 0
g) 可以使用ifconfig设置适配器的以太网地址。
h) 许多Linux发行版使用'modprobe'命令来加载模块。该程序使用'/etc/conf.modules'文件来确定加载驱动模块时传递给它的配置信息。所有上述描述的配置选项都可以放在/etc/conf.modules中。例如：

     > cat /etc/conf.modules
     ..
```bash
# 别名 eth0 为 cs89x0
别名 eth0 cs89x0
选项 cs89x0 io=0x0200 dma=5 use_dma=1
...
在这个例子中，我们告诉模块系统，这台机器的以太网驱动应该使用 cs89x0 驱动。我们要求 'modprobe' 在加载驱动时传递 'io'、'dma' 和 'use_dma' 参数。
i) Cirrus 建议 cs89x0 使用 ISA DMA 通道 5、6 或 7。你可能会发现其他 DMA 通道无法工作。
j) cs89x0 只支持接收时使用 DMA。DMA 模式显著更高效。向一台 400 MHz 的 Celeron 机器大量发送大包 ping 数据，在非 DMA 模式下会消耗 82% 的 CPU 能力。而使用 DMA 时，这个比例降低到 45%。
k) 如果你的 Linux 内核编译时启用了内置的即插即用支持，你可以通过以下命令找到关于 cs89x0 卡的信息：

    cat /proc/isapnp

l) 如果在 DMA 操作期间你发现行为异常或网络数据损坏，你应该使用 PC 的 BIOS 来减慢 EISA 总线时钟。
m) 如果 cs89x0 驱动直接编译到内核中（非模块化），其 I/O 地址将自动由 ISA 总线探测确定。中断请求号（IRQ）、媒体选项等信息将从卡上的 EEPROM 中获取。
n) 如果 cs89x0 驱动直接编译到内核中，可以通过提供内核启动选项 'cs89x0_dma=N' 来选择 DMA 模式，其中 'N' 是所需的 DMA 通道号（5、6 或 7）。
内核启动选项可以在 LILO 命令行中提供：

    LILO 启动：linux cs89x0_dma=5

或者可以放在 /etc/lilo.conf 文件中：

    image=/boot/bzImage-2.3.48
      append="cs89x0_dma=5"
      label=linux
      root=/dev/hda5
      read-only

在这种模式下，DMA 接收缓冲区大小被硬编码为 16 KB（64 KB 模式不可用）。

4. 编译驱动
=======================

cs89x0 驱动可以直接编译到内核中，也可以编译成一个可加载的设备驱动模块。
```
只需使用标准方法来配置驱动程序并编译内核。

### 4. 编译驱动程序以支持 Rx DMA
-------------------------------

在2.3版本的内核系列中，DMA（直接内存访问）的编译时可选项已被移除。DMA支持现在是驱动程序的一部分，并且默认启用。通过模块选项 `use_dma=1` 来启用DMA支持。

### 5. 测试和故障排除
====================

#### 5.1 已知缺陷和限制
----------------------------------

参见此存档中分发的 `RELEASE.TXT` 文件，其中列出了已知缺陷、驱动程序限制及解决方法。

#### 5.2 测试适配器
------------------------

安装并配置好适配器后，可以使用 CS8900/20 Setup Utility 的诊断选项来测试适配器及其网络连接的功能。使用诊断中的“自检”选项来测试硬件配置下的适配器功能。您可以使用诊断中的“网络测试”选项来测试适配器与另一台装有基于 CS8900/20 的适配器卡的PC之间的以太网通信能力（该PC也必须运行 CS8900/20 Setup Utility）。

**注意：**

    Setup Utility 的诊断工具设计用于仅运行在 DOS 操作系统环境中。**不要**在 Windows 95、Windows NT、OS/2 或其他操作系统的 DOS 或命令提示符会话中运行诊断工具。

要对 CS8900/20 适配器运行诊断测试：

1. 在 PC 上启动 DOS 并启动 CS8900/20 Setup Utility。
2. 显示适配器的当前配置。按 ENTER 键进入主菜单。
3. 从主菜单中选择“诊断”（ALT-G）。
4. 选择“自检”以测试适配器的基本功能。
5. 选择“网络测试”以测试网络连接和电缆。
5.2.1. 诊断自检
^^^^^^^^^^^^^^^^^^^^^^^^^^^

诊断自检检查适配器的基本功能以及根据硬件配置分配的系统资源，通过 ISA 总线进行通信的能力。以下测试将被执行：

- 输入输出寄存器读写测试

  输入输出寄存器读写测试确保 CS8900/20 可以在输入输出模式下被访问，并且输入输出基地址正确。
- 共享内存测试

  共享内存测试确保 CS8900/20 可以在内存模式下被访问，并且分配的内存地址范围不会与系统中的其他设备冲突。
- 中断测试

  中断测试确保分配的中断请求（IRQ）信号没有冲突。
- EEPROM 测试

  EEPROM 测试确保可以读取 EEPROM。
- 芯片 RAM 测试

  芯片 RAM 测试确保 CS8900/20 内部的 4KB 内存正常工作。
- 内部环回测试

  内部环回测试确保适配器的发射器和接收器正常运行。如果此测试失败，请确保适配器的电缆已连接到网络（例如，检查 LED 指示灯是否活动）。
- 引导 PROM 测试

  引导 PROM 测试确保引导 PROM 存在并且可以读取。测试失败表明由于硬件问题或引导 PROM 地址分配冲突导致未能成功读取引导 PROM。（仅当适配器配置为使用引导 PROM 选项时，此测试适用。）

测试项失败可能表示 ISA 总线上与其他设备存在系统资源冲突。在这种情况下，您应使用手动设置选项，通过选择不同的系统资源值来重新配置适配器。

5.2.2. 诊断网络测试
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

诊断网络测试通过在网络上的两台不同 PC 上安装的两个 CS8900/20 适配器之间传输数据来验证网络连接是否正常。（注意：不应在跨路由器的两个节点之间运行诊断网络测试。）

此测试要求两台 PC 都安装有基于 CS8900/20 的适配器，并且都运行 CS8900/20 设置工具。一台 PC 配置为响应者（Responder），另一台 PC 配置为主动者（Initiator）。一旦主动者启动，它会向响应者发送数据帧，响应者再将这些帧返回给主动者。
接收和发送的总帧数显示在发起者的屏幕上，同时还会显示接收和发送正常或出错的帧数。用户可以在任意时间在任一PC上终止测试。

设置诊断网络测试：

1. 选择一台装有CS8900/20适配器且网络连接正常的电脑作为响应者。运行CS8900/20设置工具，并从主菜单中选择“诊断 -> 网络测试 -> 响应者”。按ENTER键启动响应者。
2. 返回到您想要测试的装有CS8900/20适配器的电脑，并启动CS8900/20设置工具。
3. 从主菜单中选择“诊断 -> 网络测试 -> 发起者”，按ENTER键开始测试。
您可以在任何时候停止发起者的测试，而让响应者继续运行。这样，您可以转移到其他电脑上进行测试，只需在另一台电脑上启动发起者，而无需停止/启动响应者。

5.3 使用适配器的LED指示灯
------------------------------

2号和3号媒体适配器在靠近10Base-T连接器的板子后端有两个可见的LED。

链路完整性LED：绿色LED持续亮起表示有效的10Base-T连接。（仅适用于10Base-T。对于10Base-2或AUI连接，绿色LED没有意义。）

发送/接收LED：每次适配器传输或接收数据时，黄色LED会短暂亮起。（在典型的网络上，黄色LED看起来像是闪烁。）

5.4 解决I/O冲突
-------------------

当两个或多个适配器使用相同的ISA资源（I/O地址、内存地址或IRQ）时，就会发生I/O冲突。安装和配置CS8900/20适配器后，通常可以通过以下四种方式之一检测到I/O冲突：

1. 系统无法正常启动（或者根本无法启动）。
2. 驱动程序无法与适配器通信，报告“未找到适配器”的错误信息。
3. 您无法连接到网络，或者驱动程序无法加载。
4. 如果您已将适配器配置为内存模式运行，但驱动程序在加载时报告其使用的是IO模式，这表明存在内存地址冲突。
如果发生IO冲突，请运行CS8900/20 Setup Utility并执行诊断自检。通常，发生冲突的ISA资源会在自检中失败。如果是这样，请重新配置适配器，选择另一个未冲突的资源选项。再次运行诊断程序以检查是否存在进一步的IO冲突。
在某些情况下，例如PC无法启动时，可能需要移除适配器，并将其安装到另一台PC上以运行CS8900/20 Setup Utility。重新安装到目标系统后，运行诊断自检以确保新的配置没有冲突，然后再加载驱动程序。
手动配置适配器时，请注意下面表格中所示的典型ISA系统资源使用情况。

I/O 地址 | 设备 | IRQ | 设备
---------|------|-----|------
200-20F  | 游戏I/O适配器 | 3 | COM2, 总线鼠标
230-23F  | 总线鼠标 | 4 | COM1
270-27F  | LPT3：第三个并行端口 | 5 | LPT2
2F0-2FF  | COM2：第二个串行端口 | 6 | 软盘控制器
320-32F  | 固定磁盘控制器 | 7 | LPT1
         |       | 8 | 实时时钟
         |       | 9 | EGA/VGA显示适配器
         |       | 12 | 鼠标（PS/2）
内存地址 | 设备 | 
----------|---------------------|
A000-BFFF | EGA 图形适配器
A000-C7FF | VGA 图形适配器
B000-BFFF | 单色图形适配器
B800-BFFF | 彩色图形适配器
E000-FFFF | AT BIOS

6. 技术支持
===========

6.1. 联系Cirrus Logic的技术支持
-----------------------------------

Cirrus Logic的CS89XX技术应用支持可以通过以下方式联系：

电话 : (800) 888-5016（美国和加拿大境内）
       (512) 442-7555（美国和加拿大境外）
传真 : (512) 912-3871
邮件 : ethernet@crystal.cirrus.com
网页 : http://www.cirrus.com

6.2. 联系技术支持前所需的信息
---------------------------------

在联系Cirrus Logic寻求技术支持之前，请准备好尽可能多的以下信息：
1. 适配器类型（CRD8900, CDB8900, CDB8920等）

2. 适配器配置

   - IO基址、内存基址、启用IO或内存模式、IRQ、DMA通道
   - 即插即用功能是否启用/禁用（仅适用于基于CS8920的适配器）
   - 配置为自动检测媒体类型或特定媒体类型（具体是哪种类型）

3. PC系统的配置

   - 即插即用系统（是/否）
   - BIOS（制造商和版本）
   - 系统品牌和型号
   - CPU（类型和速度）
   - 系统RAM
   - SCSI适配器

4. 软件

   - CS89XX驱动程序及其版本
   - 您的网络操作系统及其版本
   - 您系统的操作系统版本
   - 所有协议支持文件的版本

5. 显示的任何错误消息

6.3 获取最新驱动程序版本
----------------------------

您可以从Cirrus Logic的网站获取最新的CS89XX驱动程序和支持软件。您也可以通过电子邮件（ethernet@crystal.cirrus.com）联系Cirrus Logic的技术支持，请求注册自动软件更新通知。
Cirrus Logic在其网页http://www.cirrus.com上维护着最新的驱动程序和技术文档。

6.4 当前维护者
----------------

2000年2月，该驱动程序的维护工作由Andrew Morton接管。
6.5 内核模块参数
----------------------------

为了在没有 cs89x0 EEPROM 的嵌入式环境中使用，已经实现了内核启动参数 `cs89x0_media=`。使用方法如下：

```
cs89x0_media=rj45    或
cs89x0_media=aui     或
cs89x0_media=bnc
```
