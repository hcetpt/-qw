SPDX 许可证标识符: (GPL-2.0-only 或 BSD-3-Clause)

can327: 用于 Linux SocketCAN 的 ELM327 驱动
==========================================

作者
--------

Max Staudt <max@enpas.org>

动机
-----------

此驱动程序旨在降低黑客们在使用 CAN 总线时的初始成本：
- CAN 适配器价格昂贵，且种类稀少。
- ELM327 接口便宜且普及广泛。
- 让我们利用 ELM327 作为 CAN 适配器。

介绍
-------------

此驱动程序旨在将基于 ELM327 的 OBD 接口转化为功能齐全（尽可能）的 CAN 接口。由于 ELM327 并不是设计为独立的 CAN 控制器，因此该驱动程序需要尽可能快速地在不同模式之间切换，以模拟全双工操作。因此，can327 是一个尽力而为的驱动程序。然而，这对于实现简单的请求-响应协议（如 OBD II）以及监控总线上的广播消息（如在车辆中）来说已经足够了。大多数 ELM327 设备通过 USB 或蓝牙连接，并作为未识别的串行设备出现。驱动程序本身无法识别它们，因此用户需要将其设置为 TTY 线律（类似于 PPP、SLIP、slcan 等）。此驱动程序适用于 ELM327 版本 1.4b 及以上版本，下面列出了旧控制器和克隆版本中已知的限制。
数据手册
------------

官方数据手册可以在 ELM Electronics 的主页上找到：

  https://www.elmelectronics.com/

如何附加线律
------------------

每个 ELM327 芯片出厂时都预设为 38400 波特率、8 数据位、无奇偶校验、1 停止位的串行设置。
如果你保留了默认配置，可以通过以下命令在命令提示符下附加行纪律：

    sudo ldattach \
           --debug \
           --speed 38400 \
           --eightbits \
           --noparity \
           --onestopbit \
           --iflag -ICRNL,INLCR,-IXOFF \
           30 \
           /dev/ttyUSB0

要更改 ELM327 的串口设置，请参阅其数据手册。这需要在附加行纪律之前完成。一旦附加了行纪律，CAN 接口就会处于未配置状态。在启动之前设置速度：

    # 接口需要处于关闭状态以更改参数
    sudo ip link set can0 down
    sudo ip link set can0 type can bitrate 500000
    sudo ip link set can0 up

500,000 bit/s 是 OBD-II 诊断的常见速率。如果你直接连接到汽车的 OBD 端口，这是大多数（但不是全部！）汽车期望的速度。
之后，你可以像往常一样使用 `candump`、`cansniffer` 等工具。

如何检查控制器版本
-------------------

使用终端程序连接到控制器。发出 "AT WS" 命令后，控制器将响应其版本：

    > AT WS


    ELM327 v1.4b

    >

请注意，克隆产品可能会声称任何版本。这并不表示它们的实际功能集。

通信示例
------------

这是一个简短且不完整的介绍，说明如何与 ELM327 通信。这里是为了帮助理解控制器和驱动程序的限制（如下所述）以及手动测试。
ELM327有两种模式：

- 命令模式
- 接收模式

在命令模式下，它期望每行一个命令，并以回车符（CR）结束。
默认提示符为“``>``”，之后可以输入一个命令：

    >ATE1
    OK
    >

驱动程序中的初始化脚本会关闭一些仅在芯片设计的原始OBD场景中有意义的配置选项，这些选项实际上对can327来说是障碍。
当命令不被识别时，例如由较旧版本的ELM327处理时，响应中将打印问号而不是OK：

    >ATUNKNOWN
    ?
    >

目前，can327不评估这种响应。有关已知限制的详细信息，请参阅下面的部分。
当要发送CAN帧时，首先配置目标地址，然后将帧作为包含数据十六进制转储的命令发送：

    >ATSH123
    OK
    >DEADBEEF12345678
    OK
    >

上述交互发送了带有(11位)CAN ID ``0x123`` 的短帧（SFF）"``DE AD BE EF 12 34 56 78``"。
为了使此功能正常工作，控制器必须配置为短帧发送模式（使用 "``AT PB``"，请参阅代码或数据手册）。
一旦帧发送并且等待回复模式开启（``ATR1``，在``listen-only=off`` 配置下），或者当回复超时到期且驱动程序将控制器设置为监控模式（``ATMA``）时，ELM327将为每个接收到的CAN帧发送一行，内容包括CAN ID、DLC和数据：

    123 8 DEADBEEF12345678

对于长帧（EFF，29位）CAN帧，地址格式略有不同，can327利用这一点来区分两种帧：

    12 34 56 78 8 DEADBEEF12345678

ELM327将接收短帧和长帧——当前的CAN配置（``ATPB``）无关紧要。
如果ELM327内部UART发送缓冲区满，则会终止监控模式，打印 "BUFFER FULL" 并返回到命令模式。请注意，在这种情况下，与其它错误消息不同，错误消息可能会出现在上一行（通常是不完整的）数据帧的同一行：

    12 34 56 78 8 DEADBEEF123 BUFFER FULL

### 控制器的已知限制
------------------------------------

- 克隆设备（"v1.5" 和其他）

  发送RTR帧不受支持，并且会被静默丢弃。
接收RTR帧且DLC为8时，将表现为具有上次接收帧的DLC和有效载荷的普通帧。
"``AT CSM``"（CAN静默监控，即不发送CAN确认）不受支持，并且被硬编码为ON。因此，在监听时帧不会被确认："``AT MA``"（监控所有）始终为“静默”。
然而，在发送帧后立即，ELM327将处于“接收回复”模式，在该模式下，它确实会确认任何接收到的帧。
一旦总线变得静默，或发生错误（如BUFFER FULL），或者接收回复超时，ELM327将自动结束回复接收模式，并且can327会回退到“``AT MA``”以继续监控总线。
其他限制可能适用，具体取决于克隆版本及其固件的质量。
- 所有版本

  不支持全双工操作。驱动程序将在输入/输出模式之间尽可能快速地切换。
  发出的RTR帧长度无法设置。实际上，某些克隆版本（测试中发现一个标识为"``v1.5``"的）根本无法发送RTR帧。
  我们没有获取CAN错误实时通知的方法。
  尽管有一个命令（``AT CS``）可以检索一些基本统计信息，但我们不会轮询它，因为这会迫使我们中断接收模式。
- 1.4b之前的版本

  这些版本在监控模式（AT MA）下不发送CAN确认（ACK）。
  然而，在发送帧后等待回复期间，它们确实会发送ACK。驱动程序最大化这段时间以使控制器尽可能有用。
  从1.4b版本开始，ELM327支持“``AT CSM``”命令，并且“监听模式”的CAN选项将生效。
- 1.4之前的版本

  这些芯片不支持“``AT PB``”命令，因此无法动态更改比特率或SFF/EFF模式。用户需要在连接线路纪律之前进行编程。详见数据手册。
### 1.3 版本之前的版本

这些芯片完全不能与 can327 一起使用。它们不支持 `"``AT D1``"` 命令，该命令对于避免数据输入时的解析冲突以及区分 RTR 帧长度是必要的。
具体来说，这允许轻松区分 SFF 和 EFF 帧，并检查帧是否完整。虽然可以从 ELM327 发送的数据行长度推断出类型和长度，但当 ELM327 的 UART 输出缓冲区溢出时，这种方法会失败。它可能会在一行中间中断发送，从而被误认为其他内容。

### 已知驱动程序限制
--------------------------------

- 不支持 8/7 定时
ELM327 只能设置形式为 500000/n 的 CAN 比特率，其中 n 是整数除数。
但是有一个例外：通过一个单独的标志，它可以将速度设置为除数所指示的速度的 8/7。
这种模式目前尚未实现。

- 不评估命令响应
当 ELM327 理解命令时会回复 OK，不理解时会回复 `?`。当前驱动程序不检查这一点，而是简单地假设芯片理解所有命令。
尽管如此，驱动程序的设计使得功能仍然可以平滑降级。请参见控制器已知限制部分。

- 不使用硬件 CAN ID 过滤
在 CAN 总线负载较重的情况下，ELM327 的 UART 发送缓冲区很容易溢出，导致出现 `"``BUFFER FULL``"` 消息。通过 `"``AT CF xxx``"` 和 `"``AT CM xxx``"` 使用硬件过滤器在这种情况下是有帮助的，然而 SocketCAN 目前没有提供利用此类硬件功能的方法。
选择配置的合理性
------------------------------------------

``AT E1``
  开启回显

  我们需要这样设置才能可靠地获取提示符
``AT S1``
  开启空格

  我们需要这样设置来区分接收到的 11 位和 29 位 CAN 地址
注意：
  通常我们可以通过行长度（奇数/偶数）来实现这一点，
  但如果数据行没有完全传输到主机时，这种方法就会失效（BUFFER FULL）
``AT S1``
  开启 DLC

  我们需要这样设置来确定远程传输请求（RTR）帧的“长度”
关于 CAN 总线终端电阻的说明
------------------------------

您的适配器可能焊有用于终止总线的电阻。当适配器插入 OBD-II 插座时这是正确的，但在尝试接入现有的 CAN 总线中间时就不适用了。
如果连接适配器后通信不正常，请检查其电路板上的终端电阻，并尝试移除它们。
