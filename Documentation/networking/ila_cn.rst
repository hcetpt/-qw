SPDX 许可证标识符: GPL-2.0

===================================
标识符定位地址 (ILA)
===================================

简介
============

标识符-定位地址 (ILA) 是一种与 IPv6 结合使用的技术，它区分了网络节点的位置和身份。地址的一部分表示节点的不可变身份，而另一部分则指示节点的位置，这部分可能是动态变化的。标识符-定位地址可以高效地实现用于网络虚拟化的覆盖网络以及移动性用例解决方案。ILA 可以被看作是在不使用封装的情况下实现覆盖网络的一种手段。这是通过在网络中传输数据包时对目的地址执行网络地址转换 (NAT) 来完成的。对于网络而言，经过 ILA 转换的数据包看起来与其他任何 IPv6 数据包没有区别。例如，如果传输协议是 TCP，则经过 ILA 转换的数据包看起来就像另一个普通的 TCP/IPv6 数据包。这样做的优势在于 ILA 对网络来说是透明的，因此网络中的优化（如 ECMP、RSS、GRO、GSO 等）都可以正常工作。

ILA 协议在 Internet-Draft draft-herbert-intarea-ila 中进行了描述。

ILA 术语
===============

- 标识符 (Identifier)
    一个标识网络中可寻址节点的身份的数字，与其位置无关。ILA 标识符是 64 位值。
- 定位符 (Locator)
    一个路由到物理主机的网络前缀。定位符提供了被寻址节点的拓扑位置。ILA 定位符是 64 位前缀。
- ILA 映射 (ILA Mapping)
    ILA 标识符到定位符的映射（或到定位符及其元数据）。ILA 域维护一个包含域内所有目的地映射的数据库。
- SIR 地址 (SIR Address)
    由 SIR 前缀（上 64 位）和标识符（下 64 位）组成的 IPv6 地址。SIR 地址对应用程序可见，并提供了一种独立于节点位置来寻址节点的方法。
- ILA 地址 (ILA Address)
    由定位符（上 64 位）和标识符（下 64 位）组成的 IPv6 地址。ILA 地址永远不会对应用程序可见。
- ILA 主机 (ILA Host)
    具备在发送或接收时执行 ILA 转换能力的终端主机。
### ILA路由器
一种执行ILA转换和转发已转换数据包的网络节点。

### ILA转发缓存
一种仅维护映射工作集缓存的ILA路由器类型。

### ILA节点
能够执行ILA转换的网络节点。这可以是ILA路由器、ILA转发缓存或ILA主机。

### 操作
ILA有两个基本操作：

- **将SIR地址转换为ILA地址**：在进入ILA覆盖网络时执行。
- **将ILA地址转换为SIR地址**：在离开ILA覆盖网络时执行。

ILA可以在网络中的终端主机或中间设备上部署；这些分别由“ILA主机”和“ILA路由器”提供。

这两种部署点的配置和数据路径有所不同。

下图展示了数据包通过ILA的流程，并显示了ILA主机和路由器：

```
+--------+                                                +--------+
| Host A +-+                                         +--->| Host B |
|        | |              (2) ILA                   (')   |        |
+--------+ |            ...addressed....           (   )  +--------+
	       V  +---+--+  .  packet      .  +---+--+  (_)
   (1) SIR     |  | ILA  |----->-------->---->| ILA  |   |   (3) SIR
    addressed  +->|router|  .              .  |router|->-+    addressed
    packet        +---+--+  .     IPv6     .  +---+--+        packet
		   /        .    Network
/         .              .   +--+-++--------+
    +--------+   /          .              .   |ILA ||  Host  |
    |  Host  +--+           .              .- -|host||        |
    |        |              .              .   +--+-++--------+
    +--------+              ...............
```

### 传输校验和处理
当一个地址被ILA转换时，包含该转换地址的伪头部中的封装传输校验和可能会在网络上传输时变得不正确。这对中间设备（包括NIC中的校验和卸载）处理校验和时是一个问题。有三种方法来解决这个问题：

- **不采取行动**：允许校验和在网络上传输时不正确。在接收方验证校验和之前，必须先进行ILA到SIR地址的转换。
- 调整传输校验和
  当执行ILA转换时，数据包会被解析，并且如果发现传输层校验和，则会根据转换后的地址对其进行调整。

- 校验和中立映射
  当一个地址被转换时，差异可以在数据包的其他部分（由校验和覆盖的部分）进行抵消。使用标识符的低16位。此方法是首选方案，因为它不需要对数据包进行超出IP头的解析，并且在大多数情况下，调整可以预先计算并保存在映射中。
  注意，校验和中立调整影响标识符的低16位。当在出站方向执行ILA到SIR地址转换时，低16位将恢复为原始值，从而恢复为最初发送的标识符。

标识符类型
===============
ILA定义了不同类型的标识符以适用于不同的使用场景。定义的类型包括：

    0：接口标识符

    1：本地唯一标识符

    2：IPv4地址的虚拟网络标识符

    3：IPv6单播地址的虚拟网络标识符

    4：IPv6组播地址的虚拟网络标识符

    5：非本地地址标识符

在当前内核ILA实现中，仅支持本地唯一标识符（LUID）。LUID允许使用通用的、未格式化的64位标识符。

标识符格式
==================
内核ILA支持标识符中的两个可选字段用于格式化：“C位”和“标识符类型”。这些字段的存在与否由配置决定，如下所示：
如果存在标识符类型，它占据标识符的三个最高位。可能的值如上表所示。
如果存在C位，则表示已经进行了校验和中立映射。C位只能在ILA地址中设置，而不能在SIR地址中设置。
在最简单的格式中，标识符类型、C位和校验和调整值不存在，因此标识符被视为一个未结构化的64位值：

    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                            Identifier                         |
    +                                                               +
    |                                                               |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

校验和中立调整可以配置为始终存在，使用neutral-map-auto。在这种情况下没有C位，但校验和调整值位于低16位。标识符仍然是64位：

    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                            Identifier                         |
    |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                               |  Checksum-neutral adjustment  |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

C位可用于明确指示已将校验和中立映射应用于ILA地址。格式如下：

    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |     |C|                    Identifier                         |
    |     +-+                       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                               |  Checksum-neutral adjustment  |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

标识符类型字段可以存在以指示标识符类型。如果没有该字段，则类型基于映射配置推断。校验和中立调整可以自动与标识符类型一起使用，如下图所示：

    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    | Type|                      Identifier                         |
    +-+-+-+                         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                               |  Checksum-neutral adjustment  |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

标识符类型和C位可以同时存在，因此标识符格式如下：

    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    | Type|C|                    Identifier                         |
    +-+-+-+-+                       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                               |  Checksum-neutral adjustment  |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

配置
=============
有两种方法来配置ILA映射。一种是使用LWT路由，另一种是通过NFHOOK PREROUTING钩子调用ila_xlat。ila_xlat旨在用于ILA主机的接收路径。
还实现在XDP中的ILA路由器。对此的描述超出了本文档的范围。
使用 ILA LWT 路由的命令为：

```
ip route add DEST/128 encap ila LOC csum-mode MODE ident-type TYPE via ADDR
```

目标地址（DEST）可以是 SIR 地址（用于 ILA 主机或入口 ILA 路由器）或 ILA 地址（出口 ILA 路由器）。LOC 是覆盖目标地址上部 64 位的定位符（格式为 W:X:Y:Z）。校验和模式（MODE）可以是 "no-action"、"adj-transport"、"neutral-map" 和 "neutral-map-auto"。如果设置为 neutral-map，则 C 位将存在。标识类型（TYPE）可以是 "luid" 或 "use-format"。在 use-format 情况下，标识类型字段存在，并且实际类型取自该字段。

使用 `ila_xlat` 的命令为：

```
ip ila add loc_match MATCH loc LOC csum-mode MODE ident-type TYPE
```

MATCH 表示必须匹配的传入定位符以应用转换。LOC 是覆盖目标地址上部 64 位的定位符。MODE 和 TYPE 的含义与上述相同。

一些示例
=========

```
# 配置一个使用校验和中立映射以及类型字段的 ILA 路由。注意类型字段设置在 SIR 地址中
# （2000 表示类型为 1，即 LUID）
ip route add 3333:0:0:1:2000:0:1:87/128 encap ila 2001:0:87:0 \
      csum-mode neutral-map ident-type use-format

# 配置一个使用自动校验和中立映射（无 C 位）并配置标识类型为 LUID 的 ILA LWT 路由，
# 以便标识类型字段不存在
ip route add 3333:0:0:1:2000:0:2:87/128 encap ila 2001:0:87:1 \
      csum-mode neutral-map-auto ident-type luid

# 配置一个匹配定位符并将其替换为 SIR 地址（例如 3333:0:0:1）的 ILA 到 SIR 映射。
# 使用 C 位和标识字段
ip ila add loc_match 2001:0:119:0 loc 3333:0:0:1 \
      csum-mode neutral-map-auto ident-type use-format

# 配置一个校验和中立自动设置（无 C 位）且标识类型配置为 LUID 的 ILA 到 SIR 映射，
# 以便标识类型字段不存在
ip ila add loc_match 2001:0:119:0 loc 3333:0:0:1 \
      csum-mode neutral-map-auto ident-type use-format
```
