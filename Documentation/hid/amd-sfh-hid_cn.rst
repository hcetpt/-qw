### SPDX 许可证标识符: GPL-2.0

#### AMD 传感器融合中心
##### 概述
AMD 传感器融合中心（SFH）是自锐龙平台开始的系统芯片（SoC）的一部分。
该解决方案在多种原始设备制造商（OEM）产品上表现良好。AMD SFH使用PCIe总线上的HID协议。
从架构上讲，它类似于ISH（Intel Sensor Hub），但主要区别在于所有HID报告都是作为内核驱动程序的一部分生成的。

##### 块图

```
	---------------------------------
	|  HID 用户空间应用程序  |
	- -------------------------------

    ---------------------------------------------
	 ---------------------------------
	|		HID 核心          |
	 ---------------------------------

	 ---------------------------------
	|     AMD HID 传输层            |
	 ---------------------------------

	 --------------------------------
	|             AMD HID 客户端     |
	|	带有HID 报告生成器|
	 --------------------------------

	 --------------------------------
	|     AMD MP2 PCIe 驱动          |
	 --------------------------------
    操作系统
    ---------------------------------------------
    硬件 + 固件
         --------------------------------
         |     SFH MP2 处理器         |
         --------------------------------
```

#### AMD HID 传输层
AMD SFH传输层也实现为一个总线。在AMD MP2中执行的每个客户端应用都注册为此总线上的一台设备。这里，MP2是一个与x86相连用于处理传感器数据的ARM核心。绑定每台设备（AMD SFH HID驱动程序）的这一层会识别设备类型并将其注册到HID核心。传输层为每个设备附加一个固定的“struct hid_ll_driver”对象。一旦设备注册到HID核心，通过这个结构提供的回调函数就会被HID核心用来与设备通信。AMD HID传输层实现了同步调用。

#### AMD HID 客户端层
此层负责实现HID请求和描述符。由于固件与操作系统无关，HID客户端层填充了HID请求结构和描述符。HID客户端层较为复杂，因为它介于MP2 PCIe层和HID之间。HID客户端层初始化MP2 PCIe层，并持有MP2层的一个实例。它利用MP2-PCIe层来识别连接的传感器数量。基于这些信息，它为每个传感器分配DRAM地址，并将其传递给MP2-PCIe驱动程序。在枚举每个传感器时，客户端层填充HID描述符结构和HID输入报告结构。HID特性报告结构是可选的。报告描述符结构因传感器而异。

#### AMD MP2 PCIe 层
MP2 PCIe层负责通过PCIe与固件进行所有交易。
固件与PCIe之间的连接建立发生在这里。
X86与MP2之间的通信分为三个部分：
1. 通过C2P邮箱寄存器传输命令
2. 通过DRAM传输数据
通过P2C寄存器获取支持的传感器信息。命令通过C2P邮箱寄存器发送到MP2。写入C2P消息寄存器会生成对MP2的中断。客户端层分配物理内存，并通过PCI层将之发送给MP2。MP2固件将命令输出写入客户端层分配的DRAM内存中。固件总是至少向DRAM写入32字节的数据。因此，作为协议驱动程序应当至少分配32字节的DRAM空间。

枚举和探测流程
-----------------
::

       HID             AMD            AMD                       AMD -PCIe             MP2
       Core         Transport      Client layer                   layer                FW
        |		|	       |                           |                 |
        |		|              |                 当引导驱动加载时       |
        |		|	       |                           |                 |
        |		|	       |                        MP2-PCIe 中断         |
        |		|              |			   |                 |
        |		|	       |---获取传感器数量-> |                 |
        |		|              |                       读取P2C              |
        |		|	       |			寄存器             |
        |		|              |                           |                 |
        |               |              | 循环(根据传感器数量)   |                 |
        |		|	       |----------------------|    |                 |
        |		|              | 创建HID描述符|    |                 |
        |		|	       | 创建输入报告 |    |                 |
        |		|              | 描述符映射      |    |                 |
        |		|	       | 映射MP2固件索引至 |    |                 |
        |		|              |   HID索引          |    |                 |
        |		|	       | 分配DRAM地址    |  启用              |
        |		|	       |       |  传感器             |
        |		|              |----------------------|    |                 |
        |		| HID传输|                           |    启用       |
        |	        |<--探测------|                           |---传感器命令--> |
        |		| 创建HID设备   |                           |                 |
        |               |    (混合设备)     |                           |                 |
        |		| 通过填充来创建|                           |                 |
        |               |  HID低层驱动     |                           |                 |
        | HID           |	       |			   |                 |
        |  添加         |              |                           |                 |
        | 设备          |              |                           |                 |
        |<------------- |	       |			   |                 |

从应用程序到AMD SFH驱动的数据流
---------------------------------

::

	        |	       |              |	  	 	          |		    |
                |	       |	      |			          |                 |
                |	       |	      |			          |                 |
                |              |              |                           |                 |
                |              |              |                           |                 |
                |HID请求       |              |                           |                 |
                |获取报告      |              |                           |                 |
                |------------->|              |                           |                 |
	        |              | 获取HID输入|                           |                 |
	        |              | 报告        |                           |                 |
	        |              |------------->|------------------------|  |                 |
	        |              | 读取请求传感器的DRAM数据并|  |                 |
	        |              | 创建HID输入报告                |  |                 |
	        |              |------------------------|  |                 |
	        |              |在HID报告中收到数据 |                           |                 |
	        |              |<-------------|<-------------|                           |                 |
    到	        |              |              |                           |                 |
    应用程序|              |              |                           |                 |
        <-------|              |              |                           |                 |
