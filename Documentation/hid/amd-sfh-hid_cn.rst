SPDX 许可证标识符: GPL-2.0

AMD Sensor Fusion Hub
=====================

AMD Sensor Fusion Hub (SFH) 是从基于 Ryzen 的平台开始的系统级芯片(SoC)的一部分。该解决方案在多个 OEM 产品上表现良好。AMD SFH 使用 PCIe 总线上的 HID 协议。就架构而言，它类似于 ISH，但主要区别在于所有的 HID 报告都是作为内核驱动程序的一部分生成的。

框图
-----

::

	---------------------------------
	|  HID 用户空间应用程序  |
	---------------------------------

    ---------------------------------------------
	---------------------------------
	|		HID 核心          |
	---------------------------------

	---------------------------------
	|     AMD HID 传输层            |
	---------------------------------

	--------------------------------
	|             AMD HID 客户端     |
	|   带有 HID 报告生成器      |
	--------------------------------

	--------------------------------
	|     AMD MP2 PCIe 驱动程序      |
	--------------------------------
    操作系统
    ---------------------------------------------
    硬件 + 固件
         --------------------------------
         |     SFH MP2 处理器          |
         --------------------------------

AMD HID 传输层
-----------------------
AMD SFH 传输层也是作为一个总线实现的。每个在 AMD MP2 中执行的客户端应用程序都会注册为该总线上的一台设备。在这里，MP2 是一个连接到 x86 用于处理传感器数据的 ARM 核心。绑定每个设备（AMD SFH HID 驱动程序）的这一层会识别设备类型并将其注册到 HID 核心。传输层为每个设备附加一个常量 "struct hid_ll_driver" 对象。一旦设备被注册到 HID 核心，通过该结构提供的回调函数就会被 HID 核心用来与设备通信。AMD HID 传输层实现了同步调用。

AMD HID 客户端层
--------------------
这一层负责实现 HID 请求和描述符。由于固件是与操作系统无关的，HID 客户端层填充了 HID 请求结构和描述符。HID 客户端层比较复杂，因为它充当 MP2 PCIe 层和 HID 之间的接口。HID 客户端层初始化 MP2 PCIe 层，并持有 MP2 层的一个实例。它使用 MP2-PCIe 层识别连接的传感器数量。基于此，为每个传感器分配 DRAM 地址，并将其传递给 MP2-PCIe 驱动程序。在枚举每个传感器时，客户端层填充 HID 描述符结构和 HID 输入报告结构。HID 特征报告结构是可选的。报告描述符结构因传感器而异。

AMD MP2 PCIe 层
------------------
MP2 PCIe 层负责通过 PCIe 与固件进行所有事务处理。
固件和 PCIe 之间的连接建立发生在此处。
X86 和 MP2 之间的通信分为三部分：
1. 通过 C2P 邮箱寄存器进行命令传输
2. 通过 DRAM 进行数据传输
### 通过P2C寄存器支持的传感器信息
命令通过C2P邮箱寄存器发送到MP2。写入C2P消息寄存器会生成MP2中断。客户端层分配物理内存，并通过PCI层发送给MP2。MP2固件将命令输出写入客户端层分配的DRAM内存。固件始终至少写入32字节到DRAM中。因此，协议驱动程序应当至少分配32字节的DRAM空间。

### 枚举和探测流程
```
HID              AMD            AMD                       AMD -PCIe             MP2
Core         Transport      Client layer                   layer                FW
  |                  |              |                           |                 |
  |                  |              |                        在启动驱动加载时       |
  |                  |              |                           |                 |
  |                  |              |                        MP2-PCIe中断         |
  |                  |              |                           |                 |
  |                  |              |---获取传感器数量-> |                 |
  |                  |              |                       读取P2C寄存器         |
  |                  |              |                           |                 |
  |                  |              | 循环（对于传感器数量）   |                 |
  |                  |              |----------------------|    |                 |
  |                  |              | 创建HID描述符 |    |                 |
  |                  |              | 创建输入报告 |    |                 |
  |                  |              | 描述符映射      |    |                 |
  |                  |              | MP2固件索引到  |    |                 |
  |                  |              | HID索引          |    |                 |
  |                  |              | 分配DRAM地址   |  启用              |
  |                  |              |                 |  传感器             |
  |                  |              |----------------------|    |                 |
  |                  | HID传输层    |                           |    启用传感器命令   |
  |                |<--探测------|                           |---传感器命令--> |
  |                  | 创建HID设备  |                           |                 |
  |                  | 通过填充HID  |                           |                 |
  |                  | 低级驱动程序 |                           |                 |
  | HID              |              |                           |                 |
  | 添加设备         |              |                           |                 |
  |<--------------  |              |                           |                 |
```

### 应用程序到AMD SFH驱动程序的数据流
```
        |              |              |                           |                 |
        |              |              |                           |                 |
        |              |              |                           |                 |
        |              |              |                           |                 |
        | HID请求      |              |                           |                 |
        | 获取报告     |              |                           |                 |
        |------------->|              |                           |                 |
        |              | HID获取输入  |                           |                 |
        |              | 报告          |                           |                 |
        |              |------------->|------------------------|  |                 |
        |              | 读取请求传感器的DRAM数据并创建HID输入报告 |  |                 |
        |              |------------------------|  |                 |
        |              | 数据接收在HID报告中  |                           |                 |
        |              |------------------------|  |                 |
    到应用程序|<-------------|<-------------|                           |                 |
        <-------|              |              |                           |                 |
```
