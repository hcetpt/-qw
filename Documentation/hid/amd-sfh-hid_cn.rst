SPDX 许可证标识符：GPL-2.0

AMD Sensor Fusion Hub
=====================

AMD Sensor Fusion Hub（SFH）是从基于Ryzen的平台开始的系统芯片（SoC）的一部分。该解决方案在多种原始设备制造商（OEM）产品上运行良好。AMD SFH使用PCIe总线上的HID（人类接口设备）。从架构上讲，它类似于ISH（Intel Sensor Hub），但是主要的区别在于所有HID报告都是作为内核驱动程序的一部分生成的。

块图
------

::

	---------------------------------
	|  HID 用户空间应用程序       |
	---------------------------------

    ---------------------------------------------
	---------------------------------
	|		HID 核心            |
	---------------------------------

	---------------------------------
	|     AMD HID 运输层            |
	---------------------------------

	--------------------------------
	|             AMD HID 客户端     |
	|	带有HID报告生成器      |
	--------------------------------

	--------------------------------
	|     AMD MP2 PCIe 驱动         |
	--------------------------------
    操作系统(OS)
    ---------------------------------------------
    硬件 + 固件
         --------------------------------
         |     SFH MP2 处理器          |
         --------------------------------


AMD HID 运输层
-----------------------
AMD SFH运输层也实现为一种总线。在AMD MP2中执行的每个客户端应用都注册为此总线上的一种设备。这里，MP2是一个连接到x86用于处理传感器数据的ARM核心。绑定每个设备（AMD SFH HID驱动程序）的层会识别设备类型并将其注册到HID核心。运输层为每个设备附加一个常量的"struct hid_ll_driver"对象。一旦设备注册到HID核心，通过这个结构提供的回调函数将被HID核心用来与设备通信。AMD HID运输层实现了同步调用。

AMD HID 客户端层
--------------------
这一层负责实现HID请求和描述符。由于固件是操作系统无关的，HID客户端层填充了HID请求结构和描述符。HID客户端层比较复杂，因为它介于MP2 PCIe层和HID之间。HID客户端层初始化MP2 PCIe层，并持有MP2层的实例。它使用MP2-PCIe层识别连接的传感器数量。根据这一点，为每一个传感器分配DRAM地址，并将其传递给MP2-PCIe驱动程序。在枚举每个传感器时，客户端层填充HID描述符结构和HID输入报告结构。HID特性报告结构是可选的。报告描述符结构因传感器而异。

AMD MP2 PCIe 层
------------------
MP2 PCIe层负责通过PCIe与固件进行所有交易。
固件与PCIe之间的连接建立发生在这里。
X86和MP2之间的通信分为三个部分：
1. 通过C2P邮箱寄存器进行命令传输
2. 通过DRAM进行数据传输
通过P2C寄存器支持的传感器信息
命令通过C2P邮箱寄存器发送到MP2。写入C2P消息寄存器会生成中断给MP2。客户端层分配物理内存，同样的内存通过PCI层发送给MP2。MP2固件将命令输出写入客户端层已分配的DRAM内存中。固件始终至少写入32字节至DRAM。因此，协议驱动程序应至少分配32字节的DRAM空间。

枚举和探测流程
----------------
::

       隐藏设备（HID）       AMD           AMD                      AMD - PCIe           MP2
       核心         传输层      客户端层                    层                  固件（FW）
        |		|	       |                           |                 |
        |		|              |                 当启动驱动加载时       |
        |		|	       |                           |                 |
        |		|	       |                        MP2-PCIe 中断         |
        |		|              |                           |                 |
        |		|	       |---获取传感器数量-> |                 |
        |		|              |                       读取P2C              |
        |		|	       |			寄存器             |
        |		|              |                           |                 |
        |               |              | 循环(传感器数量)   |                 |
        |		|	       |----------------------|    |                 |
        |		|              | 创建隐藏设备描述符|    |                 |
        |		|	       | 创建输入报告 |    |                 |
        |		|              | 描述符映射      |    |                 |
        |		|	       | 映射MP2固件索引至 |    |                 |
        |		|              | 隐藏设备索引      |    |                 |
        |		|	       | 分配DRAM地址    |  启用              |
        |		|	       |                     |  传感器            |
        |		|              |----------------------|    |                 |
        |		| 隐藏设备传输|                           |    启用       |
        |	        |<--探测------|                           |---传感器CMD--> |
        |		| 创建隐藏设备 |                           |                 |
        |		| (多功能设备) |                           |                 |
        |		| 通过填充     |                           |                 |
        |               | 隐藏设备     |                           |                 |
        |               | ll_driver    |                           |                 |
        | 隐藏设备      |	       |                           |                 |
        |  添加         |              |                           |                 |
        | 设备          |              |                           |                 |
        |<------------- |	       |                           |                 |

从应用程序到AMD SFH驱动的数据流
--------------------------------

::

	        |	       |              |	  	 	          |		    |
                |	       |	      |			          |                 |
                |	       |	      |			          |                 |
                |              |              |                           |                 |
                |              |              |                           |                 |
                |HID请求       |              |                           |                 |
                |获取报告      |              |                           |                 |
                |------------->|              |                           |                 |
	        |              | 获取隐藏设备输入|                           |                 |
	        |              | 报告            |                           |                 |
	        |              |------------->|------------------------|  |                 |
	        |              |              | 读取请求传感器的DRAM数据并  |  |                 |
	        |              |              | 创建隐藏设备输入报告       |  |                 |
	        |              |              |------------------------|  |                 |
	        |              |数据接收在隐藏|                           |                 |
	        |              |设备报告中     |                           |                 |
    到	        |<-------------|<-------------|                           |                 |
    应用程序    |              |              |                           |                 |
        <-------|              |              |                           |                 |
