SPDX 许可证标识符: GPL-2.0+

======================================================
IBM 虚拟管理通道内核驱动程序 (IBMVMC)
======================================================

:作者:
    Dave Engebretsen <engebret@us.ibm.com>,
    Adam Reznechek <adreznec@linux.vnet.ibm.com>,
    Steven Royer <seroyer@linux.vnet.ibm.com>,
    Bryant G. Ly <bryantly@linux.vnet.ibm.com>,

介绍
============

注意：理解本文档需要具备虚拟化技术的知识。
一个很好的参考文档是：

https://openpowerfoundation.org/wp-content/uploads/2016/05/LoPAPR_DRAFT_v11_24March2016_cmt1.pdf

虚拟管理通道 (VMC) 是一个逻辑设备，它提供了一个介于管理分区和管理程序之间的接口。这个接口类似于消息传递接口。这种管理分区旨在为使用硬件管理控制台 (HMC) 的系统管理提供替代方案。
主要的硬件管理解决方案是由 IBM 开发的，依赖于一台名为硬件管理控制台 (HMC) 的设备服务器，该设备被包装成外部塔式或机架安装的个人计算机。在一个 Power Systems 环境中，单个 HMC 可以管理多个基于 POWER 处理器的系统。

管理应用程序
----------------------

在管理分区内存在一个管理应用程序，它使系统管理员能够通过命令行界面 (CLI) 或表述性状态转移应用 (REST API) 配置系统的分区特性。
管理应用程序运行在基于 POWER8 或更新处理器的服务器上的 Linux 逻辑分区上，该服务器由 PowerVM 虚拟化。传统上需要 HMC 执行的系统配置、维护和控制功能可以通过结合 HMC 到管理程序的接口和现有的操作系统方法在管理应用程序中实现。该工具提供了 HMC 实现的功能的一个子集，并支持基本的分区配置。
管理应用程序组件支持的一组 HMC 到管理程序的消息通过 VMC 接口传递给管理程序，该接口如下定义。
VMC 使管理分区间能够提供基本的分区功能：

- 逻辑分区配置
- 启动和停止单个分区的操作
- 显示分区状态
- 虚拟以太网管理
- 虚拟存储管理
- 基本系统管理

虚拟管理通道 (VMC)
--------------------------------

为了在管理应用程序和管理程序之间进行通信，定义了一个称为虚拟管理通道 (VMC) 的逻辑设备。它基本上创建了使虚拟化管理软件能够工作的管道。该设备作为一个虚拟设备呈现给指定的管理分区。
此通信设备使用命令/响应队列 (CRQ) 和远程直接内存访问 (RDMA) 接口。定义了一个三步握手机制，必须在发送/接收任何协议消息之前确保管理程序和管理分区双方都在运行。
此驱动程序还利用了传输事件 CRQ。当管理程序检测到某个对等分区异常终止或某一方调用 H_FREE_CRQ 关闭其 CRQ 时，会发送 CRQ 消息。
为VMC设备引入了两种新的CRQ消息类别。VMC管理消息用于使用VMC的每个分区与其伙伴分区通信其能力。HMC接口消息则用于管理分区和虚拟机监控程序之间实际的HMC消息流。由于大多数HMC消息远远超过CRQ缓冲区的大小，在每次HMC接口CRQ消息之前，会先对HMC消息数据进行虚拟DMA（RDMA）。只有管理分区驱动RDMA操作；虚拟机监控程序永远不会直接导致消息数据的移动。

术语
----
RDMA
    远程直接内存访问是指从服务器到客户端或从服务器到其伙伴分区的DMA传输。DMA指的是既包括物理I/O到内存的操作也包括内存到内存的数据移动操作。
CRQ
    命令/响应队列是一种用于伙伴分区之间通信的设施。由虚拟机监控程序发送给分区的传输事件也会报告在此队列中。

示例：管理分区VMC驱动接口
==========================

本节提供了一个使用设备驱动与VMC设备接口的管理应用程序实现示例。该驱动包含一个新的设备，例如/dev/ibmvmc，它提供了打开、关闭、读取、写入以及对VMC设备执行ioctl的接口。

VMC接口初始化
---------------

当驱动加载时，设备驱动负责初始化VMC。首先创建并初始化CRQ。接下来，交换VMC能力以指示管理分区和虚拟机监控程序中的代码版本和可用资源数量。最后，虚拟机监控程序请求管理分区为每个可能的HMC连接创建一个初始的VMC缓冲池，这些缓冲池将用于管理应用程序会话初始化。在完成此初始化序列之前，设备对open()调用返回EBUSY。对于所有open()失败，返回EIO。

::

        管理分区       虚拟机监控程序
                       CRQ INIT
        ---------------------------->
                       CRQ INIT COMPLETE
        <--------------------------------
                        CAPABILITIES
        ----------------------------->
                      CAPABILITIES RESPONSE
        <---------------------------------
                   ADD BUFFER (HMC IDX=0,1,...)
        <-----------------------------------|
                     ADD BUFFER RESPONSE   | - 执行#HMC次迭代
        ------------------------------>  -

VMC接口打开
------------

在基本的VMC通道初始化后，可以建立HMC会话级别的连接。应用程序层对VMC设备执行open()并对其执行ioctl()，指示此次会话的HMC ID（32字节的数据）。如果VMC设备处于无效状态，则ioctl()会返回EIO。设备驱动为这个HMC ID创建一个新的HMC会话值（范围从1到255）和HMC索引值（从索引0开始，范围到254）。然后，驱动通过RDMA将HMC ID发送到虚拟机监控程序，并向虚拟机监控程序发送一个接口打开消息，通过VMC建立会话。虚拟机监控程序收到此信息后，会向管理分区发送添加缓冲区的消息，以建立新HMC连接的初始缓冲池。最后，虚拟机监控程序发送一个接口打开响应消息，表明已准备好进行正常的运行时消息传递。下图展示了此VMC流程：

::

        管理分区             虚拟机监控程序
                       RDMA HMC ID
        ------------------------------>
                       Interface Open
        ------------------------------>
                       Add Buffer
        <-----------------------------------
                     Add Buffer Response   |
        ------------------------------>  - 执行N次迭代
                       Interface Open Response
        <-----------------------------------

VMC接口运行时
-------------

在正常运行时，管理应用程序和虚拟机监控程序通过Signal VMC消息和RDMA操作交换HMC消息。当向虚拟机监控程序发送数据时，管理应用程序对VMC设备执行write()，驱动将数据通过RDMA发送到虚拟机监控程序，然后发送一个信号消息。如果尝试在虚拟机监控程序未提供VMC设备缓冲区之前或当前没有可用缓冲区的情况下执行write()，则返回EBUSY作为响应。对于其他错误，如设备状态无效，write()会返回EIO。当虚拟机监控程序向管理发送消息时，数据被放入一个VMC缓冲区，并向管理分区中的VMC驱动发送一个信号消息。驱动将缓冲区通过RDMA传入分区，并通过读取VMC设备将数据传递给相应的管理应用程序。如果没有可用缓冲区来读取，读取请求会被阻塞。管理应用程序可以使用select()等待VMC设备准备好数据以供读取。

::

        管理分区             虚拟机监控程序
                       MSG RDMA
        ------------------------------>
                       SIGNAL MSG
        ------------------------------>
                       SIGNAL MSG
        <--------------------------------
                       MSG RDMA
        <--------------------------------

VMC接口关闭
------------

当应用程序层对设备执行close()时，管理分区会关闭HMC会话级别的连接。这会导致一个接口关闭消息流向虚拟机监控程序，从而终止会话。设备驱动必须释放为此HMC连接分配的所有存储空间。

::

        管理分区             虚拟机监控程序
                        INTERFACE CLOSE
        ------------------------------>
                    INTERFACE CLOSE RESPONSE
        <--------------------------------

更多信息
========

有关CRQ消息、VMC消息、HMC接口缓冲区和信号消息的文档详细信息，请参阅Power架构Linux平台参考手册F部分。
当然，请提供您需要翻译的文本。
