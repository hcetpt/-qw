USB/IP 协议
==========

架构
====

USB/IP 协议遵循服务器/客户端架构。服务器导出 USB 设备，而客户端导入它们。被导出的 USB 设备的驱动程序运行在客户端机器上。
客户端可以请求导出的 USB 设备列表。为了获取这个列表，客户端会打开一个 TCP/IP 连接到服务器，并通过该连接发送一个 `OP_REQ_DEVLIST` 数据包（实际上，由于底层传输层的原因，`OP_REQ_DEVLIST` 可能会被分割为一个或多个数据包）。服务器随后会回应一个 `OP_REP_DEVLIST` 数据包，其中包含了导出的 USB 设备列表。最后，TCP/IP 连接会被关闭。

```
虚拟主机控制器                                 USB 主机
    "客户端"                                           "服务器"
(导入 USB 设备)                             (导出 USB 设备)
          |                                                 |
          |                  OP_REQ_DEVLIST                 |
          | ----------------------------------------------> |
          |                                                 |
          |                  OP_REP_DEVLIST                 |
          | <---------------------------------------------- |
          |                                                 |
```

一旦客户端知道了导出的 USB 设备列表，它就可以决定使用其中一个设备。首先，客户端会打开一个到服务器的 TCP/IP 连接，并发送一个 `OP_REQ_IMPORT` 数据包。服务器回复 `OP_REP_IMPORT`。如果导入成功，TCP/IP 连接保持打开状态，并用于在客户端与服务器之间传输 URB 通信。客户端可以发送两种类型的包：`USBIP_CMD_SUBMIT` 来提交 URB 和 `USBIP_CMD_UNLINK` 来取消之前提交的 URB。服务器的响应可能是 `USBIP_RET_SUBMIT` 和 `USBIP_RET_UNLINK`。

```
虚拟主机控制器                                 USB 主机
    "客户端"                                           "服务器"
(导入 USB 设备)                             (导出 USB 设备)
          |                                                 |
          |                  OP_REQ_IMPORT                  |
          | ----------------------------------------------> |
          |                                                 |
          |                  OP_REP_IMPORT                  |
          | <---------------------------------------------- |
          |                                                 |
          |            USBIP_CMD_SUBMIT(seqnum = n)         |
          | ----------------------------------------------> |
          |                                                 |
          |            USBIP_RET_SUBMIT(seqnum = n)         |
          | <---------------------------------------------- |
          |                        .                        |
          |                        :                        |
          |            USBIP_CMD_SUBMIT(seqnum = m)         |
          | ----------------------------------------------> |
          |                                                 |
          |            USBIP_CMD_SUBMIT(seqnum = m+1)       |
          | ----------------------------------------------> |
          |                                                 |
          |            USBIP_CMD_SUBMIT(seqnum = m+2)       |
          | ----------------------------------------------> |
          |                                                 |
          |            USBIP_RET_SUBMIT(seqnum = m)         |
          | <---------------------------------------------- |
          |                                                 |
          |            USBIP_CMD_SUBMIT(seqnum = m+3)       |
          | ----------------------------------------------> |
          |                                                 |
          |            USBIP_RET_SUBMIT(seqnum = m+1)       |
          | <---------------------------------------------- |
          |                                                 |
          |            USBIP_CMD_SUBMIT(seqnum = m+4)       |
          | ----------------------------------------------> |
          |                                                 |
          |            USBIP_RET_SUBMIT(seqnum = m+2)       |
          | <---------------------------------------------- |
          |                        .                        |
          |                        :                        |
```

对于取消（UNLINK），需要注意的是，在成功的 `USBIP_RET_UNLINK` 后，被取消的 URB 提交将不再有对应的 `USBIP_RET_SUBMIT` （这一点在 `drivers/usb/usbip/stub_rx.c` 的函数 `stub_recv_cmd_unlink` 中解释）。

```
虚拟主机控制器                                 USB 主机
    "客户端"                                           "服务器"
(导入 USB 设备)                             (导出 USB 设备)
          |                                                 |
          |            USBIP_CMD_SUBMIT(seqnum = p)         |
          | ----------------------------------------------> |
          |                                                 |
          |               USBIP_CMD_UNLINK                  |
          |         (seqnum = p+1, unlink_seqnum = p)       |
          | ----------------------------------------------> |
          |                                                 |
          |               USBIP_RET_UNLINK                  |
          |        (seqnum = p+1, status = -ECONNRESET)     |
          | <---------------------------------------------- |
          |                                                 |
          |         Note: No USBIP_RET_SUBMIT(seqnum = p)   |
          | <--X---X---X---X---X---X---X---X---X---X---X--- |
          |                        .                        |
          |                        :                        |
          |                                                 |
          |            USBIP_CMD_SUBMIT(seqnum = q)         |
          | ----------------------------------------------> |
          |                                                 |
          |            USBIP_RET_SUBMIT(seqnum = q)         |
          | <---------------------------------------------- |
          |                                                 |
          |               USBIP_CMD_UNLINK                  |
          |         (seqnum = q+1, unlink_seqnum = q)       |
          | ----------------------------------------------> |
          |                                                 |
          |               USBIP_RET_UNLINK                  |
          |           (seqnum = q+1, status = 0)            |
          | <---------------------------------------------- |
          |                                                 |
```

字段以网络字节顺序存储（大端序），这意味着最高有效字节 (MSB) 存储在最低地址处。

协议版本
========

文档化的 USBIP 版本是 v1.1.1。该版本在消息头中的二进制表示为 0x0111。这定义在 `tools/usb/usbip/configure.ac` 文件中。

消息格式
========

OP_REQ_DEVLIST:
    获取导出的 USB 设备列表
```
+-----------+--------+------------+---------------------------------------------------+
| Offset    | Length | Value      | Description                                       |
+===========+========+============+===================================================+
| 0         | 2      |            | USBIP 版本                                     |
+-----------+--------+------------+---------------------------------------------------+
| 2         | 2      | 0x8005     | 命令代码: 获取导出的 USB 设备列表。              |
+-----------+--------+------------+---------------------------------------------------+
| 4         | 4      | 0x00000000 | 状态: 未使用，应设为 0                            |
+-----------+--------+------------+---------------------------------------------------+
```

OP_REP_DEVLIST:
    回复导出的 USB 设备列表
```
+-----------+--------+------------+---------------------------------------------------+
| Offset    | Length | Value      | Description                                       |
+===========+========+============+===================================================+
| 0         | 2      |            | USBIP 版本                                     |
+-----------+--------+------------+---------------------------------------------------+
| 2         | 2      | 0x0005     | 回复代码: 导出的 USB 设备列表。                   |
+-----------+--------+------------+---------------------------------------------------+
| 4         | 4      | 0x00000000 | 状态: 0 表示成功                                 |
+-----------+--------+------------+---------------------------------------------------+
| 8         | 4      | n          | 导出设备的数量: 0 表示没有导出的设备             |
+-----------+--------+------------+---------------------------------------------------+
| 0x0C      |        |            | 从现在开始，如果有导出的 n 个设备，则描述这些设备 |
|           |        |            | 如果没有设备被导出，则消息在“导出设备数量”字段后结束 |
+-----------+--------+------------+---------------------------------------------------+
|           | 256    |            | path: 在导出 USB 设备的主机上的设备路径，字符串以零字节结尾，例如 |
|           |        |            | "/sys/devices/pci0000:00/0000:00:1d.1/usb3/3-2"   |
|           |        |            | 未使用的字节应当填充为零字节                     |
+-----------+--------+------------+---------------------------------------------------+
| 0x10C     | 32     |            | busid: 被导出设备的总线 ID，字符串以零字节结尾，例如 "3-2" |
|           |        |            | 未使用的字节应当填充为零字节                     |
+-----------+--------+------------+---------------------------------------------------+
| 0x12C     | 4      |            | busnum                                            |
+-----------+--------+------------+---------------------------------------------------+
| 0x130     | 4      |            | devnum                                            |
+-----------+--------+------------+---------------------------------------------------+
| 0x134     | 4      |            | speed                                             |
+-----------+--------+------------+---------------------------------------------------+
| 0x138     | 2      |            | idVendor                                          |
+-----------+--------+------------+---------------------------------------------------+
| 0x13A     | 2      |            | idProduct                                         |
+-----------+--------+------------+---------------------------------------------------+
| 0x13C     | 2      |            | bcdDevice                                         |
+-----------+--------+------------+---------------------------------------------------+
| 0x13E     | 1      |            | bDeviceClass                                      |
+-----------+--------+------------+---------------------------------------------------+
| 0x13F     | 1      |            | bDeviceSubClass                                   |
+-----------+--------+------------+---------------------------------------------------+
| 0x140     | 1      |            | bDeviceProtocol                                   |
+-----------+--------+------------+---------------------------------------------------+
| 0x141     | 1      |            | bConfigurationValue                               |
+-----------+--------+------------+---------------------------------------------------+
| 0x142     | 1      |            | bNumConfigurations                                |
+-----------+--------+------------+---------------------------------------------------+
| 0x143     | 1      |            | bNumInterfaces                                    |
+-----------+--------+------------+---------------------------------------------------+
| 0x144     |        | m_0        | 从现在开始，每个接口都用以下 4 个字段进行描述，总共 bNumInterfaces 次 |
+-----------+--------+------------+---------------------------------------------------+
|           | 1      |            | bInterfaceClass                                   |
+-----------+--------+------------+---------------------------------------------------+
| 0x145     | 1      |            | bInterfaceSubClass                                |
+-----------+--------+------------+---------------------------------------------------+
| 0x146     | 1      |            | bInterfaceProtocol                                |
+-----------+--------+------------+---------------------------------------------------+
| 0x147     | 1      |            | 对齐填充字节，应设为零                           |
+-----------+--------+------------+---------------------------------------------------+
| 0xC +     |        |            | 第二个导出的 USB 设备从 i=1 开始，从 path 字段开始 |
| i*0x138 + |        |            |                                                   |
| m_(i-1)*4 |        |            |                                                   |
+-----------+--------+------------+---------------------------------------------------+
```

OP_REQ_IMPORT:
    请求导入（连接）远程 USB 设备
```
+-----------+--------+------------+---------------------------------------------------+
| Offset    | Length | Value      | Description                                       |
+===========+========+============+===================================================+
| 0         | 2      |            | USBIP 版本                                     |
+-----------+--------+------------+---------------------------------------------------+
| 2         | 2      | 0x8003     | 命令代码: 导入远程 USB 设备。                    |
+-----------+--------+------------+---------------------------------------------------+
| 4         | 4      | 0x00000000 | 状态: 未使用，应设为 0                            |
+-----------+--------+------------+---------------------------------------------------+
| 8         | 32     |            | busid: 在远程主机上的被导出设备的 busid。可能的值取自 |
|           |        |            | 消息字段 OP_REP_DEVLIST.busid。字符串以零字节结尾， |
|           |        |            | 未使用的字节应当填充为零                          |
+-----------+--------+------------+---------------------------------------------------+
```

OP_REP_IMPORT:
    回复导入（连接）远程 USB 设备
