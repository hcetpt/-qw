# SPDX-许可证标识符: (GPL-2.0-only 或 BSD-2-Clause)
%YAML 1.2
---
$id: http://devicetree.org/schemas/pci/host-generic-pci.yaml#
$schema: http://devicetree.org/meta-schemas/core.yaml#

标题: 通用 PCI 主控制器

维护者:
  - Will Deacon <will@kernel.org>

描述: |
  由固件初始化的 PCI 主控制器和 PCI 模拟，例如在 kvmtool 和其他准虚拟化系统中发现的 virtio-pci 实现，并不需要驱动程序支持诸如调节器和时钟管理之类的复杂性。实际上，控制器甚至可能不需要操作系统配置控制接口，而是直接展示一组固定的窗口来描述一部分 IO、内存和配置空间。
配置空间假定为内存映射（而非通过 io 端口访问），并且通过将各个组件拼接形成偏移量以与 PCI 总线地址的地理布局直接对应。
对于 CAM，这个 24 位的偏移量是：

          cfg_offset(总线, 设备, 功能, 寄存器) =
                     总线 << 16 | 设备 << 11 | 功能 << 8 | 寄存器

  而 ECAM 通过扩展 4 位来容纳 4k 的功能空间：

          cfg_offset(总线, 设备, 功能, 寄存器) =
                     总线 << 20 | 设备 << 15 | 功能 << 12 | 寄存器

属性:
  compatible:
    描述: 取决于配置空间的布局（CAM 与 ECAM）。也可能有更具体的兼容项
oneOf:
      - 描述:
          基于 PLDA XpressRICH3-AXI IP 的 Arm Juno 中的 PCIe 主控制器
        items:
          - const: arm,juno-r1-pcie
          - const: plda,xpressrich3-axi
          - const: pci-host-ecam-generic
      - 描述: |
          针对 pass-1.x 硅片的 ThunderX PCI 主控制器

          固件初始化的 PCI 主控制器用于一些 Cavium ThunderX 处理器上的芯片内设备。这些设备具有基于 ECAM 的配置访问，但所有 BAR 都位于固定地址。我们通过为这些设备合成增强分配（EA）能力来处理固定地址
const: cavium,pci-host-thunder-ecam
      - 描述:
          Cavium ThunderX PEM 固件初始化的 PCIe 主控制器
        const: cavium,pci-host-thunder-pem
      - 描述:
          HiSilicon Hip06/Hip07 在几乎 ECAM 模式下的 PCIe 主桥。某些
          固件将主控制器置于一种模式，在这种模式下，除了根复合体之外的所有设备都符合 ECAM 规范
enum:
          - hisilicon,hip06-pcie-ecam
          - hisilicon,hip07-pcie-ecam
      - 描述: |
          在某些情况下，固件可能已经配置了 Synopsys DesignWare PCIe 控制器以 RC 模式并带有静态 ATU 窗口映射，
          这些映射以[基本上] ECAM 兼容的方式覆盖了所有配置、MMIO 和 I/O 空间。在这种情况下，操作系统无需执行任何底层时钟、PHY 或设备寄存器的设置，
          也没有理由让驱动程序在运行时重新配置 ATU 窗口以访问配置和/或 I/O 空间
在 IP 合成时最小 ATU 窗口大小为 64 KB 的情况下，它无法被通用 ECAM 驱动程序支持，因为它需要特殊的配置空间访问器来过滤对第一个总线上第 1 个设备及以后的访问
items:
          - enum:
              - marvell,armada8k-pcie-ecam
              - socionext,synquacer-pcie-ecam
          - const: snps,dw-pcie-ecam
      - 描述:
          没有任何特殊之处的 CAM 或 ECAM 兼容的 PCI 主控制器
        enum:
          - pci-host-cam-generic
          - pci-host-ecam-generic

  reg:
    描述:
      从父总线访问的配置空间基地址和大小。基地址对应于“bus-range”属性中的第一个总线。如果没有指定“bus-range”，这将是总线 0（默认值）。一些主控制器有一个不合规的第二地址范围，因此允许两个条目
minItems: 1
    maxItems: 2

  ranges:
    描述:
      如 IEEE 标准 1275-1994 所述，但必须至少提供非预取内存的定义。也可以提供可预取内存和 I/O 空间
minItems: 1
    maxItems: 3

  dma-coherent: true
  iommu-map: true
  iommu-map-mask: true
  msi-parent: true

required:
  - compatible
  - reg
  - ranges

allOf:
  - $ref: /schemas/pci/pci-host-bridge.yaml#
  - 如果:
      properties:
        compatible:
          contains:
            const: arm,juno-r1-pcie
    则:
      required:
        - dma-coherent

  - 如果:
      properties:
        compatible:
          not:
            contains:
              enum:
                - cavium,pci-host-thunder-pem
                - hisilicon,hip06-pcie-ecam
                - hisilicon,hip07-pcie-ecam
    则:
      properties:
        reg:
          maxItems: 1

unevaluatedProperties: false

例子:
  - |

    bus {
        #address-cells = <2>;
        #size-cells = <2>;
        pcie@40000000 {
            compatible = "pci-host-cam-generic";
            device_type = "pci";
            #address-cells = <3>;
            #size-cells = <2>;
            bus-range = <0x0 0x1>;

            // CPU_PHYSICAL(2)  SIZE(2)
            reg = <0x0 0x40000000  0x0 0x1000000>;

            // BUS_ADDRESS(3)  CPU_PHYSICAL(2)  SIZE(2)
            ranges = <0x01000000 0x0 0x01000000  0x0 0x01000000  0x0 0x00010000>,
                     <0x02000000 0x0 0x41000000  0x0 0x41000000  0x0 0x3f000000>;

            #interrupt-cells = <0x1>;

            // PCI_DEVICE(3)  INT#(1)  CONTROLLER(PHANDLE)  CONTROLLER_DATA(3)
            interrupt-map = <   0x0 0x0 0x0  0x1  &gic  0x0 0x4 0x1>,
                            < 0x800 0x0 0x0  0x1  &gic  0x0 0x5 0x1>,
                            <0x1000 0x0 0x0  0x1  &gic  0x0 0x6 0x1>,
                            <0x1800 0x0 0x0  0x1  &gic  0x0 0x7 0x1>;

            // PCI_DEVICE(3)  INT#(1)
            interrupt-map-mask = <0xf800 0x0 0x0  0x7>;
        };
    };
您没有提供需要翻译的文本。请提供需要翻译成中文的句子或词语。
