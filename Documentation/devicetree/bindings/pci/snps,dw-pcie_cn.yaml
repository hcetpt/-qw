# SPDX-许可证标识符: GPL-2.0
%YAML 1.2
---
$id: http://devicetree.org/schemas/pci/snps,dw-pcie.yaml#
$schema: http://devicetree.org/meta-schemas/core.yaml#

标题: Synopsys DesignWare PCIe 接口

维护者:
  - Jingoo Han <jingoohan1@gmail.com>
  - Gustavo Pimentel <gustavo.pimentel@synopsys.com>

描述: |
  Synopsys DesignWare PCIe 主控制器

# 请为您的 DWC PCIe 根端口控制器创建一个单独的 DT 架构
# 并确保它被分配了特定于供应商的兼容字符串
选择:
  属性:
    compatible:
      常量: snps,dw-pcie
  必需:
    - compatible

allOf:
  - $ref: /schemas/pci/pci-host-bridge.yaml#
  - $ref: /schemas/pci/snps,dw-pcie-common.yaml#
  - 如果:
      不:
        必需:
          - msi-map
    那么:
      属性:
        interrupt-names:
          包含:
            常量: msi

属性:
  reg:
    描述:
      控制器正常工作至少需要 DBI 寄存器空间和外围设备 CFG 空间输出窗口。如果空间未展开（IP 核版本 >= 4.80a），还需要 iATU 内存 IO 区域
最小项: 2
    最大项: 7

  reg-names:
    最小项: 2
    最大项: 7
    项:
      任一:
        - 描述:
            通过 DBI 接口访问的基本 DWC PCIe 控制器配置空间。这个内存空间可以通过设置 CDM/ELBI = 0 和 CS2 = 0 激活，或者是一个包含所有空间的连续内存区域。请注意，在 v4.80a 之前的 DWC PCIe 控制器中，iATU/eDMA CSRs 是通过 PL 视图间接访问的
常量: dbi
        - 描述:
            DWC PCIe 配置空间寄存器的镜像。通过设置 CDM/ELBI = 0 和 CS2 = 1 选择此空间。这是 PCI-SIG PCIe CFG 空间与一些 PCI 头部空间、PCI 标准和扩展结构的镜像寄存器的混合。它主要适用于端点控制器配置，但仍有一些根端口模式可用的镜像寄存器
常量: dbi2
        - 描述:
            外部本地总线寄存器。这是一个通常由平台工程师定义的应用程序相关寄存器。可以通过设置 CDM/ELBI = 1 和 CS2 = 0 或通过某些平台特定方式（例如作为系统控制器的一部分）来选择此空间
枚举: [ elbi, app ]
        - 描述:
            所有设备功能共用的 iATU/eDMA 寄存器。这是一个具有内部地址转换单元和增强型 DMA 的展开内存空间，通过设置 CDM/ELBI = 1 和 CS2 = 1 来选择。对于 v4.80a 之前的 IP 核版本，这些寄存器是通过使用一组映射到 PL 空间的视图寄存器进行间接寻址方案编程的。请注意，iATU 通常映射到此区域的 0x0 地址，而 eDMA 可在 0x80000 基地址处获取
常量: atu
        - 描述:
            平台特定的 eDMA 寄存器。一些平台可能有非标准基地址的 eDMA CSRs 映射。寄存器偏移可以更改，或者可以在内存 IO 交易到达 DW PCIe 从接口之前，在附加的 RTL 块中附加地址的 MS/LS 位
常量: dma
        - 描述:
            PHY/PCS 配置寄存器。一些平台可以通过专用内存映射区域访问 PCS 和 PHY CSRs，但主要通过嵌入式 PHY 视图方案或某些平台特定方法间接访问这些寄存器
常量: phy
        - 描述:
            用于访问外围 PCIe 设备配置空间的 iATU 能力的内存区域
常量: config
        - 描述:
            特定于供应商的 CSR 名称。考虑为新的绑定使用上述通用名称
这段文档描述了与硬件配置相关的规范，特别是针对某些特定的中断和配置空间（CSR）区域。下面是翻译后的中文版本：

`oneOf`:
    - `description`: 有关详情，请参见原生 'elbi/app' CSR 区域
`enum`: [apb, mgmt, link, ulreg, appl]
    - `description`: 有关详情，请参见原生 'atu' CSR 区域
`enum`: [atu_dma]
    - `description`: 与 Syscon 相关的 CSR 区域
`enum`: [smu, mpu]
    - `description`: Tegra234 孔径
`enum`: [ecam]

`allOf`:
    - `contains`:
        `const`: dbi
    - `contains`:
        `const`: config

`interrupts`:
    `description`:
        DWC PCIe 根端口/复合体专用的中断信号。主机控制器至少应指定一个 MSI 中断信号。
`minItems`: 1
    `maxItems`: 26

`interrupt-names`:
    `minItems`: 1
    `maxItems`: 26
    `items`:
        `oneOf`:
            - `description`:
                控制器请求从/向 VPD 能力寄存器读取或写入虚拟产品数据
`const`: vpd
            - `description`:
                链路状态 2 寄存器中的链路均衡请求标志被设置（如果在链路控制 3 寄存器中启用了相应的中断）
`const`: l_eq
            - `description`:
                表明 eDMA 发送/接收传输已完成或相应通道上发生了错误。eDMA 可以有八个发送（写入）和接收（读取）eDMA 通道，总共支持最多 16 个中断信号。根据默认的 edma_int[*] 总线设置，写入 eDMA 通道应在有序行中排在首位
`pattern`: '^dma([0-9]|1[0-5])?$'
            - `description`:
                汽车/安全特性检测到 PCIe 协议可纠正错误或数据路径保护可纠正错误
`const`: sft_ce
            - `description`:
                表明内部安全机制检测到了无法纠正的错误
`const`: sft_ue
            - `description`:
                基于供应商特定事件的基础之上引发的应用程序特定的中断
The provided text describes various interrupt types and their descriptions within a PCI Express (PCIe) context, followed by an example configuration snippet using the Device Tree Format (DTF). Below is the translation into Chinese:

### 中断常量定义
- **app**: 
    - 描述: 检测到 DSP AXI MSI 中断。当不再有待处理的 MSI 中断时，该中断会被取消激活。此中断与 iMSI-RX - 集成 MSI 接收器（AXI 桥接器）相关。
- **msi**: 
    - 描述: 传统的 A/B/C/D 中断信号。基本上是由下游设备发送的 `Assert_INT{A,B,C,D}/Deassert_INT{A,B,C,D}` 消息触发的。
- **pattern**: `"^int(a|b|c|d)$"`: 
    - 描述: 检测到错误条件，并在 AER 能力的根错误状态寄存器中设置标志。当 RC 内部生成错误或收到错误消息时被激活。
- **aer**: 
    - 描述: 在端口上接收到 PME 消息。这意味着在根状态寄存器中设置了 PME 状态位（该事件应该在根控制寄存器中未被屏蔽）。
- **pme**: 
    - 描述: 检测到热插拔事件。即 Slot 状态寄存器中的某个位被设置，并且在 Slot 控制寄存器中启用了相应的事件。
- **hp**: 
    - 描述: 在 Link 状态寄存器中设置了 Link 自主带宽状态标志（该事件应该在 Link 控制寄存器中未被屏蔽）。
- **bw_au**: 
    - 描述: 在 Link 状态寄存器中设置了带宽管理状态标志（该事件应该在 Link 控制寄存器中未被屏蔽）。
- **bw_mg**: 
    - 描述: 组合的传统的 A/B/C/D 中断信号。详情见 `"^int(a|b|c|d)$"`。
- **legacy**: 
    - 描述: 厂商特定的 IRQ 名称。对于新的绑定，考虑使用上述通用名称。
- **oneOf**:
    - 描述: 参见原生 "app" IRQ 的详细信息
    - 枚举值: `[ intr, sys, pmc, msg, err ]`

### 其他属性
- **additionalProperties**: `true`

### 必须包含的属性
- **compatible**
- **reg**
- **reg-names**

### 示例配置
```plaintext
pcie@dfc00000 {
  compatible = "snps,dw-pcie";
  device_type = "pci";
  reg = <0xdfc00000 0x0001000>, /* IP 寄存器 */
        <0xd0000000 0x0002000>; /* 配置空间 */
  reg-names = "dbi", "config";
  #address-cells = <3>;
  #size-cells = <2>;
  ranges = <0x81000000 0 0x00000000 0xde000000 0 0x00010000>,
           <0x82000000 0 0xd0400000 0xd0400000 0 0x0d000000>;
  bus-range = <0x0 0xff>;

  interrupts = <25>, <24>;
  interrupt-names = "msi", "hp";
  #interrupt-cells = <1>;

  reset-gpios = <&port0 0 1>;

  phys = <&pcie_phy>;
  phy-names = "pcie";

  num-lanes = <1>;
  max-link-speed = <3>;
};
```
This configuration represents a PCIe device with specific properties and interrupts defined according to the DTF.
