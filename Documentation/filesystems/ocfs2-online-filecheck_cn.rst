SPDX 许可声明标识符: GPL-2.0

=====================================
OCFS2 文件系统 - 在线文件检查
=====================================

本文档将描述 OCFS2 的在线文件检查功能。

介绍
============
OCFS2 常用于高可用性系统。然而，当遇到错误时，OCFS2 通常会将文件系统转换为只读模式。这可能不是必要的，因为将文件系统设置为只读会影响其他运行中的进程，从而降低可用性。
因此，引入了一个挂载选项（errors=continue），该选项会向调用进程返回 -EIO 错误号并终止进一步的处理，以防止文件系统进一步损坏。文件系统不会被转换为只读模式，并且会在内核日志中报告有问题文件的inode编号。用户可以尝试通过在线文件检查功能来检查或修复这个文件。

范围
=====
这项工作旨在通过将文件系统转换为只读模式来检查和修复可能妨碍集群文件系统日常操作的小问题。检查和修复的范围最初限于普通文件，最终扩展到文件系统中的所有文件（包括系统文件）。
如果目录到文件的链接不正确，则会报告该目录的inode编号为错误。
此功能不适合进行涉及文件系统其他组件依赖性的复杂检查，例如但不限于检查分配位是否已设置。在这种情况下，建议使用离线 fsck 进行修复。
最后，此类操作/功能不应自动化，以免文件系统在修复尝试后反而遭受更多损害。因此，必须由用户交互并确认来进行此操作。

用户界面
==============
当 OCFS2 文件系统出现错误时，通常会伴随着导致错误的inode编号。这个inode编号将是用于检查或修复文件的输入。
每个已挂载的 OCFS2 文件系统都有一个 sysfs 目录：

  /sys/fs/ocfs2/<devname>/filecheck

这里的 <devname> 表示已经挂载的 OCFS2 卷设备名称。上述文件将接受inode编号。这可用于与内核空间通信，告知将要检查或修复哪个文件（inode编号）。目前支持三种操作，包括检查inode、修复inode以及设置结果记录历史的大小。
1. 如果你想知道 <inode> 在修复前发生了什么错误，请执行以下命令：

    # echo "<inode>" > /sys/fs/ocfs2/<devname>/filecheck/check
    # cat /sys/fs/ocfs2/<devname>/filecheck/check

输出如下所示：

    INO		DONE	ERROR
    39502		1	GENERATION

    <INO> 列出inode编号
<DONE> 表示操作是否已完成  
<ERROR> 显示发现了何种错误。对于详细的错误编号，请参阅文件 `linux/fs/ocfs2/filecheck.h`  
2. 如果您决定修复该inode，请执行以下操作：  

    # echo "<inode>" > /sys/fs/ocfs2/<devname>/filecheck/fix  
    # cat /sys/fs/ocfs2/<devname>/filecheck/fix  

输出如下所示：  

    INO		DONE	ERROR  
    39502		1	SUCCESS  

这次，<ERROR> 列显示此修复是否成功  
3. 记录缓存用于存储检查/修复结果的历史记录。其默认大小为10，并且可以在10到100的范围内调整。您可以像这样调整大小：  

  # echo "<size>" > /sys/fs/ocfs2/<devname>/filecheck/set  

修复内容
========
接收到inode后，文件系统会读取inode和文件元数据。在出现错误的情况下，文件系统会修复这些错误，并在内核日志中报告它所修复的问题。作为预防措施，在进行最终修复之前，必须首先检查inode是否存在错误。inode及其结果历史将临时保存在一个小的链表缓冲区中，该缓冲区包含最后(N)个已修复/检查的inode，详细修复/检查的错误将打印在内核日志中。
