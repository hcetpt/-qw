SPDX 许可证标识符: GPL-2.0

校验和
------

从2012年初开始，所有主要的ext4和jbd2数据结构中都添加了元数据校验和。相关的功能标志是metadata_csum。超级块中指定了所需的校验和算法，但截至2012年10月，唯一支持的算法是crc32c。一些数据结构没有足够的空间来存储完整的32位校验和，因此只存储较低的16位。启用64位功能会增加数据结构的大小，以便许多数据结构可以存储完整的32位校验和。然而，现有的32位文件系统无法扩展以启用64位模式，至少在没有实验性的resize2fs补丁的情况下不能。

现有文件系统可以通过对底层设备运行`tune2fs -O metadata_csum`来添加校验和。如果tune2fs遇到缺乏足够空闲空间来添加校验和的目录块，它将要求您运行`e2fsck -D`以使用校验和重建目录。这还有助于去除目录文件中的松弛空间并重新平衡htree索引。如果您忽略此步骤，您的目录将不会受到校验和保护！

下表描述了构成每种类型校验和的数据元素。除非另有说明，校验和函数是超级块中描述的（截至2013年10月为crc32c）。
.. list-table::
   :widths: 20 8 50
   :header-rows: 1

   * - 元数据
     - 长度
     - 成分
   * - 超级块
     - __le32
     - 整个超级块直到校验和字段。UUID位于超级块内部
* - MMP
     - __le32
     - UUID + 整个MMP块直到校验和字段
* - 扩展属性
     - __le32
     - UUID + 整个扩展属性块。校验和字段设为零
* - 目录项
     - __le32
     - UUID + inode编号 + inode生成号 + 目录块直到包含校验和字段的假条目
* - HTREE节点
     - __le32
     - UUID + inode编号 + inode生成号 + 所有有效范围 + HTREE尾部。校验和字段设为零
* - 区段
     - __le32
     - UUID + inode编号 + inode生成号 + 整个区段块直到校验和字段
* - 位图
     - __le32 或 __le16
     - UUID + 整个位图。校验和存储在组描述符中，并在组描述符大小为 32 字节时（即 ^64 位）进行截断
   * - 索引节点
     - __le32
     - UUID + 索引节点号 + 索引节点生成号 + 整个索引节点。校验和字段设置为零。每个索引节点都有自己的校验和
* - 组描述符
     - __le16
     - 如果是 metadata_csum，则 UUID + 组号 + 整个描述符；如果是 gdt_csum，则 crc16(UUID + 组号 + 整个描述符)。在所有情况下，仅存储低 16 位
