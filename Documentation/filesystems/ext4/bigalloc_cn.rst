SPDX 许可证标识符: GPL-2.0

大分配 (Bigalloc)
----------------

目前，默认的块大小为 4KiB，这是大多数具有内存管理单元（MMU）的硬件普遍支持的页面大小。这很幸运，因为 ext4 代码还没有准备好处理块大小超过页面大小的情况。然而，对于主要由大型文件组成的文件系统来说，能够以多个块为单位分配磁盘块可以减少碎片和元数据开销。大分配功能正好提供了这种能力。

大分配功能（EXT4_FEATURE_RO_COMPAT_BIGALLOC）使 ext4 改用聚簇分配，因此 ext4 块分配位图中的每个位都对应着一个2的幂次方数量的块。例如，如果文件系统主要用于存储 4 到 32 兆字节范围内的大文件，那么设置 1 兆字节的聚簇大小可能是合理的。

这意味着块分配位图中的每个位现在对应 256 个 4K 块。这将一个 2TB 文件系统的块分配位图总大小从 64 兆字节缩小到 256 千字节。这也意味着一个块组现在管理的是 32GB 而不是 128MB，从而减少了文件系统的元数据开销。

管理员可以在创建文件系统时（即 mkfs 时）设置块聚簇大小（该值存储在超级块中的 s_log_cluster_size 字段中）。从那时起，块位图跟踪的是聚簇而不是单个块。这意味着块组可以达到几 GB 的大小（而不仅仅是 128MiB），但最小分配单位变成了聚簇而不是块，即使对于目录也是如此。淘宝有一个补丁集扩展了“使用聚簇而不是块”的概念到 extent 树，不过这些补丁的去向并不明确——它们最终演变成“extent 树 v2”，但截至 2015 年 5 月，这些代码尚未合并。
