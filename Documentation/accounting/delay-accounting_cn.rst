延迟会计
========

任务在等待某些内核资源可用时会遇到执行延迟，例如，一个可运行的任务可能需要等待空闲的CPU来运行。
每任务延迟会计功能衡量了任务在以下情况下的延迟：

a) 等待CPU（当任务处于可运行状态）
b) 由任务发起的同步块I/O完成
c) 页面交换进入内存
d) 内存回收
e) 冲突（系统试图写入已满的磁盘空间）
f) 直接压缩
g) 写保护复制
h) 中断请求/软中断

并通过`taskstats`接口将这些统计信息提供给用户空间。
此类延迟可以为设置任务的CPU优先级、I/O优先级和RSS限制值提供反馈。重要任务的长时间延迟可能是提高其相应优先级的触发条件。
通过使用`taskstats`接口，该功能还提供了对属于线程组（对应于传统的Unix进程）的所有任务（或线程）的延迟统计汇总。这是通常需要的汇总，并且由内核更高效地完成。
用户空间工具，特别是资源管理应用，也可以将延迟统计信息汇总到任意组别中。为此，任务的延迟统计信息在其生命周期中以及退出时都可用，确保可以进行连续和完整的监控。

接口
----

延迟会计使用`taskstats`接口，该接口在此目录中的单独文档中有详细描述。`Taskstats`向用户空间返回与每个进程ID (`pid`) 和线程组ID (`tgid`) 统计信息相对应的通用数据结构。延迟会计功能填充此结构体中的特定字段。参见

     `include/uapi/linux/taskstats.h`

以获取与延迟会计相关的字段描述。
一般情况下，这些字段将以计数器的形式返回累积的延迟，如CPU、同步块I/O、页面交换、内存回收、冲突页缓存、直接压缩、写保护复制、中断请求/软中断等。
两个连续读取的给定计数器（例如`cpu_delay_total`）之间的差值将给出任务在该区间内等待相应资源所经历的延迟。
当任务退出时，包含每任务统计信息的记录将被发送到用户空间，无需发出命令。如果它是线程组中最后一个退出的任务，则还会发送每`tgid`的统计信息。更多细节在`taskstats`接口描述中有说明。
`tools/accounting`目录中的`getdelays.c`用户空间工具允许运行简单的命令并显示相应的延迟统计信息。它也作为使用`taskstats`接口的一个示例。
### 使用方法
------

使用以下配置编译内核：

```
CONFIG_TASK_DELAY_ACCT=y
CONFIG_TASKSTATS=y
```

延迟会计默认在启动时是禁用的。
要启用它，请在内核启动选项中添加：

```
delayacct
```

下面的说明假设已经完成了这个设置。或者，您也可以使用 `sysctl kernel.task_delayacct` 在运行时切换状态。需要注意的是，只有在启用后启动的任务才会有延迟会计信息。

系统启动后，可以使用一个类似于 `getdelays.c` 的工具来访问某个任务或任务组（tgid）所经历的延迟。
该工具还可以让您执行特定命令并查看相应的延迟。

`getdelays` 命令的一般格式如下：

```
getdelays [-dilv] [-t tgid] [-p pid]
```

获取自系统启动以来 pid 10 的所有延迟：

```
# ./getdelays -d -p 10
# 输出类似于下一个案例
```

获取自系统启动以来 tgid 为 5 的所有 pid 的延迟总和：

```
# ./getdelays -d -t 5
打印延迟会计统计 ON
TGID	5

CPU             计数     实际总计  虚拟总计    延迟总计  平均延迟
                        8        7000000        6872122        3382277          0.423ms
IO              计数    延迟总计  平均延迟
                   0              0          0.000ms
SWAP            计数    延迟总计  平均延迟
                      0              0          0.000ms
RECLAIM         计数    延迟总计  平均延迟
                   0              0          0.000ms
THRASHING       计数    延迟总计  平均延迟
                      0              0          0.000ms
COMPACT         计数    延迟总计  平均延迟
                      0              0          0.000ms
WPCOPY          计数    延迟总计  平均延迟
                      0              0          0.000ms
IRQ             计数    延迟总计  平均延迟
                      0              0          0.000ms
```

获取 pid 1 的 I/O 会计信息，此命令只能与 `-p` 一起使用：

```
# ./getdelays -i -p 1
打印 I/O 会计信息
linuxrc: 读取=65536, 写入=0, 取消写入=0
```

上述命令可以与 `-v` 一起使用以获得更多的调试信息。
