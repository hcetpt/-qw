C DCL-fixed

(*
 * 结果：从不
 *
 * 此测试用例展示了在正确使用 smp_load_acquire() 和 smp_store_release() 的基础上，双重检查锁定（double-checked locking）可以是可靠的。
*)

{
	int flag;
	int data;
}

P0(int *flag, int *data, spinlock_t *lck)
{
	int r0;
	int r1;
	int r2;

	r0 = smp_load_acquire(flag);
	if (r0 == 0) {
		spin_lock(lck);
		r1 = READ_ONCE(*flag);
		if (r1 == 0) {
			WRITE_ONCE(*data, 1);
			smp_store_release(flag, 1);
		}
		spin_unlock(lck);
	}
	r2 = READ_ONCE(*data);
}

P1(int *flag, int *data, spinlock_t *lck)
{
	int r0;
	int r1;
	int r2;

	r0 = smp_load_acquire(flag);
	if (r0 == 0) {
		spin_lock(lck);
		r1 = READ_ONCE(*flag);
		if (r1 == 0) {
			WRITE_ONCE(*data, 1);
			smp_store_release(flag, 1);
		}
		spin_unlock(lck);
	}
	r2 = READ_ONCE(*data);
}

位置 [flag;data;0:r0;0:r1;1:r0;1:r1]
存在 (0:r2=0 或 1:r2=0)
