### SPDX 许可证标识符：GPL-2.0

#### 简介

Linux 计算加速器子系统旨在以通用的方式向用户空间暴露计算加速器，并提供一套通用的功能。这些设备可以是独立的 ASIC（专用集成电路）或 SoC（片上系统）/GPU 内的 IP（知识产权）模块。尽管这些设备通常被设计用于加速机器学习 (ML) 和/或深度学习 (DL) 的计算，但加速层并不局限于处理这些类型的加速器。通常情况下，计算加速器将属于以下类别之一：

- **边缘 AI** — 在边缘设备上执行推理。它可以是一个嵌入式的 ASIC/FPGA，或是 SoC 中的一个 IP（例如笔记本电脑的网络摄像头）。这类设备通常通过寄存器进行配置，并且可以使用或不使用 DMA（直接内存访问）。
- **数据中心推理** — 大型服务器中的单用户或多用户设备。这种类型的设备可以是独立的，也可以是 SoC 或 GPU 中的一个 IP。它会配备板载 DRAM（用于存储 DL 拓扑结构）、DMA 引擎和命令提交队列（内核或用户空间队列）。它还可能包含 MMU（内存管理单元）来管理多个用户，并支持虚拟化（如 SR-IOV），以在同一设备上支持多个虚拟机。此外，这些设备通常会有一些工具，如性能分析器和调试器。
- **数据中心训练** — 与数据中心推理卡类似，但通常具有更强的计算能力和更大的内存带宽（例如 HBM），并且很可能有一种扩展方法，即在服务器内部或跨服务器与其他训练卡连接。

所有这些设备通常都拥有不同的运行时用户空间软件堆栈，这些堆栈根据其硬件定制而成。此外，它们也可能包括一个编译器来为其定制的计算引擎生成程序。通常，用户空间中的通用层将是 DL（深度学习）框架，例如 PyTorch 和 TensorFlow。

#### 与 DRM 共享代码

由于这类设备可以是 GPU 内的 IP 或具有与 GPU 类似的特性，加速子系统将利用 DRM 子系统的代码和功能。也就是说，加速核心代码将成为 DRM 子系统的一部分，而加速设备将成为一种新的 DRM 设备类型。这将使我们能够利用 DRM 的庞大代码库，并与有此类设备开发经验的 DRM 开发者合作。此外，为加速器驱动程序添加的新功能也可能对 GPU 驱动程序有用。
与GPU的区别
=========================

因为我们希望防止用户空间图形软件堆栈尝试将加速器用作GPU，所以计算加速器将通过使用新的主版本号和新的设备字符文件与GPU区分开来。此外，驱动程序将位于内核树的独立位置 - drivers/accel/。
加速器设备将以专用的261主版本号暴露给用户空间，并遵循以下约定：

- 设备字符文件 - /dev/accel/accel\*
- sysfs             - /sys/class/accel/accel\*/
- debugfs           - /sys/kernel/debug/accel/\*/

入门指南
===============

首先，请阅读Documentation/gpu/index.rst中的DRM文档。它不仅会解释如何编写一个新的DRM驱动程序，还会包含有关如何贡献、行为准则以及编码风格/文档的所有信息。所有这些对于加速子系统同样适用。
其次，请确保内核配置了CONFIG_DRM_ACCEL选项。
为了将您的设备暴露为加速器，您的驱动程序需要进行两项更改（与标准DRM驱动程序相比）：

- 在drm_driver的driver_features字段中添加DRIVER_COMPUTE_ACCEL特性标志。需要注意的是，此驱动特性与DRIVER_RENDER和DRIVER_MODESET互斥。想要同时暴露图形和计算设备字符文件的设备应该通过辅助总线框架由两个驱动程序处理。
- 更改您驱动程序fops结构中的open回调为accel_open()。或者，您的驱动程序可以使用DEFINE_DRM_ACCEL_FOPS宏轻松设置正确的函数操作指针结构。

外部参考资料
===================

邮件讨论
-------------

* `关于新加速设备子系统的初步讨论 <https://lore.kernel.org/lkml/CAFCwf11=9qpNAepL7NL+YAV_QO=Wv6pnWPhKHKAepK3fNn+2Dg@mail.gmail.com/>`_ - Oded Gabbay (2022)
* `添加新子系统的补丁集 <https://lore.kernel.org/lkml/20221022214622.18042-1-ogabbay@kernel.org/>`_ - Oded Gabbay (2022)

会议演讲
----------------

* `LPC 2022 加速器BOF成果总结 <https://airlied.blogspot.com/2022/09/accelerators-bof-outcomes-summary.html>`_ - Dave Airlie (2022)
