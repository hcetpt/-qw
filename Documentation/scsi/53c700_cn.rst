SPDX 许可证标识符: GPL-2.0

=======================
53c700 驱动程序说明
=======================

一般描述
===================

此驱动程序支持 53c700 和 53c700-66 芯片。它还支持 53c710，但仅限于在 53c700 模拟模式下。该驱动程序功能齐全，并支持同步（仅限 -66 和 710），断开连接和标签命令队列。由于 53c700 必须与总线接口，因此您需要在此驱动程序周围包装卡检测器。例如，请参阅 NCR_D700.[ch] 或 lasi700.[ch] 文件。
53c700.[ch] 文件中的注释会告诉您需要填写哪些部分才能使驱动程序工作。
编译时标志
==================

一个编译时标志是：

`CONFIG_53C700_LE_ON_BE`

如果需要在大端字节序架构上以小端字节序模式支持该芯片集，则定义此标志（用于 parisc 上的 700）。
使用芯片核心驱动程序
==========================

为了将 53c700 芯片核心驱动程序集成到一个工作的 SCSI 驱动程序中，您需要了解有关芯片在系统（或扩展卡）中布线方式的以下三个信息：
1. SCSI 核心的时钟速度
2. 使用的中断线
3. 53c700 寄存器的内存（或 I/O 空间）位置

此外，您可能还需要知道其他一些信息，比如如何从卡 BIOS 中读取 SCSI ID 或者芯片是否连接为差分操作。

通常，您可以从通用规格文档中找到第 2 和第 3 项信息，甚至通过检查另一个操作系统下的工作驱动程序配置也可以找到这些信息。

时钟速度通常隐藏在技术文献深处。这是必需的，因为它用于设置芯片的同步和异步除数。作为一般的经验法则，制造商将时钟速度设置为与芯片最佳操作一致的最低设置（尽管有些人选择将其驱动为 CPU 或总线时钟而不是额外花费一个时钟芯片）。最佳操作时钟速度如下：

=========  =====
53c700     25MHz
53c700-66  50MHz
53c710     40MHz
=========  =====

编写您的粘合驱动程序
========================

这将是一个标准的 SCSI 驱动程序（我不知道有一份好的文档来描述这一点，可以从其他驱动程序复制）。至少包含一个检测和释放入口。
在检测例程中，你需要分配一个 `NCR_700_Host_Parameters` 大小的内存区域，并将其清空（这样所有默认值都为 0）。然后你需要填写对你重要的参数（见下文），将中断行连接到 `NCR_700_intr` 例程，并使用主机模板和新的参数调用 `NCR_700_detect`。你还应该调用相应的 `request_*_region` 函数并将寄存器基地址放入主机参数中的 `'base'` 指针。

在释放例程中，你必须释放之前分配的 `NCR_700_Host_Parameters`，调用相应的 `release_*_region` 并释放中断。

处理中断
---------

一般来说，你应该通过以下方式将卡的中断行连接起来：

```c
request_irq(irq, NCR_700_intr, <irq flags>, <driver name>, host);
```

其中 `host` 是从相关的 `NCR_700_detect()` 例程返回的值。

你也可以编写自己的中断处理例程，直接调用 `NCR_700_intr()`。但是，只有在你的卡上有多个芯片并且你可以读取寄存器来判断是哪一组芯片需要中断的情况下，才应该这样做。

可设置的 `NCR_700_Host_Parameters`
----------------------------------

以下是用户可设置的参数列表：

- `clock`: （强制）
  设置为芯片的时钟速度（MHz）。
- `base`: （强制）
  设置为寄存器集的 I/O 或内存区域的基地址。在 64 位架构上，这个值只有 32 位宽，因此寄存器必须映射到内存的低 32 位。
- `pci_dev`: （可选）
  设置为 PCI 板卡设备。对于非 PCI 板卡，请留空。这用于 `pci_alloc_consistent()` 和 `pci_map_*()` 函数。
- `dmode_extra`: （可选，仅适用于 53c710）
  用于 DMODE 寄存器的额外标志。这些用于控制 710 芯片上的总线输出引脚。这些引脚的实际功能完全取决于板卡设计者。通常可以忽略这个设置。
- `differential`: （可选）
  如果芯片驱动差分总线，则设置为 1。
- `force_le_on_be`: （可选，仅当设置了 CONFIG_53C700_LE_ON_BE 时）
  如果芯片在大端模式架构上以小端模式运行，则设置为 1。
chip710：（可选）
  如果芯片是53c710，则设置为1
burst_disable：（可选，仅限53c710）
  禁用DMA传输中的8字节突发模式
