SPDX 许可证标识符: GPL-2.0

============
SYM-2 驱动程序
============

作者：Gerard Roudier <groudier@free.fr>

21 Rue Carnot

95170 DEUIL LA BARRE - 法国

更新者：Matthew Wilcox <matthew@wil.cx>

2004-10-09

.. 目录

   1. 引言
   2. 支持的芯片和 SCSI 特性
   3. 对于新芯片的优势
       3.1 优化的 SCSI SCRIPTS
           3.2 新特性出现在 SYM53C896 中
   4. 内存映射 I/O 与普通 I/O
   5. 标记命令队列
   6. 奇偶校验
   7. 性能分析信息
   8. 控制命令
       8.1 设置最小同步周期
       8.2 设置宽大小
       8.3 设置最大并发标记命令数
       8.4 设置调试模式
       8.5 设置标志（no_disc）
       8.6 设置详细级别
       8.7 重置目标的所有逻辑单元
       8.8 终止目标所有逻辑单元的所有任务
   9. 配置参数
   10. 启动设置命令
       10.1 语法
       10.2 可用参数
           10.2.1 默认标记命令数
           10.2.2 突发最大值
           10.2.3 LED 支持
           10.2.4 差分模式
           10.2.5 IRQ 模式
           10.2.6 检查 SCSI 总线
           10.2.7 为主机建议默认的 SCSI ID
           10.2.8 详细级别
           10.2.9 调试模式
           10.2.10 结算延迟
           10.2.11 串行 NVRAM
           10.2.12 排除一个主机不被连接
       10.3 从旧选项转换
       10.4 检查 SCSI 总线启动选项
   11. 解决 SCSI 问题
       15.1 问题追踪
       15.2 理解硬件错误报告
   12. 串行 NVRAM 支持（由 Richard Waltham 提供）
       17.1 功能
       17.2 Symbios NVRAM 布局
       17.3 Tekram NVRAM 布局

1. 引言
===============

此驱动程序支持整个 SYM53C8XX 系列的 PCI-SCSI 控制器。
它还支持基于 SYM53C8XX SCRIPTS 语言的 LSI53C10XX PCI-SCSI 控制器的子集。
它取代了 sym53c8xx+ncr53c8xx 驱动程序捆绑包，并与其 FreeBSD 的 SYM-2 驱动程序共享核心代码。
使该驱动程序在 Linux 下工作的“粘合”部分包含在名为 sym_glue.h 和 sym_glue.c 的两个文件中。
其他驱动程序文件旨在不依赖所使用的操作系统。
此驱动程序的历史可以总结如下：

1993: ncr 驱动程序为 386bsd 和 FreeBSD 编写：
          - Wolfgang Stanglmeier        <wolf@cologne.de>
          - Stefan Esser                <se@mi.Uni-Koeln.de>

1996: 将 ncr 驱动程序移植到 Linux-1.2.13 并将其重命名为 ncr53c8xx
- Gerard Roudier

1998: 新的 sym53c8xx 驱动程序，基于 LOAD/STORE 指令，并增加了对 896 的全面支持，但放弃了对早期 NCR 设备的支持
- Gerard Roudier

1999: 将 sym53c8xx 驱动程序移植到 FreeBSD，并支持 LSI53C1010 33 MHz 和 66 MHz Ultra-3 控制器。新的驱动程序名为 'sym'
- Gerard Roudier

2000: 为 FreeBSD 的 'sym' 驱动程序添加对早期 NCR 设备的支持，将驱动程序拆分为多个源文件，并将操作系统粘合代码与可以在不同操作系统之间共享的核心代码分开
为Linux编写粘合代码
- Gerard Roudier

2004: 移除FreeBSD兼容代码。移除对Linux 2.6之前版本的支持。开始使用Linux的特性。
此README文件针对的是Linux版本的驱动程序。在FreeBSD下，驱动文档是sym.8手册页。
有关新芯片的信息可以在LSILOGIC的服务器上找到：

          http://www.lsilogic.com/

SCSI标准文档可以在T10网站上找到：

          http://www.t10.org/

由Eric Youngdale编写的有用的SCSI工具包含在大多数Linux发行版中：

   ============ ==========================
   scsiinfo     命令行工具
   scsi-config  使用scsiinfo的TCL/Tk工具
   ============ ==========================

2. 支持的芯片和SCSI特性
============================

以下特性支持所有芯片：
- 同步协商
- 断开连接
- 标记命令队列
- SCSI奇偶校验检查
- PCI主控奇偶校验检查

其他特性取决于芯片的能力
该驱动特别为支持LOAD/STORE特性的设备优化了SCRIPTS，并通过SCRIPTS处理支持相应特性的设备的PHASE MISMATCH问题。
下表显示了芯片家族的一些特性
+--------+-----------+-----+-----------+------------+------------+---------+
|        |           |     |           |            |Load/store  |Hardware |
|        |On board   |     |           |            |scripts     |phase    |
|Chip    |SDMS BIOS  |Wide |SCSI std.  | Max. sync  |            |mismatch |
+--------+-----------+-----+-----------+------------+------------+---------+
|810     |     N     |  N  | FAST10    | 10 MB/s    |      N     |    N    |
+--------+-----------+-----+-----------+------------+------------+---------+
|810A    |     N     |  N  | FAST10    | 10 MB/s    |      Y     |    N    |
+--------+-----------+-----+-----------+------------+------------+---------+
|815     |     Y     |  N  | FAST10    | 10 MB/s    |      N     |    N    |
+--------+-----------+-----+-----------+------------+------------+---------+
|825     |     Y     |  Y  | FAST10    | 20 MB/s    |      N     |    N    |
+--------+-----------+-----+-----------+------------+------------+---------+
|825A    |     Y     |  Y  | FAST10    | 20 MB/s    |      Y     |    N    |
+--------+-----------+-----+-----------+------------+------------+---------+
|860     |     N     |  N  | FAST20    | 20 MB/s    |      Y     |    N    |
+--------+-----------+-----+-----------+------------+------------+---------+
|875     |     Y     |  Y  | FAST20    | 40 MB/s    |      Y     |    N    |
+--------+-----------+-----+-----------+------------+------------+---------+
|875A    |     Y     |  Y  | FAST20    | 40 MB/s    |      Y     |    Y    |
+--------+-----------+-----+-----------+------------+------------+---------+
|876     |     Y     |  Y  | FAST20    | 40 MB/s    |      Y     |    N    |
+--------+-----------+-----+-----------+------------+------------+---------+
|895     |     Y     |  Y  | FAST40    | 80 MB/s    |      Y     |    N    |
+--------+-----------+-----+-----------+------------+------------+---------+
|895A    |     Y     |  Y  | FAST40    | 80 MB/s    |      Y     |    Y    |
+--------+-----------+-----+-----------+------------+------------+---------+
|896     |     Y     |  Y  | FAST40    | 80 MB/s    |      Y     |    Y    |
+--------+-----------+-----+-----------+------------+------------+---------+
|897     |     Y     |  Y  | FAST40    | 80 MB/s    |      Y     |    Y    |
+--------+-----------+-----+-----------+------------+------------+---------+
|1510D   |     Y     |  Y  | FAST40    | 80 MB/s    |      Y     |    Y    |
+--------+-----------+-----+-----------+------------+------------+---------+
|1010    |     Y     |  Y  | FAST80    |160 MB/s    |      Y     |    Y    |
+--------+-----------+-----+-----------+------------+------------+---------+
|1010_66 |     Y     |  Y  | FAST80    |160 MB/s    |      Y     |    Y    |
|[1]_    |           |     |           |            |            |         |
+--------+-----------+-----+-----------+------------+------------+---------+

.. [1] 芯片支持33MHz和66MHz PCI总线时钟
其他支持特性的总结：

:模块:                允许加载驱动
:内存映射I/O:         提高性能
:控制命令:            写入操作到proc SCSI文件系统
:调试信息:            写入syslog（仅限专家）
:串行NVRAM:            Symbios和Tekram格式

- 分散/聚集
- 共享中断
- 引导设置命令

3. 新芯片的驱动优势
=============================================

3.1 优化的SCSI SCRIPTS
--------------------------

除了810、815和825之外的所有芯片都支持新的SCSI SCRIPTS指令LOAD和STORE，这些指令允许从/向IO寄存器到/从内存移动最多一个DWORD的数据，速度比53c7xx和53c8xx系列支持的MOVE MEMORY指令快得多。
LOAD/STORE指令支持绝对地址和DSA相对地址模式。SCSI SCRIPTS已经完全重写，用LOAD/STORE指令替换了MOVE MEMORY指令。
由于早期芯片缺乏LOAD/STORE SCRIPTS指令，这个驱动还包含了一套基于MEMORY MOVE的不同SCRIPTS集，以便支持整个SYM53C8XX芯片系列。

3.2 新特性出现在SYM53C896中
--------------------------------------------

较新的芯片（见上文）允许从SCRIPTS处理相位不匹配的情况（避免了因相位不匹配中断而导致SCSI处理器停止直到C代码保存传输上下文）。
896和1010芯片支持64位PCI事务和寻址，而895A芯片支持32位PCI事务和64位寻址。
这些芯片的SCRIPTS处理器不是真正的64位，而是使用段寄存器来处理第32到63位。另一个有趣的特点是，访问片上RAM（8K）的LOAD/STORE指令保持在芯片内部。

4. 内存映射I/O与普通I/O
======================================

内存映射I/O比普通I/O具有更低的延迟，并且是推荐用于PCI设备的I/O方式。在大多数硬件配置上，内存映射I/O似乎工作得很好，但一些设计不佳的芯片组可能会破坏这一功能。提供了一个配置选项以使用普通I/O，但驱动默认使用MMIO。

5. 带标签的命令队列
==========================

向设备同时排队超过一个命令可以让它根据实际磁头位置及其机械特性进行优化。此功能还可以减少平均命令延迟。
为了真正利用这一特性，设备必须有合理的缓存大小（对于低端硬盘来说，128KB或更小的缓存不要期望奇迹发生）。
一些已知的老SCSI设备不正确支持带标签的命令队列。
通常，修复这类问题的固件更新可以在各自厂商的网站上找到。
我可以说的是，使用这个驱动及其前身时，我从未遇到过带标签队列的问题。以下是我使用带标签命令时表现正常的硬盘：

- IBM S12 0662
- Conner 1080S
- Quantum Atlas I
- Quantum Atlas II
- Seagate Cheetah I
- Quantum Viking II
- IBM DRVS
- Quantum Atlas IV
- Seagate Cheetah II

如果你的控制器有NVRAM，你可以通过用户设置工具为每个目标配置此功能。Tekram设置程序允许调整最多32个排队命令的数量。Symbios设置仅允许启用或禁用此功能。
设备上同时排队的标记命令的最大数量目前默认设置为16。这个值对于大多数SCSI磁盘来说是合适的。对于大容量SCSI磁盘（>= 2GB，缓存 >= 512KB，平均寻道时间 <= 10 毫秒），使用更大的值可能会带来更好的性能。

此驱动程序支持每个设备最多255个命令，但超过64个通常是没有必要的，除非您使用的是非常大的磁盘或磁盘阵列。值得注意的是，最近的大多数硬盘似乎不接受超过64个并发命令。因此，使用超过64个排队命令可能只是浪费资源。

如果您的控制器没有NVRAM或者由SDMS BIOS/SETUP管理，您可以从启动命令行配置标记队列功能和设备队列深度。例如：

```
sym53c8xx=tags:4/t2t3q15-t4q7/t1u0q32
```

将设置标记命令队列深度如下：

- 控制器0上的目标2所有LUN --> 15
- 控制器0上的目标3所有LUN --> 15
- 控制器0上的目标4所有LUN --> 7
- 控制器1上的目标1 LUN 0 --> 32
- 其他所有目标/LUN --> 4

在某些特殊情况下，一些SCSI磁盘固件可能会为一个SCSI命令返回一个“队列已满”状态。这种行为通过以下启发式方法由驱动程序管理：

- 每次返回“队列已满”状态时，标记队列深度将减少到实际断开连接的命令数。
- 每完成200个成功的SCSI命令后，在当前限制允许的情况下，可队列命令的最大数量将增加。

由于接收和处理“队列已满”状态会消耗资源，默认情况下，驱动程序会通过指示实际使用的命令数及其状态以及其对设备队列深度变化的决策来通知用户这个问题。

驱动程序在处理“队列已满”时所使用的启发式方法确保了对性能的影响不是太严重。您可以通过将详细级别设置为零来消除这些消息，具体方法如下：

第一种方法：
    使用 'sym53c8xx=verb:0' 选项启动系统。

第二种方法：
    启动后，对与您的控制器对应的proc文件系统条目应用 "setverbose 0" 控制命令。

6. 校验和检查
==================

该驱动程序支持SCSI校验和检查和PCI总线主控校验和检查。为了确保数据传输的安全性，必须启用这些功能。一些有缺陷的设备或主板可能存在校验和问题。用于禁用校验和检查的选项已被从驱动程序中移除。

7. 性能分析信息
========================

此驱动程序不像其前身那样提供性能分析信息。此功能并不是特别有用，并且增加了代码的复杂性。
随着驱动代码变得越来越复杂，我决定移除所有看起来不实际有用的部分。

8. 控制命令
===========

控制命令可以通过对 proc SCSI 文件系统的写操作发送给驱动。通用的命令语法如下：

      echo "<verb> <parameters>" >/proc/scsi/sym53c8xx/0
      （假设控制器编号为 0）

使用 "all" 作为 "<target>" 参数时，以下命令将应用于 SCSI 链上的所有目标（除了控制器）。
可用的命令：

8.1 设置最小同步周期因子
-------------------------------

    setsync <target> <period factor>

    :target: 目标编号
    :period: 最小同步周期
最大速度 = 1000 / (4 * 周期因子)，特殊情况除外
指定周期为 0 以强制异步传输模式
- 9 表示 12.5 纳秒同步周期
- 10 表示 25 纳秒同步周期
- 11 表示 30 纳秒同步周期
- 12 表示 50 纳秒同步周期

8.2 设置宽数据大小
-------------------

    setwide <target> <size>

    :target: 目标编号
    :size:   0=8 位, 1=16 位

8.3 设置并发标记命令的最大数量
--------------------------------

    settags <target> <tags>

    :target: 目标编号
    :tags:   并发标记命令的数量
             不得大于配置的数量（默认：16）

8.4 设置调试模式
------------------

    setdebug <调试标志列表>

    可用的调试标志：

	======== ========================================================
        alloc    打印内存分配信息（ccb, lcb）
        queue    打印插入命令启动队列的信息
        result   打印 CHECK CONDITION 状态下的感觉数据
        scatter  打印分散过程中的信息
        scripts  打印脚本绑定过程中的信息
	tiny     打印最少的调试信息
	timing   打印 NCR 芯片的时间信息
	nego     打印 SCSI 协商信息
	phase    打印脚本中断信息
	======== ========================================================

    使用 "setdebug" 不带参数来重置调试标志

8.5 设置标志（no_disc）
------------------------

    setflag <target> <flag>

    :target: 目标编号

    目前只有一个标志可用：

        no_disc: 不允许目标断开连接
不指定任何标志来重置标志。例如：

    setflag 4
      将重置目标 4 的 no_disc 标志，从而允许其断开连接
setflag all
      将允许 SCSI 总线上所有设备断开连接

8.6 设置详细级别
---------------------

    setverbose #level

    驱动程序默认的详细级别为 1。此命令允许在启动后更改驱动程序的详细级别。
8.7 重置目标的所有逻辑单元
---------------------------------------

    resetdev <target>

    :target:    目标编号

    驱动程序将尝试向目标发送BUS DEVICE RESET消息。

8.8 终止目标所有逻辑单元的所有任务
----------------------------------------------------

    cleardev <target>

    :target:    目标编号

    驱动程序将尝试向目标的所有逻辑单元发送ABORT消息。

9. 配置参数
===========================

在内核配置工具（例如 make menuconfig）中，可以更改一些默认的驱动程序配置参数。
如果所有设备的固件足够完善，那么可以在启动时启用驱动程序支持的所有功能。然而，如果某个设备在某些SCSI特性上存在缺陷，您可以在Linux启动时禁用该特性的支持，并且仅在启动后为那些能够安全支持该特性的设备启用它。

配置参数：

使用正常IO                         （默认答案：n）
    如果怀疑您的主板不允许内存映射I/O，请回答“y”。
    可能会稍微降低性能。
默认标记命令队列深度   （默认答案：16）
    输入0表示不使用标记命令。
    此参数可以从引导命令行指定。
最大排队命令数           （默认答案：32）
    此选项允许您指定可以排队到设备的最大标记命令数。支持的最大值为255。
同步传输频率             （默认答案：80）
    此选项允许您指定驱动程序在启动时用于同步数据传输协商的频率（MHz）。
0 表示“异步数据传输”

10. 启动设置命令
=======================

10.1 语法
-----------

设置命令可以在启动时或作为 `modprobe` 的参数传递给驱动程序，具体描述见 `Documentation/admin-guide/kernel-parameters.rst`

在 LILO 提示符下的启动设置命令示例：

```
lilo: linux root=/dev/sda2 sym53c8xx.cmd_per_lun=4 sym53c8xx.sync=10 sym53c8xx.debug=0x200
```

- 启用标记命令，最多可排队 4 个标记命令
- 将同步协商速度设置为 10 兆次传输/秒
- 设置 DEBUG_NEGO 标志

以下命令将使用相同的选项加载驱动模块：

```
modprobe sym53c8xx cmd_per_lun=4 sync=10 debug=0x200
```

10.2 可用的参数
------------------------

10.2.1 默认标记命令数量
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- `cmd_per_lun=0`（或 `cmd_per_lun=1`） 禁用标记命令队列
- `cmd_per_lun=#tags`（`#tags > 1`） 启用标记命令队列

`#tags` 将被截断到最大排队命令配置参数

10.2.2 最大突发长度
^^^^^^^^^^^^^^^^

| 参数 | 描述 |
| --- | --- |
| `burst=0` | 禁用突发模式 |
| `burst=255` | 从初始 I/O 寄存器设置获取突发长度 |
| `burst=#x` | 启用突发模式（最多支持 1<<#x 次突发传输） |

`#x` 是一个整数值，表示最大突发传输次数的对数（以 2 为底）

默认情况下，驱动程序使用芯片支持的最大值

10.2.3 LED 支持
^^^^^^^^^^^^^^^^^^

| 参数 | 描述 |
| --- | --- |
| `led=1` | 启用 LED 支持 |
| `led=0` | 禁用 LED 支持 |

如果您的 SCSI 板卡不使用 SDMS BIOS，请不要启用 LED 支持（参见“配置参数”）

10.2.4 差分模式
^^^^^^^^^^^^^^^^^^^^

| 参数 | 描述 |
| --- | --- |
| `diff=0` | 从不设置差分模式 |
| `diff=1` | 如果 BIOS 设置了差分模式，则设置差分模式 |
| `diff=2` | 始终设置差分模式 |
| `diff=3` | 如果 GPIO3 未设置，则设置差分模式 |

10.2.5 中断模式
^^^^^^^^^^^^^^^

| 参数 | 描述 |
| --- | --- |
| `irqm=0` | 始终开启漏极开路模式 |
| `irqm=1` | 使用初始设置（假设是 BIOS 设置） |
| `irqm=2` | 始终使用推挽模式 |

10.2.6 检查 SCSI 总线
^^^^^^^^^^^^^^^^^^^^^

`buschk=<option bits>`

可用的选项位：

| 选项位 | 描述 |
| --- | --- |
| `0x0` | 不进行检查 |
```
0x1    检查并在出错时不连接控制器
0x2    检查并在出错时仅警告
===    ================================================

10.2.7 建议默认的SCSI ID给主机
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

	==========	==========================================
	hostid=255	不建议任何ID
	hostid=#x	(0 < x < 7) 建议x作为主机的SCSI ID
	==========	==========================================

如果NVRAM中有可用的主机SCSI ID，驱动程序将忽略任何作为启动选项建议的值。否则，如果提供了不同于255的建议值，它将使用该值。否则，它将尝试推断硬件中先前设置的值，并在硬件值为零时使用7。

10.2.8 详细级别
^^^^^^^^^^^^^^^^^^^^^^^

	======     ========
	verb=0     最小化
	verb=1     正常
	verb=2     过多
	======     ========

10.2.9 调试模式
^^^^^^^^^^^^^^^^^

	=========   ====================================
	debug=0	    清除调试标志
	debug=#x    设置调试标志

	#x是一个整数值，组合了以下2的幂次方值：

	============  ======
	DEBUG_ALLOC       0x1
	DEBUG_PHASE       0x2
	DEBUG_POLL        0x4
	DEBUG_QUEUE       0x8
	DEBUG_RESULT     0x10
	DEBUG_SCATTER    0x20
	DEBUG_SCRIPT     0x40
	DEBUG_TINY       0x80
	DEBUG_TIMING    0x100
	DEBUG_NEGO      0x200
	DEBUG_TAGS      0x400
	DEBUG_FREEZE    0x800
	DEBUG_RESTART  0x1000
	============  ======
	=========   ====================================

你可以安全地使用DEBUG_NEGO。然而，这些标志中的某些可能会生成大量的syslog消息。

10.2.10 结算延迟
^^^^^^^^^^^^^^^^

	========	===================
	settle=n	延迟n秒
	========	===================

在总线重置后，驱动程序将在与总线上的任何设备通信之前延迟n秒。默认是3秒，安全模式将其默认设置为10秒。

10.2.11 串行NVRAM
^^^^^^^^^^^^^^^^

	.. Note:: 该选项目前尚未实现
=======     =========================================
	nvram=n     不查找串行NVRAM
	nvram=y     测试控制器以检查是否具有板载串行NVRAM
	=======     =========================================

（替代二进制形式）

	nvram=<位选项>

	====   =================================================================
	0x01   查找NVRAM  （等同于nvram=y）
	0x02   忽略所有设备的NVRAM“同步协商”参数
	0x04   忽略所有设备的NVRAM“宽协商”参数
	0x08   忽略所有设备的NVRAM“启动时扫描”参数
	0x80   同时连接NVRAM设置为OFF的控制器（仅适用于sym53c8xx）
	====   =================================================================

10.2.12 排除某个主机的连接
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

	excl=<io_address>,..
防止位于特定IO地址的主机被连接
```
例如，`excl=0xb400,0xc000` 表示驱动程序不应在地址 0xb400 和 0xc000 上连接主机。

10.3 从旧样式选项转换
------------------------------

以前，sym2 驱动程序接受如下形式的参数：

```
sym53c8xx=tags:4,sync:10,debug:0x200
```

由于新的模块参数，这种方式不再可用。大多数选项保持不变，但 `tags` 变为了 `cmd_per_lun` 以反映其不同的用途。上面的例子现在应指定为：

```
modprobe sym53c8xx cmd_per_lun=4 sync=10 debug=0x200
```

或者在内核启动行中指定为：

```
sym53c8xx.cmd_per_lun=4 sym53c8xx.sync=10 sym53c8xx.debug=0x200
```

10.4 SCSI 总线检查启动选项
----------------------------------

当此选项设置为非零值时，驱动程序会在断言 SCSI 重置信号线后的 100 微秒检查 SCSI 线路的逻辑状态。驱动程序仅读取 SCSI 线路并检查所有线路读取值为 FALSE，除了 RESET 线路。由于在断言 SCSI 重置信号后，SCSI 设备应在最多 800 纳秒内释放总线，因此任何信号为 TRUE 的情况可能表明存在 SCSI 总线问题。
不幸的是，以下常见的 SCSI 总线问题无法检测到：

- 只安装了一个终结器
- 终结器位置错误
- 终结器质量差

另一方面，不良的电缆、损坏的设备或不符合标准的设备也可能导致驱动程序读取时 SCSI 信号不正确。

15. SCSI 问题故障排除
=============================

15.1 问题追踪
---------------------

大多数 SCSI 问题是由不符合标准的 SCSI 总线或过于有缺陷的设备引起的。如果您不幸遇到了 SCSI 问题，可以检查以下内容：

- SCSI 总线电缆
- SCSI 链两端的终结器
- Linux 系统日志消息（其中一些可能有助于您）

如果找不到问题的根源，您可以使用最少的功能配置驱动程序或设备的 NVRAM。
- 仅支持异步数据传输
- 禁用带标签的命令
- 不允许断开连接

如果您的SCSI总线没有问题，系统有很大机会能够以这种安全配置正常工作，但性能不会是最优的。如果仍然出现问题，您可以将问题描述发送到相应的邮件列表或新闻组。请给我一份副本，以确保我能收到。显然，驱动程序中可能存在错误。
我的当前电子邮件地址：Gerard Roudier <groudier@free.fr>

允许断开连接对于使用多个设备的SCSI总线非常重要，但通常会导致有问题的设备出现故障。
同步数据传输可以提高像硬盘这样的高速设备的吞吐量。具有大缓存的良好SCSI硬盘可以从带标签的命令队列中获益。

15.2 理解硬件错误报告
------------------------------

当驱动程序检测到意外错误时，可能会显示如下模式的消息：

```
sym0:1: ERROR (0:48) (1-21-65) (f/95/0) @ (script 7c0:19000000)
sym0: script cmd = 19000000
sym0: regdump: da 10 80 95 47 0f 01 07 75 01 81 21 80 01 09 00
```

消息中的某些字段可以帮助您理解问题的原因，如下所示：

```
sym0:1: ERROR (0:48) (1-21-65) (f/95/0) @ (script 7c0:19000000)
.....A.........B.C....D.E..F....G.H..I.......J.....K...L......
```

字段 A : 目标编号
控制器在发生错误时正在与之通信的设备的SCSI ID
字段 B：DSTAT IO 寄存器（DMA 状态）
========   =============================================================
位 0x40   MDPE 主数据奇偶校验错误
             在 PCI 总线上检测到数据奇偶校验错误
位 0x20   BF   总线故障
             检测到 PCI 总线故障条件
位 0x01   IID 非法指令检测
             当芯片在某些使指令非法的条件下检测到非法指令格式时设置
位 0x80   DFE DMA FIFO 空
             纯状态位，不表示错误
========   =============================================================

如果报告的 DSTAT 值包含 MDPE (0x40) 和 BF (0x20) 的组合，则原因可能是由于 PCI 总线问题。

字段 C：SIST IO 寄存器（SCSI 中断状态）
========   ==================================================================
位 0x08   SGE  SCSI 严重错误
             表示芯片检测到 SCSI 总线上导致 SCSI 协议无法正常工作的严重错误条件
位 0x04   UDC 意外断开连接
             表示设备在芯片未预期的情况下释放了 SCSI 总线。设备可能如此表现以指示 SCSI 发起者发生了无法通过 SCSI 协议报告的错误条件
位 0x02   RST SCSI 总线复位
             通常 SCSI 目标不会复位 SCSI 总线，尽管总线上的任何设备都可以随时复位它
位 0x01   PAR 奇偶校验
             检测到 SCSI 奇偶校验错误
========   ==================================================================

在故障的 SCSI 总线上，芯片可能会检测到 SGE (0x08)、UDC (0x04) 和 PAR (0x01) 中的任何错误条件。如果你的 SCSI 系统有时遇到这些错误条件，特别是 SCSI 严重错误，则 SCSI 总线问题可能是这些错误的原因。

对于字段 D、E、F、G 和 H，你可以查看 `sym53c8xx_defs.h` 文件，其中包含一些关于 IO 寄存器位的基本注释。
字段 D：SOCL Scsi 输出控制锁存器  
此寄存器反映了芯片希望驱动或与之比较的 SCSI 控制线的状态。

字段 E：SBCL Scsi 总线控制线  
SCSI 总线上控制线的实际值。

字段 F：SBDL Scsi 总线数据线  
SCSI 总线上数据线的实际值。

字段 G：SXFER Scsi 传输  
包含输出的同步周期设置和当前的同步偏移（偏移 0 表示异步）。

字段 H：SCNTL3 Scsi 控制寄存器 3  
包含异步和同步数据传输的定时值设置。

字段 I：SCNTL4 Scsi 控制寄存器 4  
仅对 53C1010 Ultra3 控制器有意义。

理解字段 J、K、L 和转储需要具备良好的 SCSI 标准知识、芯片核心功能以及内部驱动数据结构。
除非你想帮助维护驱动代码，否则你不需要解码并理解它们。

17. 串行 NVRAM（由 Richard Waltham 添加：dormouse@farsrobt.demon.co.uk）
==========================================================================

17.1 特性
---------

启用串行 NVRAM 支持可以检测 Symbios 及某些兼容 Symbios 的主机适配器以及 Tekram 板上的串行 NVRAM。Symbios 和 Tekram 使用串行 NVRAM 存储主机适配器及其连接的驱动器的设置参数。
Symbios 的 NVRAM 还存储了多主机适配器系统中主机适配器的启动顺序信息。这些信息不再使用，因为它们从根本上与热插拔 PCI 模型不兼容。
