SPDX 许可证标识符: GPL-2.0
.. include:: <isonum.txt>

======================================================
Highpoint RocketRAID 3xxx/4xxx 适配器驱动程序 (hptiop)
======================================================

控制器寄存器映射
-----------------------

对于基于 Intel IOP 的 RR44xx 适配器，控制器 IOP 通过 PCI BAR0 和 BAR2 访问。

     ============== ==================================
     BAR0 偏移量    寄存器
     ============== ==================================
            0x11C5C 链路接口中断设置
            0x11C60 链路接口中断清除
     ============== ==================================

     ============== ==================================
     BAR2 偏移量    寄存器
     ============== ==================================
            0x10    入站消息寄存器 0
            0x14    入站消息寄存器 1
            0x18    出站消息寄存器 0
            0x1C    出站消息寄存器 1
            0x20    入站门铃寄存器
            0x24    入站中断状态寄存器
            0x28    入站中断屏蔽寄存器
            0x30    出站中断状态寄存器
            0x34    出站中断屏蔽寄存器
            0x40    入站队列端口
            0x44    出站队列端口
     ============== ==================================

对于基于 Intel IOP 的适配器，控制器 IOP 通过 PCI BAR0 访问：

     ============== ==================================
     BAR0 偏移量    寄存器
     ============== ==================================
            0x10    入站消息寄存器 0
            0x14    入站消息寄存器 1
            0x18    出站消息寄存器 0
            0x1C    出站消息寄存器 1
            0x20    入站门铃寄存器
            0x24    入站中断状态寄存器
            0x28    入站中断屏蔽寄存器
            0x30    出站中断状态寄存器
            0x34    出站中断屏蔽寄存器
            0x40    入站队列端口
            0x44    出站队列端口
     ============== ==================================

对于基于 Marvell（非 Frey）IOP 的适配器，IOP 通过 PCI BAR0 和 BAR1 访问：

     ============== ==================================
     BAR0 偏移量    寄存器
     ============== ==================================
         0x20400    入站门铃寄存器
         0x20404    入站中断屏蔽寄存器
         0x20408    出站门铃寄存器
         0x2040C    出站中断屏蔽寄存器
     ============== ==================================

     ============== ==================================
     BAR1 偏移量    寄存器
     ============== ==================================
             0x0    入站队列头指针
             0x4    入站队列尾指针
             0x8    出站队列头指针
             0xC    出站队列尾指针
            0x10    入站消息寄存器
            0x14    出站消息寄存器
     0x40-0x1040    入站队列
     0x1040-0x2040  出站队列
     ============== ==================================

对于基于 Marvell Frey IOP 的适配器，IOP 通过 PCI BAR0 和 BAR1 访问：

     ============== ==================================
     BAR0 偏移量    寄存器
     ============== ==================================
             0x0    IOP 配置信息
     ============== ==================================

     ============== ===================================================
     BAR1 偏移量    寄存器
     ============== ===================================================
          0x4000    入站列表基地址低
          0x4004    入站列表基地址高
          0x4018    入站列表写指针
          0x402C    入站列表配置和控制
          0x4050    出站列表基地址低
          0x4054    出站列表基地址高
          0x4058    出站列表复制指针阴影基地址低
          0x405C    出站列表复制指针阴影基地址高
          0x4088    出站列表中断原因
          0x408C    出站列表中断使能
         0x1020C    PCIe 功能 0 中断使能
         0x10400    PCIe 功能 0 到 CPU 消息 A
         0x10420    CPU 到 PCIe 功能 0 消息 A
         0x10480    CPU 到 PCIe 功能 0 门铃
         0x10484    CPU 到 PCIe 功能 0 门铃使能
     ============== ===================================================

非 Marvell Frey 的 I/O 请求工作流程
----------------------------------------

所有排队的请求都通过入站/出站队列端口处理。
请求包可以在 IOP 或主机内存中分配。
要向控制器发送一个请求：

    - 通过读取入站队列端口或在主机 DMA 一致内存中分配一个空闲请求来获取一个空闲请求包。
从入站队列端口返回的值是相对于 IOP BAR0 的偏移量。
在主机内存中分配的请求必须以 32 字节对齐。
- 填充该包。
- 将该包通过写入入站队列发送到 IOP。对于在 IOP 内存中分配的请求，将偏移量写入入站队列端口；对于在主机内存中分配的请求，将 (0x80000000 | (bus_addr >> 5)) 写入入站队列端口。
- IOP 处理该请求。当请求完成时，它会被放入出站队列，并生成一个出站中断。
对于在 IOP 内存中分配的请求，请求偏移量被发送到出站队列。
对于分配在主机内存中的请求，(0x80000000 | (bus_addr >> 5)) 将被发布到出站队列。如果请求中设置了 IOP_REQUEST_FLAG_OUTPUT_CONTEXT 标志，则将低 32 位的上下文值发布到出站队列。

- 主机读取出站队列并完成请求。
对于分配在 IOP 内存中的请求，主机驱动程序通过将其写入出站队列来释放请求。
非队列请求（如重置/刷新等）可以通过传入消息寄存器 0 发送。具有相同值的传出消息表示传入消息已完成。

Marvell Frey 的 I/O 请求工作流程
------------------------------------

所有队列请求都通过传入/传出列表处理。
要向控制器发送请求：

- 在主机 DMA 一致内存中分配一个空闲请求。分配在主机内存中的请求必须以 32 字节为单位对齐。
- 用请求索引填充请求标志。
- 用请求的物理地址和大小填充一个空闲的传入列表单元。
- 设置传入列表写指针为前一个单元的索引，如果索引达到支持的请求数量，则回绕到 0。
### 翻译成中文：

- 将入站列表写入指针发布到IOP
- IOP处理请求。当请求完成时，带有或运算的IOPMU_QUEUE_MASK_HOST_BITS标志将被放入一个空闲的出站列表单元，并且该出站列表单元的索引将被放入复制指针影子寄存器中。会生成一个出站中断。
- 主机读取出站列表复制指针影子寄存器并与之前保存的读指针N进行比较。如果它们不同，主机将读取第(N+1)个出站列表单元。
主机从第(N+1)个出站列表单元获取请求的索引并完成请求。
非队列请求（重置通信/重置/刷新等）可以通过PCIe功能0发送到CPU消息A寄存器。具有相同值的CPU到PCIe功能0消息寄存器表示消息完成。

用户级接口
---------------------

驱动程序公开以下sysfs属性：

| 名称                | R/W | 描述                     |
|-------------------|----|--------------------------|
| driver-version     | R  | 驱动程序版本字符串         |
| firmware-version   | R  | 固件版本字符串             |

---------------------------------------------------------------------------------

版权所有 © 2006-2012 HighPoint Technologies, Inc. 保留所有权利
本文件以希望它将有用的方式分发，
但没有任何保证；甚至不包括适销性或适用于特定目的的默示保证。详见GNU通用公共许可证以获取更多详细信息。
linux@highpoint-tech.com

  http://www.highpoint-tech.com
