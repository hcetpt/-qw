SPDX许可证标识符: GPL-2.0

=========================
SCSI媒体更换器驱动程序
=========================

这是一个用于SCSI介质更换设备的驱动程序，这些设备在/proc/scsi/scsi中以“类型：介质更换器”列出。
这是为真正的点唱机设计的。不支持与常见的小型CD-ROM更换器、单槽单逻辑单元（LUN）的SCSI更换器或IDE驱动器一起工作。
用户空间工具可以从这里获取：
	http://linux.bytesex.org/misc/changer.html

一般信息
-------------------

首先简单介绍一下更换器的工作原理：更换器有两个（可能更多）SCSI ID。一个用于控制机器人的更换设备，另一个用于实际读写数据的设备。后者可以是任何东西，例如MOD、CD-ROM、磁带等。对于更换设备而言，这是一个“无关紧要”的问题，它*仅*移动介质，不做其他事情。
与IDE-CD更换器相比，SCSI更换模型较为复杂。但它几乎可以处理所有可能的情况。它知道四种不同类型的更换器元素：

  ===============   ==================================================
  媒体传输         这个部件负责移动介质，即传输臂。也称为“选择器”
存储             可以容纳介质的插槽
导入/导出       与上述相同，但可以从外部访问，即操作员（你！）可以使用它来
                    向更换器中添加和移除介质
有时称为“邮箱”
数据传输         这是进行读写的设备，即CD-ROM/磁带/其他驱动器
  ===============   ==================================================

这些都不是限定于一个：一个巨大的点唱机可以有123个CD-ROM插槽，5个CD-ROM读取器（因此有6个SCSI ID：更换器和每个CD-ROM），以及2个传输臂。处理起来没有任何问题。

实现方式
---------------------

我将该驱动程序实现为字符设备驱动程序，并采用了类似NetBSD的ioctl接口。我只是拿来了NetBSD的头文件和另一个Linux SCSI设备驱动程序作为起点。该接口应与NetBSD的源代码兼容。所以如果有任何支持类BSD更换器驱动程序的软件（有人知道吗？？？），也应该可以与这个驱动程序一起工作。
随着时间的推移，添加了一些新的ioctl调用，例如对卷标签的支持就没有被NetBSD的ioctl API所覆盖。

当前状态
------------

目前还没有实现支持多个传输臂的功能（到目前为止还没有人提出过这个需求……）
我自己使用并测试了一个Grundig品牌的35槽CD-ROM换盘机。我收到一些报告说它与磁带自动装载机（如Exabyte、HP和DEC）配合工作良好。有些人还用这个驱动程序与Amanda备份软件一起使用。它与小型（11槽）和大型（4个MO，88槽）磁光盘换盘机工作得很好。可能与其他许多换盘机也能正常工作，不过大多数（但不是全部:-) 人们只有在设备无法工作时才会给我发邮件。
我没有任何设备列表，既没有黑名单也没有白名单。因此问某个特定设备是否受支持基本上是无用的。理论上，任何支持SCSI-2媒体换盘命令集的换盘设备都应该能即插即用地与这个驱动程序兼容。如果不行，那就是一个bug。可能是驱动程序中的问题，也可能是换盘设备固件的问题。

使用说明
--------

这是一个主设备号为86的字符设备，所以可以通过 "mknod /dev/sch0 c 86 0" 创建该驱动的特殊文件。
如果模块找到了换盘机，它会打印一些关于设备的信息 [ 如果看不到任何信息，可以尝试 "dmesg" ] 并且应该出现在/proc/devices中。如果没有出现……某些换盘机使用ID? / LUN 0作为设备地址，并且使用ID? / LUN 1作为机械手地址。但是Linux默认情况下不会查找LUN 0以外的逻辑单元号，因为有很多设备不支持这一点。你可以尝试以下方法：

  1) 在 /proc/scsi/scsi 中执行 "echo 'scsi add-single-device 0 0 ID 1'" （将ID替换为设备的SCSI-ID）
  2) 在启动内核时加上 "max_scsi_luns=1" 参数（在lilo.conf中追加 "append=max_scsi_luns=1" 应该可以解决问题）

遇到问题？
--------

如果你通过 "insmod debug=1" 加载驱动程序，它将会非常详细地输出很多日志到系统日志中。编译内核时启用CONFIG_SCSI_CONSTANTS=y选项可以显著提高错误消息的质量，因为内核会将错误代码转换为人类可读的字符串。
你可以通过dmesg命令显示这些消息（或者检查日志文件）。如果你因为驱动程序的问题给我发邮件提问，请务必包含这些消息。

加载选项
--------------

debug=0/1
	启用调试信息（见上文，默认：0）
verbose=0/1
	详细输出（默认：1）
init=0/1
	在加载模块时向换盘机发送INITIALIZE ELEMENT STATUS命令（默认：1）
```plaintext
timeout_init=<seconds>
    初始化元素状态命令的超时时间（默认：3600秒）
timeout_move=<seconds>
    其他所有命令的超时时间（默认：120秒）
dt_id=<id1>,<id2>,... / dt_lun=<lun1>,<lun2>,..
    这两个选项允许指定数据传输元素的SCSI ID和LUN。你可能不需要这个，因为自动换盘机应该会提供这些信息。但有些设备不会。
vendor_firsts=, vendor_counts=, vendor_labels=
    这些insmod选项可以用来告诉驱动程序存在一些厂商特定的元素类型。例如，Grundig就是这样做的。某些自动换盘机有一个打印机来标记新刻录的CD，该打印机被分配到元素0xc000（类型5）。为了告诉驱动程序这个厂商特定的元素，可以使用以下命令：

        $ insmod ch \
            vendor_firsts=0xc000 \
            vendor_counts=1 \
            vendor_labels=printer

    所有三个insmod选项最多接受四个逗号分隔的值，这样你可以配置元素类型5-8。
你需要针对具体设备的SCSI规范来找到正确的值，因为这些值不在SCSI-2标准范围内。

致谢
------

我使用著名的“邮件补丁环游世界”方法编写了这个驱动程序。得到了（或多或少的帮助）来自：

    - Daniel Moehwald <moehwald@hdg.de>
    - Dane Jasper <dane@sonic.net>
    - R. Scott Bailey <sbailey@dsddi.eds.com>
    - Jonathan Corbet <corbet@lwn.net>

特别感谢

    - Martin Kuehne <martin.kuehne@bnbt.de>

因为他提供了一台旧的、二手的（但功能齐全的）CD-ROM自动换盘机，我现在用它来开发和测试驱动程序及工具。
祝大家玩得开心，

   Gerd

Gerd Knorr <kraxel@bytesex.org>
```
